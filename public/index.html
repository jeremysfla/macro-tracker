<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />
<title>Jeremymacro</title>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js" defer></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js" defer></script>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  :root {
    --bg:          #0d0f14;
    --surface:     #161920;
    --surface2:    #1e222d;
    --surface3:    #252a37;
    --border:      #2a2f3d;
    --border2:     #343a4d;
    --text:        #eef0f6;
    --text2:       #8b92a8;
    --text3:       #4d5468;
    --green:       #22c55e;
    --green-soft:  #0d2d1a;
    --blue:        #3b82f6;
    --blue-soft:   #0d1e3d;
    --amber:       #f59e0b;
    --amber-soft:  #2d1f05;
    --red:         #ef4444;
    --red-soft:    #2d0f0f;
    --purple:      #8b5cf6;
    --purple-soft: #1a1030;
    --cyan:        #06b6d4;
    --cyan-soft:   #051e26;
    --shadow:      0 2px 16px rgba(0,0,0,0.4);
    --shadow-md:   0 4px 28px rgba(0,0,0,0.5);
  }
  body { background: var(--bg); color: var(--text); font-family: 'Plus Jakarta Sans', sans-serif; min-height: 100vh; padding-bottom: 90px; }
  ::-webkit-scrollbar { width: 4px; } ::-webkit-scrollbar-track { background: var(--bg); } ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }
  #app { max-width: 600px; margin: 0 auto; }

  /* Header */
  .header { background: linear-gradient(135deg, #0d0f14 0%, #161920 100%); border-bottom: 1px solid var(--border); padding: 22px 20px 18px; }
  .header-sub { font-size: 11px; color: var(--green); letter-spacing: 2px; text-transform: uppercase; font-weight: 700; margin-bottom: 4px; }
  .header-title { font-size: 26px; font-weight: 800; color: var(--text); letter-spacing: -0.5px; }

  /* Content */
  .content { padding: 18px 16px; }

  /* Cards */
  .card { background: var(--surface); border: 1px solid var(--border); border-radius: 20px; padding: 18px; margin-bottom: 14px; box-shadow: var(--shadow); }
  .card-label { font-size: 11px; font-weight: 700; letter-spacing: 1.5px; text-transform: uppercase; margin-bottom: 14px; color: var(--text2); }


  /* Tab bar */
  .tab-bar { position: fixed; bottom: 0; left: 0; right: 0; background: #0d0f14; border-top: 1px solid var(--border); display: flex; z-index: 100; padding-bottom: env(safe-area-inset-bottom); box-shadow: 0 -4px 30px rgba(0,0,0,0.6); }
  .tab-btn { flex: 1; padding: 6px 0 5px; background: none; border: none; color: var(--text3); font-size: 8px; font-family: inherit; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; display: flex; flex-direction: column; align-items: center; gap: 2px; cursor: pointer; transition: all 0.2s; }
  .tab-btn.active { color: var(--green); }
  .tab-btn.active .tab-icon { transform: scale(1.1); filter: drop-shadow(0 2px 6px rgba(0,0,0,0.18)); }
  .tab-icon { font-size: 22px; transition: transform 0.2s, filter 0.2s; display: block; }

  /* Inputs */
  input[type=number], input[type=text] { background: var(--surface2); border: 1.5px solid var(--border); color: var(--text); padding: 11px 14px; border-radius: 14px; font-family: inherit; font-size: 14px; font-weight: 500; width: 100%; outline: none; -moz-appearance: textfield; transition: border-color 0.2s, box-shadow 0.2s; }
  input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; }
  input:focus { border-color: var(--green); box-shadow: 0 0 0 3px rgba(34,197,94,0.12); }
  input::placeholder { color: var(--text3); }

  /* Button */
  .btn-green { width: 100%; padding: 14px; background: var(--green); color: #fff; font-family: inherit; font-weight: 700; font-size: 14px; letter-spacing: 0.5px; border: none; border-radius: 16px; cursor: pointer; transition: opacity 0.15s, transform 0.1s; box-shadow: 0 4px 14px rgba(34,197,94,0.3); }
  .btn-green:active { opacity: 0.9; transform: scale(0.99); }

  /* Macro grid */
  .macro-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 16px; }
  .macro-tile { background: var(--surface2); border-radius: 16px; padding: 14px; border: 1.5px solid var(--border); }
  .macro-tile-label { font-size: 10px; font-weight: 700; letter-spacing: 1px; text-transform: uppercase; }
  .macro-tile-val { font-size: 20px; font-weight: 700; letter-spacing: -0.5px; margin-top: 5px; color: var(--text); }
  .macro-tile-note { font-size: 11px; color: var(--text3); margin-top: 3px; }

  /* Rings */
  .rings-row { display: flex; justify-content: space-around; align-items: center; padding: 4px 0; }
  .ring-wrap { display: flex; flex-direction: column; align-items: center; gap: 6px; }
  .ring-lbl { font-size: 10px; font-weight: 700; letter-spacing: 0.8px; text-transform: uppercase; color: var(--text2); }

  /* Week strip */
  .week-strip { display: flex; gap: 6px; margin-bottom: 18px; overflow-x: auto; padding-bottom: 4px; scrollbar-width: none; }
  .week-strip::-webkit-scrollbar { display: none; }
  .week-day { min-width: 44px; flex: 1; border-radius: 16px; padding: 10px 4px 8px; text-align: center; border: 1.5px solid var(--border); background: var(--surface); transition: all 0.2s; cursor: pointer; position: relative; }
  .week-day:active { transform: scale(0.94); }
  .week-day.selected { border-color: var(--blue); box-shadow: 0 0 0 2px rgba(59,130,246,0.3); }
  .week-day.today-card { background: var(--surface2); }
  .week-day-name { font-size: 9px; font-weight: 700; letter-spacing: 0.8px; text-transform: uppercase; color: var(--text3); margin-bottom: 6px; }
  .week-day-name.active-name { color: var(--text); }
  .week-day-icon { font-size: 20px; line-height: 1; }
  .week-day-sess { font-size: 9px; font-weight: 800; margin-top: 4px; letter-spacing: 0.3px; }

  /* Session tabs */
  .session-tabs { display: flex; gap: 8px; margin-bottom: 16px; background: var(--surface2); border-radius: 18px; padding: 4px; }
  .sess-btn { flex: 1; padding: 10px 4px; background: transparent; color: var(--text2); border: none; border-radius: 14px; font-family: inherit; font-size: 12px; font-weight: 600; cursor: pointer; text-align: center; line-height: 1.5; transition: all 0.2s; }
  .sess-btn.active { background: var(--surface); color: var(--text); box-shadow: var(--shadow); }

  /* Exercise cards — per-set logging */
  .ex-card { background: var(--surface); border: 1.5px solid var(--border); border-radius: 18px; padding: 16px; margin-bottom: 10px; box-shadow: var(--shadow); }
  .ex-header { display: flex; align-items: center; gap: 12px; margin-bottom: 10px; }
  .ex-badge { width: 36px; height: 36px; border-radius: 12px; background: var(--green-soft); color: var(--green); display: flex; align-items: center; justify-content: center; font-size: 13px; font-weight: 700; flex-shrink: 0; }
  .ex-badge.done { background: #0d2d1a; color: #22c55e; }
  .ex-name { font-size: 15px; font-weight: 700; color: var(--text); }
  .ex-meta { font-size: 11px; color: var(--blue); font-weight: 500; margin-top: 2px; }
  .ex-suggestion { display: flex; align-items: flex-start; gap: 8px; background: #1f1800; border-radius: 12px; padding: 9px 12px; margin-bottom: 12px; border: 1.5px solid #3d2e00; }
  .ex-suggestion-text { font-size: 12px; color: #d4a017; font-weight: 500; flex: 1; line-height: 1.6; }
  .ex-suggestion-text strong { color: #f59e0b; font-weight: 700; }
  .set-col-headers { display: flex; align-items: center; gap: 8px; margin-bottom: 5px; padding: 0 2px; }
  .set-col-lbl { font-size: 9px; font-weight: 700; color: var(--text3); text-transform: uppercase; letter-spacing: 0.8px; }
  .set-rows { display: flex; flex-direction: column; gap: 7px; }
  .set-row { display: flex; align-items: center; gap: 8px; }
  .set-label { font-size: 11px; font-weight: 700; color: var(--text3); width: 36px; flex-shrink: 0; }
  .set-weight-input { flex: 1; padding: 10px 8px; border-radius: 12px; border: 1.5px solid var(--border); background: var(--surface2); font-family: inherit; font-size: 15px; font-weight: 700; color: var(--text); text-align: center; transition: all 0.15s; }
  .set-weight-input:focus { outline: none; border-color: var(--green); background: var(--green-soft); }
  .set-weight-input.completed { border-color: #166534; background: #0d2d1a; color: #22c55e; }
  .set-reps-input { width: 54px; padding: 10px 6px; border-radius: 12px; border: 1.5px solid var(--border); background: var(--surface2); font-family: inherit; font-size: 15px; font-weight: 700; color: var(--text); text-align: center; transition: all 0.15s; }
  .set-reps-input:focus { outline: none; border-color: var(--blue); background: #0d1e3d; }
  .set-done-btn { width: 36px; height: 36px; border-radius: 11px; border: 1.5px solid var(--border); background: var(--surface2); font-size: 16px; cursor: pointer; display: flex; align-items: center; justify-content: center; flex-shrink: 0; transition: all 0.15s; }
  .set-done-btn.done { background: var(--green-soft); border-color: #86efac; }
  .ex-volume { font-size: 11px; font-weight: 600; color: var(--text3); margin-top: 10px; display: flex; align-items: center; gap: 6px; }
  .ex-volume span { background: var(--surface2); padding: 3px 9px; border-radius: 20px; font-weight: 700; }
  .rpe-row { display: flex; gap: 4px; margin-top: 10px; }
  .rpe-btn { flex: 1; padding: 5px 2px; border-radius: 8px; border: 1.5px solid var(--border); background: var(--surface2); font-family: inherit; font-size: 11px; font-weight: 700; color: var(--text3); cursor: pointer; text-align: center; transition: all 0.15s; }
  .rpe-btn.active { background: var(--amber-soft); border-color: #3d2e00; color: #f59e0b; }

  /* Principles */
  .principle-row { padding-bottom: 12px; margin-bottom: 12px; border-bottom: 1px solid var(--border); }
  .principle-title { font-size: 14px; font-weight: 600; color: var(--text); margin-bottom: 3px; }
  .principle-desc { font-size: 12px; color: var(--text2); line-height: 1.5; }
  .principle-row:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }

  /* History */
  .hist-card { background: var(--surface); border: 1.5px solid var(--border); border-radius: 18px; padding: 16px; margin-bottom: 12px; box-shadow: var(--shadow); }
  .hist-header { display: flex; justify-content: space-between; margin-bottom: 12px; }
  .hist-sess { font-size: 14px; font-weight: 600; color: var(--text); }
  .hist-date { font-size: 11px; color: var(--text3); margin-top: 2px; font-weight: 500; }
  .hist-row { display: flex; justify-content: space-between; font-size: 13px; padding: 6px 0; border-bottom: 1px solid var(--border); }
  .hist-row:last-child { border-bottom: none; }
  .hist-ex { color: var(--text2); font-weight: 500; }
  .hist-wt { color: var(--text); font-weight: 600; }

  /* History sub-tabs */
  /* Food search mode tabs */
  .fstab-btn { flex:1; padding:8px 4px; border:1.5px solid var(--border); border-radius:12px; background:var(--surface); color:var(--text2); font-size:12px; font-weight:600; cursor:pointer; font-family:inherit; transition:all 0.15s; }
  .fstab-active { background:#22c55e; border-color:#22c55e; color:#fff; }
  #fstab-meal.fstab-active  { background:#7c3aed; border-color:#7c3aed; }
  #fstab-supp.fstab-active  { background:#3b82f6; border-color:#3b82f6; }

  /* Supplement presets */
  .supp-preset-row { display:flex; align-items:center; justify-content:space-between; padding:10px 0; border-bottom:1px solid var(--border); }
  .supp-preset-row:last-child { border-bottom:none; }
  .supp-preset-info { flex:1 }
  .supp-preset-name { font-size:13px; font-weight:600; color:var(--text); }
  .supp-preset-detail { font-size:11px; color:var(--text3); margin-top:2px; }
  .supp-log-btn { padding:6px 14px; border-radius:10px; border:1.5px solid #3b82f6; background:transparent; color:#3b82f6; font-size:12px; font-weight:700; cursor:pointer; font-family:inherit; white-space:nowrap; }

  /* Meal analysis */
  .meal-ingredient-row { display:flex; align-items:center; gap:8px; padding:8px 0; border-bottom:1px solid var(--border); font-size:12px; }
  .meal-ingredient-row:last-child { border-bottom:none; }
  .meal-ingredient-status { font-size:14px; flex-shrink:0; }

    .htab-btn { flex:1; padding:9px 6px; border:1.5px solid var(--border); border-radius:12px; background:var(--surface); color:var(--text2); font-size:12px; font-weight:600; cursor:pointer; font-family:inherit; transition:all 0.15s; }
  .htab-active { background:#ef4444; border-color:#ef4444; color:#fff; }
  #htab-blood.htab-active { background:#ef4444; border-color:#ef4444; }
  #htab-lift.htab-active  { background:#22c55e; border-color:#22c55e; }
  #htab-nutr.htab-active  { background:#3b82f6; border-color:#3b82f6; }

  /* Blood work cards */
  /* ── Blood Work ─────────────────────────────────── */
  .blood-panel-card { background:var(--surface); border:1.5px solid var(--border); border-radius:18px; padding:16px; margin-bottom:12px; }
  .blood-panel-card.has-bad  { border-color:#ef444444; }
  .blood-panel-card.has-warn { border-color:#f59e0b44; }
  .blood-panel-title { font-size:13px; font-weight:700; color:var(--text); margin-bottom:12px; display:flex; align-items:center; justify-content:space-between; flex-wrap:wrap; gap:6px; }

  /* Marker rows */
  .blood-marker-row { padding:10px 0; border-bottom:1px solid var(--border); }
  .blood-marker-row:last-child { border-bottom:none; }
  .blood-marker-row.status-bad  { background:linear-gradient(90deg,#ef444408 0%,transparent 100%); margin:0 -16px; padding:10px 16px; border-left:3px solid #ef4444; }
  .blood-marker-row.status-warn { background:linear-gradient(90deg,#f59e0b08 0%,transparent 100%); margin:0 -16px; padding:10px 16px; border-left:3px solid #f59e0b; }
  .blood-marker-top { display:flex; align-items:center; justify-content:space-between; margin-bottom:6px; }
  .blood-marker-name { font-size:13px; color:var(--text2); font-weight:500; flex:1; }
  .blood-marker-right { display:flex; align-items:center; gap:8px; flex-shrink:0; }
  .blood-marker-val  { font-size:15px; font-weight:800; }
  .blood-marker-val.status-ok   { color:#22c55e; }
  .blood-marker-val.status-warn { color:#f59e0b; }
  .blood-marker-val.status-bad  { color:#ef4444; }
  .blood-marker-flag { font-size:9px; font-weight:800; padding:2px 6px; border-radius:20px; }
  .blood-marker-flag.H, .blood-marker-flag.HH { background:#450a0a; color:#ef4444; }
  .blood-marker-flag.L, .blood-marker-flag.LL { background:#0c1a4e; color:#60a5fa; }
  .blood-marker-trend { font-size:11px; font-weight:700; padding:2px 7px; border-radius:20px; }
  .blood-marker-trend.good { background:#0d2d1a; color:#22c55e; }
  .blood-marker-trend.bad  { background:#450a0a; color:#ef4444; }
  .blood-marker-trend.neut { background:var(--surface2); color:var(--text3); }

  /* Range bar */
  .blood-range-bar { height:6px; background:var(--surface2); border-radius:3px; position:relative; margin-top:4px; overflow:visible; }
  .blood-range-zone { position:absolute; top:0; height:6px; background:#22c55e22; border-radius:3px; }
  .blood-range-dot  { position:absolute; top:50%; transform:translate(-50%,-50%); width:10px; height:10px; border-radius:50%; border:2px solid var(--bg); z-index:2; }
  .blood-range-labels { display:flex; justify-content:space-between; font-size:9px; color:var(--text3); margin-top:3px; }

  /* Summary dashboard */
  .blood-summary-grid { display:grid; grid-template-columns:repeat(3,1fr); gap:8px; margin-bottom:14px; }
  .blood-summary-tile { background:var(--surface2); border-radius:14px; padding:10px 8px; text-align:center; }
  .blood-summary-num  { font-size:24px; font-weight:800; line-height:1; }
  .blood-summary-lbl  { font-size:10px; color:var(--text3); margin-top:3px; font-weight:600; text-transform:uppercase; letter-spacing:0.5px; }

  /* Out of range strip */
  .blood-oob-strip { background:#450a0a; border:1px solid #ef444430; border-radius:14px; padding:12px 14px; margin-bottom:12px; }
  .blood-oob-strip-title { font-size:11px; font-weight:800; color:#ef4444; text-transform:uppercase; letter-spacing:1px; margin-bottom:8px; }
  .blood-oob-item { display:flex; align-items:center; justify-content:space-between; padding:5px 0; border-bottom:1px solid #ef444418; }
  .blood-oob-item:last-child { border-bottom:none; }

  /* Trend chart v2 */
  .btchart-wrap { background:var(--surface2); border-radius:14px; padding:12px; margin-bottom:10px; }
  .btchart-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; }
  .btchart-name { font-size:12px; font-weight:700; color:var(--text); }
  .btchart-delta { font-size:11px; font-weight:700; padding:2px 8px; border-radius:20px; }

  /* View toggle */
  .bview-btn { padding:6px 14px; border-radius:10px; border:1.5px solid var(--border); background:transparent; color:var(--text3); font-size:11px; font-weight:700; cursor:pointer; font-family:inherit; transition:all 0.15s; }
  .bview-btn.active { background:#ef4444; border-color:#ef4444; color:#fff; }

  /* Comparison table */
  .bcomp-table { width:100%; border-collapse:collapse; font-size:12px; }
  .bcomp-table th { padding:8px 6px; text-align:left; color:var(--text3); font-size:10px; font-weight:700; text-transform:uppercase; letter-spacing:0.5px; border-bottom:1px solid var(--border); }
  .bcomp-table td { padding:8px 6px; border-bottom:1px solid var(--border)10; vertical-align:middle; }
  .bcomp-table tr:last-child td { border-bottom:none; }
  .bcomp-table tr.row-bad  td { background:#ef444410; }
  .bcomp-table tr.row-warn td { background:#f59e0b08; }
  .bcomp-dot { width:8px; height:8px; border-radius:50%; display:inline-block; margin-right:4px; vertical-align:middle; }
  .blood-status-ok   { color:#22c55e; }
  .blood-status-warn { color:#f59e0b; }
  .blood-status-bad  { color:#ef4444; }
  .blood-trend-up   { font-size:10px; margin-left:4px; color:#ef4444; }
  .blood-trend-down { font-size:10px; margin-left:4px; color:#22c55e; }
  .blood-date-badge { font-size:10px; background:#1e293b; color:#64748b; padding:3px 10px; border-radius:20px; font-weight:600; }

  /* Nutrition report */
  .nr-btn { padding:7px 14px; border:1.5px solid var(--border); border-radius:20px; background:transparent; color:var(--text2); font-size:12px; font-weight:600; cursor:pointer; font-family:inherit; transition:all 0.15s; }
  .nr-btn-active { background:#3b82f6; border-color:#3b82f6; color:#fff; }
  .nutr-bar-wrap { margin-bottom:10px; }
  .nutr-bar-label { display:flex; justify-content:space-between; font-size:12px; margin-bottom:4px; }
  .nutr-bar-track { background:var(--surface3); border-radius:6px; height:8px; overflow:hidden; }
  .nutr-bar-fill  { height:100%; border-radius:6px; transition:width 0.4s; }

  /* Tip box */
  .tip-box { margin-top: 14px; padding: 14px; background: #0d2d1a; border-radius: 14px; border: 1.5px solid #166534; font-size: 12px; color: #4ade80; line-height: 1.7; font-weight: 500; }

  /* Daily Quote */
  .quote-card { background: linear-gradient(135deg, #1a1d2e, #2d1f4e); border-radius: 0; padding: 16px 20px; display: flex; align-items: flex-start; gap: 12px; border-bottom: 1px solid rgba(255,255,255,0.06); }
  .quote-icon { font-size: 22px; flex-shrink: 0; margin-top: 2px; }
  .quote-text { font-size: 13px; font-weight: 600; color: #e2e8f0; line-height: 1.65; flex: 1; font-style: italic; }
  .quote-author { font-size: 10px; font-weight: 700; color: #8b5cf6; letter-spacing: 1px; text-transform: uppercase; margin-top: 5px; }
  .quote-loading { opacity: 0.45; font-style: italic; }
  @keyframes quoteFade { from { opacity:0; transform: translateY(4px); } to { opacity:1; transform: translateY(0); } }
  .quote-animate { animation: quoteFade 0.5s ease forwards; }

  /* ── Shoe Tracker ── */
  .shoe-card { background:var(--surface2);border:1.5px solid var(--border);border-radius:16px;padding:14px;margin-bottom:10px;box-shadow:var(--shadow);position:relative;overflow:hidden;transition:all 0.2s; }
  .shoe-card:last-child { margin-bottom:0; }
  .shoe-card:active { transform:scale(0.98); }
  .shoe-card.retired { opacity:0.65;border-style:dashed; }
  .shoe-card-accent { position:absolute;top:0;left:0;width:4px;height:100%;border-radius:20px 0 0 20px; }
  .shoe-card-top { display:flex;align-items:center;gap:12px;margin-bottom:12px; }
  .shoe-avatar { width:52px;height:52px;border-radius:14px;object-fit:cover;flex-shrink:0;background:var(--surface2);display:flex;align-items:center;justify-content:center;font-size:26px; }
  .shoe-name { font-size:15px;font-weight:800;color:var(--text);line-height:1.2; }
  .shoe-brand { font-size:11px;color:var(--text3);font-weight:600;margin-top:2px; }
  .shoe-status-badge { font-size:9px;font-weight:800;padding:3px 8px;border-radius:20px;text-transform:uppercase;letter-spacing:1px; }
  .shoe-status-active { background:#0d2d1a;color:#22c55e; }
  .shoe-status-retired { background:#2d0f0f;color:#f87171; }
  .shoe-mileage-bar-track { height:8px;background:var(--surface2);border-radius:99px;overflow:hidden;margin-bottom:6px; }
  .shoe-mileage-bar-fill { height:100%;border-radius:99px;transition:width 0.6s cubic-bezier(0.34,1.56,0.64,1); }
  .shoe-stats-grid { display:grid;grid-template-columns:repeat(4,1fr);gap:6px;margin-top:10px; }
  .shoe-stat { text-align:center;background:var(--surface2);border-radius:10px;padding:8px 4px; }
  .shoe-stat-val { font-size:13px;font-weight:800;color:var(--text); }
  .shoe-stat-lbl { font-size:9px;color:var(--text3);font-weight:600;margin-top:2px;text-transform:uppercase;letter-spacing:0.5px; }
  .shoe-run-row { display:flex;align-items:center;gap:10px;padding:10px 0;border-bottom:1px solid var(--border); }
  .shoe-run-row:last-child { border-bottom:none; }
  .shoe-run-date { font-size:11px;color:var(--text3);font-weight:600;min-width:72px; }
  .shoe-run-info { flex:1; }
  .shoe-run-mi { font-size:13px;font-weight:700;color:var(--text); }
  .shoe-run-meta { font-size:11px;color:var(--text3);margin-top:1px; }
  .assign-shoe-btn { display:flex;align-items:center;gap:12px;width:100%;padding:14px 16px;background:var(--surface2);border:1.5px solid var(--border);border-radius:16px;font-family:inherit;cursor:pointer;margin-bottom:8px;transition:all 0.15s;text-align:left; }
  .assign-shoe-btn:hover,.assign-shoe-btn:active { border-color:var(--green);background:var(--green-soft); }
  .assign-shoe-avatar { width:40px;height:40px;border-radius:10px;background:var(--surface);display:flex;align-items:center;justify-content:center;font-size:20px;flex-shrink:0; }


  /* ── Workout Timer Bar ── */
  .workout-timer-bar { position:sticky; top:0; z-index:50; background:linear-gradient(135deg,#0d1e3d,#1a1030); border-bottom:1.5px solid #1e3a5f; padding:12px 16px; display:flex; align-items:center; justify-content:space-between; margin:-18px -16px 16px; }
  .workout-timer-elapsed { font-size:28px; font-weight:800; color:#60a5fa; letter-spacing:-1px; font-variant-numeric:tabular-nums; }
  .workout-timer-stats { display:flex; gap:14px; }
  .workout-timer-stat { text-align:center; }
  .workout-timer-stat-val { font-size:14px; font-weight:800; color:var(--text); }
  .workout-timer-stat-lbl { font-size:9px; color:var(--text3); font-weight:700; text-transform:uppercase; letter-spacing:0.8px; }

  /* ── Rest Timer Overlay ── */
  .rest-timer-overlay { position:fixed; bottom:90px; left:50%; transform:translateX(-50%); z-index:200; background:linear-gradient(135deg,#0d2d1a,#0d1e3d); border:2px solid #22c55e; border-radius:20px; padding:14px 22px; display:flex; align-items:center; gap:14px; box-shadow:0 8px 32px rgba(0,0,0,0.5); min-width:260px; }
  .rest-timer-countdown { font-size:36px; font-weight:800; color:#22c55e; font-variant-numeric:tabular-nums; letter-spacing:-1px; }
  .rest-timer-label { font-size:11px; color:var(--text2); font-weight:700; text-transform:uppercase; letter-spacing:1px; }
  .rest-timer-skip { margin-left:auto; background:rgba(255,255,255,0.1); border:1px solid rgba(255,255,255,0.15); border-radius:10px; padding:6px 12px; font-family:inherit; font-size:11px; font-weight:700; color:var(--text2); cursor:pointer; }
  .rest-timer-bar { height:4px; background:rgba(255,255,255,0.1); border-radius:2px; margin-top:8px; overflow:hidden; }
  .rest-timer-bar-fill { height:100%; background:#22c55e; border-radius:2px; transition:width 1s linear; }

  /* ── PR Flash ── */
  .pr-flash { position:fixed; top:80px; left:50%; transform:translateX(-50%); z-index:300; background:linear-gradient(135deg,#3d2e00,#2d1f05); border:2px solid #f59e0b; border-radius:16px; padding:12px 20px; display:flex; align-items:center; gap:10px; box-shadow:0 8px 32px rgba(245,158,11,0.4); animation:prPop 0.4s cubic-bezier(0.34,1.56,0.64,1); }
  @keyframes prPop { from{opacity:0;transform:translateX(-50%) scale(0.7)} to{opacity:1;transform:translateX(-50%) scale(1)} }
  .pr-flash-icon { font-size:28px; }
  .pr-flash-text { font-size:14px; font-weight:800; color:#f59e0b; }
  .pr-flash-sub { font-size:11px; color:#d97706; font-weight:600; }

  /* ── Set type badge ── */
  .set-type-btn { width:32px; height:32px; border-radius:8px; border:1.5px solid var(--border); background:var(--surface2); font-size:10px; font-weight:800; color:var(--text3); cursor:pointer; display:flex; align-items:center; justify-content:center; flex-shrink:0; transition:all 0.15s; }
  .set-type-btn.warmup { background:#051e26; border-color:#0e4d6e; color:#06b6d4; }
  .set-type-btn.drop { background:#1a1030; border-color:#4c1d95; color:#a78bfa; }
  .set-type-btn.failure { background:#2d0f0f; border-color:#7f1d1d; color:#f87171; }
  .set-type-menu { position:absolute; z-index:100; background:var(--surface); border:1.5px solid var(--border); border-radius:14px; padding:6px; box-shadow:var(--shadow-md); min-width:160px; }
  .set-type-option { display:flex; align-items:center; gap:10px; padding:10px 12px; border-radius:10px; font-size:13px; font-weight:600; color:var(--text); cursor:pointer; transition:background 0.1s; }
  .set-type-option:hover { background:var(--surface2); }

  /* ── Add set / remove set ── */
  .btn-add-set { width:100%; padding:9px; background:var(--surface2); border:1.5px dashed var(--border); border-radius:12px; font-family:inherit; font-size:12px; font-weight:700; color:var(--text3); cursor:pointer; margin-top:8px; transition:all 0.15s; }
  .btn-add-set:hover, .btn-add-set:active { border-color:var(--green); color:var(--green); background:var(--green-soft); }
  .set-row { position:relative; }
  .btn-del-set { width:28px; height:28px; border-radius:8px; border:none; background:transparent; color:var(--text3); font-size:14px; cursor:pointer; flex-shrink:0; display:flex; align-items:center; justify-content:center; transition:all 0.15s; }
  .btn-del-set:hover { background:var(--red-soft); color:var(--red); }

  /* ── Workout completion screen ── */
  .workout-complete-overlay { position:fixed; inset:0; z-index:500; background:var(--bg); display:flex; flex-direction:column; align-items:center; justify-content:center; padding:24px; overflow-y:auto; }
  .workout-complete-icon { font-size:72px; margin-bottom:8px; animation:prPop 0.5s cubic-bezier(0.34,1.56,0.64,1); }
  .workout-complete-title { font-size:28px; font-weight:800; color:var(--text); letter-spacing:-0.5px; margin-bottom:4px; }
  .workout-complete-sub { font-size:14px; color:var(--text2); margin-bottom:28px; }
  .workout-complete-stats { display:grid; grid-template-columns:1fr 1fr; gap:12px; width:100%; max-width:340px; margin-bottom:24px; }
  .wc-stat { background:var(--surface); border:1.5px solid var(--border); border-radius:16px; padding:16px; text-align:center; }
  .wc-stat-val { font-size:24px; font-weight:800; color:var(--text); letter-spacing:-0.5px; }
  .wc-stat-lbl { font-size:10px; font-weight:700; color:var(--text3); text-transform:uppercase; letter-spacing:1px; margin-top:4px; }
  .wc-prs { background:linear-gradient(135deg,#3d2e00,#2d1f05); border:1.5px solid #f59e0b; border-radius:16px; padding:14px 18px; width:100%; max-width:340px; margin-bottom:20px; }
  .wc-pr-item { font-size:13px; font-weight:700; color:#f59e0b; padding:4px 0; }

  /* ── Exercise progress chart modal ── */
  .ex-chart-modal { position:fixed; inset:0; z-index:400; background:rgba(0,0,0,0.7); display:flex; align-items:flex-end; }
  .ex-chart-sheet { background:var(--surface); border-radius:24px 24px 0 0; padding:20px; width:100%; max-height:70vh; overflow-y:auto; }
  .ex-chart-title { font-size:17px; font-weight:800; color:var(--text); margin-bottom:4px; }
  .ex-chart-sub { font-size:12px; color:var(--text2); margin-bottom:16px; }
  .ex-chart-svg { width:100%; height:140px; overflow:visible; }
  .ex-stats-row { display:grid; grid-template-columns:repeat(3,1fr); gap:8px; margin-top:14px; }
  .ex-stat-box { background:var(--surface2); border-radius:12px; padding:10px; text-align:center; }
  .ex-stat-val { font-size:16px; font-weight:800; color:var(--text); }
  .ex-stat-lbl { font-size:9px; font-weight:700; color:var(--text3); text-transform:uppercase; letter-spacing:0.8px; margin-top:2px; }

  /* Shared search pill row */
  .feature-tabs { display:flex; gap:6px; margin-bottom:14px; background:var(--surface2); border-radius:18px; padding:4px; }
  .ft-btn { flex:1; padding:9px 4px; background:transparent; color:var(--text2); border:none; border-radius:14px; font-family:inherit; font-size:11px; font-weight:600; cursor:pointer; text-align:center; transition:all 0.2s; }
  .ft-btn.active { background:var(--surface); color:var(--text); box-shadow:var(--shadow); }

  /* USDA / Restaurant DB result rows */
  .db-result { display:flex; align-items:center; gap:10px; padding:11px 14px; border-radius:14px; border:1.5px solid var(--border); background:var(--surface2); margin-bottom:8px; cursor:pointer; transition:all 0.15s; }
  .db-result:active, .db-result:hover { border-color:var(--green); background:var(--green-soft); }
  .db-result-info { flex:1; min-width:0; }
  .db-result-name { font-size:13px; font-weight:700; color:var(--text); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .db-result-meta { font-size:11px; color:var(--text3); margin-top:2px; font-weight:500; }
  .db-result-kcal { font-size:13px; font-weight:700; color:var(--amber); flex-shrink:0; }

  /* Recipe Builder */
  .recipe-card { background:var(--surface); border:1.5px solid var(--border); border-radius:18px; padding:14px; margin-bottom:10px; box-shadow:var(--shadow); }
  .recipe-name { font-size:15px; font-weight:700; color:var(--text); }
  .recipe-meta { font-size:11px; color:var(--text3); margin-top:3px; }
  .recipe-ingredient-row { display:flex; align-items:center; gap:8px; padding:7px 0; border-bottom:1px solid var(--border); }
  .recipe-ingredient-row:last-child { border-bottom:none; }
  .recipe-ing-name { flex:1; font-size:13px; color:var(--text); font-weight:500; }
  .recipe-ing-macros { font-size:11px; color:var(--text3); }
  .recipe-total-row { background:var(--surface2); border-radius:12px; padding:10px 12px; margin-top:10px; display:flex; justify-content:space-between; align-items:center; }
  .recipe-total-macros { font-size:12px; font-weight:700; color:var(--text); }
  .btn-recipe-log { padding:8px 16px; background:var(--green-soft); color:#22c55e; border:1.5px solid #166534; border-radius:12px; font-family:inherit; font-size:12px; font-weight:700; cursor:pointer; }
  .btn-recipe-delete { padding:8px 12px; background:var(--red-soft); color:var(--red); border:1.5px solid #7f1d1d; border-radius:12px; font-family:inherit; font-size:12px; font-weight:700; cursor:pointer; }
  .ing-qty-input { width:60px; padding:7px 8px; border-radius:10px; border:1.5px solid var(--border); background:var(--surface2); font-family:inherit; font-size:13px; font-weight:600; color:var(--text); text-align:center; }
  .ing-qty-input:focus { outline:none; border-color:var(--green); }

  /* Monthly Charts */
  .chart-container { width:100%; overflow-x:auto; }
  .month-bar-chart { display:flex; align-items:flex-end; gap:4px; height:100px; padding:0 2px; }
  .month-bar-wrap { flex:1; display:flex; flex-direction:column; align-items:center; gap:3px; min-width:18px; }
  .month-bar { width:100%; border-radius:5px 5px 0 0; min-height:3px; transition:height 0.3s; }
  .month-bar-lbl { font-size:8px; color:var(--text3); font-weight:600; text-align:center; }
  .month-bar-val { font-size:7px; color:var(--text3); font-weight:700; text-align:center; }
  .chart-tab-row { display:flex; gap:6px; margin-bottom:12px; flex-wrap:wrap; }
  .chart-tab { padding:5px 12px; border-radius:20px; border:1.5px solid var(--border); background:var(--surface2); font-family:inherit; font-size:11px; font-weight:700; color:var(--text2); cursor:pointer; transition:all 0.15s; }
  .chart-tab.active { background:var(--purple-soft); border-color:#4c1d95; color:#a78bfa; }

  /* Weekly Calorie Balance */
  .week-balance-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; margin-bottom: 16px; }
  .wbd { display: flex; flex-direction: column; align-items: center; gap: 3px; }
  .wbd-name { font-size: 9px; font-weight: 700; color: var(--text3); letter-spacing: 0.5px; text-transform: uppercase; }
  .wbd-bar-wrap { width: 100%; height: 56px; display: flex; flex-direction: column; justify-content: flex-end; align-items: center; position: relative; }
  .wbd-bar { width: 100%; border-radius: 6px 6px 0 0; min-height: 3px; transition: height 0.3s; }
  .wbd-bar.surplus { background: var(--red); }
  .wbd-bar.deficit { background: var(--green); }
  .wbd-bar.none    { background: var(--border); }
  .wbd-val { font-size: 8px; font-weight: 700; margin-top: 2px; text-align: center; line-height: 1.2; }
  .wbd-val.surplus { color: var(--red); }
  .wbd-val.deficit { color: var(--green); }
  .wbd-val.none    { color: var(--text3); }
  .wbd-today { outline: 2px solid var(--blue); border-radius: 8px; padding: 3px 2px; }
  .weekly-summary-row { display: flex; gap: 10px; }
  .weekly-stat { flex: 1; background: var(--surface2); border-radius: 14px; padding: 12px 10px; border: 1.5px solid var(--border); text-align: center; }
  .weekly-stat-val { font-size: 18px; font-weight: 700; letter-spacing: -0.5px; }
  .weekly-stat-lbl { font-size: 9px; font-weight: 700; color: var(--text3); text-transform: uppercase; letter-spacing: 0.8px; margin-top: 3px; }

  /* Misc */
  .empty-state { text-align: center; color: var(--text3); padding: 48px 20px; font-size: 14px; line-height: 1.8; }
  .section-title { font-size: 20px; font-weight: 700; letter-spacing: -0.3px; margin-bottom: 4px; color: var(--text); }
  .page { display: none; } .page.active { display: block; }
  .pill-tag { display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 11px; font-weight: 700; letter-spacing: 0.5px; }

  @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

  /* Garmin & Settings */
  .garmin-card { background: linear-gradient(135deg, rgba(59,130,246,0.08), rgba(6,182,212,0.06)); border: 1.5px solid #1e3a5f; border-radius: 20px; padding: 16px; margin-bottom: 14px; }
  .garmin-logo { width: 40px; height: 40px; border-radius: 12px; background: #1a56db; display: flex; align-items: center; justify-content: center; font-size: 20px; flex-shrink: 0; }
  .garmin-activity-row { display: flex; gap: 8px; margin-top: 12px; flex-wrap: wrap; }
  .garmin-stat { flex: 1; min-width: 70px; background: var(--surface2); border-radius: 12px; padding: 10px 8px; text-align: center; border: 1px solid var(--border); }
  .garmin-stat-val { font-size: 16px; font-weight: 700; color: var(--text); }
  .garmin-stat-lbl { font-size: 9px; font-weight: 700; color: var(--text3); text-transform: uppercase; letter-spacing: 0.5px; margin-top: 2px; }
  .macro-adj-banner { background: var(--green-soft); border: 1.5px solid #166534; border-radius: 12px; padding: 10px 14px; margin-top: 10px; font-size: 12px; color: #4ade80; font-weight: 600; display: flex; align-items: center; gap: 8px; }
  .settings-btn { background: none; border: none; font-size: 22px; cursor: pointer; padding: 4px; line-height: 1; }
  .settings-section { margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid var(--border); }
  .settings-section:last-child { border-bottom: none; margin-bottom: 0; }
  .settings-section-title { font-size: 11px; font-weight: 700; color: var(--text3); letter-spacing: 1.5px; text-transform: uppercase; margin-bottom: 12px; }
  .settings-row { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid var(--border); }
  .settings-row:last-child { border-bottom: none; }
  .settings-row-label { font-size: 14px; font-weight: 600; color: var(--text); }
  .settings-row-sub { font-size: 11px; color: var(--text3); margin-top: 2px; font-weight: 400; }
  .toggle { width: 44px; height: 26px; border-radius: 13px; background: var(--border); border: none; cursor: pointer; position: relative; transition: background 0.2s; flex-shrink: 0; }
  .toggle.on { background: var(--green); }
  .toggle::after { content:''; position:absolute; width:20px; height:20px; border-radius:50%; background:#fff; top:3px; left:3px; transition: left 0.2s; box-shadow: 0 1px 4px rgba(0,0,0,0.2); }
  .toggle.on::after { left: 21px; }
  .btn-red { width: 100%; padding: 13px; background: var(--red-soft); color: var(--red); font-family: inherit; font-weight: 700; font-size: 14px; border: 1.5px solid #7f1d1d; border-radius: 16px; cursor: pointer; margin-top: 8px; }
  .oauth-step { display: flex; gap: 12px; align-items: flex-start; padding: 10px 0; border-bottom: 1px solid var(--border); }
  .oauth-step:last-child { border-bottom: none; padding-bottom: 0; }
  .step-num { width: 24px; height: 24px; border-radius: 50%; background: var(--blue); color: #fff; font-size: 11px; font-weight: 700; display: flex; align-items: center; justify-content: center; flex-shrink: 0; margin-top: 1px; }
  .oauth-step-text { font-size: 13px; color: var(--text); line-height: 1.6; flex: 1; }
  .oauth-step-text a { color: var(--blue); font-weight: 600; }
  .key-input-group { margin-bottom: 10px; }
  .key-input-label { font-size: 11px; font-weight: 700; color: var(--text2); margin-bottom: 5px; letter-spacing: 0.5px; }
  .connect-status { display: flex; align-items: center; gap: 8px; padding: 10px 14px; border-radius: 12px; font-size: 13px; font-weight: 600; margin-bottom: 12px; }
  .connect-status.connected { background: var(--green-soft); color: #4ade80; border: 1.5px solid #166534; }
  .connect-status.disconnected { background: var(--surface2); color: var(--text3); border: 1.5px solid var(--border); }
  .meal-time-label { font-size: 11px; font-weight: 700; letter-spacing: 1px; text-transform: uppercase; color: var(--text3); margin-bottom: 10px; display: flex; align-items: center; gap: 6px; }
  .meal-time-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--amber); }
  .quick-foods-scroll { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 4px; margin-bottom: 4px; }
  .quick-food-chip { flex-shrink: 0; background: var(--surface2); border: 1.5px solid var(--border); border-radius: 14px; padding: 10px 12px; cursor: pointer; transition: all 0.15s; max-width: 160px; }
  .quick-food-chip:active { background: var(--green-soft); border-color: var(--green); }
  .qfc-name { font-size: 12px; font-weight: 700; color: var(--text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .qfc-cal { font-size: 11px; color: var(--text3); font-weight: 500; margin-top: 2px; }
  .qfc-delete { font-size: 10px; color: var(--red); margin-top: 4px; cursor: pointer; font-weight: 600; }

  /* Saved foods bottom sheet */
  .save-food-row { display: flex; align-items: center; gap: 10px; margin-top: 12px; }
  .save-name-input { flex: 1; }
  .btn-save-food { padding: 11px 16px; background: var(--amber-soft); color: #f59e0b; border: 1.5px solid #3d2e00; border-radius: 14px; font-family: inherit; font-weight: 700; font-size: 13px; cursor: pointer; white-space: nowrap; }
  .time-slot-picker { display: flex; gap: 6px; flex-wrap: wrap; margin-top: 10px; }
  .ts-btn { padding: 6px 12px; border-radius: 20px; border: 1.5px solid var(--border); background: var(--surface2); font-family: inherit; font-size: 11px; font-weight: 700; color: var(--text2); cursor: pointer; transition: all 0.15s; }
  .ts-btn.active { background: var(--amber-soft); border-color: #3d2e00; color: #f59e0b; }
  .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 200; align-items: flex-end; justify-content: center; backdrop-filter: blur(4px); }
  .modal-overlay.open { display: flex; }
  .modal-sheet { background: var(--surface); border-radius: 28px 28px 0 0; width: 100%; max-width: 600px; padding: 24px 20px 40px; max-height: 90vh; overflow-y: auto; animation: slideUp 0.3s ease; }
  @keyframes slideUp { from { transform: translateY(100%); opacity:0; } to { transform: translateY(0); opacity:1; } }
  .modal-handle { width: 40px; height: 4px; background: var(--border); border-radius: 4px; margin: 0 auto 20px; }
  .modal-title { font-size: 18px; font-weight: 700; color: var(--text); margin-bottom: 4px; }
  .modal-sub { font-size: 12px; color: var(--text3); font-weight: 500; margin-bottom: 20px; }
  #scanner-video { width: 100%; border-radius: 18px; background: #000; aspect-ratio: 4/3; object-fit: cover; }
  .scanner-frame { position: relative; margin-bottom: 16px; }
  .scanner-overlay { position: absolute; inset: 0; border-radius: 18px; overflow: hidden; pointer-events: none; }
  .scanner-line { position: absolute; left: 10%; right: 10%; height: 2px; background: linear-gradient(90deg, transparent, #22c55e, transparent); animation: scanLine 2s ease-in-out infinite; top: 50%; }
  @keyframes spinPulse { 0%,100%{transform:scale(1) rotate(0deg);opacity:1} 50%{transform:scale(1.2) rotate(20deg);opacity:0.7} }
  .spin-pulse { display:inline-block; animation: spinPulse 1.2s ease-in-out infinite; }
  .search-result-item { display:flex; align-items:center; gap:10px; padding:11px 14px; border-radius:14px; border:1.5px solid var(--border); background:var(--surface2); margin-bottom:8px; cursor:pointer; transition:all 0.15s; }
  .search-result-item:active, .search-result-item:hover { border-color:var(--green); background:var(--green-soft); }
  .search-result-name { font-size:13px; font-weight:700; color:var(--text); }
  .search-result-macros { font-size:11px; color:var(--text3); margin-top:2px; font-weight:500; }
  .search-result-arrow { font-size:16px; color:var(--text3); margin-left:auto; flex-shrink:0; }
  .scanner-corners::before, .scanner-corners::after { content:''; position:absolute; width:28px; height:28px; border-color:#22c55e; border-style:solid; }
  .scanner-corners::before { top:12px; left:12px; border-width:3px 0 0 3px; border-radius:4px 0 0 0; }
  .scanner-corners::after { bottom:12px; right:12px; border-width:0 3px 3px 0; border-radius:0 0 4px 0; }
  .food-result { background: var(--surface2); border-radius: 18px; padding: 16px; margin-bottom: 16px; border: 1.5px solid var(--border); }
  .food-name { font-size: 16px; font-weight: 700; color: var(--text); margin-bottom: 4px; }
  .food-brand { font-size: 12px; color: var(--text3); font-weight: 500; margin-bottom: 14px; }
  .food-macros { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 16px; }
  .food-macro-chip { background: var(--surface); border-radius: 12px; padding: 10px 6px; text-align: center; border: 1px solid var(--border); }
  .food-macro-chip-val { font-size: 15px; font-weight: 700; color: var(--text); }
  .food-macro-chip-lbl { font-size: 9px; font-weight: 700; color: var(--text3); text-transform: uppercase; letter-spacing: 0.5px; margin-top: 2px; }
  .servings-row { display: flex; align-items: center; gap: 12px; background: var(--surface); border-radius: 14px; padding: 10px 14px; border: 1.5px solid var(--border); }
  .servings-label { font-size: 13px; font-weight: 600; color: var(--text); flex: 1; }
  .servings-ctrl { display: flex; align-items: center; gap: 10px; }
  .srv-btn { width: 32px; height: 32px; border-radius: 50%; background: var(--surface2); border: 1.5px solid var(--border); font-size: 18px; font-weight: 700; color: var(--text); cursor: pointer; display: flex; align-items: center; justify-content: center; line-height: 1; transition: background 0.15s; }
  .srv-btn:active { background: var(--green-soft); }
  .srv-val { font-size: 17px; font-weight: 700; color: var(--text); min-width: 36px; text-align: center; }
  .scan-status { text-align: center; padding: 12px; font-size: 13px; color: var(--text2); font-weight: 500; }
  .btn-outline { width: 100%; padding: 13px; background: transparent; color: var(--text2); font-family: inherit; font-weight: 600; font-size: 14px; border: 1.5px solid var(--border); border-radius: 16px; cursor: pointer; margin-top: 10px; }
  .btn-scan { display: flex; align-items: center; justify-content: center; gap: 8px; padding: 13px 20px; background: var(--surface2); color: var(--text); font-family: inherit; font-weight: 700; font-size: 14px; border: 1.5px solid var(--border); border-radius: 16px; cursor: pointer; width: 100%; margin-bottom: 10px; transition: background 0.15s; }
  .btn-scan:active { background: var(--green-soft); }

  /* Weight trend & adaptive macros */
  .weight-card { background: linear-gradient(135deg, #0a1f12, #0a1525); border: 1.5px solid #1a3a25; border-radius: 20px; padding: 16px; margin-bottom: 14px; }
  .weight-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px; }
  .weight-stat { text-align: right; }
  .weight-stat-val { font-size: 22px; font-weight: 700; color: var(--text); letter-spacing: -0.5px; }
  .weight-stat-lbl { font-size: 10px; font-weight: 700; color: var(--text3); text-transform: uppercase; letter-spacing: 0.5px; }
  .weight-chart { width: 100%; height: 60px; }
  .weight-badges { display: flex; gap: 6px; margin-top: 10px; flex-wrap: wrap; }
  .weight-badge { padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 700; }
  .weight-badge.on-track  { background: #0d2d1a; color: #22c55e; }
  .weight-badge.too-slow  { background: #2d1f05; color: #f59e0b; }
  .weight-badge.too-fast  { background: #2d0f0f; color: #f87171; }
  .weight-badge.neutral   { background: var(--surface2); color: var(--text2); }
  .adaptive-banner { background: #0d1e3d; border: 1.5px solid #1e3a5f; border-radius: 12px; padding: 10px 14px; margin-top: 10px; font-size: 12px; color: #60a5fa; font-weight: 600; line-height: 1.6; display: flex; gap: 8px; align-items: flex-start; }
  .log-weight-btn { background: none; border: 1.5px solid var(--green); color: var(--green); border-radius: 20px; padding: 5px 14px; font-size: 11px; font-weight: 700; font-family: inherit; cursor: pointer; white-space: nowrap; }
  /* Copy yesterday */
  .copy-yesterday-btn { display: flex; align-items: center; justify-content: center; gap: 6px; width: 100%; padding: 11px; background: var(--blue-soft); color: #60a5fa; border: 1.5px solid #1e3a5f; border-radius: 14px; font-family: inherit; font-weight: 700; font-size: 13px; cursor: pointer; margin-bottom: 10px; transition: background 0.15s; }
  .copy-yesterday-btn:active { background: #1e3a5f; }
  /* Weight check-in modal */
  .big-input { font-size: 36px; font-weight: 700; text-align: center; padding: 16px; border-radius: 18px; letter-spacing: -1px; }
  .log-entry { display:flex; align-items:center; gap:10px; padding:10px 0; border-bottom:1px solid var(--border); }
  .log-entry:last-child { border-bottom:none; }
  .log-entry-icon { width:36px; height:36px; border-radius:12px; background:var(--surface2); display:flex; align-items:center; justify-content:center; font-size:16px; flex-shrink:0; }
  .log-entry-info { flex:1; min-width:0; }
  .log-entry-name { font-size:13px; font-weight:700; color:var(--text); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .log-entry-macros { font-size:11px; color:var(--text3); margin-top:2px; font-weight:500; }
  .log-entry-time { font-size:10px; color:var(--text3); font-weight:500; margin-top:1px; }
  .log-entry-actions { display:flex; gap:6px; flex-shrink:0; }
  .log-action-btn { width:30px; height:30px; border-radius:10px; border:1.5px solid var(--border); background:var(--surface2); font-size:14px; cursor:pointer; display:flex; align-items:center; justify-content:center; transition:all 0.15s; }
  .log-action-btn:active { transform:scale(0.92); }
  .log-action-btn.edit { color:var(--blue); border-color:#1e3a5f; background:var(--blue-soft); }
  .log-action-btn.del  { color:var(--red);  border-color:#7f1d1d; background:var(--red-soft); }
  .log-total-row { display:flex; justify-content:space-between; align-items:center; padding:10px 0 0; margin-top:4px; border-top:2px solid var(--border); }
  /* Usual Foods tile */
  .uf-row { display:flex; align-items:center; gap:10px; padding:9px 0; border-bottom:1px solid var(--border); }
  .uf-row:last-child { border-bottom:none; padding-bottom:0; }
  .uf-icon { font-size:22px; flex-shrink:0; width:32px; text-align:center; }
  .uf-info { flex:1; min-width:0; }
  .uf-name { font-size:13px; font-weight:700; color:var(--text); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .uf-macros { font-size:11px; color:var(--text3); font-weight:500; margin-top:1px; }
  .uf-badge { font-size:9px; font-weight:700; color:#f97316; background:#2d1a0e; border:1px solid #3d2e00; border-radius:8px; padding:2px 6px; flex-shrink:0; }
  .uf-stepper { display:none; align-items:center; gap:6px; flex-shrink:0; }
  .uf-stepper.active { display:flex; }
  .uf-step-btn { width:28px; height:28px; border-radius:8px; border:1.5px solid var(--border); background:var(--surface2); color:var(--text); font-size:16px; font-weight:700; cursor:pointer; display:flex; align-items:center; justify-content:center; line-height:1; transition:all 0.15s; }
  .uf-step-btn:active { background:var(--green-soft); border-color:var(--green); }
  .uf-step-val { font-size:13px; font-weight:800; color:var(--text); min-width:18px; text-align:center; }
  .uf-add-btn { flex-shrink:0; padding:6px 12px; background:var(--green-soft); border:1.5px solid var(--green); border-radius:10px; color:#4ade80; font-size:11px; font-weight:700; cursor:pointer; transition:all 0.15s; }
  .uf-add-btn:active { background:var(--green); color:#fff; }
  .uf-tap-btn { flex-shrink:0; padding:6px 12px; background:var(--surface2); border:1.5px solid var(--border); border-radius:10px; color:var(--text2); font-size:11px; font-weight:700; cursor:pointer; transition:all 0.15s; }
  .uf-tap-btn:active { background:var(--surface); }
  .uf-repeat-row { display:flex; align-items:center; gap:10px; padding:6px 0; }
  .uf-repeat-row:not(:last-child) { border-bottom:1px solid rgba(74,222,128,0.15); }
  .log-total-label { font-size:12px; font-weight:700; color:var(--text2); text-transform:uppercase; letter-spacing:0.8px; }
  .log-total-macros { font-size:12px; font-weight:700; color:var(--text); }

  /* Edit entry modal */
  .edit-macro-grid { display:grid; grid-template-columns:1fr 1fr; gap:10px; margin:14px 0; }
  .edit-macro-field label { font-size:10px; font-weight:700; color:var(--text2); letter-spacing:1px; text-transform:uppercase; display:block; margin-bottom:5px; }
</style>
<link rel="icon" type="image/png" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMAAAADACAYAAABS3GwHAAAIVElEQVR4nO3d228cZxnH8d/M7MG7a8dOYq9LSJuT4gYq0tJKVStFRAgE4hLxJ/AnRFwjuEUREveIy3LDHXcVV1RcIEFFD1LVqgWpIqUmaurE58MuFxsXe3e93pl533fG83w/UlTFbj0j+/nO+84e3EgF27nX7Rd9DihO8/5qVOTxgx+cgcckoYMIcjCGHlmEiMHrARh8uOAzBC9fmMGHDz5CcPoFGXyE4DIEJ1+IwUcRXIQQ5/0CDD+K4mL2cgXA8KNoeWcw0xLC4KOMsmyJUq8ADD/KKstspgqA4UfZpZ3RqZeMIod/bWu1qEMjh/lWt7BjT7sdmupfCj38DHw1hQ5imghqIU5kGgx99R39GRe5Ohx1aiE+r/4MPSS/MZy2Cky8CWb4EYLPWThthk+sw9fwM/iYxNdqcNJKkPulEGkw/DhN6BkZW4Xrqz+DjyxcrwbjVgHvKwDDj6xCzM5IAC6v/gw/8nI5Q+Nm29sKwPDDFZ+zdCwAV1d/hh+uuZqp4Rl3/kwwwz/w5oOWfvbX896P8+Mrm/r5t7/0fpwyWNtadX5j/NUK4OLqz/DDNxczdnTWgz4PAJSNswC4+iMUl7NWk/Jvfxj+4rz/H+k3f/7/3194RvrezeLOJ5S89wM797r95v3ViC0QTMsdAFd/FMXF7OUKgOFH0fLOYMwb3WHVzr1un3sAmJY5ALY/KIs8s8gKANMIAKZlCoDtD8om60yyAsA0AoBpBADTUgfA/h9llWU2WQFgGgHANAKAaQQA0wgAphEATCMAmEYAMI0AYBoBwDQCgGkEANMIAKYRAEwjAJhGADCNAGAaAcA0AoBpBADTCACmEQBMIwCYRgAwjQBgGgHANAKAaQQA0wgAphEATCMAmEYAMI0AYBoBwDQCgGkEANMIAKYRAEwjAJhGADCNAGAaAcA0AoBpBADTCACmEQBMIwCYRgAwjQBgGgHANAKAaQQA0wgAphEATCMAmEYAMI0AYBoBwDQCgGkEANMIAKYRAEwjAJhGADCNAGAaAcA0AoBpBADTCACmEQBMIwCYRgAwjQBgGgHANALwZL8X5jhx1A9zoIoiAE/2elGQ49REAHkQgCfre2ECSFgBciEATx7uJEGOUwvTWWURgCefbYYK4PjNRkwQqRCAJx89rgc5Tjs+HkCNn2gqfLs82NiP9M8ntSDHmo0Pjv2dANLh2+XB3x82dRDo3rQzHECYnVdlEIAHbz6YCXKcWH21hgKo8xNNhW+XYxv7kf70oBXkWOdr+xq+5+00gxy6MgjAsTc+6WhjP8xDMYu1vZGPzRFAKgTg0H+3E/3uw7lgx1tMdkc+RgDpEIAjvb70i7cXgl39JWlpaAWII6ndCHb4SiAAR379/jm99Xm4y287PtCFoQAudjRyT4DJwjxYXWEHfelX787r9590gh73ucb2yMeWZ4OeQiUQQA4fP6npl28v6B9fhN93jAugG+72ozIIIIMP1up64+OO/vhpO9gTXkfNxD1dqo/eAC8TQGoEcIJeX9rtRVrfi/XZVqJ/rdf03qO6/vJ5U59uFPttu9XcUDz0PoBOQ1oKuwurBAJ46qdvLepvD8v/EEqsvm7NbI58/PrFAk6mAngU6Iy53txWe+jlDxIBZEUAZ0gS9fVy+/HIx1t16fJC+POpAgI4Q27PrI+8/FmSvvU1KeEJgEwI4IyYiw90u7U+8vE4GgSAbAjgDIjV13fnvhj7BviVpcEjQMiGAM6AVzuPx77ysxZLr18Nfz5VQgAld7O5qW/ObIz93CuXefVnXgRQYtebW7oz++XYz52bkV55Nuz5VBEBlNS1xpbuzj4a++rOJJJ+dIs3wLvAM8El9FLriV5uPznx83eu87ofVwigROpRX3dnH419peehbyxLL14KeFIVRwAlcaWxrdc6ayO/5uSolSXp+ysBT8oAAijYXLKv19uPdXnCVV+Sbi5JP3yed3y5RgAFOZ/s6XZrXdeaW6c+EvHqc9JrV4KcljkEEFAS9fVsfUcrzc1Tr/iS1EikHzzPKz19IgDP6lFfy/UdXWts62pjS/Upf5//jYvSd27wRJdvqQOYb3W1trXq41wqYTY+0PnanpZru3qmvqvF2m6qJ1vmZ6S7N6SrF7ydYmXNt7qp/xtWgFPE6iuJpER9JdHgz0zUUzvuqRUfqBX31IkPtJDsayHZm/oKP+xiZ/DShpUlfsd/SATw1G/vPDz29z+8I/17ze8xk3hwpX9hmSt+UQggsHoifX1eurko3Vgc3OiiOJkC4D5genPNwfbm0rnB2xa7s2xxfMiy/5dYAVJLosHW5fBPLR68J7fdkDpP/znXlC60B3/qXOFLjQBO8JPbRZ8BQsj8gtqsSw7gWp5Z5BXlMC1u3l/llgwmNe+vRrlWALZBKFreGcy9BSICFMXF7HEPANNiabAXyvNFWAUQWt6ZO5x5ZysAESAUl7PGFgimfRWAi4dDWQXgm4sZOzrrzlcAIoAvPmbrWACunhQjArjmaqaGZ9zbPQARwBWfszQSgMuXRhAB8nI5Q+Nm2/ujQESArELMzolX+517Xef/C2jeRYZp+Bj8k3Y2QZ8HYDXAaULPyMT9vo9V4BCrAY7yOfiT7msnrgA+3yvAaoBDRQ2/NOUvG/a5EhxiRbAlxAVwmgt4ad4Uf/QbQgzVVMZVf+otTohV4CQEcTYVOfDTbt9T7fGLjACYVpp711QPg/IGepRd2hlN/TwAEaCsssxmrmFmS4QyyHNRzvVMMKsBipZ3BnO/FIIIUBQXs+d0eNkSIQSXF10vV29CgA8+dhtety+EABd8brOD7N8JAVmEuL8MfgNLDJgk9IMqhT+CQxC2Ff0o4v8APYf6bKG9Se0AAAAASUVORK5CYII=" />
<link rel="apple-touch-icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAALQAAAC0CAYAAAA9zQYyAAAHzElEQVR4nO3dz28bZR7H8c/M+HecJi2R0x8BCrTdFhAICe2u2G4lql0JiQv8DxwRlx6Q+B964c6J6+5qj3vYvSGtVgIJAeKAkPghtIIIbZumbeokjvdguUricTzjeZ5n7K/fr0sV1/VMnXe/fmY8cSOVqHur0y9z+/CjfnszKmvbwTZMvIstVOReN0LESOMzbi8PTMjIwkfYTh+QkDENl2E7eSBChgsuwo6LPgAxwxUXLRUKmpjhWtGmphrxhIwQplmC5J7QxIxQpmktV9DEjNDyNpd5pIeOeWtnM+TmkNNKsxN0e1mXH5nuFCJmAp5vIQLPEvXEO/iMmYht8hn3pKgr3rZ8AkK2bfj9Db0skSZMaNfTmZAXk+uwT5rSY89yEDNccf29P6nN1NJdxkzIOMzltE6b1IWv5TgJMeM4302MBO1qOhMzxnHVRlqrXiY0MWMSX40cCdrFdCZmZOWilePNOp3QxIy8XDfz+Cix6HRe5Ji/267o7X/5fRPhn2/8rLXGgddtlKno2Y/hGQ8nE3qRY4YbrhryetoOCC2Wii03mM5wpUhLw4YLXZxEzOF89B+peej19J3fSa1aefvjy9bOZqH1NEsOmDJ10Exn+FKkLSY0TImnOSBkOsO3aRrr3ur0mdAwhaBhSu6gWW4glGlaY0LDFIKGKQQNU3IFzfoZoeVtjgkNUwgaphA0TCFomELQMIWgYQpBwxSChikEDVMIGqYQNEwhaJhC0DCFoGEKQcMUgoYpBA1TCBqmEDRMIWiYQtAwhaBhCkHDFIKGKQQNUwgaphA0TCFomELQMIWgYQpBwxSChikEDVMIGqYQNEwhaJhC0DCFoGEKQcMUgoYpBA1TCBqmEDRMIWiYQtAwhaBhCkHDFIKGKQQNUwgaphA0TCFomELQMIWgYQpBwxSChikEDVMIGqYQNEwhaJhC0DCFoGEKQcMUgoYpBA1TCBqmEDRMIWiYQtAwhaAd6PX9byPyvwkTCNqB7T3/T2MSBfhXYwBBOxAi6ApBZ0LQDmzv+V0QxOqz5MiIoB34eSfx+vjVlOkcUXgqgnbgyzs1r4/fig9GbqvwnUvF0+LAV56DXop7I7cRdDqeloJ+vF/Rr4/8Po1LydGg44glxzgEXdBff2h530Y73j/yddXvkn2uEXQB3V6kvwcI+onK3pGv235XOHONoAv4y/ctbe36fwrXkmNB171vcm4R9JS+267ow69Ped9OO+6pcewsxzJBj0XQU+j2Ir3/6Wl1e/6PzNaruyO3LTe8b3ZuEXROD/YjvfvvM/pmqxpke0/VHo3c1mkH2fRcqpS9A/Pkqzs1ffDZqn68H+Zpi9XXRpWg8yDoDL6+W9XH37b1j5+aCnmJ0IVad+Rt7+W61Azz4jCXCPqQbi/Sw/1IvzxK9P12RV/eqemTX+r6IdBEPu5q/eHIbRdWStiRObKwQX/6a13vfPJE2bsx1qlkX0+mrJ+fmd1dngkcFM6o5xsPRm5LIunp0yXszBwh6Bl0KtnX1cbocuPJ01KNt71PRNAz6Lete4pTDj9fOlfCzswZgp4xG7VHqeeeV5vSxTMl7NCcIegZ0op7urF0N/X3Xj4fdl/mFUHPiFjS68t3Rq7bkAbT+UWWG5kQ9Iz4Q/uu1iuj121I0vVnBmc4MBlBz4DXlrZ0OeVNFGmwbn6Wc8+ZLewbK7MgVl+vtbd0ZUzM7Zr05yuBd2rOEXRJmvGBbi7/b+wyI46kN65x3UZeBF2CjWpX19t31Ur5ae6hm5el8/5/fsAcgg6oFff0+6V7uljbOfF+Ny9Jz68H2iljCDqAZnygFxr3da3xIPVTkIbiSHr9kvTC2YA7ZwxBe3Qm2dPVxkNdrj+c+OmhrZr05jXpHMuMQgjasZVkXxdrO3quvqPVZH/yH9DgCro/XZGW+HiCwgi6gFiDK+M6lV2drXZ1rrqb+rFd47Rr0o3npEtr/vZx0eQKeqXZ0dbOpq99mQmx+kqi4a99VaO+GtGBmnFPzfhArfhAp5J9rSZ7Wkl6qVfFTdKqSa9cGFw9x6cgnWyl2cl1/4Wd0K+udfX5W/99/PVPW9LfvvC7zbWlQcTX1qWE92i9WNigQ1ltSpfXpN90pDP+PzVs4RG0Q3E0CPjssrSxKm2s8LFdoeUOehHW0YfF0WB5kMRSJZIqidSqDtbBrdrgzMRqYzB9T7cG94cbedfPEhP6sY0V6b0/lr0XKIpDE5gS129v5n6RnOalAMhjmsbqtzcjJjRMmTpopjR8KdIWExqmFAqaKQ3XijYVS4PFdFk7AAwVaWnYMEsOmOIkaKY0inLV0OOgiyw7JKLG9Iq2c7hdp0sOokZerps5EnTRKS0RNbJz0crxZr0cFBI1JvHVyEjQLqa0RNQYz1Ubaa16PW1H1DjOdxNjp3H3Vsfpf8m3SD8UgFGuQx63khg7oV0tPYaY1osrVMzSCRN6yPWklpjWi8LHEJs0aEv5EazhX5SwbSrz1TjTssLHlD6OuOdbiIizLIMzr5NDRH0Ygc+20FM46zFdrgO/0FEDUr4TFLnOQ7s+8wFMkre53G+sEDVCmaa1QnGyBIEPRYZmobe+mdZwrWhTha/lIGq44qIlpzGyBME0XA5FL9OVsJGFj1d3r8sFwkYan8vUYOtf4l5soY61Sj2gI3KbyjxR8H/xwNiHyraAfgAAAABJRU5ErkJggg==" />
<link rel="manifest" href="data:application/json;base64,eyJuYW1lIjogIkplcmVteSdzIE1hY3JvIEFwcGxpY2F0aW9uIiwgInNob3J0X25hbWUiOiAiSmVyZW15TWFjcm8iLCAiaWNvbnMiOiBbeyJzcmMiOiAiZGF0YTppbWFnZS9wbmc7YmFzZTY0LGlWQk9SdzBLR2dvQUFBQU5TVWhFVWdBQUFNQUFBQURBQ0FZQUFBQlMzR3dIQUFBSVZFbEVRVlI0bk8zZDIyOGNaeG5IOGQvTTdNRzdhOGRPWXE5TFNKdVQ0Z1lxMHRKS1ZTdEZSQWdFNGhMeEovQW5SRndqdUVVUkV2ZUl5M0xESFhjVlYxUmNJRUZGRDFMVnFnV3BJcVVtYXVyRTU4TXVGeHNYZTNlOTNwbDUzM2ZHODN3L1VsVEZiajBqKy9uTys4NGUzRWdGMjduWDdSZDlEaWhPOC81cVZPVHhneCtjZ2Nja29ZTUljakNHSGxtRWlNSHJBUmg4dU9BekJDOWZtTUdIRHo1Q2NQb0ZHWHlFNERJRUoxK0l3VWNSWElRUTUvMENERCtLNG1MMmNnWEE4S05vZVdjdzB4TEM0S09Nc215SlVxOEFERC9LS3N0c3BncUE0VWZacFozUnFaZU1Jb2QvYld1MXFFTWpoL2xXdDdCalQ3c2RtdXBmQ2ozOERIdzFoUTVpbWdocUlVNWtHZ3g5OVIzOUdSZTVPaHgxYWlFK3IvNE1QU1MvTVp5MkNreThDV2I0RVlMUFdUaHRoaytzdzlmd00vaVl4TmRxY05KS2tQdWxFR2t3L0RoTjZCa1pXNFhycXorRGp5eGNyd2JqVmdIdkt3RERqNnhDek01SUFDNnYvZ3cvOG5JNVErTm0yOXNLd1BEREZaK3pkQ3dBVjFkL2hoK3V1WnFwNFJsMy9rd3d3ei93NW9PV2Z2Ylg4OTZQOCtNcm0vcjV0Ny8wZnB3eVdOdGFkWDVqL05VSzRPTHF6L0RETnhjemRuVFdnejRQQUpTTnN3QzQraU1VbDdOV2svSnZmeGorNHJ6L0grazNmLzcvMzE5NFJ2cmV6ZUxPSjVTODl3TTc5N3I5NXYzVmlDMFFUTXNkQUZkL0ZNWEY3T1VLZ09GSDBmTE9ZTXdiM1dIVnpyMXVuM3NBbUpZNUFMWS9LSXM4czhnS0FOTUlBS1psQ29EdEQ4b202MHl5QXNBMEFvQnBCQURUVWdmQS9oOWxsV1UyV1FGZ0dnSEFOQUtBYVFRQTB3Z0FwaEVBVENNQW1FWUFNSTBBWUJvQndEUUNnR2tFQU5NSUFLWVJBRXdqQUpoR0FEQ05BR0FhQWNBMEFvQnBCQURUQ0FDbUVRQk1Jd0NZUmdBd2pRQmdHZ0hBTkFLQWFRUUEwd2dBcGhFQVRDTUFtRVlBTUkwQVlCb0J3RFFDZ0drRUFOTUlBS1lSQUV3akFKaEdBRENOQUdBYUFjQTBBb0JwQkFEVENBQ21FUUJNSXdDWVJnQXdqUUJnR2dIQU5BS0FhUVFBMHdnQXBoRUFUQ01BbUVZQU1JMEFZQm9Cd0RRQ2dHa0VBTk1JQUtZUkFFd2pBSmhHQURDTkFHQWFBY0EwQW9CcEJBRFRDQUNtRVFCTUl3Q1lSZ0F3alFCZ0dnSEFOQUx3Wkw4WDVqaHgxQTl6b0lvaUFFLzJlbEdRNDlSRUFIa1FnQ2ZyZTJFQ1NGZ0JjaUVBVHg3dUpFR09Vd3ZUV1dVUmdDZWZiWVlLNFBqTlJrd1FxUkNBSng4OXJnYzVUanMrSGtDTm4yZ3FmTHM4Mk5pUDlNOG50U0RIbW8wUGp2MmRBTkxoMitYQjN4ODJkUkRvM3JRekhFQ1luVmRsRUlBSGJ6NllDWEtjV0gyMWhnS284eE5OaFcrWFl4djdrZjcwb0JYa1dPZHIreHErNSswMGd4eTZNZ2pBc1RjKzZXaGpQOHhETVl1MXZaR1B6UkZBS2dUZzBIKzNFLzN1dzdsZ3gxdE1ka2MrUmdEcEVJQWp2YjcwaTdjWGdsMzlKV2xwYUFXSUk2bmRDSGI0U2lBQVIzNzkvam05OVhtNHkyODdQdENGb1FBdWRqUnlUNERKd2p4WVhXRUhmZWxYNzg3cjk1OTBnaDczdWNiMnlNZVdaNE9lUWlVUVFBNGZQNm5wbDI4djZCOWZoTjkzakF1Z0crNzJveklJSUlNUDF1cDY0K09PL3ZocE85Z1RYa2ZOeEQxZHFvL2VBQzhUUUdvRWNJSmVYOXJ0UlZyZmkvWFpWcUovcmRmMDNxTzYvdko1VTU5dUZQdHR1OVhjVUR6MFBvQk9RMW9LdXd1ckJBSjQ2cWR2TGVwdkQ4di9FRXFzdm03TmJJNTgvUHJGQWs2bUFuZ1U2SXk1M3R4V2UramxEeElCWkVVQVowZ1M5ZlZ5Ky9ISXgxdDE2ZkpDK1BPcEFnSTRRMjdQckkrOC9GbVN2dlUxS2VFSmdFd0k0SXlZaXc5MHU3VSs4dkU0R2dTQWJBamdESWpWMTNmbnZoajdCdmlWcGNFalFNaUdBTTZBVnp1UHg3N3lzeFpMcjE4TmZ6NVZRZ0FsZDdPNXFXL09iSXo5M0N1WGVmVm5YZ1JRWXRlYlc3b3orK1hZejUyYmtWNTVOdXo1VkJFQmxOUzF4cGJ1emo0YSsrck9KSkorZElzM3dMdkFNOEVsOUZMcmlWNXVQem54ODNldTg3b2ZWd2lnUk9wUlgzZG5INDE5cGVlaGJ5eExMMTRLZUZJVlJ3QWxjYVd4cmRjNmF5Ty81dVNvbFNYcCt5c0JUOG9BQWlqWVhMS3YxOXVQZFhuQ1ZWK1NiaTVKUDN5ZWQzeTVSZ0FGT1ovczZYWnJYZGVhVzZjK0V2SHFjOUpyVjRLY2xqa0VFRkFTOWZWc2ZVY3J6YzFUci9pUzFFaWtIenpQS3oxOUlnRFA2bEZmeS9VZFhXdHM2MnBqUy9VcGY1Ly9qWXZTZDI3d1JKZHZxUU9ZYjNXMXRyWHE0MXdxWVRZKzBQbmFucFpydTNxbXZxdkYybTZxSjF2bVo2UzdONlNyRjd5ZFltWE50N3FwL3h0V2dGUEU2aXVKcEVSOUpkSGd6MHpVVXp2dXFSVWZxQlgzMUlrUHRKRHNheUhabS9vS1AreGlaL0RTaHBVbGZzZC9TQVR3MUcvdlBEejI5eis4SS8xN3plOHhrM2h3cFg5aG1TdCtVUWdnc0hvaWZYMWV1cmtvM1ZnYzNPaWlPSmtDNEQ1Z2VuUE53ZmJtMHJuQjJ4YTdzMnh4Zk1peS81ZFlBVkpMb3NIVzVmQlBMUjY4SjdmZGtEcFAvem5YbEM2MEIzL3FYT0ZMalFCTzhKUGJSWjhCUXNqOGd0cXNTdzdnV3A1WjVCWGxNQzF1M2wvbGxnd21OZSt2UnJsV0FMWkJLRnJlR2N5OUJTSUNGTVhGN0hFUEFOTmlhYkFYeXZORldBVVFXdDZaTzV4NVp5c0FFU0FVbDdQR0ZnaW1mUldBaTRkRFdRWGdtNHNaT3pycnpsY0FJb0F2UG1icldBQ3VuaFFqQXJqbWFxYUdaOXpiUFFBUndCV2ZzelFTZ011WFJoQUI4bkk1UStObTIvdWpRRVNBckVMTXpvbFgrNTE3WGVmL0MyamVSWVpwK0JqOGszWTJRWjhIWURYQWFVTFB5TVQ5dm85VjRCQ3JBWTd5T2ZpVDdtc25yZ0ErM3l2QWFvQkRSUTIvTk9VdkcvYTVFaHhpUmJBbHhBVndtZ3Q0YWQ0VWYvUWJRZ3pWVk1aVmYrb3RUb2hWNENRRWNUWVZPZkRUYnQ5VDdmR0xqQUNZVnBwNzExUVBnL0lHZXBSZDJobE4vVHdBRWFDc3NzeG1ybUZtUzRReXlITlJ6dlZNTUtzQmlwWjNCbk8vRklJSVVCUVhzK2QwZU5rU0lRU1hGMTB2VjI5Q2dBOCtkaHRldHkrRUFCZDhick9EN044SkFWbUV1TDhNZmdOTERKZ2s5SU1xaFQrQ1F4QzJGZjBvNHY4QVBZZjZiS0c5U2UwQUFBQUFTVVZPUks1Q1lJST0iLCAic2l6ZXMiOiAiMTkyeDE5MiIsICJ0eXBlIjogImltYWdlL3BuZyJ9LCB7InNyYyI6ICJkYXRhOmltYWdlL3BuZztiYXNlNjQsaVZCT1J3MEtHZ29BQUFBTlNVaEVVZ0FBQWdBQUFBSUFDQVlBQUFEMGVOVDZBQUFaWmtsRVFWUjRuTzNkeTQ5azUzblk0YmN1WFgyZm5odG5TQTZ2RWltS3BFUkxrU1VpbG9RNHRtellRSkkvSWRzRTlpYUFzdkU2bTJ5MENSTEE4TUpBTnQ0RThNTE9CUUVDSkhEZ0JCWUVJM0RnV0Zia3lMSnNpeVlwa1hQalRNK2xPNHRpV3owemZhdXFjK3A4MzNtZkJ5QkdDM1gxNlZQZDUvM1ZkMDZkR2dSTHRmdjFLL3RkYndOQWlWYS84ZTZnNjIzSXhNNXVnU0VQMEN4eDBEdzdkRUdHUFVBM1JNRmk3THdaR2ZnQVpSSUVzN0d6enNEUUI2aUxHRGlkSFhRRUF4K2dYd1RCayt5UVF3eCtnSDRUQWorUmZrY1krZ0E1WlkrQnREKzh3UTlBUk40UVNQZERHL3dBSENWYkNLVDRZUTE5QUdhUklRWjYvUU1hL0FBc29zOGhNT3g2QTlwaStBT3dxRDdQa3Q2VlRaK2ZMQUM2MDdmVmdONzhNQVkvQU12UWx4Q28vb2N3K0FIb1F1MGhVUFUxQUlZL0FGMnBmUVpWV1MrMTczUUErcVhHMVlEcVZnQU1md0JLVStOc3Fpb0FhdHpCQU9SUTI0eXFZc21pdHAwS1FHNDFuQklvZmdYQThBZWdOalhNcnFJRG9JWWRDQUJIS1gyR0ZibEVVZnBPQTRCWmxIaEtvTGdWQU1NZmdMNHBjYllWRlFBbDdpQUFhRUpwTTY2WUFDaHR4d0JBMDBxYWRVVUVRRWs3QkFEYVZNck02endBU3RrUkFMQXNKY3krVGdPZ2hCMEFBRjNvZWdaMkZnQmQvK0FBMExVdVoyRW5BV0Q0QThCVVZ6Tng2VGNtTVB5WDcvcWRkN3ZlQktBeU8rdFh1dDZFZEpaOXM2Q2xmalBEdngwR1BMQnNBcUVkeTR5QXBYMGp3Nzg1Qmo1UUdrSFFuR1ZGd0ZLK2llRy9HQU1mcUkwZ1dNd3lJcUQxYjJENHo4N0FCL3BHRU15dTdRaG85Y0VOLzdNejlJRXN4TURadFJrQjQ3WWVtTk1aK2tCR2g0OTlZcUE3clpXRlYvL0hNL2dCSGlVRWp0ZldLa0FyRDJyNEg4M2dCemlaRURoYUd4SFErQU1hL284eTlBSG1Jd1llMVhRRXVBYWdKUVkvd0dJT2pxTkNvQjJOMW9SWC93WS9RRnVFUUxPckFJMTlHSkRoYi9nRHRNa3h0dGxaMjBoSlpCLytmaWtCbGl2N2FrQVRLd0d1QVZpQXdRL1FEZGNITEc3aFV3QlpYLzBiL2dEZHkzb3NibUwyTHJTRWtISDRaLzFsQXloZHh0V0FSVTRGTkhZUllBYUdQMEM1SEtObk0zYzVaSHIxNzVjS29DNlpWZ1BtWFFXd0FuQUt3eCtnUG83ZHA1c3JBTEs4K3ZjTEJGQ3ZMTWZ3ZVdleXR3RWVJY3N2RFVEZmVidmc4V1plQWVqN3EzL0RINkIvK241c24yYzJ6eFFBaGo4QXRlcjdNWDdXR2UwaXdJLzEvUmNEQU1mNnc4NGNBSDErOWU4WEFpQ1BQaC96WjVuVnFTOEM3UE12QVFESGMzRmc0bE1BaGo4QW1XZkJtUUtnYjh2L21aOXdBQjdWdDVsdzFwbWRiZ1dnYjA4MEFJdkxPQnRPRFlBK3ZmclArQVFEY0RaOW1oRm5tZDFwVmdENjlNUUMwSTVNcytMRUFPalRxMzhBeU9TMEdaN2liWUNaaW83KytLTWZUK0lmLzk3bHJqZWpLSlBoZm56ekgvMnc2ODJnNTY3ZmVUZkYyd043ZndyQThBZGdWaGxteDdFQjBJZmwvd3hQSUFEdDZNTU1PV21XOTNZRm9BOVBIQURkNnZNc09USUFhbi8xMytjbkRJRGxxbjJtSERmVGU3c0NBQUFjcjNjQlVIdXBBVkNlUHM2V1hnVkFINThnQU1yUXR4bnpSQURVZXY2L2IwOE1BT1dwZGRZY05kdDd0UUlBQUp4Tkx3S2cxaUlEb0Q1OW1UbVBCRUNOeS85OWVTSUFxRWVOcytmeEdaL2lzd0NBZm5pNEgvR3YvdnZaLy8ralljU3Zmcm05N1lHYVZYMEtvTVlDQTZBZmFwOUIxUVpBN1RzZWdQclZQSXYrTmdCcVBQOFBBSnpkNFZsZjVRcEF6Y1VGUUwvVU9wT3FEQUFBWURIVkJVQ3RwUVZBZjlVNG02b0tnQnAzTUFBNTFEYWpoaEV1QUFTQUxBNW1malVyQUxXVkZRRDUxRFNycWdrQUFLQTVWUVJBVFVVRlFHNjF6S3dxQWdBQWFKWUFBSUNFaWcrQVdwWlNBT0JBRGJOcjZDMkFBSkRMN3RldjdCZTlBbEJEUVFIQVVVcWZZVVVIQUFEUWptSURvUFJ5QW9EVGxEekxpZzBBQUtBOUFnQUFFaW95QUVwZU1nR0FXWlE2MDRvTUFBQ2dYUUlBQUJJcUxnQktYU29CZ0htVk9OdUtDd0FBb0gwQ0FBQVNFZ0FBa0ZCUkFWRGlPUklBYUVKcE02Nm9BQUFBbGtNQUFFQkNBZ0FBRWlvbUFFbzdOd0lBVFN0cDFoVVRBQURBOGdnQUFFaElBQUJBUWtVRVFFbm5SQUNnVGFYTXZDSUNBQUJZTGdFQUFBa0pBQUJJU0FBQVFFSUNBQUFTRWdBQWtKQUFBSUNFT2crQVV0NFBDUURMVXNMczZ6d0FBSURsRXdBQWtKQUFBSUNFQkFBQUpDUUFBQ0FoQVFBQUNRa0FBRWhJQUFCQVFnSUFBQklTQUFDUWtBQUFnSVFFQUFBa0pBQUFJQ0VCQUFBSkNRQUFTRWdBQUVCQ0FnQUFFaElBQUpDUUFBQ0FoQVFBQUNRa0FBQWdJUUVBQUFrSkFBQklTQUFBUUVJQ0FBQVNFZ0FBa0pBQUFJQ0VCQUFBSkNRQUFDQWhBUUFBQ1FrQUFFaElBQUJBUWdJQUFCSVNBQUNRa0FBQWdJUUVBQUFrSkFBQUlDRUJBQUFKQ1FBQVNFZ0FBRUJDQWdBQUVoSUFBSkNRQUFDQWhBUUFBQ1FrQUFBZ0lRRUFBQWtKQUFCSVNBQUFRRUlDQUFBU0VnQUFrSkFBQUlDRUJBQUFKQ1FBQUNBaEFRQUFDUWtBQUVoSUFBQkFRZ0lBQUJJU0FBQ1FrQUFBZ0lRRUFBQWtKQUFBSUNFQkFBQUpDUUFBU0VnQUFFQkNBZ0FBRWhJQUFKQ1FBQUNBaEFRQUFDUWtBQUFnSVFFQUFBa0pBQUJJU0FBQVFFSUNBQUFTRWdBQWtKQUFBSUNFQkFBQUpDUUFBQ0FoQVFBQUNRa0FBRWhJQUFCQVFnSUFBQklTQUFDUWtBQUFnSVFFQUFBa0pBQUFJQ0VCQUFBSkNRQUFTRWdBQUVCQ0FnQUFFaElBQUpDUUFBQ0FoQVFBQUNRa0FBQWdJUUVBQUFrSkFBQklTQUFBUUVJQ0FBQVNFZ0FBa0pBQUFJQ0VCQUFBSkNRQUFDQWhBUUFBQ1FrQUFFaElBQUJBUWdJQUFCSVNBQUNRa0FBQWdJUUVBQUFrSkFBQUlDRUJBQUFKQ1FBQVNFZ0FBRUJDQWdBQUVoSUFBSkNRQUFDQWhBUUFBQ1FrQUFBZ0lRRUFBQWtKQUFCSVNBQUFRRUlDQUFBU0VnQUFrSkFBQUlDRUJBQUFKQ1FBQUNBaEFRQUFDUWtBQUVoSUFBQkFRZ0lBQUJJU0FBQ1FrQUFBZ0lRRUFBQWtKQUFBSUNFQkFBQUpDUUFBU0VnQUFFQkNBZ0FBRWhJQUFKQ1FBQUNBaEFRQUFDUWtBQUFnSVFFQUFBa0pBQUJJU0FBQVFFSUNBQUFTRWdBQWtKQUFBSUNFQkFBQUpDUUFBQ0FoQVFBQUNRa0FBRWhJQUFCQVFnSUFBQklTQUFDUWtBQUFnSVFFQUFBa0pBQUFJQ0VCQUFBSkNRQUFTRWdBQUVCQ0FnQUFFaElBQUpDUUFBQ0FoQVFBQUNRa0FBQWdJUUVBQUFrSkFBQklTQUFBUUVJQ0FBQVNFZ0FBa0pBQUFJQ0VCQUFBSkNRQUFDQWhBUUFBQ1FrQUFFaElBQUJBUWdJQUFCSVNBQUNRa0FBQWdJUUVBQUFrSkFBQUlDRUJBQUFKQ1FBQVNFZ0FBRUJDQWdBQUVoSUFBSkNRQUlCQzNkc2JkTDBKeFhIQWd1YjRlNEpDN1Q3c2VndktNNHo5cmpjQmVrTUFRS0dzQUR4cFlKZEFZd1FBRkdyM29XbjNPQ3NBMEJ3QkFJV3lBdkFrQnl4b2pyOG5LTlR0QndMZ2NjT0JGUUJvaWdDQVFyMS9kOVQxSmhSbkxBQ2dNUUlBQ3ZYZVhYK2VqMXNSQU5BWVJ4Z29sQldBSjYwTTlycmVCT2dOQVFDRmV0OEt3Qk1tVmdDZ01ZNHdVS2gzclFBOHdTa0FhSTRBZ0FMOWVIY1lIOTd6NS9tNGlWTUEwQmhIR0NqUS83MngwdlVtRkdsdHhnQVllaWNsSEVzQVFJRytlMlBjOVNZVWFYMDQyd2NrQ0FBNG5nQ0FBbGtCT05yNjBBb0FORVVBUUlHK2MxMEFIRVVBUUhNRUFCVG01djFoZkZzQUhHbGo0QlFBTkVVQVFHRys5ZjRrOXJ6YjdRbkQySS9WR1ZjQVJvNXdjQ3gvSGxDWVAzaHZ0ZXROS05MVzZHSE0rb0orN0FnSHgvTG5BWVVSQUVmYm52RWRBQkVSRTIrbWdHTUpBQ2pJOTIrTjQzczNUYTJqYkk4ZXpQdzFFemRUaEdNSkFDakl2Ly9CZXRlYlVLeTVWZ0FFQUJ4TEFFQWg5aVBpUC94Z28rdk5LSllWQUdpV0FJQkMvT0g3ay9qcmoweXM0NXlmSndDY1RZRmpDUUFveEc5L2Y3UHJUU2pXYUxBZjUrWUlnQTIzVTRCakNRQW93Ri9lSHNWLytrdm4vNDl6ZnZSZ3JvUFZ4cVR4VFlIZUVBQlFnTi84enJhYi81emc0dWorWEY5bkJRQ09Kd0NnWSsvY0djWHZ1UHIvUkJmbVdQNlBzQUlBSnhFQTBMRi84eWZiOFdEUFRldFBjbWs4M3dyQXBnQ0FZd2tBNk5BMzMxdU4zLzBMYi8wN3lTQWlMby92emZ4MXcwSEVtbE1BY0N3QkFCM1pmVGlJZi9HL2RycmVqT0pkSE4rUGxjSHNGMGljVzR1WlB6c0FNaEVBMEpGZi8vWjIvT0MyTjZxZjVzb2NyLzRqcGdFQUhFOEFRQWQrNzUyMStMZmYzZXA2TTZvd2J3RHNDQUE0a1FDQUpmdmV6WEg4MnJjdWVOdmZHVjFkRVFEUUJnRUFTM1R6L2pEKzJSOWNqTnNQbkowK2k1M1JnOWlhNDBPQUlnUUFuRVlBd0pMY3ZEK01YL2tmRitQN3Q1ejNQNnRySzd0emYrMEZiNjZBRXprU3dSSjhlRzhZLy9UM0w4VzNyM3RmMml5ZW16TUFSc09JOCs2dEJDY1NBTkN5OSsrTzRwLzgvcVg0czV2KzNHWXhHdXpIMDNNR3dNV042WDBBZ09NNUlrR0x2dm5lYXZ6YXR5N0VqM2FkYlp2VjArTjdNWjdqL2Y4UkVaZDlzQ0tjU2dCQUMvYjJJMzdqVDdmak4vN1VoL3pNNjZYSm5ibS85cEx6LzNBcUFRQU4rODcxbGZpWGY3UVRmL2dqTjZLZjF6QWlYbHE5Ty9mWFgzR0xCVGlWQUlDR2ZIaHZHUC82LzJ6SGIzOS8wNnYrQlQyenNodXJnNzI1dm5Zd2lMaTYzZkFHUVE4SkFGalErM2RIOGUvK2ZDTis2ODgyNCtaOTUvcWI4UExxL012L2x6Y2pWa1lOYmd6MGxBQ0FPZjN4Qnl2eFcvOXZLLzd6WDYzNU9OOEdqUWI3OGVKay91WC9aODQxdURIUVl3SUF6bWcvSXY3M2p5ZngzOTVaaS8vNnc3WDRucmYxdGVLbHlkMjVsLzhqSXA2eC9BOW40Z2dHeDloOU9JanYzRmlKUC81Zyt0Ly9mRzgxM3I5cmJibHRyNjNlWHVqcm4vVUp5M0FtQW9CVTl2WWo3ajRjeE83RFFlenVEZUx1dzBIY3ZqK0lkKzZNNHAwN28vaWJPNlA0NFoxUi9PRFdPTDU3YzJ4cGY4bk9qUjdFMDNOKytFOUV4SVgxaU8zVkJqY0lla3dBVUwxLy9zMkw4Vi8rMmllLzlNRnJxeDh0OVBVdlhHaG9ReUFCbHl3RFJWZ1o3TWRyYTRzRndJc0NBTTVNQUFCRmVHMzFka3dXdVBodk5JeDQ3bnh6MndOOUp3Q0F6ZzFqUDk1Y1greml2MnM3RVdOSE5EZ3pmeTVBNXo2eGVpYzJodzhYZW94WExqZTBNWkNFQUFBNk5ZaUluMXEvdGRCakRBY1JyMXhxWm5zZ0N3RUFkT3JWMVk5aVovUmdvY2Q0N256RTJrb3oyd05aQ0FDZ002UEJmdnlkalpzTFA4NnJsdjloWmdJQTZNd2JhN2RqWThGei82Tmh4Q2NGQU14TUFBQ2RXQnZzeFZzTG52dVBtRjc4dCthV1pqQXpBUUIwNG91Yk54YjYwSjhEbjNtNmdZMkJoQVFBc0hSUHI5eUxWeGU4N1c5RXhQbjE2ZnYvZ2RrSkFHQ3BockVmZjNmencwWWV5NnQvbUo4QUFKYnFyZlZiY1dIQnQvMUZSRXhHRVc4S0FKaWJBQUNXNXZMNGZueHVZL0VML3lLbXczL1Z4WDh3TndFQUxNVjRzQjkvYit1REdNYit3bzgxSEVSOC9sb0RHd1dKQ1FCZ0tiNjBjV1BoTy80ZGVPMnBpSzNWUmg0SzBoSUFRT3RlbnR5SlQ2OHQ5bWwvQndhRGlKOSt2cEdIZ3RRRUFOQ3FDNlA3OGRXdER4dDd2RGV1Umx6WWFPemhJQzBCQUxSbWRiQVhYOXYrY1l3SGk1LzNqNWplOXZmdEZ4dDVLRWhQQUFDdEdFYkV6MjUvRU51anhlNzFmOWpubm8zWW1qVDJjSkNhQUFCYThlV3REK1BheW01amo3ZSs0dHcvTkVrQUFJMzc0c2FOUm03MWU5aFhYdmErZjJpU0FBQWE5Wm0xVy9IWkJqN2w3N0JyT3hHdlgyMzBJU0U5QVFBMDV2VzEyL0dselJ1TlB1WndFUEd6cnpUNmtFQkVXRkFER3ZIbTJxMTR1K0hoSHhIeGhlY2pMbm5iSHpST0FBQUwrNm4xVy9HRmplYUgvNVd0aUxkZmFQeGhnUkFBd0lLK3VIR2o4WFArRVJIalljUXZmWHA2Q2dCb25nQUE1akw2K01OOVhwcmNiZVh4di9xSmlQUHJyVHcwRUFJQW1NUDZjQzkrWWZ0SGNYbDh2NVhIZi9XcGlNOCswOHBEQXg4VEFNQk1uaHJmaTUvYi9pQTJoODNkNGUrd1M1c1JYM3UxbFljR0RoRUF3Sm05dVhZN3ZyaDVJNGJSekwzOUg3YzZqdmdIYjBTc2pGcDVlT0FRQVFDY2FqTFlpNjl1ZlJndnRuUytQMko2c2Q4dmZ6cGlaNjIxYndFY0lnQ0FFMTFiMlkydmJIM1kycEwvZ1o5L05lS0ZDNjErQytBUUFRQWNhVExZaXk5dDNvaFBOWHhQLzZOOCtXVzMrb1ZsRXdEQUUxNlkzSTJmMmJ3ZUd5Mi82bytJK1B5MWlDODgxL3EzQVI3VGVRRHNyRitKNjNmZTdYb3pnSWc0UDNvUWIyOWViL1JqZkUveTFqUFQ5L3RETmp2clY3cmVoTzREQU9qZVpMQVhuOSs0R2ErdjNWN2FKNFI5L3ByaEQxMFNBSkRZZUxBZnI2L2RqcmZXYjhYcVlHOXAzL2VubjQvNG1aZVc5dTJBSXdnQVNHZzAySS9YVjZlRGYyMjR2TUVmTWIzZ3p6bC82SjRBZ0VSV0IzdngydHBIOGViYXJWaGY4dUFmRHlOKzhiV0lWeTR2OWRzQ3h4QUFrTURPNkVHOHVYWTdYbG45S01hRGR1N2lkNUtOU2NRL2ZDUGk2dmJTdnpWd0RBRUFQVFdNL1hoK3NodXZyZDJPNTVaMFZmOVJudDZPK09YWEk3WlhPOXNFNEFnQ0FIcm13dWgrZkdydFRueHk5YU5ZVytLRmZVZjUzTFdJcjd3OHZjMHZVSllpQXNDOUFHQXhPNk1IOGRMa2JydzB1Uk9YV3ZxSTNsbXNqaU8rOXFtSVQxN3Fla3VnUENYY0F5Q2lrQUFBWm5keGREOWVuTnlObDFidnhvVlI5MFAvd0lzWEluN3VWVXYrVURvQkFKVllHK3pGczVQZHVMWXkvVzhadCttZHhlcDRlbU9mTjl6VEg2b2dBS0JRNjhPOXVEcStGMWRXN3NYVDQ5MjROTDRmcFo1Sy84U2xpTC8vU3NUbXBPc3RBYzZxbUFCd0hRQ1pyUXoyNCtMb2Zsd2EzNC9MNDN0eGRYd3Z0a2RsdmNJL3lzV042YXYrRjMyTUw1eEpLZWYvSXdvS0FNaGdOTmlQYzhNSHNUTjZHT2RIOStQaStINWNHajJJN2RHRHJqZHRKcXZqaUxkZmlIanJXVmY0UTYwRUFEUm9OTmlQamVGZWJBNGZ4dWJ3WVd3TUg4YjI4R0djR3oySWM2TUhzVlhZZWZ0WnJZeW1uK0QzaGVjaTFsYTYzaHBnRVFLQTFBWVJNWWo5R0E2bS8zc1krekVZVFA5ZEdlekgrT1AvVnVMamZ3ZDdNUm5zeDlwd0wxWUhlNC84dXo1NHVQVDc2aS9MZUJqeDJXZW1IK0t6YnZCREx3eDJ2MzVsK2ZjRlBZSHJBR2piZi95VGlPKyszL1ZXMUdGdEhQR1paeUkrOSt6MGRyN0EvRW82L3g5aEJRQTR3b1gxNlYzOFhyODZmZlVQOUk4QUFDSmllakhmeXhlbnIvaGQxUS85SndBZ3VVdWIwNXYzZlBxSzgvdVFTWEVCNEg0QTBMN3o2eEd2WEk1NDlYTEVVMXRkYnczMFgybm4veU1LREFDZ0haYzNweC9PODhybDZhdCtJRGNCQUQyMXZoTHgvUG5wK2Z3WExyaE5ML0NvSWdQQWFRQ1kzY1lrNHBsekVjK2VpN2kyTTEzYWQ1TSs2RjZKeS84UmhRWUFjTExKYUxxTWYyVXI0dXIyZFBEdnJIVzlWVUJOQkFBVWJEeU0yRm1mWHJSM2FXTjZIditwTGNNZVdGeXhBZUEwQUJtTWhoRmJrNGl0MVkvL20wU2NXNXNPL1BQckVkdXJYVzhoc0loU2wvOGpDZzRBS05IMGN3SSsvbmZ3azM5SGc0anhhTG8wUHg1RnJBeW5INXl6TXBwK2N0NzZ5dlMydXVzcjB3L1JXUjlQejlsNzN6M1FsZUkrQytCeFZnRUFxRkhKci80aklvYXIzM2pYaGNJQWtNanFOOTRkRlA4eEg2VVhGQUE4cm9iWlZYd0FBQURORXdBQWtGQVZBVkREVWdvQVJOUXpzNm9JQUFDZ1dkVUVRQzFGQlVCZU5jMnFZY1QwN1FCZGJ3Z0EwTDZEbVYvTkNrQkVYV1VGUUM2MXphaXFBaUNpdmgwTVFQL1ZPSnVxQ3dBQVlIRlZCa0NOcFFWQVA5VTZrLzQyQUZ3SUNBRDlkbmpXVjdrQ0VGRnZjUUhRSHpYUG9tb0RJS0x1SFE5QTNXcWZRVlVIQUFBd24wY0NvTWJyQUdvdk1BRHFVK1BzZVh6RzkySUZvTVluQW9BNjlXWG05Q0lBQUlEWlBCRUFOWjRHaU9oUGtRRlFybHBuelZHenZWY3JBTFUrTVFDVXIyOHpwbGNCRU5HL0p3aUE3dlZ4dHZRdUFBQ0EweDBaQUxWZUIzQ2dqNlVHUURkcW55bkh6ZlRlcmdEVS9vUUIwTDArejVKakE2RDJWWUNJZmo5eEFMU3JEelBrcEZuZTJ4V0FBMzE0QWdGWXJneXpvL2NCRUpIamlRU2dHVmxteG9rQjBJZlRBQUNRMFdrelBNVUtRRVNlb2dOZ2ZwbG14YWtCMEtkVmdFeFBMQUN6NmRPTU9NdnNUck1DY0tCUFR6QUF6Y2c0Rzg0VUFIMWFCWWpJK1VRRGNMUyt6WVN6enV4MEt3QUgrdmFFQXpDN3pMTmczUFVHZE9uZ2liOSs1OTJPdHdTQVpjbzgrQStjZVFXZ2I2Y0JEdk9MQUpCSG40LzVzOHpxdEtjQUh0Zm5Yd2dBcGh6cmYyS21BT2p6S2tDRVh3eUFQdXY3TVg3V0dUM3pDb0FJQUtBMmZUKzJ6ek9iVTE4RWVCd1hCd0wwUTk4SC95TG11Z2FnNzZzQUIvemlBTlFyeXpGODNwbnNJc0JUWlBrRkF1Z1R4KzdUTGZSS2Z2ZnJWL2FiMnBBYU9DVUFVTFpzZzMrUkZYa3JBRFBJOW9zRlVCUEg2TmtzZkM0LzJ5ckFBYXNCQUdYSU92Z1h2UjV2NFJXQUxCY0VQaTdyTHh4QVNiSWVpNXVZdmQ0R3VBQnZGd1RvUnRiQjM2VEdYcjFuUFJWd21CQUFhSmZCMzl6S2UyTVhBV1k5RlhDWVgweUE5ampHTmp0ckd4L2FWZ0ttckFZQU5NUGduMnI2aGJackFGcmkrZ0NBeFJqODdXcGwyZDRxd05IRUFNREpEUDJqdFhHYXZiWHo5aUxnZUVJQTRGRUcvL0hhdXNhdTFRdjNSTURKaEFDUW5jRi9zall2c0hjTlFJY08vK0tMQVNBTFE3OE1yYjkxenlyQTdNUUEwRGVHL3V6YWZudjlVdDY3THdJV0l3aUEyaGo0aTFuR3ZYV1dkdk1lRWRBY1FRQ1V4c0J2enJKdXJMZlV1L2VKZ0hZSUFtRFpEUHgyTFBPdXVrdS9mYThJV0Q2QkFNektnRisrWmQ5U3Y1UDc5NHNBQVBpSkxqNVBwN0VQQTVxRkR3NENnS211Wm1JbkFSQWhBZ0NneTFuWVdRQkVpQUFBOHVwNkJuWWFBQkhkN3dBQVdMWVNabC9uQVJCUnhvNEFnR1VvWmVZVkVRQVI1ZXdRQUdoTFNiT3VtQUNJS0d2SEFFQ1RTcHR4UlFWQVJIazdDQUFXVmVKc0syNkREblBESUFCcVZ1TGdQMURjQ3NCaEplODRBRGhKNlRPczZBQ0lLSDhIQXNEamFwaGR4Vy9nWVU0SkFGQ3lHZ2IvZ2VKWEFBNnJhY2NDa0V0dE02cXFBSWlvYndjRDBIODF6cWJxTnZnd3B3UUE2RktOZy85QWRTc0FoOVc4NHdHb1crMHpxT3FOUDh4cUFBRExVUHZnUDlDTEgrSXdJUUJBRy9veStBLzA2b2M1VEFnQTBJUytEZjREVlY4RGNKSytQbUVBTEUrZlowbHZmN0REckFZQU1JcytELzREdmY4Qkh5Y0dBRGhLaHFGL1dLb2Y5akFoQUVCRXZzRi9JT1VQZlpnUUFNZ3A2K0Eva1BxSGY1d1lBT2kzN0VQL01EdmlDRUlBb0Y4TS9pZlpJV2NnQ0FEcVl1Q2Z6ZzZha1JnQUtKT2hQeHM3YTBHQ0FLQWJCdjVpN0x3V2lBS0FaaG4yemJORGwwd2NBQnpOa0YrdS93OVlrVXluYUoxTkp3QUFBQUJKUlU1RXJrSmdnZz09IiwgInNpemVzIjogIjUxMng1MTIiLCAidHlwZSI6ICJpbWFnZS9wbmcifV0sICJzdGFydF91cmwiOiAiLiIsICJkaXNwbGF5IjogInN0YW5kYWxvbmUiLCAiYmFja2dyb3VuZF9jb2xvciI6ICIjMWExZDJlIiwgInRoZW1lX2NvbG9yIjogIiNmOTczMTYifQ==" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<meta name="apple-mobile-web-app-title" content="JeremyMacro" />
<meta name="theme-color" content="#f97316" />
</head>
<body>
<div id="_err" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:#1a0000;color:#ff6b6b;font-family:monospace;font-size:13px;padding:20px;z-index:99999;overflow:auto;white-space:pre-wrap"></div>
<script>
window.onerror = function(msg, src, line, col, err) {
  var d = document.getElementById('_err');
  d.style.display = 'block';
  d.textContent = 'RUNTIME ERROR:
' + msg + '
Line: ' + line + '
File: ' + src + '

' + (err&&err.stack||'');
};
window.addEventListener('unhandledrejection', function(e) {
  var d = document.getElementById('_err');
  d.style.display = 'block';
  d.textContent = (d.textContent||'') + '
PROMISE ERROR:
' + e.reason;
});
</script>
<div id="app">
  <div class="header">
    <div style="display:flex;justify-content:space-between;align-items:flex-start">
      <div>
        <div class="header-sub">170 → 163 lbs · 30 days</div>
        <div class="header-title" id="appHeaderTitle" onclick="handleDeployTap()">Jeremy's Tracker AI</div>
        <div id="headerDateLabel" style="font-size:12px;color:var(--text2);font-weight:600;margin-top:4px;letter-spacing:0.2px"></div>
      </div>
      <button class="settings-btn" onclick="openSettings()" title="Settings">⚙️</button>
    </div>
  </div>
  <!-- Daily Motivation Quote -->
  <div class="quote-card" id="dailyQuoteCard">
    <div class="quote-icon">💬</div>
    <div>
      <div class="quote-text quote-loading" id="dailyQuoteText">Loading today's motivation…</div>
      <div class="quote-author" id="dailyQuoteAuthor"></div>
    </div>
  </div>
  <div class="content">

    <!-- TODAY PAGE -->
    <div id="page-today" class="page active">

      <!-- 1. Date Nav Bar -->
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;background:var(--surface);border:1.5px solid var(--border);border-radius:18px;padding:10px 16px;box-shadow:var(--shadow)">
        <button onclick="shiftSelectedDay(-1)" style="background:none;border:none;font-size:20px;cursor:pointer;color:var(--text2);padding:2px 8px;border-radius:10px;transition:background 0.15s" onmouseover="this.style.background='var(--surface2)'" onmouseout="this.style.background='none'">‹</button>
        <div style="text-align:center;flex:1">
          <div id="selectedDayLabel" style="font-size:14px;font-weight:700;color:var(--text)"></div>
          <div id="selectedDaySub" style="font-size:10px;color:var(--text3);font-weight:600;margin-top:2px"></div>
        </div>
        <button onclick="shiftSelectedDay(1)" id="nextDayBtn" style="background:none;border:none;font-size:20px;cursor:pointer;color:var(--text2);padding:2px 8px;border-radius:10px;transition:background 0.15s" onmouseover="this.style.background='var(--surface2)'" onmouseout="this.style.background='none'">›</button>
      </div>

      <!-- 2. Week strip -->
      <div class="week-strip" id="weekStrip"></div>

      <!-- 3. Workout streak -->
      <div id="streakCard" class="card" style="padding:12px 18px;margin-bottom:14px;display:flex;align-items:center;gap:14px">
        <div style="font-size:36px;line-height:1">🔥</div>
        <div style="flex:1">
          <div style="font-size:11px;font-weight:700;color:#f59e0b;letter-spacing:1px;text-transform:uppercase;margin-bottom:2px">Workout Streak</div>
          <div style="font-size:22px;font-weight:800;color:var(--text);letter-spacing:-0.5px" id="streakCount">0</div>
          <div style="font-size:11px;color:var(--text3);font-weight:500" id="streakSub">No workouts logged yet</div>
        </div>
        <div id="weekDotRow" style="display:flex;flex-direction:column;gap:5px;align-items:flex-end"></div>
      </div>

      <!-- Event Countdowns -->
      <div id="eventCountdowns"></div>

      <!-- 4. Today's Nutrition -->
      <div class="card">
        <div class="card-label" style="color:#22c55e">Today's Nutrition</div>
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px">
          <div style="display:flex;background:var(--surface2);border-radius:20px;padding:3px;border:1px solid var(--border)">
            <button id="toggleConsumed" onclick="setRingMode('consumed')" style="padding:5px 14px;border-radius:16px;border:none;font-family:inherit;font-size:11px;font-weight:700;cursor:pointer;background:var(--green);color:#fff;transition:all 0.2s">Consumed</button>
            <button id="toggleRemaining" onclick="setRingMode('remaining')" style="padding:5px 14px;border-radius:16px;border:none;font-family:inherit;font-size:11px;font-weight:700;cursor:pointer;background:transparent;color:var(--text3);transition:all 0.2s">Remaining</button>
          </div>
          <div id="ringModeLabel" style="font-size:11px;color:var(--text3);font-weight:500"></div>
        </div>
        <div class="rings-row" id="ringsRow"></div>
        <div id="macroTargetsRow" style="display:flex;justify-content:space-between;background:var(--surface2);border-radius:12px;padding:8px 12px;margin-bottom:12px;border:1px solid var(--border)">
          <div style="text-align:center">
            <div style="font-size:11px;font-weight:700;color:#f59e0b" id="targetCalories">—</div>
            <div style="font-size:9px;color:var(--text3);font-weight:600;margin-top:1px">kcal target</div>
          </div>
          <div style="text-align:center">
            <div style="font-size:11px;font-weight:700;color:#22c55e" id="targetProtein">—</div>
            <div style="font-size:9px;color:var(--text3);font-weight:600;margin-top:1px">protein g</div>
          </div>
          <div style="text-align:center">
            <div style="font-size:11px;font-weight:700;color:#3b82f6" id="targetCarbs">—</div>
            <div style="font-size:9px;color:var(--text3);font-weight:600;margin-top:1px">carbs g</div>
          </div>
          <div style="text-align:center">
            <div style="font-size:11px;font-weight:700;color:#ef4444" id="targetFat">—</div>
            <div style="font-size:9px;color:var(--text3);font-weight:600;margin-top:1px">fat g</div>
          </div>
          <div style="text-align:center">
            <div style="font-size:11px;font-weight:600;color:var(--text3)" id="targetSource">Base</div>
            <div style="font-size:9px;color:var(--text3);font-weight:600;margin-top:1px">source</div>
          </div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:4px">
          <button class="btn-scan" onclick="openScanner()">
            <span style="font-size:16px">&#x1F4F7;</span> Scan
          </button>
          <button class="btn-scan" onclick="openPhotoAI()" style="background:var(--purple-soft);border-color:#4c1d95;color:#a78bfa">
            <span style="font-size:16px">🤖</span> Photo
          </button>
          <button class="btn-scan" onclick="openAISearch()" style="background:#2d1f05;border-color:#3d2e00;color:#f59e0b">
            <span style="font-size:16px">🔍</span> Search
          </button>
        </div>
        <div style="display:flex;align-items:center;gap:10px;margin:4px 0 12px">
          <div style="flex:1;height:1px;background:var(--border)"></div>
          <span style="font-size:11px;color:var(--text3);font-weight:600">OR ENTER MANUALLY</span>
          <div style="flex:1;height:1px;background:var(--border)"></div>
        </div>
        <div class="macro-grid">
          <input type="number" id="in-calories" placeholder="+ calories (kcal)" />
          <input type="number" id="in-protein" placeholder="+ protein (g)" />
          <input type="number" id="in-carbs" placeholder="+ carbs (g)" />
          <input type="number" id="in-fat" placeholder="+ fat (g)" />
        </div>
        <button class="btn-green" style="margin-top:10px" onclick="logMacros()">LOG MEAL</button>
        <div id="manualSaveSection" style="margin-top:14px;padding-top:14px;border-top:1px solid var(--border)">
          <div style="font-size:11px;font-weight:700;color:var(--text2);letter-spacing:1px;text-transform:uppercase;margin-bottom:8px">💾 Save as Quick-Add Food</div>
          <input type="text" id="manualFoodName" placeholder="Food name (e.g. Oatmeal with berries)" style="margin-bottom:8px"/>
          <div class="time-slot-picker" id="manualTimeSlotPicker">
            <button class="ts-btn" data-slot="breakfast" onclick="toggleTimeSlot(this,'manual')">🌅 Breakfast</button>
            <button class="ts-btn" data-slot="morning" onclick="toggleTimeSlot(this,'manual')">☕ Morning Snack</button>
            <button class="ts-btn" data-slot="lunch" onclick="toggleTimeSlot(this,'manual')">🥗 Lunch</button>
            <button class="ts-btn" data-slot="afternoon" onclick="toggleTimeSlot(this,'manual')">🍎 Afternoon</button>
            <button class="ts-btn" data-slot="dinner" onclick="toggleTimeSlot(this,'manual')">🍽️ Dinner</button>
            <button class="ts-btn" data-slot="evening" onclick="toggleTimeSlot(this,'manual')">🌙 Evening</button>
          </div>
          <button class="btn-save-food" style="margin-top:10px;width:100%" onclick="saveManualFood()">Save Food</button>
        </div>
      </div>

      <!-- 5. Food recommendations -->
      <div id="quickRecsCard" class="card" style="display:none">
        <div class="meal-time-label"><span class="meal-time-dot"></span><span id="mealTimeLabel">Breakfast suggestions</span></div>
        <div class="quick-foods-scroll" id="quickFoodsRow"></div>
        <div style="font-size:10px;color:var(--text3);font-weight:500;margin-top:4px">Tap to quick-add · Based on your usual <span id="mealTimeHint"></span> foods</div>
      </div>

      <!-- 5b. My Usual Foods — top 10 last 30 days -->
      <div id="usualFoodsCard" class="card" style="display:none">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px">
          <div>
            <div class="card-label" style="color:#f97316;margin-bottom:2px">⚡ My Usual Foods</div>
            <div id="usualFoodsSubtitle" style="font-size:10px;color:var(--text3);font-weight:600"></div>
          </div>
          <div style="font-size:10px;color:var(--text3);font-weight:600" id="usualFoodsTimeLabel"></div>
        </div>
        <!-- Yesterday same-time repeat banner -->
        <div id="yesterdayRepeatBanner" style="display:none;background:linear-gradient(135deg,#1a2e1a,#0d1e0d);border:1.5px solid #166534;border-radius:12px;padding:10px 12px;margin-bottom:10px">
          <div style="font-size:10px;font-weight:700;color:#4ade80;letter-spacing:1px;text-transform:uppercase;margin-bottom:6px">🔁 Same time yesterday</div>
          <div id="yesterdayRepeatList"></div>
        </div>
        <div id="usualFoodsList"></div>
      </div>

      <!-- 6. Protein pace bar -->
      <div id="proteinPaceCard" class="card" style="padding:14px 18px;margin-bottom:14px">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
          <div style="font-size:11px;font-weight:700;color:#4ade80;letter-spacing:1px;text-transform:uppercase">💪 Protein Pace</div>
          <div style="font-size:11px;color:var(--text3);font-weight:600" id="proteinPaceLabel">—</div>
        </div>
        <div style="background:var(--surface2);border-radius:8px;height:10px;overflow:hidden;margin-bottom:8px">
          <div id="proteinPaceBar" style="height:100%;border-radius:8px;background:#4ade80;transition:width 0.4s ease;width:0%"></div>
        </div>
        <div style="font-size:11px;color:var(--text2);font-weight:500" id="proteinPaceHint"></div>
      </div>

      <!-- 7. Daily Targets -->
      <div class="card">
        <div class="card-label" style="color:#3b82f6">Daily Targets</div>
        <div class="macro-grid">
          <div class="macro-tile" style="border-color:#3d2e00">
            <div class="macro-tile-label" style="color:#f59e0b">Calories</div>
            <div class="macro-tile-val">2,200 kcal</div>
            <div class="macro-tile-note">~600 kcal deficit</div>
          </div>
          <div class="macro-tile" style="border-color:#166534">
            <div class="macro-tile-label" style="color:#22c55e">Protein</div>
            <div class="macro-tile-val">190g</div>
            <div class="macro-tile-note">Protect muscle in deficit</div>
          </div>
          <div class="macro-tile" style="border-color:#1e3a5f">
            <div class="macro-tile-label" style="color:#3b82f6">Carbs</div>
            <div class="macro-tile-val">190g</div>
            <div class="macro-tile-note">Fuel runs + lifts</div>
          </div>
          <div class="macro-tile" style="border-color:#7f1d1d">
            <div class="macro-tile-label" style="color:#ef4444">Fat</div>
            <div class="macro-tile-val">65g</div>
            <div class="macro-tile-note">Hormone support</div>
          </div>
        </div>
        <div class="tip-box">
          💡 <span style="color:#4ade80">Goal:</span> 170 → 163 lbs in 30 days. Eat protein first at every meal. On run days, keep carbs toward the higher end. If energy crashes, add 100 kcal from carbs only.
        </div>
      </div>

      <!-- 8. Weekly Calorie Balance -->
      <div class="card" id="weeklyBalanceCard">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px">
          <div class="card-label" style="color:#8b5cf6;margin-bottom:0">📊 Weekly Calorie Balance</div>
          <div id="weekRangeLabel" style="font-size:10px;color:var(--text3);font-weight:600"></div>
        </div>
        <div class="week-balance-grid" id="weekBalanceGrid"></div>
        <div class="weekly-summary-row" id="weeklySummaryRow"></div>
      </div>

      <!-- 9. Weight trend -->
      <div id="weightTrendCard" class="weight-card">
        <div class="weight-header">
          <div>
            <div style="font-size:11px;font-weight:700;color:var(--text3);letter-spacing:1px;text-transform:uppercase;margin-bottom:4px">Weight Trend</div>
            <div style="font-size:13px;color:var(--text2);font-weight:500" id="weightTrendSubtitle">Log your weight daily for trend tracking</div>
          </div>
          <div style="display:flex;align-items:center;gap:8px">
            <div class="weight-stat" id="weightStatBlock" style="display:none">
              <div class="weight-stat-val" id="weightTrendVal">—</div>
              <div class="weight-stat-lbl">lbs today</div>
            </div>
            <button class="log-weight-btn" onclick="openWeightModal()">+ Log</button>
          </div>
        </div>
        <svg class="weight-chart" id="weightSparkline" viewBox="0 0 300 60" preserveAspectRatio="none"></svg>
        <div class="weight-badges" id="weightBadges"></div>
        <div id="adaptiveMacroBanner" class="adaptive-banner" style="display:none">
          <span>🧠</span><div id="adaptiveMacroText"></div>
        </div>
      </div>

      <!-- 10. Workout nutrition prompt -->
      <div id="workoutNutritionBanner" style="display:none;background:linear-gradient(135deg,#1a1030,#0d1e3d);border:1.5px solid #2a1f4a;border-radius:16px;padding:12px 16px;margin-bottom:14px">
        <div style="font-size:11px;font-weight:700;color:#a78bfa;letter-spacing:1px;text-transform:uppercase;margin-bottom:6px" id="workoutNutritionTitle">🏋️ Lift Day Fuel</div>
        <div style="font-size:13px;color:var(--text);font-weight:600;line-height:1.6" id="workoutNutritionMsg"></div>
      </div>

      <!-- 11. Strava / Garmin activity card -->
      <div id="garminCard" style="display:none" class="garmin-card">
        <div style="display:flex;align-items:center;gap:12px;margin-bottom:4px">
          <div class="garmin-logo">🏃</div>
          <div style="flex:1">
            <div style="font-size:14px;font-weight:700;color:var(--text)" id="garminActivityTitle">Today's Activity</div>
            <div style="font-size:11px;color:var(--text2);margin-top:1px" id="garminActivitySub">Syncing…</div>
          </div>
          <button onclick="getStorage('stravaToken',null)?fetchStravaToday():fetchGarminToday()" style="background:none;border:none;font-size:18px;cursor:pointer;color:var(--text2)" title="Refresh">🔄</button>
        </div>
        <div class="garmin-activity-row" id="garminStatsRow"></div>
        <div id="garminMacroBanner" class="macro-adj-banner" style="display:none">
          <span>🎯</span><span id="garminMacroText"></span>
        </div>
        <div id="todayShoeRow" style="display:none;margin-top:10px;padding-top:10px;border-top:1px solid #1e3a5f;align-items:center;justify-content:space-between">
          <div style="font-size:12px;color:#60a5fa;font-weight:600" id="todayShoeLabel">👟 Which shoes did you wear?</div>
          <button id="todayShoeAssignBtn" onclick="openTodayShoeAssign()" style="padding:6px 14px;background:#f97316;color:#fff;border:none;border-radius:10px;font-family:inherit;font-size:12px;font-weight:700;cursor:pointer;flex-shrink:0">Assign Shoes</button>
        </div>
      </div>

      <!-- 12. Today's Food Log -->
      <div class="card" id="foodLogCard" style="display:none">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
          <div class="card-label" style="color:#8b5cf6;margin-bottom:0">Today's Food Log</div>
          <button onclick="clearAllEntries()" style="font-size:11px;font-weight:700;color:var(--red);background:none;border:none;cursor:pointer;padding:4px 8px;border-radius:8px;background:var(--red-soft)">Clear All</button>
        </div>
        <button class="copy-yesterday-btn" id="copyYesterdayBtn" onclick="copyYesterdayMeals()" style="display:none">
          📋 Copy Yesterday's Meals
        </button>
        <div id="foodLogList"></div>
      </div>

    </div>

    <!-- WORKOUT PAGE -->
    <div id="page-lift" class="page">
      <!-- Live workout timer bar -->
      <div class="workout-timer-bar" id="workoutTimerBar">
        <div>
          <div style="font-size:9px;color:#60a5fa;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;margin-bottom:2px">Duration</div>
          <div class="workout-timer-elapsed" id="workoutTimerDisplay">0:00</div>
        </div>
        <div class="workout-timer-stats">
          <div class="workout-timer-stat">
            <div class="workout-timer-stat-val" id="timerSetsCount">0</div>
            <div class="workout-timer-stat-lbl">Sets</div>
          </div>
          <div class="workout-timer-stat">
            <div class="workout-timer-stat-val" id="timerVolumeCount">0</div>
            <div class="workout-timer-stat-lbl">Volume (lbs)</div>
          </div>
        </div>
      </div>
      <div class="session-tabs" id="sessionTabs"></div>
      <div class="card" id="sessionHeader"></div>
      <div id="exerciseList"></div>
      <div class="card" style="padding:14px 18px;margin-bottom:14px" id="workoutNotesCard">
        <div style="font-size:11px;font-weight:700;color:var(--text2);letter-spacing:1px;text-transform:uppercase;margin-bottom:8px">📝 Session Notes</div>
        <textarea id="workoutNotesInput" placeholder="How did it feel? Any PRs, injuries, energy levels…" style="width:100%;min-height:72px;background:var(--surface2);border:1.5px solid var(--border);border-radius:14px;color:var(--text);font-family:inherit;font-size:13px;padding:10px 14px;resize:vertical;outline:none;line-height:1.6"></textarea>
      </div>
      <button class="btn-green" onclick="saveWorkout()">SAVE WORKOUT ✓</button>
    </div>

    <!-- PROGRAM PAGE -->
    <div id="page-program" class="page">

      <!-- Events Section -->
      <div class="card" style="margin-bottom:14px">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px">
          <div class="card-label" style="color:#3b82f6;margin-bottom:0">🏁 Upcoming Events</div>
          <button onclick="openAddEventModal()" style="background:#3b82f6;border:none;border-radius:10px;padding:6px 14px;color:#fff;font-size:12px;font-weight:700;cursor:pointer">+ Add Event</button>
        </div>
        <div id="eventList"></div>
      </div>
      <div class="card">
        <div class="section-title">YOUR PROGRAM</div>
        <div style="font-size:12px;color:var(--text2);line-height:1.8"><span style="color:#22c55e;font-weight:600">Push / Pull / Legs</span> — classic 3-day split optimized for hypertrophy at 52. Progressive overload every session. Rotate A→B→C each lift day.</div>
      </div>
      <div class="card">
        <div class="card-label" style="color:#f59e0b">Key Principles</div>
        <div class="principle-row"><div class="principle-title">Progressive Overload</div><div class="principle-desc">Add 2.5–5 lbs when you hit the top of the rep range on all sets</div></div>
        <div class="principle-row"><div class="principle-title">Deload Week</div><div class="principle-desc">Every 6–8 weeks, reduce weight by 40% for one full week</div></div>
        <div class="principle-row"><div class="principle-title">Recovery at 52</div><div class="principle-desc">Sleep 7–9 hrs. This is when muscle is built. Non-negotiable.</div></div>
        <div class="principle-row"><div class="principle-title">Protein Timing</div><div class="principle-desc">~50g protein per meal, 4–5x/day for optimal synthesis</div></div>
        <div class="principle-row"><div class="principle-title">Running Sync</div><div class="principle-desc">Keep runs easy (Zone 2) on lifting days if doubling up</div></div>
      </div>
      <div id="programList"></div>
    </div>

    <!-- HISTORY PAGE -->
    <div id="page-history" class="page">
      <!-- Sub-tab bar -->
      <div style="display:flex;gap:6px;padding:0 0 14px 0;border-bottom:1px solid var(--border);margin-bottom:16px">
        <button id="htab-blood"   class="htab-btn htab-active" onclick="switchHistoryTab('blood')">🩸 Blood</button>
        <button id="htab-nutr"    class="htab-btn"             onclick="switchHistoryTab('nutr')">🥗 Nutrition</button>
        <button id="htab-trends"  class="htab-btn"             onclick="switchHistoryTab('trends')">📈 Trends</button>
        <button id="htab-lift"    class="htab-btn"             onclick="switchHistoryTab('lift')">🏋️ Lifts</button>
      </div>

      <!-- LIFT HISTORY -->
      <div id="historyTab-lift" style="display:none">
        <div id="historyList"></div>
      </div>

      <!-- BLOOD WORK -->
      <div id="historyTab-blood">
        <div id="bloodResultsList"></div>
        <div id="bloodAIInsights" style="display:none" class="card">
          <div class="card-label" style="color:#a78bfa">🤖 AI Health Insights</div>
          <div id="bloodAIInsightsText" style="font-size:13px;color:var(--text2);line-height:1.7"></div>
          <button onclick="analyzeBloodWithNutrition()" style="margin-top:14px;width:100%;background:#0f172a;border:1px solid #7c3aed;border-radius:12px;padding:12px;color:#a78bfa;font-size:13px;font-weight:700;cursor:pointer;font-family:inherit">🔗 Correlate with My Nutrition</button>
        </div>
        <div class="card" style="margin-top:14px">
          <div class="card-label" style="color:#ef4444">🩸 Upload Lab Results</div>
          <div style="font-size:12px;color:var(--text2);margin-bottom:12px;line-height:1.6">Take a photo or scan of your lab report. AI will read all values automatically.</div>
          <div id="bloodUploadDrop" style="border:2px dashed #2a3040;border-radius:14px;padding:24px;text-align:center;cursor:pointer;transition:all 0.2s" onclick="document.getElementById('bloodFileInput').click()" ondragover="event.preventDefault();this.style.borderColor='#ef4444'" ondragleave="this.style.borderColor='#2a3040'" ondrop="event.preventDefault();handleBloodDrop(event)">
            <div style="font-size:32px;margin-bottom:6px">🩸</div>
            <div style="font-size:13px;color:var(--text2)">Tap to upload lab report photo or PDF</div>
            <div id="bloodUploadName" style="font-size:12px;color:#22c55e;margin-top:6px;font-weight:600"></div>
          </div>
          <input type="file" id="bloodFileInput" accept="image/*,.pdf" style="display:none" onchange="handleBloodFile(this.files[0])">
          <div id="bloodUploadStatus" style="margin-top:10px;font-size:13px;font-weight:600;color:var(--text2);display:none"></div>
          <button id="bloodAnalyzeBtn" onclick="analyzeBloodReport()" style="display:none;width:100%;margin-top:12px;background:#ef4444;border:none;border-radius:12px;padding:13px;color:#fff;font-size:14px;font-weight:700;cursor:pointer;font-family:inherit">🤖 Analyze Image with AI</button>
          <!-- PDF text paste fallback -->
          <div id="bloodPasteToggle" style="text-align:center;margin-top:12px">
            <button onclick="toggleBloodPaste()" style="background:none;border:none;color:var(--text3);font-size:12px;cursor:pointer;font-family:inherit;text-decoration:underline">📋 Or paste report text instead (for PDFs)</button>
          </div>
          <div id="bloodPasteArea" style="display:none;margin-top:10px">
            <textarea id="bloodPasteText" placeholder="Paste the full text of your lab report here..." style="width:100%;height:120px;background:var(--surface2);border:1.5px solid var(--border);border-radius:12px;padding:10px;color:var(--text);font-size:12px;font-family:inherit;resize:vertical;box-sizing:border-box"></textarea>
            <button onclick="analyzeBloodPasteText()" style="width:100%;margin-top:8px;background:#7c3aed;border:none;border-radius:12px;padding:12px;color:#fff;font-size:14px;font-weight:700;cursor:pointer;font-family:inherit">🤖 Analyze Pasted Text</button>
          </div>
        </div>
      </div>

      <!-- NUTRITION REPORT -->
      <div id="historyTab-nutr" style="display:none">
        <!-- Retroactive enrichment card -->
        <div class="card" style="margin-bottom:14px;border-color:#7c3aed22">
          <div class="card-label" style="color:#a78bfa">🔄 Enrich Historical Data</div>
          <div style="font-size:12px;color:var(--text2);margin-bottom:12px;line-height:1.6">Add micronutrient data to all your past food entries using USDA database + AI estimation. This runs once and can take a minute for large logs.</div>
          <div id="enrichStatus" style="display:none;font-size:12px;margin-bottom:10px"></div>
          <div id="enrichProgress" style="display:none;margin-bottom:10px">
            <div style="background:var(--surface2);border-radius:6px;height:8px;overflow:hidden">
              <div id="enrichProgressBar" style="height:100%;background:#7c3aed;border-radius:6px;transition:width 0.3s;width:0%"></div>
            </div>
            <div id="enrichProgressText" style="font-size:11px;color:var(--text3);margin-top:4px;text-align:center"></div>
          </div>
          <button id="enrichBtn" onclick="startRetroEnrichment()" style="width:100%;background:#0f172a;border:1.5px solid #7c3aed;border-radius:12px;padding:12px;color:#a78bfa;font-size:13px;font-weight:700;cursor:pointer;font-family:inherit">🔄 Enrich All Past Meals with Micronutrients</button>
        </div>

        <div class="card" style="margin-bottom:14px">
          <div class="card-label" style="color:#22c55e">🥗 Micronutrient Report</div>
          <div style="font-size:12px;color:var(--text2);margin-bottom:12px">Average daily intake vs recommended values — based on logged foods with full nutrient data.</div>
          <div style="display:flex;gap:8px;margin-bottom:14px">
            <button onclick="renderNutritionReport(7)"  id="nrBtn7"  class="nr-btn nr-btn-active">7 days</button>
            <button onclick="renderNutritionReport(30)" id="nrBtn30" class="nr-btn">30 days</button>
            <button onclick="renderNutritionReport(90)" id="nrBtn90" class="nr-btn">90 days</button>
          </div>
          <div id="nutritionReportGrid"></div>
        </div>
        <div id="nutritionReportDetails"></div>
      </div>

      <!-- TRENDS TAB -->
      <div id="historyTab-trends" style="display:none">
        <div class="card">
          <div class="section-title" style="margin-bottom:6px">📈 Monthly Trends</div>
          <div class="chart-tab-row" id="trendChartTabs">
            <button class="chart-tab active" data-metric="calories" onclick="setTrendMetric('calories',this)">Calories</button>
            <button class="chart-tab" data-metric="protein" onclick="setTrendMetric('protein',this)">Protein</button>
            <button class="chart-tab" data-metric="carbs" onclick="setTrendMetric('carbs',this)">Carbs</button>
            <button class="chart-tab" data-metric="fat" onclick="setTrendMetric('fat',this)">Fat</button>
            <button class="chart-tab" data-metric="weight" onclick="setTrendMetric('weight',this)">Weight</button>
          </div>
          <div class="chart-container" id="monthChartContainer"></div>
          <div id="trendSummaryRow" style="display:flex;gap:10px;margin-top:14px;flex-wrap:wrap"></div>
        </div>
      </div>

    </div>

    <!-- RECIPES PAGE -->
    <div id="page-recipes" class="page">
      <div class="card">
        <div class="section-title" style="margin-bottom:6px">📖 Recipe Builder</div>
        <div style="font-size:12px;color:var(--text2);margin-bottom:14px;line-height:1.7">Build multi-ingredient recipes. Search ingredients from USDA or restaurant menus, set quantities, save and log in one tap.</div>
        <button class="btn-green" onclick="openNewRecipeModal()">+ Create New Recipe</button>
      </div>
      <div id="recipeList"></div>
      <div class="card">
        <div class="card-label" style="color:#8b5cf6">🍽️ Restaurant Food Search</div>
        <div style="font-size:12px;color:var(--text2);margin-bottom:12px;line-height:1.6">Search restaurants and fast food — powered by USDA branded food database.</div>
        <div style="position:relative;margin-bottom:10px">
          <input type="text" id="restaurantSearchInput" placeholder="e.g. McDonald's Big Mac, Chipotle burrito bowl…"
            style="padding-right:48px" onkeydown="if(event.key==='Enter')runRestaurantSearch()" />
          <button onclick="runRestaurantSearch()" style="position:absolute;right:8px;top:50%;transform:translateY(-50%);width:34px;height:34px;border-radius:10px;background:var(--amber);border:none;cursor:pointer;font-size:16px;display:flex;align-items:center;justify-content:center;color:#fff">🔍</button>
        </div>
        <div style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:10px" id="restaurantChips">
          <button class="ts-btn" onclick="quickRestaurant(this)">🍔 McDonald's</button>
          <button class="ts-btn" onclick="quickRestaurant(this)">🌯 Chipotle</button>
          <button class="ts-btn" onclick="quickRestaurant(this)">🍕 Domino's</button>
          <button class="ts-btn" onclick="quickRestaurant(this)">🍗 Chick-fil-A</button>
          <button class="ts-btn" onclick="quickRestaurant(this)">🥙 Subway</button>
          <button class="ts-btn" onclick="quickRestaurant(this)">🍜 Panera</button>
        </div>
        <div id="restaurantLoading" style="display:none;text-align:center;padding:20px 0;font-size:13px;color:var(--text2)">🔍 Searching database…</div>
        <div id="restaurantResults"></div>
      </div>
    </div>



    <!-- SHOES PAGE -->
    <div id="page-shoes" class="page">
      <div class="card" style="background:linear-gradient(135deg,#0f172a 0%,#1e293b 100%);border:none;color:#fff;position:relative;overflow:hidden">
        <div style="position:absolute;top:-20px;right:-20px;font-size:100px;opacity:0.07;line-height:1">👟</div>
        <div style="font-size:10px;font-weight:700;letter-spacing:2px;color:#94a3b8;text-transform:uppercase;margin-bottom:4px">Shoe Tracker</div>
        <div style="font-size:22px;font-weight:800;color:#fff;margin-bottom:2px">Mileage Garage</div>
        <div style="font-size:12px;color:#94a3b8" id="shoeGarageSummary">Track every mile on every pair</div>
        <button onclick="openAddShoeModal()" style="margin-top:14px;padding:10px 20px;background:#f97316;color:#fff;border:none;border-radius:14px;font-family:inherit;font-size:13px;font-weight:700;cursor:pointer;box-shadow:0 4px 14px rgba(249,115,22,0.4)">+ Add New Shoe</button>
      </div>

      <!-- Today's miles from Strava — simple display only -->
      <div id="shoeStravaCard" style="display:none;background:var(--surface);border:1.5px solid #1e3a5f;border-radius:16px;padding:12px 16px;margin-bottom:12px;display:flex;align-items:center;gap:12px">
        <div style="font-size:28px">🏃</div>
        <div>
          <div style="font-size:11px;font-weight:700;color:var(--text2);text-transform:uppercase;letter-spacing:1px">Today's Run</div>
          <div style="font-size:20px;font-weight:800;color:#3b82f6" id="shoeStravaMiles">—</div>
          <div style="font-size:11px;color:var(--text2);margin-top:1px" id="shoeStravaSub">Synced from Strava</div>
        </div>
      </div>

      <div id="shoeRetireWarning" style="display:none;background:#2d1f05;border:1.5px solid #3d2e00;border-radius:16px;padding:12px 16px;margin-bottom:12px;font-size:13px;color:#f59e0b;font-weight:600"></div>

      <!-- Unified shoe garage list -->
      <div style="border:1.5px solid var(--border);border-radius:20px;padding:16px;background:var(--surface)">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px">
          <div style="font-size:16px;font-weight:800;color:var(--text)">👟 Shoe Garage</div>
          <div style="font-size:11px;color:var(--text3);font-weight:600" id="shoeGarageCount"></div>
        </div>
        <div id="shoeList"></div>
        <div id="shoeEmptyState" style="display:none;text-align:center;padding:32px 20px;color:var(--text3)">
          <div style="font-size:48px;margin-bottom:12px">👟</div>
          <div style="font-size:15px;font-weight:700;color:var(--text2);margin-bottom:6px">No shoes yet</div>
          <div style="font-size:12px;line-height:1.7">Add your first pair, then after each<br>Strava run you'll be asked which shoes you wore.</div>
        </div>
      </div>
    </div>

  </div><!-- end content -->
</div><!-- end app -->

<!-- AI Food Search Modal -->
<div class="modal-overlay" id="aiSearchModal">
  <div class="modal-sheet">
    <div class="modal-handle"></div>
    <div class="modal-title">🔍 Food & Supplement Logger</div>

    <!-- Mode tabs -->
    <div style="display:flex;gap:6px;margin-bottom:14px">
      <button id="fstab-search" class="fstab-btn fstab-active" onclick="switchFoodSearchTab('search')">🔍 Search</button>
      <button id="fstab-meal"   class="fstab-btn"              onclick="switchFoodSearchTab('meal')">🍽️ Meal</button>
      <button id="fstab-supp"   class="fstab-btn"              onclick="switchFoodSearchTab('supp')">💊 Supplements</button>
    </div>

    <!-- SEARCH TAB -->
    <div id="fstab-search-content">
      <div style="font-size:12px;color:var(--text2);margin-bottom:10px">USDA database — brands, whole foods, restaurants. Whole foods auto-include full micronutrient data.</div>
      <div style="position:relative;margin-bottom:10px">
        <input type="text" id="aiSearchInput"
          placeholder="e.g. banana, grilled chicken breast, Chipotle bowl"
          style="padding-right:48px"
          onkeydown="if(event.key==='Enter')runAISearch()" />
        <button onclick="runAISearch()" id="aiSearchBtn"
          style="position:absolute;right:8px;top:50%;transform:translateY(-50%);width:34px;height:34px;border-radius:10px;background:var(--green);border:none;cursor:pointer;font-size:16px;display:flex;align-items:center;justify-content:center">
          ➤
        </button>
      </div>
      <div style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:14px" id="aiSearchExamples">
        <button class="ts-btn" onclick="setSearchExample(this)" style="font-size:11px">🍗 Chicken breast cooked</button>
        <button class="ts-btn" onclick="setSearchExample(this)" style="font-size:11px">🥚 Eggs scrambled</button>
        <button class="ts-btn" onclick="setSearchExample(this)" style="font-size:11px">🍚 White rice cooked 1 cup</button>
        <button class="ts-btn" onclick="setSearchExample(this)" style="font-size:11px">🫐 Blueberries 1/2 cup</button>
        <button class="ts-btn" onclick="setSearchExample(this)" style="font-size:11px">🥦 Broccoli steamed</button>
        <button class="ts-btn" onclick="setSearchExample(this)" style="font-size:11px">🐟 Salmon Atlantic</button>
      </div>
    </div>

    <!-- MEAL TAB -->
    <div id="fstab-meal-content" style="display:none">
      <div style="font-size:12px;color:var(--text2);margin-bottom:10px;line-height:1.6">Describe a home-cooked meal or restaurant dish. AI decomposes it into ingredients, looks each up in USDA, and logs complete micronutrient data.</div>
      <textarea id="mealDescInput" placeholder="e.g. Grilled salmon 6oz with roasted broccoli 1 cup and brown rice 1/2 cup&#10;&#10;Or: Chipotle chicken burrito bowl with rice, black beans, fajita veggies, salsa" style="width:100%;height:90px;background:var(--surface2);border:1.5px solid var(--border);border-radius:12px;padding:10px;color:var(--text);font-size:13px;font-family:inherit;resize:none;box-sizing:border-box;margin-bottom:10px"></textarea>
      <div id="mealAnalysisResult" style="display:none"></div>
      <button onclick="analyzeMealDescription()" id="mealAnalyzeBtn" style="width:100%;background:#7c3aed;border:none;border-radius:12px;padding:13px;color:#fff;font-size:14px;font-weight:700;cursor:pointer;font-family:inherit">🤖 Analyze Meal + Get Micros</button>
    </div>

    <!-- SUPPLEMENTS TAB -->
    <div id="fstab-supp-content" style="display:none">
      <div style="font-size:12px;color:var(--text2);margin-bottom:12px">Log supplements with accurate micronutrient data. These count toward your daily nutrition totals.</div>
      <div id="suppPresetList" style="margin-bottom:14px"></div>
      <div style="border-top:1px solid var(--border);padding-top:12px;margin-bottom:10px">
        <div style="font-size:11px;font-weight:700;color:var(--text3);text-transform:uppercase;letter-spacing:0.8px;margin-bottom:8px">Custom Supplement</div>
        <input type="text" id="suppCustomName" placeholder="Supplement name (e.g. Zinc 15mg)" style="margin-bottom:8px">
        <div id="suppCustomNutrients" style="display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-bottom:10px"></div>
        <button onclick="addCustomSuppNutrient()" style="width:100%;padding:9px;background:var(--surface2);border:1.5px dashed var(--border);border-radius:10px;color:var(--text2);font-size:12px;font-weight:600;cursor:pointer;font-family:inherit;margin-bottom:10px">+ Add Nutrient</button>
        <button onclick="logCustomSupplement()" style="width:100%;padding:12px;background:#0f172a;border:1.5px solid #7c3aed;border-radius:12px;color:#a78bfa;font-size:13px;font-weight:700;cursor:pointer;font-family:inherit">Log Custom Supplement</button>
      </div>
    </div>

    <!-- Loading state -->
    <div id="aiSearchLoading" style="display:none;text-align:center;padding:24px 0">
      <div style="font-size:28px;margin-bottom:8px" class="spin-pulse">🔍</div>
      <div style="font-size:13px;color:var(--text2);font-weight:600" id="aiSearchLoadingText">Searching nutrition database…</div>
    </div>

    <!-- Results -->
    <div id="aiSearchResults" style="display:none">
      <div style="font-size:11px;font-weight:700;color:var(--text3);letter-spacing:1px;text-transform:uppercase;margin-bottom:10px">Results</div>
      <div id="aiSearchResultsList"></div>
    </div>

    <!-- Selected food detail -->
    <div id="aiSearchSelected" style="display:none">
      <div class="food-result" id="aiSearchFoodCard"></div>
      <div style="display:flex;align-items:center;gap:12px;background:var(--surface2);border-radius:14px;padding:10px 14px;border:1.5px solid var(--border);margin-bottom:12px">
        <div style="font-size:13px;font-weight:600;color:var(--text);flex:1">Servings</div>
        <div style="display:flex;align-items:center;gap:10px">
          <button class="srv-btn" onclick="adjustAISearchServings(-0.5)">−</button>
          <div class="srv-val" id="aiSearchServingsVal">1</div>
          <button class="srv-btn" onclick="adjustAISearchServings(0.5)">+</button>
        </div>
      </div>
      <button class="btn-green" onclick="logAISearchFood()">LOG THIS FOOD ✓</button>
      <button class="btn-outline" onclick="backToAISearch()">← Search Again</button>
    </div>

    <button class="btn-outline" onclick="closeAISearch()" style="margin-top:6px">Close</button>
  </div>
</div>

<!-- Weight Check-in Modal -->
<div class="modal-overlay" id="weightModal">
  <div class="modal-sheet">
    <div class="modal-handle"></div>
    <div class="modal-title">⚖️ Log Today's Weight</div>
    <div class="modal-sub">Weigh in first thing in the morning for the most consistent readings</div>
    <input type="number" id="weightInput" class="big-input" placeholder="170.0" step="0.1" style="margin-bottom:16px" />
    <div style="font-size:11px;color:var(--text3);font-weight:500;margin-bottom:16px;text-align:center">lbs · fasted · after bathroom</div>
    <button class="btn-green" onclick="saveWeight()">Save Weight</button>
    <button class="btn-outline" onclick="document.getElementById('weightModal').classList.remove('open')">Cancel</button>
  </div>
</div>

<!-- Add Event Modal -->
<div class="modal-overlay" id="addEventModal">
  <div class="modal-sheet">
    <div class="modal-handle"></div>
    <div class="modal-title" id="addEventModalTitle">🏁 Add Event / Goal</div>
    <div class="modal-sub">Race, milestone, or weight target</div>
    <input type="hidden" id="eventEditId" value="" />
    <div id="evtTypeRow" style="display:flex;gap:8px;margin-bottom:14px">
      <button id="evtTypeRace" onclick="setEventType('race')" style="flex:1;padding:8px;border-radius:10px;border:2px solid #3b82f6;background:#3b82f6;color:#fff;font-weight:700;font-size:13px;cursor:pointer;font-family:inherit">🏁 Race/Event</button>
      <button id="evtTypeWeight" onclick="setEventType('weight')" style="flex:1;padding:8px;border-radius:10px;border:2px solid var(--border);background:var(--surface2);color:var(--text2);font-weight:700;font-size:13px;cursor:pointer;font-family:inherit">⚖️ Weight Goal</button>
    </div>
    <input type="text" id="eventNameInput" class="big-input" placeholder="e.g. Grandma's Marathon" style="margin-bottom:12px" />
    <input type="date" id="eventDateInput" class="big-input" style="margin-bottom:12px" />
    <div id="eventWeightRow" style="display:none;margin-bottom:12px">
      <input type="number" id="eventWeightTarget" class="big-input" placeholder="Target weight (lbs)" step="0.1" />
    </div>
    <button class="btn-green" id="saveEventBtn" onclick="saveEvent()">Save</button>
    <button class="btn-outline" onclick="document.getElementById('addEventModal').classList.remove('open')">Cancel</button>
  </div>
</div>

<!-- Edit Food Entry Modal -->
<div class="modal-overlay" id="editEntryModal">
  <div class="modal-sheet">
    <div class="modal-handle"></div>
    <div class="modal-title">✏️ Edit Entry</div>
    <div class="modal-sub" id="editEntrySubtitle">Adjust servings or macros directly</div>
    <input type="hidden" id="editEntryId" />

    <div style="margin-bottom:12px">
      <div style="font-size:10px;font-weight:700;color:var(--text2);letter-spacing:1px;text-transform:uppercase;margin-bottom:5px">Food Name</div>
      <input type="text" id="editEntryName" placeholder="Food name" />
    </div>

    <!-- Servings stepper — shown when base macros are stored -->
    <div id="editServingsRow" style="display:none;align-items:center;justify-content:space-between;background:var(--surface2);border:1.5px solid var(--border);border-radius:14px;padding:10px 16px;margin-bottom:14px">
      <div>
        <div style="font-size:12px;font-weight:700;color:var(--text)">Servings</div>
        <div style="font-size:10px;color:var(--text3);margin-top:2px" id="editServingBaseLabel"></div>
      </div>
      <div style="display:flex;align-items:center;gap:12px">
        <button class="srv-btn" onclick="adjustEditServings(-0.5)">−</button>
        <div style="font-size:18px;font-weight:700;color:var(--text);min-width:32px;text-align:center" id="editServingsDisplay">1</div>
        <button class="srv-btn" onclick="adjustEditServings(0.5)">+</button>
      </div>
    </div>

    <!-- Macro fields — auto-update with servings, or editable directly -->
    <div style="font-size:10px;font-weight:700;color:var(--text2);letter-spacing:1px;text-transform:uppercase;margin-bottom:8px" id="editMacroLabel">Macros per serving</div>
    <div class="edit-macro-grid">
      <div class="edit-macro-field">
        <label style="color:#f59e0b">CALORIES (kcal)</label>
        <input type="number" id="editCalories" placeholder="0" oninput="onEditMacroInput()" />
      </div>
      <div class="edit-macro-field">
        <label style="color:#22c55e">PROTEIN (g)</label>
        <input type="number" id="editProtein" placeholder="0" oninput="onEditMacroInput()" />
      </div>
      <div class="edit-macro-field">
        <label style="color:#3b82f6">CARBS (g)</label>
        <input type="number" id="editCarbs" placeholder="0" oninput="onEditMacroInput()" />
      </div>
      <div class="edit-macro-field">
        <label style="color:#ef4444">FAT (g)</label>
        <input type="number" id="editFat" placeholder="0" oninput="onEditMacroInput()" />
      </div>
    </div>

    <!-- Live total preview -->
    <div id="editTotalPreview" style="display:none;background:var(--surface2);border-radius:12px;padding:10px 14px;margin-bottom:14px;font-size:12px;font-weight:700;color:var(--text);display:flex;justify-content:space-between;align-items:center">
      <span style="color:var(--text3);font-size:10px;text-transform:uppercase;letter-spacing:1px">Total</span>
      <span id="editTotalText"></span>
    </div>

    <button class="btn-green" onclick="saveEditedEntry()">Save Changes</button>
    <button class="btn-outline" onclick="document.getElementById('editEntryModal').classList.remove('open')">Cancel</button>
  </div>
</div>

<!-- Barcode Scanner Modal -->
<div class="modal-overlay" id="scannerModal">
  <div class="modal-sheet">
    <div class="modal-handle"></div>
    <div class="modal-title">Scan Food Barcode</div>
    <div class="modal-sub" id="scanSubtitle">Point your camera at a barcode</div>

    <!-- Camera view -->
    <div class="scanner-frame" id="cameraView">
      <div id="quagga-container" style="width:100%;border-radius:18px;overflow:hidden;background:#000;aspect-ratio:4/3;position:relative;">
        <video id="scanner-video" style="display:none"></video>
      </div>
      <div class="scanner-overlay" style="pointer-events:none;border-radius:18px">
        <div class="scanner-line"></div>
        <div class="scanner-corners"></div>
      </div>
    </div>

    <div class="scan-status" id="scanStatus">🔍 Scanning for barcode…</div>

    <!-- Food result (hidden until found) -->
    <div id="foodResult" style="display:none">
      <div class="food-result">
        <div class="food-name" id="foodName"></div>
        <div class="food-brand" id="foodBrand"></div>
        <div class="food-macros" id="foodMacros"></div>
        <div id="scanMacroWarning" style="display:none;background:#2d0f0f;border:1px solid #7f1d1d;border-radius:10px;padding:8px 12px;margin-top:8px;font-size:11px;color:#fca5a5;font-weight:500;line-height:1.5"></div>
        <div class="servings-row">
          <div class="servings-label">Servings</div>
          <div class="servings-ctrl">
            <button class="srv-btn" onclick="adjustServings(-0.5)">−</button>
            <div class="srv-val" id="srvVal">1</div>
            <button class="srv-btn" onclick="adjustServings(0.5)">+</button>
          </div>
        </div>
        <!-- Save to favorites -->
        <div style="margin-top:12px;padding-top:12px;border-top:1px solid var(--border)">
          <div style="font-size:11px;font-weight:700;color:var(--text2);letter-spacing:1px;text-transform:uppercase;margin-bottom:8px">Save as Quick-Add</div>
          <div style="font-size:11px;color:var(--text3);font-weight:500;margin-bottom:8px">Save to a meal time for smart recommendations</div>
          <div class="time-slot-picker" id="scanTimeSlotPicker">
            <button class="ts-btn" data-slot="breakfast" onclick="toggleTimeSlot(this,'scan')">🌅 Breakfast</button>
            <button class="ts-btn" data-slot="morning" onclick="toggleTimeSlot(this,'scan')">☕ Morning Snack</button>
            <button class="ts-btn" data-slot="lunch" onclick="toggleTimeSlot(this,'scan')">🥗 Lunch</button>
            <button class="ts-btn" data-slot="afternoon" onclick="toggleTimeSlot(this,'scan')">🍎 Afternoon</button>
            <button class="ts-btn" data-slot="dinner" onclick="toggleTimeSlot(this,'scan')">🍽️ Dinner</button>
            <button class="ts-btn" data-slot="evening" onclick="toggleTimeSlot(this,'scan')">🌙 Evening</button>
          </div>
        </div>
      </div>
      <button class="btn-green" onclick="logScannedFood()">Add to Today's Log</button>
    </div>

    <button class="btn-outline" onclick="closeScanner()">Cancel</button>
  </div>
</div>

<!-- AI Photo Macro Modal -->
<div class="modal-overlay" id="photoModal">
  <div class="modal-sheet">
    <div class="modal-handle"></div>
    <div class="modal-title">📸 AI Macro Estimator</div>
    <div class="modal-sub">Take or upload a photo of your food and AI will estimate the macros</div>

    <!-- Step 1: capture -->
    <div id="photoStep1">
      <div id="photoPreviewWrap" style="display:none;margin-bottom:14px;position:relative">
        <img id="photoPreview" style="width:100%;border-radius:18px;max-height:280px;object-fit:cover"/>
        <button onclick="resetPhoto()" style="position:absolute;top:10px;right:10px;background:rgba(0,0,0,0.55);border:none;border-radius:50%;width:30px;height:30px;color:#fff;font-size:16px;cursor:pointer;display:flex;align-items:center;justify-content:center">✕</button>
      </div>
      <div id="photoPlaceholder" style="background:var(--surface2);border:2px dashed var(--border);border-radius:18px;padding:36px 20px;text-align:center;margin-bottom:14px">
        <div style="font-size:40px;margin-bottom:8px">🍽️</div>
        <div style="font-size:14px;font-weight:600;color:var(--text2)">No photo yet</div>
        <div style="font-size:12px;color:var(--text3);margin-top:4px">Take a photo or pick from your library</div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:12px">
        <button class="btn-scan" onclick="triggerCamera()">📷 Camera</button>
        <button class="btn-scan" onclick="triggerGallery()">🖼️ Gallery</button>
      </div>
      <input type="file" id="cameraInput" accept="image/*" capture="environment" style="display:none" onchange="handlePhotoInput(this)"/>
      <input type="file" id="galleryInput" accept="image/*" style="display:none" onchange="handlePhotoInput(this)"/>

      <!-- Food description hint -->
      <div style="margin-bottom:12px">
        <input type="text" id="photoHint" placeholder="Optional: describe the food (e.g. grilled salmon with rice)" />
      </div>

      <button class="btn-green" id="analyzeBtn" onclick="analyzePhoto()" disabled style="opacity:0.4">
        🤖 Analyse with AI
      </button>
    </div>

    <!-- Step 2: loading -->
    <div id="photoStep2" style="display:none;text-align:center;padding:30px 0">
      <div style="font-size:48px;margin-bottom:16px;animation:spin 1.2s linear infinite;display:inline-block">🔄</div>
      <div style="font-size:16px;font-weight:700;color:var(--text);margin-bottom:8px">Analysing your food…</div>
      <div style="font-size:12px;color:var(--text3)" id="aiLoadingMsg">Identifying ingredients and estimating portions…</div>
    </div>

    <!-- Step 3: results -->
    <div id="photoStep3" style="display:none">
      <div class="food-result">
        <div class="food-name" id="aiMealName"></div>
        <div class="food-brand" id="aiMealDesc" style="line-height:1.6;margin-bottom:12px"></div>
        <div class="food-macros" id="aiMealMacros"></div>
        <div style="background:#2d1f05;border:1.5px solid #3d2e00;border-radius:12px;padding:10px 12px;margin-bottom:14px;font-size:11px;color:#f59e0b;line-height:1.6">
          ⚠️ AI estimates are approximate. Adjust servings if portion differs from what's shown.
        </div>
        <div class="servings-row">
          <div class="servings-label">Servings / portion</div>
          <div class="servings-ctrl">
            <button class="srv-btn" onclick="adjustAIServings(-0.25)">−</button>
            <div class="srv-val" id="aiSrvVal">1</div>
            <button class="srv-btn" onclick="adjustAIServings(0.25)">+</button>
          </div>
        </div>
        <!-- Save to slot -->
        <div style="margin-top:12px;padding-top:12px;border-top:1px solid var(--border)">
          <div style="font-size:11px;font-weight:700;color:var(--text2);letter-spacing:1px;text-transform:uppercase;margin-bottom:8px">Save as Quick-Add</div>
          <div class="time-slot-picker" id="aiTimeSlotPicker">
            <button class="ts-btn" data-slot="breakfast" onclick="toggleTimeSlot(this,'ai')">🌅 Breakfast</button>
            <button class="ts-btn" data-slot="morning" onclick="toggleTimeSlot(this,'ai')">☕ Morning Snack</button>
            <button class="ts-btn" data-slot="lunch" onclick="toggleTimeSlot(this,'ai')">🥗 Lunch</button>
            <button class="ts-btn" data-slot="afternoon" onclick="toggleTimeSlot(this,'ai')">🍎 Afternoon</button>
            <button class="ts-btn" data-slot="dinner" onclick="toggleTimeSlot(this,'ai')">🍽️ Dinner</button>
            <button class="ts-btn" data-slot="evening" onclick="toggleTimeSlot(this,'ai')">🌙 Evening</button>
          </div>
        </div>
      </div>
      <button class="btn-green" onclick="logAIFood()">Add to Today's Log</button>
      <button class="btn-outline" style="margin-top:8px" onclick="resetPhoto()">Try Another Photo</button>
    </div>

    <button class="btn-outline" style="margin-top:10px" onclick="closePhotoModal()">Cancel</button>
  </div>
</div>

<!-- Settings Modal -->
<div class="modal-overlay" id="settingsModal">
  <div class="modal-sheet">
    <div class="modal-handle"></div>
    <div class="modal-title">⚙️ Settings</div>

    <div class="settings-section">
      <div class="settings-section-title">🏃 Garmin Connect</div>
      <div id="garminConnectStatus" class="connect-status disconnected">⚪ Not connected</div>

      <div id="garminSetupSteps">
        <div style="font-size:12px;color:var(--text2);margin-bottom:14px;line-height:1.7">
          Connect your Garmin account to automatically pull run calories and adjust your daily macros.
        </div>
        <div style="font-size:11px;font-weight:700;color:var(--text3);letter-spacing:1px;text-transform:uppercase;margin-bottom:10px">Setup steps</div>
        <div class="oauth-step">
          <div class="step-num">1</div>
          <div class="oauth-step-text">Visit <a href="https://developer.garmin.com/gc-developer-program/overview/" target="_blank">developer.garmin.com</a>, sign in with your Garmin account and join the free Developer Program.</div>
        </div>
        <div class="oauth-step">
          <div class="step-num">2</div>
          <div class="oauth-step-text">Create a new app → type <strong>Web</strong> → set the OAuth Callback URL to this app's URL. Copy your <strong>Consumer Key</strong> and <strong>Consumer Secret</strong>.</div>
        </div>
        <div class="oauth-step">
          <div class="step-num">3</div>
          <div class="oauth-step-text">Paste them below and tap <strong>Connect</strong>. You'll authorize access on Garmin's site and be redirected back automatically.</div>
        </div>
        <div style="margin-top:16px">
          <div class="key-input-group">
            <div class="key-input-label">CONSUMER KEY</div>
            <input type="text" id="garminKey" placeholder="Paste your Consumer Key…" />
          </div>
          <div class="key-input-group" style="margin-top:8px">
            <div class="key-input-label">CONSUMER SECRET</div>
            <input type="text" id="garminSecret" placeholder="Paste your Consumer Secret…" />
          </div>
          <button class="btn-green" style="margin-top:10px" onclick="startGarminOAuth()">🔗 Connect to Garmin</button>
        </div>
      </div>

      <div id="garminConnectedPanel" style="display:none">
        <div class="settings-row">
          <div>
            <div class="settings-row-label">Auto-adjust macros</div>
            <div class="settings-row-sub">Adds calories & carbs based on run burn</div>
          </div>
          <button class="toggle on" id="autoAdjustToggle" onclick="toggleAutoAdjust(this)"></button>
        </div>
        <div class="settings-row">
          <div>
            <div class="settings-row-label">Connected as</div>
            <div class="settings-row-sub" id="garminUsername">—</div>
          </div>
        </div>
        <button class="btn-red" onclick="disconnectGarmin()">Disconnect Garmin</button>
      </div>
    </div>

    <!-- Strava Section -->
    <div class="settings-section">
      <div class="settings-section-title">🟠 Strava</div>
      <div id="stravaConnectStatus" class="connect-status disconnected">⚪ Not connected</div>

      <div id="stravaSetupSteps">
        <div style="font-size:12px;color:var(--text2);margin-bottom:14px;line-height:1.7">
          Connect Strava to pull run calories automatically. Strava's API is simpler to set up than Garmin — takes about 2 minutes.
        </div>
        <div style="font-size:11px;font-weight:700;color:var(--text3);letter-spacing:1px;text-transform:uppercase;margin-bottom:10px">Setup steps</div>
        <div class="oauth-step">
          <div class="step-num">1</div>
          <div class="oauth-step-text">Go to <a href="https://www.strava.com/settings/api" target="_blank">strava.com/settings/api</a> and create a free API app. Set the <strong>Authorization Callback Domain</strong> to your app's domain (e.g. <code style="background:var(--surface2);padding:1px 5px;border-radius:4px">yourapp.netlify.app</code>).</div>
        </div>
        <div class="oauth-step">
          <div class="step-num">2</div>
          <div class="oauth-step-text">Copy your <strong>Client ID</strong> and <strong>Client Secret</strong> from the API settings page.</div>
        </div>
        <div class="oauth-step">
          <div class="step-num">3</div>
          <div class="oauth-step-text">Paste them below and tap <strong>Connect</strong>. You'll authorize on Strava's site and be redirected back automatically.</div>
        </div>
        <div style="margin-top:16px">
          <div class="key-input-group">
            <div class="key-input-label">CLIENT ID</div>
            <input type="text" id="stravaClientId" placeholder="e.g. 12345" />
          </div>
          <div class="key-input-group" style="margin-top:8px">
            <div class="key-input-label">CLIENT SECRET</div>
            <input type="text" id="stravaClientSecret" placeholder="Paste your Client Secret…" />
          </div>
          <button class="btn-green" style="margin-top:10px;background:#fc4c02;box-shadow:0 4px 14px rgba(252,76,2,0.3)" onclick="startStravaOAuth()">🟠 Connect to Strava</button>
        </div>
      </div>

      <div id="stravaConnectedPanel" style="display:none">
        <div class="settings-row">
          <div>
            <div class="settings-row-label">Auto-adjust macros</div>
            <div class="settings-row-sub">Adds calories & carbs based on run burn</div>
          </div>
          <button class="toggle on" id="stravaAutoAdjustToggle" onclick="toggleStravaAutoAdjust(this)"></button>
        </div>
        <div class="settings-row">
          <div>
            <div class="settings-row-label">Connected as</div>
            <div class="settings-row-sub" id="stravaUsername">—</div>
          </div>
        </div>
        <button class="btn-red" onclick="disconnectStrava()">Disconnect Strava</button>
      </div>
    </div>
      <div class="settings-section-title">🎯 Goals & Macros</div>
      <div class="settings-row">
        <div><div class="settings-row-label">Current weight (lbs)</div></div>
        <input type="number" id="settingWeight" style="width:80px;text-align:center;padding:8px" placeholder="170" />
      </div>
      <div class="settings-row">
        <div><div class="settings-row-label">Goal weight (lbs)</div></div>
        <input type="number" id="settingGoalWeight" style="width:80px;text-align:center;padding:8px" placeholder="163" />
      </div>
      <div style="font-size:11px;font-weight:700;color:var(--text3);letter-spacing:1px;text-transform:uppercase;margin:14px 0 8px">Maintenance Calories (TDEE)</div>
      <div style="font-size:11px;color:var(--text2);line-height:1.6;margin-bottom:8px">Your daily calorie burn at rest + activity, before any deficit. The weekly balance chart measures your deficit against this.</div>
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">
        <input type="number" id="settingTDEE" style="width:100px;text-align:center;padding:8px" placeholder="2800" />
        <button onclick="autoCalcTDEE()" style="flex:1;padding:9px 12px;background:var(--surface2);border:1.5px solid var(--border);border-radius:14px;color:var(--text2);font-family:inherit;font-size:11px;font-weight:700;cursor:pointer">🧮 Auto-calculate from my data</button>
      </div>
      <div id="tdeeCalcResult" style="display:none;font-size:11px;line-height:1.7;padding:10px 12px;background:var(--surface2);border-radius:12px;border:1px solid var(--border);margin-bottom:10px"></div>

      <div style="font-size:11px;font-weight:700;color:var(--text3);letter-spacing:1px;text-transform:uppercase;margin:14px 0 8px">Daily Macro Targets</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:10px">
        <div>
          <div style="font-size:10px;font-weight:700;color:#f59e0b;letter-spacing:1px;text-transform:uppercase;margin-bottom:4px">Calories (kcal)</div>
          <input type="number" id="settingCalories" style="text-align:center;padding:8px" placeholder="2200" />
        </div>
        <div>
          <div style="font-size:10px;font-weight:700;color:#4ade80;letter-spacing:1px;text-transform:uppercase;margin-bottom:4px">Protein (g)</div>
          <input type="number" id="settingProtein" style="text-align:center;padding:8px" placeholder="190" />
        </div>
        <div>
          <div style="font-size:10px;font-weight:700;color:#60a5fa;letter-spacing:1px;text-transform:uppercase;margin-bottom:4px">Carbs (g)</div>
          <input type="number" id="settingCarbs" style="text-align:center;padding:8px" placeholder="190" />
        </div>
        <div>
          <div style="font-size:10px;font-weight:700;color:#f87171;letter-spacing:1px;text-transform:uppercase;margin-bottom:4px">Fat (g)</div>
          <input type="number" id="settingFat" style="text-align:center;padding:8px" placeholder="65" />
        </div>
      </div>
      <button class="btn-green" style="margin-top:4px" onclick="saveGoalSettings()">💾 Save Goals & Macros</button>
    </div>

    <button class="btn-outline" onclick="closeSettings()">Close</button>

    <div style="margin-top:16px;padding-top:16px;border-top:1px solid var(--border)">
      <div class="settings-section-title">💾 Data Backup & Restore</div>
      <div style="font-size:12px;color:var(--text2);line-height:1.7;margin-bottom:14px">Export all your food logs, weight entries, workouts, and recipes to a file. Import it anytime to restore — even on a new device or after re-deploying.</div>

      <button class="btn-green" onclick="exportData()" style="margin-bottom:10px">
        ⬇️ Export All Data (JSON)
      </button>

      <div style="font-size:11px;font-weight:700;color:var(--text2);letter-spacing:1px;text-transform:uppercase;margin-bottom:8px">Restore from backup</div>
      <label style="display:flex;align-items:center;justify-content:center;gap:10px;width:100%;padding:13px;background:var(--blue-soft);color:#60a5fa;border:1.5px solid #1e3a5f;border-radius:16px;font-family:inherit;font-weight:700;font-size:14px;cursor:pointer">
        ⬆️ Import Backup File
        <input type="file" id="importFileInput" accept=".json" style="display:none" onchange="importData(this)" />
      </label>
      <div id="importStatus" style="margin-top:10px;font-size:12px;text-align:center;color:var(--green);font-weight:600;display:none"></div>
    </div>
  </div>

<!-- Rest Timer Overlay -->
<div id="restTimerOverlay" style="display:none" class="rest-timer-overlay">
  <div>
    <div class="rest-timer-label">Rest</div>
    <div class="rest-timer-countdown" id="restTimerCount">1:30</div>
    <div class="rest-timer-bar"><div class="rest-timer-bar-fill" id="restTimerBarFill" style="width:100%"></div></div>
  </div>
  <button class="rest-timer-skip" onclick="skipRestTimer()">Skip ›</button>
</div>

<!-- Exercise Progress Chart Modal -->
<div class="ex-chart-modal" id="exChartModal" style="display:none" onclick="if(event.target===this)closeExChart()">
  <div class="ex-chart-sheet">
    <div class="modal-handle"></div>
    <div class="ex-chart-title" id="exChartTitle"></div>
    <div class="ex-chart-sub" id="exChartSub"></div>
    <svg class="ex-chart-svg" id="exChartSvg" viewBox="0 0 300 140"></svg>
    <div class="ex-stats-row" id="exChartStats"></div>
    <button class="btn-outline" style="margin-top:16px;width:100%" onclick="closeExChart()">Close</button>
  </div>
</div>

<!-- Workout Complete Overlay -->
<div class="workout-complete-overlay" id="workoutCompleteOverlay" style="display:none">
  <div class="workout-complete-icon">💪</div>
  <div class="workout-complete-title">Workout Complete!</div>
  <div class="workout-complete-sub" id="wcSub">Great session today</div>
  <div class="workout-complete-stats" id="wcStats"></div>
  <div class="wc-prs" id="wcPRs" style="display:none">
    <div style="font-size:11px;font-weight:800;color:#f59e0b;letter-spacing:1px;text-transform:uppercase;margin-bottom:8px">🏆 Personal Records</div>
    <div id="wcPRList"></div>
  </div>
  <button class="btn-green" style="width:100%;max-width:340px" onclick="closeWorkoutComplete()">Done 🎉</button>
</div>

<!-- OAuth Result Modal -->
<div class="modal-overlay" id="oauthModal">
  <div class="modal-sheet" style="text-align:center;padding:36px 20px 48px">
    <div style="font-size:52px;margin-bottom:16px" id="oauthIcon">⏳</div>
    <div style="font-size:18px;font-weight:700;color:var(--text);margin-bottom:8px" id="oauthTitle">Connecting…</div>
    <div style="font-size:13px;color:var(--text2);line-height:1.7" id="oauthMsg">Completing authorization. Please wait…</div>
    <button class="btn-outline" style="margin-top:24px" onclick="document.getElementById('oauthModal').classList.remove('open')">Close</button>
  </div>
</div>


    <!-- CLAUDE AI PAGE -->
    <div id="page-claude" class="page">
      <div style="display:flex;flex-direction:column;height:calc(100vh - 56px);position:relative;overflow:hidden">

        <!-- INPUT BAR - TOP (most important - first thing visible) -->
        <div style="padding:10px 12px 8px;background:#0a0f1a;border-bottom:1px solid #1e293b;flex-shrink:0">
          <div style="display:flex;gap:8px;align-items:flex-end">
            <textarea id="claudeInput" placeholder="Ask your AI coach..." rows="1"
              style="flex:1;background:#111827;border:1.5px solid #1e3a5f;border-radius:14px;padding:10px 14px;color:#fff;font-size:14px;font-family:inherit;resize:none;outline:none;max-height:100px;overflow-y:auto;line-height:1.4"
              onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendClaudeMessage()}"
              oninput="this.style.height='auto';this.style.height=Math.min(this.scrollHeight,100)+'px'"></textarea>
            <button onclick="sendClaudeMessage()"
              style="background:linear-gradient(135deg,#2563eb,#1d4ed8);border:none;border-radius:12px;width:42px;height:42px;color:white;font-size:18px;cursor:pointer;flex-shrink:0;display:flex;align-items:center;justify-content:center">➤</button>
          </div>

          <!-- Quick prompts - horizontal scroll, compact -->
          <div style="display:flex;gap:6px;overflow-x:auto;margin-top:8px;scrollbar-width:none;-webkit-overflow-scrolling:touch">
            <button onclick="claudeQuickPrompt('What should I eat to hit my remaining macros today?')"
              style="white-space:nowrap;background:#0f172a;border:1px solid #1e3a5f;color:#60a5fa;border-radius:16px;padding:5px 11px;font-size:11px;font-weight:600;cursor:pointer;font-family:inherit;flex-shrink:0">🥗 Meals</button>
            <button onclick="claudeQuickPrompt('Analyze my nutrition this week and give me insights.')"
              style="white-space:nowrap;background:#0f172a;border:1px solid #1e3a5f;color:#60a5fa;border-radius:16px;padding:5px 11px;font-size:11px;font-weight:600;cursor:pointer;font-family:inherit;flex-shrink:0">📊 Weekly</button>
            <button onclick="claudeQuickPrompt('Should I run today based on my workout schedule and recovery?')"
              style="white-space:nowrap;background:#0f172a;border:1px solid #1e3a5f;color:#60a5fa;border-radius:16px;padding:5px 11px;font-size:11px;font-weight:600;cursor:pointer;font-family:inherit;flex-shrink:0">🏃 Run?</button>
            <button onclick="claudeQuickPrompt('How am I tracking toward my weight loss goal?')"
              style="white-space:nowrap;background:#0f172a;border:1px solid #1e3a5f;color:#60a5fa;border-radius:16px;padding:5px 11px;font-size:11px;font-weight:600;cursor:pointer;font-family:inherit;flex-shrink:0">⚖️ Weight</button>
            <button onclick="claudeQuickPrompt('Give me a summary of my latest blood work results and what to focus on.')"
              style="white-space:nowrap;background:#0f172a;border:1px solid #1e3a5f;color:#60a5fa;border-radius:16px;padding:5px 11px;font-size:11px;font-weight:600;cursor:pointer;font-family:inherit;flex-shrink:0">🩸 Blood</button>
            <button onclick="claudeQuickPrompt('What should my workout be today?')"
              style="white-space:nowrap;background:#0f172a;border:1px solid #1e3a5f;color:#60a5fa;border-radius:16px;padding:5px 11px;font-size:11px;font-weight:600;cursor:pointer;font-family:inherit;flex-shrink:0">💪 Workout</button>
            <button onclick="triggerAppImprovement()"
              style="white-space:nowrap;background:#0f172a;border:1px solid #7c3aed;color:#a78bfa;border-radius:16px;padding:5px 11px;font-size:11px;font-weight:600;cursor:pointer;font-family:inherit;flex-shrink:0">💡 Improve</button>
          </div>
        </div>

        <!-- CHAT MESSAGES -->
        <div id="claudeChatMessages" style="flex:1;overflow-y:auto;padding:12px 14px;display:flex;flex-direction:column;gap:10px">
          <div style="text-align:center;color:#334155;font-size:12px;margin-top:12px">Ask me anything about your fitness, nutrition, or training.</div>
        </div>



      </div>
    </div>

<div class="tab-bar">
  <button class="tab-btn active" onclick="switchTab('today',this)"><span class="tab-icon">🏠</span>Today</button>
  <button class="tab-btn" onclick="switchTab('recipes',this)"><span class="tab-icon">🍽️</span>Recipes</button>
  <button class="tab-btn" onclick="switchTab('shoes',this)"><span class="tab-icon">👟</span>Shoes</button>
  <button class="tab-btn" onclick="switchTab('lift',this)"><span class="tab-icon">🏋️</span>Workout</button>
  <button class="tab-btn" onclick="switchTab('program',this)"><span class="tab-icon">📋</span>Program</button>
  <button class="tab-btn" onclick="switchTab('history',this)"><span class="tab-icon">🗓️</span>History</button>
  <button class="tab-btn" onclick="switchTab('claude',this)"><span class="tab-icon">🤖</span>AI</button>
</div>

<script>

const MACROS = { calories: 2200, protein: 190, carbs: 190, fat: 65 };
const TDEE   = 2800; // Maintenance calories — target is 600 kcal below this
const MACRO_COLORS = { calories: '#f59e0b', protein: '#4ade80', carbs: '#60a5fa', fat: '#f87171' };

const PROGRAM = {
  A: { name: 'Push Day A', exercises: [
    { name: 'Barbell Bench Press', sets: 4, reps: '6–8', notes: 'Primary chest builder' },
    { name: 'Incline Dumbbell Press', sets: 3, reps: '8–10', notes: '' },
    { name: 'Overhead Press', sets: 4, reps: '6–8', notes: 'Seated or standing' },
    { name: 'Lateral Raises', sets: 3, reps: '12–15', notes: 'Light, controlled' },
    { name: 'Tricep Pushdowns', sets: 3, reps: '10–12', notes: '' },
    { name: 'Overhead Tricep Ext.', sets: 3, reps: '10–12', notes: '' },
  ]},
  B: { name: 'Pull Day B', exercises: [
    { name: 'Barbell Row', sets: 4, reps: '6–8', notes: 'Brace core hard' },
    { name: 'Lat Pulldown', sets: 3, reps: '8–10', notes: '' },
    { name: 'Seated Cable Row', sets: 3, reps: '10–12', notes: '' },
    { name: 'Face Pulls', sets: 3, reps: '15–20', notes: 'Shoulder health essential' },
    { name: 'Barbell Curl', sets: 3, reps: '8–10', notes: '' },
    { name: 'Hammer Curl', sets: 3, reps: '10–12', notes: '' },
  ]},
  C: { name: 'Legs & Core Day C', exercises: [
    { name: 'Barbell Squat', sets: 4, reps: '6–8', notes: 'Prioritize depth & form' },
    { name: 'Romanian Deadlift', sets: 3, reps: '8–10', notes: 'Hip hinge focus' },
    { name: 'Leg Press', sets: 3, reps: '10–12', notes: '' },
    { name: 'Leg Curl', sets: 3, reps: '10–12', notes: '' },
    { name: 'Calf Raise', sets: 4, reps: '15–20', notes: '' },
    { name: 'Plank', sets: 3, reps: '45–60s', notes: '' },
  ]}
};

const WEEK = [
  { day: 'Mon', type: 'lift', sess: 'C' },
  { day: 'Tue', type: 'run', sess: null },
  { day: 'Wed', type: 'run', sess: null },
  { day: 'Thu', type: 'run', sess: null },
  { day: 'Fri', type: 'lift', sess: 'A' },
  { day: 'Sat', type: 'longrun', sess: 'B', optLift: true },
  { day: 'Sun', type: 'recoveryrun', sess: null },
];

const DAY_MAP = { Mon:1, Tue:2, Wed:3, Thu:4, Fri:5, Sat:6, Sun:0 };
// ── EST Date Helpers ──
let _nowESTcache = null, _nowESTcacheTs = 0;
function nowEST() {
  // Cache the EST time for 1 second, but always return a COPY
  // so callers can safely call setDate/setMonth etc without poisoning the cache
  const now = Date.now();
  if (now - _nowESTcacheTs >= 1000 || !_nowESTcache) {
    _nowESTcache = new Date(new Date().toLocaleString('en-US', { timeZone: 'America/New_York' }));
    _nowESTcacheTs = now;
  }
  return new Date(_nowESTcache); // always a fresh copy
}

function dateToKey(d) {
  // Format a date object as YYYY-MM-DD
  const y = d.getFullYear();
  const m = String(d.getMonth() + 1).padStart(2, '0');
  const day = String(d.getDate()).padStart(2, '0');
  return `${y}-${m}-${day}`;
}

const todayKey = () => dateToKey(nowEST());

// ── Selected Day (for viewing/editing past days) ──
let selectedDateKey = todayKey();

function getSelectedDateKey() { return selectedDateKey; }

function setSelectedDay(dateKey) {
  selectedDateKey = dateKey;
  updateDateNavBar();
  renderRings();
  renderFoodLog();
  renderWeekStrip();
  checkCopyYesterday();
  renderWeeklyBalance();
}

function shiftSelectedDay(delta) {
  const d = new Date(selectedDateKey + 'T12:00:00'); // noon to avoid DST edge
  d.setDate(d.getDate() + delta);
  const newKey = dateToKey(d);
  // Don't allow going into the future past today
  if (newKey > todayKey()) return;
  setSelectedDay(newKey);
}

function updateDateNavBar() {
  const today = todayKey();
  const isToday = selectedDateKey === today;
  const labelEl = document.getElementById('selectedDayLabel');
  const subEl   = document.getElementById('selectedDaySub');
  const nextBtn = document.getElementById('nextDayBtn');

  // Human-friendly label
  const d = new Date(selectedDateKey + 'T12:00:00');
  const dayName = d.toLocaleDateString('en-US', { weekday:'long' });
  const dateFmt = d.toLocaleDateString('en-US', { month:'short', day:'numeric', year:'numeric' });

  if (isToday) {
    labelEl.textContent = 'Today';
    labelEl.style.color = 'var(--green)';
    subEl.textContent = dateFmt;
  } else {
    const diffDays = Math.round((new Date(today + 'T12:00:00') - d) / 86400000);
    labelEl.textContent = diffDays === 1 ? 'Yesterday' : dayName;
    labelEl.style.color = 'var(--text)';
    subEl.textContent = dateFmt + (diffDays > 1 ? ` · ${diffDays} days ago` : '');
  }

  // Disable next button when viewing today
  nextBtn.style.opacity = isToday ? '0.3' : '1';
  nextBtn.style.pointerEvents = isToday ? 'none' : 'auto';
}

function getYesterdayKey() {
  const d = nowEST();
  d.setDate(d.getDate() - 1);
  return dateToKey(d);
}

// ── Header Date Display ──
function updateHeaderDate() {
  const d = nowEST();
  const label = d.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', timeZone: 'America/New_York' });
  const el = document.getElementById('headerDateLabel');
  if (el) el.textContent = label;
}

// ── Auto Midnight Refresh ──
function scheduleMidnightRefresh() {
  const now = nowEST();
  const msUntilMidnight =
    ((23 - now.getHours()) * 60 * 60 +
     (59 - now.getMinutes()) * 60 +
     (60 - now.getSeconds())) * 1000;

  setTimeout(() => {
    // New day — clear today's burn adjustment so yesterday's run doesn't carry over
    setStorage('garminAdjustedMacros', null);
    // Keep burnLog entries (historical) but clear the adjustment
    updateHeaderDate();
    renderWeekStrip();
    renderRings();
    renderFoodLog();
    renderWeightTrend();
    renderWeeklyBalance();
    checkCopyYesterday();
    checkAdaptiveMacros();
    loadDailyQuote();
    showToast('🌅 Good morning! New day started.');
    scheduleMidnightRefresh(); // schedule next midnight
  }, msUntilMidnight + 1000); // +1s buffer
}

let activeSession = 'A';

// ── HTML escape helper — prevents XSS from user-entered names in innerHTML ──
function esc(str) {
  if (!str) return '';
  return String(str)
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#39;');
}

// ── Render scheduler — batches multiple render calls within one animation frame ──
const _pendingRenders = new Set();
let   _renderRAF = null;
function scheduleRender(fn) {
  _pendingRenders.add(fn);
  if (!_renderRAF) {
    _renderRAF = requestAnimationFrame(() => {
      _renderRAF = null;
      const fns = [..._pendingRenders];
      _pendingRenders.clear();
      fns.forEach(f => f());
    });
  }
}

function getStorage(key, def) {
  try { return JSON.parse(localStorage.getItem(key)) || def; } catch { return def; }
}
function setStorage(key, val) {
  try {
    localStorage.setItem(key, JSON.stringify(val));
    return true;
  } catch(e) {
    console.error('setStorage failed for key:', key, e);
    return false;
  }
}

// ── SVG Ring ──
let ringMode = 'consumed'; // 'consumed' | 'remaining'

function setRingMode(mode) {
  ringMode = mode;
  document.getElementById('toggleConsumed').style.cssText  = `padding:5px 14px;border-radius:16px;border:none;font-family:inherit;font-size:11px;font-weight:700;cursor:pointer;transition:all 0.2s;background:${mode==='consumed'?'var(--green)':'transparent'};color:${mode==='consumed'?'#fff':'var(--text3)'}`;
  document.getElementById('toggleRemaining').style.cssText = `padding:5px 14px;border-radius:16px;border:none;font-family:inherit;font-size:11px;font-weight:700;cursor:pointer;transition:all 0.2s;background:${mode==='remaining'?'var(--blue)':'transparent'};color:${mode==='remaining'?'#fff':'var(--text3)'}`;
  renderRings();
}

function makeSVGRing(consumed, max, color, label, unit, mode) {
  const r = 36, circ = 2 * Math.PI * r;
  const remaining = Math.max(0, max - consumed);
  const over = consumed > max;

  if (mode === 'remaining') {
    const pct  = Math.min(remaining / max, 1);
    const dash = pct * circ;
    const ringColor = over ? '#ef4444' : color;
    const displayVal = over ? `-${Math.round(consumed - max)}` : (unit === 'kcal' ? Math.round(remaining) : remaining.toFixed(1).replace(/\.0$/,''));
    return `<div class="ring-wrap">
      <svg width="90" height="90" viewBox="0 0 90 90">
        <circle cx="45" cy="45" r="${r}" fill="none" stroke="#e8eaf2" stroke-width="8"/>
        <circle cx="45" cy="45" r="${r}" fill="none" stroke="${ringColor}" stroke-width="8"
          stroke-dasharray="${dash} ${circ}" stroke-linecap="round"
          transform="rotate(-90 45 45)" style="transition:stroke-dasharray 0.5s ease"/>
        <text x="45" y="41" text-anchor="middle" fill="${over?'#ef4444':'#eef0f6'}" font-size="12" font-weight="700" font-family="Plus Jakarta Sans,sans-serif">${displayVal}</text>
        <text x="45" y="55" text-anchor="middle" fill="#4d5468" font-size="9" font-family="Plus Jakarta Sans,sans-serif">${unit} left</text>
      </svg>
      <div class="ring-lbl" style="color:${ringColor}">${label}</div>
    </div>`;
  } else {
    const pct  = Math.min(consumed / max, 1);
    const dash = pct * circ;
    const ringColor = over ? '#ef4444' : color;
    const displayVal = unit === 'kcal' ? Math.round(consumed) : (Number.isInteger(consumed) ? consumed : consumed.toFixed(1).replace(/\.0$/,''));
    return `<div class="ring-wrap">
      <svg width="90" height="90" viewBox="0 0 90 90">
        <circle cx="45" cy="45" r="${r}" fill="none" stroke="#e8eaf2" stroke-width="8"/>
        <circle cx="45" cy="45" r="${r}" fill="none" stroke="${ringColor}" stroke-width="8"
          stroke-dasharray="${dash} ${circ}" stroke-linecap="round"
          transform="rotate(-90 45 45)" style="transition:stroke-dasharray 0.5s ease"/>
        <text x="45" y="41" text-anchor="middle" fill="#eef0f6" font-size="13" font-weight="700" font-family="Plus Jakarta Sans,sans-serif">${displayVal}</text>
        <text x="45" y="55" text-anchor="middle" fill="#4d5468" font-size="9" font-family="Plus Jakarta Sans,sans-serif">${unit}</text>
      </svg>
      <div class="ring-lbl" style="color:${ringColor}">${label}</div>
    </div>`;
  }
}

function renderWeekStrip() {
  const todayDow = nowEST().getDay();
  const typeColors = { lift:'#22c55e', run:'#3b82f6', rest:'#4d5468', optional:'#8b5cf6', longrun:'#f59e0b', recoveryrun:'#06b6d4' };
  const typeBg     = { lift:'#0d2d1a', run:'#0d1e3d', rest:'#1a1d26', optional:'#1a1030', longrun:'#2d1f05', recoveryrun:'#051e26' };
  const typeIcons  = { lift:'🏋️', run:'🏃', rest:'😴', optional:'🏋️', longrun:'🏃', recoveryrun:'🚶' };

  const nowE = nowEST();
  const dow  = nowE.getDay();
  const diffToMon = (dow === 0 ? -6 : 1 - dow);
  const weekKeys = WEEK.map((s, i) => {
    const d = nowEST();
    d.setDate(nowE.getDate() + diffToMon + i);
    return dateToKey(d);
  });

  document.getElementById('weekStrip').innerHTML = WEEK.map((s, i) => {
    const isToday    = DAY_MAP[s.day] === todayDow;
    const isSelected = weekKeys[i] === getSelectedDateKey();
    const c   = typeColors[s.type];
    const bg  = isToday ? typeBg[s.type] : 'var(--surface)';
    const border = isToday ? c + '60' : 'var(--border)';

    const subLabel = s.type === 'optional'
      ? `<div class="week-day-sess" style="color:#8b5cf6">OPT</div>`
      : s.type === 'longrun' && s.optLift
        ? `<div class="week-day-sess" style="color:#f59e0b">LONG</div><div style="font-size:7px;color:#8b5cf6;font-weight:800;margin-top:1px">+B OPT</div>`
      : s.type === 'longrun'
        ? `<div class="week-day-sess" style="color:#f59e0b">LONG</div>`
      : s.type === 'recoveryrun'
        ? `<div class="week-day-sess" style="color:#06b6d4">EASY</div>`
      : s.sess && s.type === 'lift'
        ? `<div class="week-day-sess" style="color:${c}">${s.sess}</div>`
      : `<div style="height:13px"></div>`;

    const selectedClass = isSelected ? ' selected' : (isToday ? ' today-card' : '');

    return `<div class="week-day${selectedClass}" style="background:${bg};border-color:${border};" onclick="setSelectedDay('${weekKeys[i]}')">
      <div class="week-day-name${isToday ? ' active-name' : ''}" style="${isToday ? `color:${c}` : ''}">${s.day}</div>
      <div class="week-day-icon">${typeIcons[s.type]}</div>
      ${subLabel}
    </div>`;
  }).join('');
}

function logMacros() {
  const cals = parseFloat(document.getElementById('in-calories').value) || 0;
  const prot = parseFloat(document.getElementById('in-protein').value)  || 0;
  const carbs= parseFloat(document.getElementById('in-carbs').value)    || 0;
  const fat  = parseFloat(document.getElementById('in-fat').value)      || 0;
  if (!cals && !prot && !carbs && !fat) { showToast('⚠️ Enter at least one value'); return; }
  const name = document.getElementById('manualFoodName').value.trim() || 'Manual Entry';
  addFoodEntry({ name, calories: cals, protein: prot, carbs, fat, icon: '✍️' });
  ['calories','protein','carbs','fat'].forEach(k => document.getElementById('in-'+k).value = '');
}

// ── Workout Page — Per-Set Logging ──
let currentSets = {};
let currentRPE  = {};

function getLastWorkout(sessKey, exIdx) {
  const liftLog = getStorage('liftLog2', {});
  const keys = Object.keys(liftLog)
    .filter(k => k.endsWith('-' + sessKey))
    .sort().reverse();
  if (!keys.length) return null;
  return liftLog[keys[0]]?.exercises?.[exIdx] || null;
}

function getSuggestedWeight(lastSets, targetReps, lastRPE) {
  if (!lastSets || !lastSets.length) return null;
  const completed = lastSets.filter(s => s.done && parseFloat(s.weight) > 0);
  if (!completed.length) return null;
  const avgWt = completed.reduce((s, x) => s + parseFloat(x.weight), 0) / completed.length;
  const rpe = lastRPE || 8;
  let mult = 1.0;
  if      (rpe <= 6)  mult = 1.05;
  else if (rpe === 7) mult = 1.025;
  else if (rpe === 8) mult = 1.0;
  else if (rpe === 9) mult = 0.975;
  else                mult = 0.95;
  return Math.round((avgWt * mult) / 2.5) * 2.5;
}

// ══════════════════════════════════════════════════════════
// WORKOUT ENGINE v2 — Timer · Rest · Set Types · PR · Charts
// ══════════════════════════════════════════════════════════

// ── Globals ──────────────────────────────────────────────────
let workoutTimerInterval = null;
let workoutStartTime     = null;
let restTimerTimeout     = null;
let restTimerInterval    = null;
let restTimerEnd         = null;
let currentRestDuration  = 90; // seconds

// ── PR Store ─────────────────────────────────────────────────
function getPRs() { return getStorage('liftPRs', {}); }
function savePRs(prs) { setStorage('liftPRs', prs); }

function checkAndUpdatePR(exName, weight, reps) {
  const prs  = getPRs();
  const key  = exName.toLowerCase().replace(/\s+/g, '_');
  const w    = parseFloat(weight) || 0;
  const r    = parseInt(reps)     || 0;
  if (!w || !r) return false;
  // Epley 1RM estimate
  const est1rm = w * (1 + r / 30);
  const prev   = prs[key] || { weight: 0, reps: 0, est1rm: 0 };
  if (est1rm > (prev.est1rm || 0)) {
    prs[key] = { weight: w, reps: r, est1rm: Math.round(est1rm * 10) / 10, date: todayKey() };
    savePRs(prs);
    return { weight: w, reps: r, est1rm: Math.round(est1rm) };
  }
  return false;
}

function flashPR(exName, pr) {
  document.querySelectorAll('.pr-flash').forEach(e => e.remove());
  const el = document.createElement('div');
  el.className = 'pr-flash';
  el.innerHTML = `<div class="pr-flash-icon">🏆</div>
    <div>
      <div class="pr-flash-text">New PR — ${exName}!</div>
      <div class="pr-flash-sub">${pr.weight} lbs × ${pr.reps} reps · ~${pr.est1rm} lbs 1RM</div>
    </div>`;
  document.body.appendChild(el);
  setTimeout(() => { el.style.opacity = '0'; el.style.transition = 'opacity 0.4s'; setTimeout(() => el.remove(), 400); }, 3500);
}

// ── Workout Timer ─────────────────────────────────────────────
function startWorkoutTimer() {
  if (workoutTimerInterval) return; // already running
  if (!workoutStartTime) workoutStartTime = Date.now();
  workoutTimerInterval = setInterval(() => {
    const elapsed = Math.floor((Date.now() - workoutStartTime) / 1000);
    const m = Math.floor(elapsed / 60);
    const s = elapsed % 60;
    const el = document.getElementById('workoutTimerDisplay');
    if (el) el.textContent = `${m}:${s.toString().padStart(2,'0')}`;
  }, 1000);
}

function stopWorkoutTimer() {
  clearInterval(workoutTimerInterval);
  workoutTimerInterval = null;
}

function getWorkoutDuration() {
  if (!workoutStartTime) return 0;
  return Math.floor((Date.now() - workoutStartTime) / 1000);
}

function resetWorkoutTimer() {
  stopWorkoutTimer();
  workoutStartTime = null;
  const el = document.getElementById('workoutTimerDisplay');
  if (el) el.textContent = '0:00';
}

function updateTimerStats() {
  // Count done sets and total volume across all exercises
  let totalDone = 0, totalVol = 0;
  Object.values(currentSets).forEach(sets => {
    sets.forEach(s => {
      if (s.done) {
        totalDone++;
        totalVol += (parseFloat(s.weight) || 0) * (parseInt(s.reps) || 0);
      }
    });
  });
  const sd = document.getElementById('timerSetsCount');
  const vd = document.getElementById('timerVolumeCount');
  if (sd) sd.textContent = totalDone;
  if (vd) vd.textContent = totalVol >= 1000 ? (totalVol / 1000).toFixed(1) + 'k' : Math.round(totalVol);
}

// ── Rest Timer ────────────────────────────────────────────────
function startRestTimer(seconds) {
  clearTimeout(restTimerTimeout);
  clearInterval(restTimerInterval);
  const overlay = document.getElementById('restTimerOverlay');
  if (!overlay) return;
  overlay.style.display = 'flex';
  restTimerEnd = Date.now() + seconds * 1000;
  const totalMs = seconds * 1000;

  function tick() {
    const remaining = Math.max(0, Math.ceil((restTimerEnd - Date.now()) / 1000));
    const m = Math.floor(remaining / 60);
    const s = remaining % 60;
    const countEl = document.getElementById('restTimerCount');
    const barEl   = document.getElementById('restTimerBarFill');
    if (countEl) countEl.textContent = `${m}:${s.toString().padStart(2,'0')}`;
    const pct = (restTimerEnd - Date.now()) / totalMs;
    if (barEl) barEl.style.width = Math.max(0, pct * 100) + '%';
  }
  tick();
  restTimerInterval = setInterval(() => {
    tick();
    if (Date.now() >= restTimerEnd) {
      clearInterval(restTimerInterval);
      overlay.style.display = 'none';
      // Vibrate if available
      if (navigator.vibrate) navigator.vibrate([200, 100, 200]);
      showToast('⏰ Rest complete — next set!');
    }
  }, 500);
}

function skipRestTimer() {
  clearTimeout(restTimerTimeout);
  clearInterval(restTimerInterval);
  const overlay = document.getElementById('restTimerOverlay');
  if (overlay) overlay.style.display = 'none';
}

// ── Set Type Management ───────────────────────────────────────
const SET_TYPES = {
  normal:  { label: 'W',   title: 'Normal',   cls: '',        desc: 'Working set' },
  warmup:  { label: 'W',   title: 'Warm-up',  cls: 'warmup',  desc: 'Not counted in volume' },
  drop:    { label: 'D',   title: 'Drop Set', cls: 'drop',    desc: 'Reduce weight, continue' },
  failure: { label: 'F',   title: 'Failure',  cls: 'failure', desc: 'Train to failure' },
};

let _setTypeMenuKey = null;
let _setTypeMenuIdx = null;

function openSetTypeMenu(key, si, btnEl) {
  closeSetTypeMenu();
  _setTypeMenuKey = key;
  _setTypeMenuIdx = si;
  const menu = document.createElement('div');
  menu.id = 'setTypeMenu';
  menu.className = 'set-type-menu';
  menu.innerHTML = Object.entries(SET_TYPES).map(([type, info]) =>
    `<div class="set-type-option" onclick="applySetType('${key}',${si},'${type}')">
      <span style="font-size:11px;font-weight:800;width:20px;color:${type==='warmup'?'#06b6d4':type==='drop'?'#a78bfa':type==='failure'?'#f87171':'var(--text3)'}">${info.title.slice(0,1)}</span>
      <div>
        <div style="font-size:13px;font-weight:700;color:var(--text)">${info.title}</div>
        <div style="font-size:10px;color:var(--text3)">${info.desc}</div>
      </div>
    </div>`
  ).join('');
  const rect = btnEl.getBoundingClientRect();
  menu.style.position = 'fixed';
  menu.style.top = (rect.bottom + 4) + 'px';
  menu.style.left = Math.max(8, rect.left - 120) + 'px';
  document.body.appendChild(menu);
  setTimeout(() => document.addEventListener('click', closeSetTypeMenuOutside), 10);
}

function closeSetTypeMenuOutside(e) {
  const menu = document.getElementById('setTypeMenu');
  if (menu && !menu.contains(e.target)) closeSetTypeMenu();
}

function closeSetTypeMenu() {
  const menu = document.getElementById('setTypeMenu');
  if (menu) menu.remove();
  document.removeEventListener('click', closeSetTypeMenuOutside);
}

function applySetType(key, si, type) {
  if (!currentSets[key]) return;
  currentSets[key][si].type = type;
  closeSetTypeMenu();
  // Re-render just the type button
  const btn = document.getElementById(`stype-${key}-${si}`);
  if (btn) {
    const info = SET_TYPES[type];
    btn.textContent = type === 'normal' ? (si + 1) : type.slice(0,1).toUpperCase();
    btn.className = 'set-type-btn ' + (info.cls || '');
    btn.title = info.title;
  }
  refreshExVolume(key);
}

// ── Add / Remove Sets ──────────────────────────────────────────
function addSetToExercise(key) {
  if (!currentSets[key]) currentSets[key] = [];
  const sets = currentSets[key];
  const lastSet = sets[sets.length - 1];
  sets.push({ weight: lastSet?.weight || '', reps: '', done: false, type: 'normal' });
  // Re-render the set rows section only
  const card = document.getElementById(`excard-${key}`);
  if (!card) return;
  const [sessKey, exIdxStr] = key.split('-');
  const ex = PROGRAM[sessKey]?.exercises?.[parseInt(exIdxStr)];
  const lastData = getLastWorkout(sessKey, parseInt(exIdxStr));
  const lastSets = lastData?.sets || null;
  const suggested = getSuggestedWeight(lastSets, ex?.reps, lastData?.rpe);
  // Replace set rows container
  const rowsContainer = card.querySelector('.set-rows');
  if (rowsContainer) rowsContainer.outerHTML = buildJustSetRows(key, ex?.reps || '8');
  else card.querySelector('.set-col-headers')?.insertAdjacentHTML('afterend', `<div class="set-rows">${buildOneSetRow(key, sets.length - 1, ex?.reps)}</div>`);
  refreshExVolume(key);
}

function removeSetFromExercise(key, si) {
  if (!currentSets[key] || currentSets[key].length <= 1) return;
  currentSets[key].splice(si, 1);
  const card = document.getElementById(`excard-${key}`);
  if (!card) return;
  const [sessKey, exIdxStr] = key.split('-');
  const ex = PROGRAM[sessKey]?.exercises?.[parseInt(exIdxStr)];
  const rowsContainer = card.querySelector('.set-rows');
  if (rowsContainer) rowsContainer.outerHTML = buildJustSetRows(key, ex?.reps || '8');
  refreshExVolume(key);
}

function buildJustSetRows(key, targetReps) {
  const sets = currentSets[key] || [];
  const rows = sets.map((s, si) => buildOneSetRow(key, si, targetReps)).join('');
  return `<div class="set-rows">${rows}</div>`;
}

function buildOneSetRow(key, si, targetReps) {
  const s = (currentSets[key] || [])[si];
  if (!s) return '';
  const type = s.type || 'normal';
  const info = SET_TYPES[type];
  const typeLabel = type === 'normal' ? (si + 1) : type.slice(0,1).toUpperCase();
  const isWarmup  = type === 'warmup';
  return `<div class="set-row" id="setrow-${key}-${si}">
    <button class="set-type-btn ${info?.cls||''}" id="stype-${key}-${si}" title="${info?.title||'Normal'}"
      onclick="openSetTypeMenu('${key}',${si},this)">${typeLabel}</button>
    <input class="set-weight-input${s.done?' completed':''}${isWarmup?' warmup-input':''}" type="number" id="sw-${key}-${si}"
      placeholder="0" value="${s.weight}"
      oninput="updateSet('${key}',${si},'weight',this.value)" style="${isWarmup?'opacity:0.6;':''}" />
    <input class="set-reps-input" type="number" id="sr-${key}-${si}"
      placeholder="${(targetReps+'').split('–')[0]||'8'}" value="${s.reps}"
      oninput="updateSet('${key}',${si},'reps',this.value)" />
    <button class="set-done-btn${s.done?' done':''}" id="sdb-${key}-${si}"
      onclick="toggleSetDone('${key}',${si})">${s.done?'✅':'○'}</button>
    <button class="btn-del-set" onclick="removeSetFromExercise('${key}',${si})" title="Remove set">✕</button>
  </div>`;
}

// ── Updated buildSetRows ──────────────────────────────────────
function buildSetRows(sessKey, exIdx, numSets, targetReps, lastSets, suggested, lastRPE) {
  const key = `${sessKey}-${exIdx}`;
  const ex  = PROGRAM[sessKey]?.exercises?.[exIdx];
  if (!currentSets[key]) {
    currentSets[key] = Array.from({ length: numSets }, () => ({
      weight: suggested ? String(suggested) : '',
      reps: '', done: false, type: 'normal',
    }));
  }
  currentRPE[key] = currentRPE[key] || lastRPE || 8;
  const sets = currentSets[key];

  // Previous session summary
  let suggestionHtml = '';
  if (lastSets && lastSets.length) {
    const done = lastSets.filter(s => s.done);
    const lastWeights = done.map(s => s.weight + ' lbs').join(', ') || '—';
    const lastRepsStr = done.map(s => s.reps + ' reps').join(', ')  || '—';
    const trend = suggested && parseFloat(done[0]?.weight) > 0
      ? (suggested > parseFloat(done[0].weight) ? '↑ ' : suggested < parseFloat(done[0].weight) ? '↓ ' : '') : '';
    const prs   = getPRs();
    const prKey = (ex?.name || '').toLowerCase().replace(/\s+/g, '_');
    const prData = prs[prKey];
    const prStr  = prData ? ` · 🏆 PR: ${prData.weight}×${prData.reps}` : '';
    suggestionHtml = `<div class="ex-suggestion" onclick="openExChart('${(ex?.name||'').replace(/'/g,"\'")}')">
      <span style="font-size:15px">🧠</span>
      <div class="ex-suggestion-text">
        Last: <strong>${lastWeights}</strong> · ${lastRepsStr}${lastRPE ? ' · RPE '+lastRPE : ''}${prStr}<br>
        ${suggested ? `Target: <strong>${trend}${suggested} lbs</strong>` : 'No suggestion yet'} <span style="font-size:10px;color:#60a5fa">· tap for chart →</span>
      </div></div>`;
  } else {
    suggestionHtml = `<div class="ex-suggestion">
      <span style="font-size:15px">💡</span>
      <div class="ex-suggestion-text">First session — enter your starting weight. Data builds over time.</div></div>`;
  }

  // Exercise notes shown inline during session
  const notesHtml = ex?.notes ? `<div style="font-size:11px;color:#60a5fa;background:#0d1e3d;border-radius:10px;padding:7px 10px;margin-bottom:10px;border:1px solid #1e3a5f">💬 ${ex.notes}</div>` : '';

  const colHeaders = `<div class="set-col-headers" style="margin-top:6px">
    <div class="set-col-lbl" style="width:32px">Type</div>
    <div class="set-col-lbl" style="flex:1;text-align:center">Weight (lbs)</div>
    <div class="set-col-lbl" style="width:54px;text-align:center">Reps</div>
    <div class="set-col-lbl" style="width:36px;text-align:center">✓</div>
    <div class="set-col-lbl" style="width:28px"></div>
  </div>`;

  const setRowsHtml = sets.map((s, si) => buildOneSetRow(key, si, targetReps)).join('');

  const rpeHtml = `<div style="font-size:10px;font-weight:700;color:var(--text3);letter-spacing:0.8px;text-transform:uppercase;margin-top:12px;margin-bottom:5px">How hard? (RPE)</div>
    <div class="rpe-row" id="rpe-${key}">
      ${[5,6,7,8,9,10].map(r =>
        `<button class="rpe-btn${currentRPE[key]===r?' active':''}" onclick="setRPE('${key}',${r})">${r}</button>`
      ).join('')}
    </div>`;

  const addSetBtn = `<button class="btn-add-set" onclick="addSetToExercise('${key}')">+ Add Set</button>`;

  const completedSets = sets.filter(s => s.done && parseFloat(s.weight) > 0 && s.type !== 'warmup');
  const totalVol = completedSets.reduce((sum, s) => sum + parseFloat(s.weight) * (parseInt(s.reps)||0), 0);
  const volHtml = completedSets.length
    ? `<div class="ex-volume">Volume: <span>${Math.round(totalVol).toLocaleString()} lbs</span> · ${completedSets.length}/${sets.filter(s=>s.type!=='warmup').length} sets</div>` : '';

  return notesHtml + suggestionHtml + colHeaders + `<div class="set-rows">${setRowsHtml}</div>` + addSetBtn + rpeHtml + volHtml;
}

function updateSet(key, si, field, val) {
  if (!currentSets[key]) return;
  currentSets[key][si][field] = val;
  refreshExVolume(key);
  updateTimerStats();
}

function refreshExVolume(key) {
  const sets = currentSets[key] || [];
  const done = sets.filter(s => s.done && parseFloat(s.weight) > 0 && s.type !== 'warmup');
  const vol  = done.reduce((sum, s) => sum + parseFloat(s.weight) * (parseInt(s.reps)||0), 0);
  const card = document.getElementById(`excard-${key}`);
  if (!card) return;
  let el = card.querySelector('.ex-volume');
  if (!el) { el = document.createElement('div'); el.className = 'ex-volume'; card.appendChild(el); }
  const allWorking = sets.filter(s => s.type !== 'warmup');
  el.innerHTML = done.length
    ? `Volume: <span>${Math.round(vol).toLocaleString()} lbs</span> · ${done.length}/${allWorking.length} sets`
    : '';
  updateTimerStats();
}

function toggleSetDone(key, si) {
  if (!currentSets[key]) return;
  const set = currentSets[key][si];
  const wtInput   = document.getElementById(`sw-${key}-${si}`);
  const repsInput = document.getElementById(`sr-${key}-${si}`);
  if (wtInput   && !set.weight) set.weight = wtInput.value   || wtInput.placeholder;
  if (repsInput && !set.reps)   set.reps   = repsInput.value || repsInput.placeholder;
  set.done = !set.done;
  const btn  = document.getElementById(`sdb-${key}-${si}`);
  const wtEl = document.getElementById(`sw-${key}-${si}`);
  if (btn)  { btn.textContent = set.done ? '✅' : '○'; btn.classList.toggle('done', set.done); }
  if (wtEl) { if (set.weight) wtEl.value = set.weight; wtEl.classList.toggle('completed', set.done); }
  const badge = document.getElementById(`exbadge-${key}`);
  if (badge) badge.classList.toggle('done', currentSets[key].every(s => s.done));
  refreshExVolume(key);

  if (set.done) {
    // Check PR
    const [sessKey, exIdxStr] = key.split('-');
    const ex = PROGRAM[sessKey]?.exercises?.[parseInt(exIdxStr)];
    if (ex && set.type !== 'warmup') {
      const pr = checkAndUpdatePR(ex.name, set.weight, set.reps);
      if (pr) flashPR(ex.name, pr);
    }
    // Start rest timer (skip for warmup sets)
    if (set.type !== 'warmup') {
      const dur = set.type === 'drop' ? 45 : (parseInt(key.split('-')[1]) === 0 ? 120 : 90);
      startRestTimer(dur);
    }
    updateTimerStats();
  } else {
    skipRestTimer();
  }
}

function setRPE(key, val) {
  currentRPE[key] = val;
  const row = document.getElementById(`rpe-${key}`);
  if (!row) return;
  row.querySelectorAll('.rpe-btn').forEach(b => b.classList.toggle('active', parseInt(b.textContent) === val));
}

// ── renderWorkoutPage ─────────────────────────────────────────
function renderWorkoutPage() {
  // Start timer if not running
  startWorkoutTimer();

  document.getElementById('sessionTabs').innerHTML = ['A','B','C'].map(k =>
    `<button class="sess-btn ${activeSession===k?'active':''}" onclick="setSession('${k}')">${k}<br><span style="font-size:9px">${PROGRAM[k].name.split(' ').slice(0,2).join(' ')}</span></button>`
  ).join('');

  const sess = PROGRAM[activeSession];
  document.getElementById('sessionHeader').innerHTML = `
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div>
        <div style="font-size:20px;font-weight:700;letter-spacing:-0.3px;color:var(--text)">${sess.name}</div>
        <div style="font-size:11px;color:var(--text2);margin-top:4px;font-weight:500">Tap set type to change · ✅ = mark done · + Add Set</div>
      </div>
      <span style="display:inline-block;padding:5px 14px;border-radius:20px;font-size:11px;font-weight:700;background:#0d2d1a;color:#22c55e">3×/wk</span>
    </div>`;

  document.getElementById('exerciseList').innerHTML = sess.exercises.map((ex, i) => {
    const key       = `${activeSession}-${i}`;
    const lastData  = getLastWorkout(activeSession, i);
    const lastSets  = lastData?.sets  || null;
    const lastRPE   = lastData?.rpe   || null;
    const suggested = getSuggestedWeight(lastSets, ex.reps, lastRPE);
    return `<div class="ex-card" id="excard-${key}">
      <div class="ex-header" style="cursor:pointer" onclick="openExChart('${ex.name.replace(/'/g,"\'")}')">
        <div class="ex-badge" id="exbadge-${key}">${i+1}</div>
        <div style="flex:1">
          <div class="ex-name">${ex.name}</div>
          <div class="ex-meta">${ex.sets} × ${ex.reps}</div>
        </div>
        <div style="font-size:10px;color:#60a5fa;font-weight:600">📈 chart</div>
      </div>
      ${buildSetRows(activeSession, i, ex.sets, ex.reps, lastSets, suggested, lastRPE)}
    </div>`;
  }).join('');

  updateTimerStats();
}

function setSession(s) {
  activeSession = s;
  currentSets = {};
  currentRPE  = {};
  resetWorkoutTimer();
  if (document.getElementById('workoutNotesInput')) document.getElementById('workoutNotesInput').value = '';
  renderWorkoutPage();
}

// ── saveWorkout → show completion screen ──────────────────────
function saveWorkout() {
  const liftLog = getStorage('liftLog2', {});
  const key     = `${todayKey()}-${activeSession}`;
  const durSecs = getWorkoutDuration();
  const exercises = PROGRAM[activeSession].exercises.map((ex, i) => ({
    name: ex.name,
    sets: currentSets[`${activeSession}-${i}`] || [],
    rpe:  currentRPE[`${activeSession}-${i}`]  || null,
  }));
  const notes = (document.getElementById('workoutNotesInput')?.value || '').trim();
  liftLog[key] = { session: activeSession, date: todayKey(), exercises, notes, duration: durSecs };
  setStorage('liftLog2', liftLog);
  logInteraction('workout_saved', activeSession);
  const totalDone = exercises.reduce((n, ex) => n + ex.sets.filter(s => s.done).length, 0);
  const totalSets = exercises.reduce((n, ex) => n + ex.sets.length, 0);
  const totalVol  = exercises.reduce((n, ex) =>
    n + ex.sets.filter(s => s.done && s.type !== 'warmup').reduce((sv, s) => sv + (parseFloat(s.weight)||0) * (parseInt(s.reps)||0), 0), 0);

  // Collect today's PRs
  const prs = getPRs();
  const todayPRs = Object.values(prs).filter(p => p.date === todayKey());

  // Reset state
  currentSets = {};
  currentRPE  = {};
  stopWorkoutTimer();
  skipRestTimer();
  if (document.getElementById('workoutNotesInput')) document.getElementById('workoutNotesInput').value = '';

  renderStreakCard();
  showWorkoutComplete(totalDone, totalSets, totalVol, durSecs, todayPRs, exercises);
}


// ── Workout Complete Screen ───────────────────────────────────
function showWorkoutComplete(done, total, volume, durSecs, prList, exercises) {
  const overlay = document.getElementById('workoutCompleteOverlay');
  if (!overlay) { renderWorkoutPage(); return; }

  const m = Math.floor(durSecs / 60);
  const s = durSecs % 60;
  const durStr = durSecs > 0 ? `${m}:${s.toString().padStart(2,'0')}` : '—';

  // Workout ordinal
  const liftLog = getStorage('liftLog2', {});
  const totalWorkouts = Object.keys(liftLog).length;

  document.getElementById('wcSub').textContent = `Session #${totalWorkouts} · ${PROGRAM[activeSession].name}`;

  document.getElementById('wcStats').innerHTML = `
    <div class="wc-stat">
      <div class="wc-stat-val" style="color:#60a5fa">${durStr}</div>
      <div class="wc-stat-lbl">Duration</div>
    </div>
    <div class="wc-stat">
      <div class="wc-stat-val" style="color:#22c55e">${done}/${total}</div>
      <div class="wc-stat-lbl">Sets Done</div>
    </div>
    <div class="wc-stat">
      <div class="wc-stat-val" style="color:#f59e0b">${volume >= 1000 ? (volume/1000).toFixed(1)+'k' : Math.round(volume)}</div>
      <div class="wc-stat-lbl">Total Volume</div>
    </div>
    <div class="wc-stat">
      <div class="wc-stat-val" style="color:#a78bfa">${exercises.length}</div>
      <div class="wc-stat-lbl">Exercises</div>
    </div>`;

  const prContainer = document.getElementById('wcPRs');
  const prListEl    = document.getElementById('wcPRList');
  if (prList && prList.length > 0) {
    prContainer.style.display = 'block';
    prListEl.innerHTML = prList.map(p =>
      `<div class="wc-pr-item">🏆 ${p.weight} lbs × ${p.reps} reps · ~${p.est1rm} lbs 1RM</div>`
    ).join('');
  } else {
    prContainer.style.display = 'none';
  }

  overlay.style.display = 'flex';
}

function closeWorkoutComplete() {
  const overlay = document.getElementById('workoutCompleteOverlay');
  if (overlay) overlay.style.display = 'none';
  resetWorkoutTimer();
  renderWorkoutPage();
}

// ── Exercise Progress Chart ───────────────────────────────────
function openExChart(exName) {
  const modal = document.getElementById('exChartModal');
  if (!modal) return;

  const liftLog = getStorage('liftLog2', {});
  const prs     = getPRs();
  const prKey   = exName.toLowerCase().replace(/\s+/g, '_');
  const prData  = prs[prKey];

  // Gather all data points: { date, maxWeight, bestReps, est1rm }
  const points = [];
  Object.entries(liftLog).sort(([a],[b]) => a.localeCompare(b)).forEach(([k, log]) => {
    if (!log.exercises) return;
    log.exercises.forEach(ex => {
      if (ex.name !== exName) return;
      const done = (ex.sets || []).filter(s => s.done && s.type !== 'warmup' && parseFloat(s.weight) > 0);
      if (!done.length) return;
      // Best set by estimated 1RM
      let best = null;
      done.forEach(s => {
        const e1rm = (parseFloat(s.weight) || 0) * (1 + (parseInt(s.reps) || 0) / 30);
        if (!best || e1rm > best.est1rm) best = { weight: parseFloat(s.weight), reps: parseInt(s.reps) || 0, est1rm: e1rm };
      });
      if (best) points.push({ date: log.date || k.slice(0,10), ...best });
    });
  });

  // Title and sub
  document.getElementById('exChartTitle').textContent = exName;
  document.getElementById('exChartSub').textContent = points.length
    ? `${points.length} sessions logged` + (prData ? ` · 🏆 PR: ${prData.weight} lbs × ${prData.reps} reps` : '')
    : 'No data yet — log this exercise to see progress';

  // Draw SVG chart
  const svg = document.getElementById('exChartSvg');
  svg.innerHTML = '';
  const W = 300, H = 130, PAD = { t: 10, r: 10, b: 30, l: 40 };
  const iW = W - PAD.l - PAD.r;
  const iH = H - PAD.t - PAD.b;

  if (points.length >= 2) {
    const vals   = points.map(p => p.est1rm);
    const minV   = Math.min(...vals) * 0.92;
    const maxV   = Math.max(...vals) * 1.05;
    const xStep  = iW / (points.length - 1);
    const yScale = v => iH - ((v - minV) / (maxV - minV)) * iH;

    // Grid lines
    for (let i = 0; i <= 4; i++) {
      const y = PAD.t + (i / 4) * iH;
      const v = maxV - (i / 4) * (maxV - minV);
      svg.innerHTML += `<line x1="${PAD.l}" y1="${y}" x2="${W - PAD.r}" y2="${y}" stroke="#2a2f3d" stroke-width="1"/>`;
      svg.innerHTML += `<text x="${PAD.l - 4}" y="${y + 4}" text-anchor="end" fill="#4d5468" font-size="9" font-family="Plus Jakarta Sans,sans-serif">${Math.round(v)}</text>`;
    }

    // Line path
    const pts = points.map((p, i) => {
      const x = PAD.l + i * xStep;
      const y = PAD.t + yScale(p.est1rm);
      return `${x},${y}`;
    }).join(' ');
    svg.innerHTML += `<polyline points="${pts}" fill="none" stroke="#22c55e" stroke-width="2.5" stroke-linejoin="round" stroke-linecap="round"/>`;

    // Area fill
    const firstX = PAD.l, lastX = PAD.l + (points.length - 1) * xStep;
    const areaBase = PAD.t + iH;
    const areaPath = `M${firstX},${areaBase} ` +
      points.map((p, i) => `L${PAD.l + i * xStep},${PAD.t + yScale(p.est1rm)}`).join(' ') +
      ` L${lastX},${areaBase} Z`;
    svg.innerHTML += `<path d="${areaPath}" fill="url(#chartGrad)" opacity="0.3"/>`;
    svg.innerHTML += `<defs><linearGradient id="chartGrad" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="#22c55e"/><stop offset="100%" stop-color="#22c55e" stop-opacity="0"/></linearGradient></defs>`;

    // Dots + date labels (show every Nth)
    const showEvery = Math.max(1, Math.ceil(points.length / 5));
    points.forEach((p, i) => {
      const x = PAD.l + i * xStep;
      const y = PAD.t + yScale(p.est1rm);
      svg.innerHTML += `<circle cx="${x}" cy="${y}" r="3.5" fill="#22c55e" stroke="#0d1e3d" stroke-width="1.5"/>`;
      if (i % showEvery === 0 || i === points.length - 1) {
        const dateLabel = p.date ? p.date.slice(5) : '';
        svg.innerHTML += `<text x="${x}" y="${H - 6}" text-anchor="middle" fill="#4d5468" font-size="8" font-family="Plus Jakarta Sans,sans-serif">${dateLabel}</text>`;
      }
    });
  } else if (points.length === 1) {
    svg.innerHTML = `<text x="150" y="70" text-anchor="middle" fill="#4d5468" font-size="12" font-family="Plus Jakarta Sans,sans-serif">Only 1 session — log more to see trends</text>`;
  } else {
    svg.innerHTML = `<text x="150" y="70" text-anchor="middle" fill="#4d5468" font-size="12" font-family="Plus Jakarta Sans,sans-serif">No data yet — log this exercise first</text>`;
  }

  // Stats row
  const best = points.length ? points.reduce((b, p) => p.est1rm > b.est1rm ? p : b) : null;
  const latest = points.length ? points[points.length - 1] : null;
  const first  = points.length ? points[0] : null;
  const pctChange = (first && latest && first.est1rm > 0)
    ? (((latest.est1rm - first.est1rm) / first.est1rm) * 100).toFixed(1) : null;

  document.getElementById('exChartStats').innerHTML = `
    <div class="ex-stat-box">
      <div class="ex-stat-val" style="color:#f59e0b">${best ? Math.round(best.est1rm) : '—'}</div>
      <div class="ex-stat-lbl">Best 1RM Est.</div>
    </div>
    <div class="ex-stat-box">
      <div class="ex-stat-val" style="color:#22c55e">${prData ? prData.weight : '—'}</div>
      <div class="ex-stat-lbl">PR Weight</div>
    </div>
    <div class="ex-stat-box">
      <div class="ex-stat-val" style="color:${pctChange > 0 ? '#22c55e' : '#f87171'}">${pctChange !== null ? (pctChange > 0 ? '+' : '') + pctChange + '%' : '—'}</div>
      <div class="ex-stat-lbl">Progress</div>
    </div>`;

  modal.style.display = 'flex';
}

function closeExChart() {
  const modal = document.getElementById('exChartModal');
  if (modal) modal.style.display = 'none';
}

// ── renderHistoryPage v2 ──────────────────────────────────────
function renderHistoryPage() {
  const liftLog = getStorage('liftLog2', {});
  const keys    = Object.keys(liftLog).sort().reverse();
  const el      = document.getElementById('historyList');
  if (!el) return;

  if (keys.length === 0) {
    el.innerHTML = '<div class="section-title">LIFT HISTORY</div><div class="empty-state">No workouts logged yet.<br>Complete a session to see history here.</div>';
    return;
  }

  const sectionTitle = '<div class="section-title" style="margin-bottom:14px">LIFT HISTORY</div>';
  el.innerHTML = sectionTitle + keys.map(k => {
    const log    = liftLog[k];
    const sess   = PROGRAM[log.session];
    const date   = log.date || k.slice(0,10);
    const durSecs = log.duration || 0;
    const durStr  = durSecs > 60 ? `${Math.floor(durSecs/60)}m ${durSecs%60}s` : (durSecs > 0 ? `${durSecs}s` : '');

    // Compute volume
    const vol = (log.exercises || []).reduce((n, ex) =>
      n + (ex.sets || []).filter(s => s.done && s.type !== 'warmup').reduce((sv, s) =>
        sv + (parseFloat(s.weight)||0) * (parseInt(s.reps)||0), 0), 0);

    // Exercise rows with best set per exercise
    const rows = (log.exercises || []).map(ex => {
      const done = (ex.sets || []).filter(s => s.done && parseFloat(s.weight) > 0);
      if (!done.length) return '';
      const bestSet = done.reduce((b, s) =>
        (parseFloat(s.weight) * (parseInt(s.reps)||1)) > (parseFloat(b.weight) * (parseInt(b.reps)||1)) ? s : b
      );
      const sets1rm = done.map(s => (parseFloat(s.weight)||0) * (1 + (parseInt(s.reps)||0)/30));
      const est1rm  = Math.max(...sets1rm);
      const volEx   = done.reduce((sv, s) => sv + (parseFloat(s.weight)||0)*(parseInt(s.reps)||0), 0);
      return `<div class="hist-row">
        <span class="hist-ex">${ex.name}</span>
        <span class="hist-wt">${bestSet.weight} lbs × ${bestSet.reps} · ${done.length} sets</span>
      </div>`;
    }).filter(Boolean).join('');

    // Badge color by session
    const sessionColors = { A:'#f59e0b', B:'#3b82f6', C:'#22c55e' };
    const badgeColor = sessionColors[log.session] || '#22c55e';
    const badgeBg    = log.session === 'A' ? '#2d1f05' : log.session === 'B' ? '#0d1e3d' : '#0d2d1a';

    return `<div class="hist-card">
      <div class="hist-header">
        <div>
          <div class="hist-sess" style="font-size:15px;font-weight:800">${sess?.name || 'Session'}</div>
          <div class="hist-date">${date}${durStr ? ' · ⏱ ' + durStr : ''}</div>
        </div>
        <div style="display:flex;flex-direction:column;align-items:flex-end;gap:5px">
          <span style="padding:4px 12px;border-radius:20px;font-size:11px;font-weight:700;background:${badgeBg};color:${badgeColor}">Day ${log.session}</span>
          ${vol > 0 ? `<span style="font-size:10px;font-weight:700;color:var(--text3)">${vol >= 1000 ? (vol/1000).toFixed(1)+'k' : Math.round(vol)} lbs</span>` : ''}
        </div>
      </div>
      ${rows || '<div style="font-size:12px;color:var(--text3)">No sets recorded</div>'}
      ${log.notes ? `<div style="margin-top:10px;padding-top:10px;border-top:1px solid var(--border);font-size:12px;color:var(--text2);line-height:1.6">📝 ${log.notes}</div>` : ''}
    </div>`;
  }).join('');
}

// ── Program Page ──
function renderProgramPage() {
  document.getElementById('programList').innerHTML = Object.entries(PROGRAM).map(([key, sess]) =>
    `<div class="card" style="margin-bottom:14px">
      <div style="font-size:18px;font-weight:700;color:#22c55e;margin-bottom:12px;letter-spacing:-0.3px">Day ${key} — ${sess.name}</div>
      ${sess.exercises.map(ex => `
        <div style="display:flex;align-items:center;gap:12px;padding:10px 0;border-bottom:1px solid #e8eaf2">
          <div style="min-width:58px;height:32px;border-radius:20px;background:#0d2d1a;color:#22c55e;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;flex-shrink:0;padding:0 8px">${ex.sets}×${ex.reps}</div>
          <div>
            <div style="font-size:14px;font-weight:600;color:var(--text)">${ex.name}</div>
            ${ex.notes ? `<div style="font-size:11px;color:var(--text2);margin-top:2px">${ex.notes}</div>` : ''}
          </div>
        </div>`).join('')}
    </div>`
  ).join('');
}


// ── Tab switching ──
function switchTab(name, btn) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('page-'+name).classList.add('active');
  btn.classList.add('active');
  logInteraction('tab_visit', name);
  if (name === 'today') { selectedDateKey = todayKey(); updateDateNavBar(); scheduleRender(renderRings); renderWeekStrip(); renderStreakCard(); renderEventCountdowns(); renderQuickRecs(); renderUsualFoods(); renderWorkoutNutritionBanner(); scheduleRender(renderFoodLog); scheduleRender(renderProteinPace); renderWeightTrend(); checkCopyYesterday(); scheduleRender(renderWeeklyBalance); }
  if (name === 'lift') renderWorkoutPage();
  else { stopWorkoutTimer(); skipRestTimer(); }
  if (name === 'program') { renderProgramPage(); renderEventList(); }
  if (name === 'history') { renderBloodWorkPage(); renderHistoryPage(); }
  if (name === 'trends') renderTrendChart();
  if (name === 'shoes')  renderShoePage();
}

// ── Food Entry Log (individual entries per day) ──
function getFoodEntries(dateKey) {
  const key = dateKey || getSelectedDateKey();
  const all = getStorage('foodEntries', {});
  return all[key] || [];
}

function setFoodEntries(entries, dateKey) {
  const key      = dateKey || getSelectedDateKey();
  // Update foodEntries
  const all      = getStorage('foodEntries', {});
  all[key]       = entries;
  setStorage('foodEntries', all);
  // Keep macroLog in sync — single read+write
  const totals   = entries.reduce((acc, e) => ({
    calories: acc.calories + (e.calories || 0),
    protein:  acc.protein  + (e.protein  || 0),
    carbs:    acc.carbs    + (e.carbs    || 0),
    fat:      acc.fat      + (e.fat      || 0),
  }), { calories: 0, protein: 0, carbs: 0, fat: 0 });
  const macroLog = getStorage('macroLog', {});
  macroLog[key]  = totals;
  setStorage('macroLog', macroLog);
}

function addFoodEntry(food) {
  const entries = getFoodEntries();
  const servings = food.servings || 1;
  const entry = {
    id:           Date.now(),
    name:         food.name || 'Food',
    calories:     food.calories || 0,
    protein:      food.protein  || 0,
    carbs:        food.carbs    || 0,
    fat:          food.fat      || 0,
    icon:         food.icon || '🍽️',
    time:         nowEST().toLocaleTimeString('en-US', { hour:'2-digit', minute:'2-digit', timeZone:'America/New_York' }),
    servings,
    // Store per-serving base so editing can rescale
    baseMacros: {
      calories: Math.round((food.calories || 0) / servings * 10) / 10,
      protein:  Math.round((food.protein  || 0) / servings * 10) / 10,
      carbs:    Math.round((food.carbs    || 0) / servings * 10) / 10,
      fat:      Math.round((food.fat      || 0) / servings * 10) / 10,
    },
  };
  // Persist micros if provided
  if (food.micros && Object.keys(food.micros).length > 0) {
    entry.micros = food.micros;
    entry.baseMicros = Object.fromEntries(
      Object.entries(food.micros).map(([k, v]) => [k, Math.round(v / servings * 1000) / 1000])
    );
  }
  entries.push(entry);
  setFoodEntries(entries);
  logInteraction('food_logged', food.name);
  scheduleRender(renderRings);
  scheduleRender(renderFoodLog);
  scheduleRender(renderProteinPace);
  scheduleRender(renderWeeklyBalance);
  const isPast = getSelectedDateKey() !== todayKey();
  showToast(`✅ ${food.name} logged!${isPast ? ' (past day)' : ''}`);
}




function renderWorkoutNutritionBanner() {
  const banner = document.getElementById('workoutNutritionBanner');
  const title  = document.getElementById('workoutNutritionTitle');
  const msg    = document.getElementById('workoutNutritionMsg');
  if (!banner) return;

  const dow     = nowEST().getDay();
  const h       = nowEST().getHours();
  const todayW  = WEEK.find(d => DAY_MAP[d.day] === dow);
  const isLift  = todayW && (todayW.type === 'lift' || todayW.type === 'optional');
  const isRun   = todayW && (todayW.type === 'run' || todayW.type === 'longrun' || todayW.type === 'recoveryrun');
  const entries = getFoodEntries();
  const consumed = entries.reduce((s, e) => s + (e.calories || 0), 0);
  const macros   = getStorage('userMacros', null) || MACROS;

  if (!isLift && !isRun) { banner.style.display = 'none'; return; }

  banner.style.display = 'block';

  if (isLift) {
    title.textContent = '🏋️ Lift Day Fuel';
    if (h < 10) {
      msg.textContent = 'Pre-lift: aim for 40–50g carbs + 30g protein 60–90 min before you train. Oats + protein shake works great.';
    } else if (h >= 10 && h < 14) {
      msg.textContent = 'Mid-day lift window: make sure your pre-workout meal had carbs. Post-lift, hit 50g protein + 60g carbs within 30 min.';
    } else if (h >= 14 && h < 20) {
      const postLiftRemaining = Math.max(0, (macros.protein || 190) - consumed);
      msg.textContent = `Post-workout window. Target: 50g protein + 60g carbs NOW. You still have ${(macros.calories - consumed).toFixed(0)} kcal remaining today.`;
    } else {
      msg.textContent = 'Recovery night — prioritize protein before bed. Cottage cheese or casein shake ideal.';
    }
  } else if (isRun) {
    const isLong = todayW.type === 'longrun';
    title.textContent = isLong ? '🏃 Long Run Day' : '🏃 Run Day';
    if (h < 8) {
      msg.textContent = isLong ? 'Long run today — eat 60–80g carbs 2 hrs before. Hydrate well. Bring fuel if running 60+ min.' : 'Easy run day — light carbs before, focus on hitting protein target through the day.';
    } else {
      msg.textContent = isLong ? 'Post long run: replenish with 80–100g carbs + 40g protein ASAP. Your carb target is higher today.' : 'Post-run: good job. Keep carbs toward the higher end today to replenish glycogen.';
    }
  }
}

function renderStreakCard() {
  const liftLog  = getStorage('liftLog2', {});
  const shoeRuns = getShoeRuns();
  const streakEl = document.getElementById('streakCount');
  const subEl    = document.getElementById('streakSub');
  const dotRow   = document.getElementById('weekDotRow');
  if (!streakEl) return;

  const now = nowEST();

  // Helper: did the user complete a workout on a given YYYY-MM-DD key?
  // Counts: any liftLog entry for that date OR any shoeRun logged on that date
  function hasActivityOn(key) {
    const hasLift = Object.keys(liftLog).some(k => k.startsWith(key));
    const hasRun  = shoeRuns.some(r => r.date === key);
    return hasLift || hasRun;
  }

  // Count consecutive active days going back from today
  // Today is allowed to be empty without breaking the streak
  let streak = 0;
  for (let i = 0; i < 90; i++) {
    const d = new Date(now);
    d.setDate(now.getDate() - i);
    const key = dateToKey(d);
    if (hasActivityOn(key)) {
      streak++;
    } else if (i > 0) {
      break; // gap found — stop (i=0 is today, allowed to be empty)
    }
  }

  streakEl.textContent = streak;
  subEl.textContent    = streak === 0
    ? 'Log a workout or run to start your streak!'
    : streak === 1 ? 'Day 1 — keep it going!'
    : `${streak} consecutive day${streak !== 1 ? 's' : ''} 🔥`;

  // ── Week dot row — show ALL workout days (lifts + runs) ──────
  const dow        = now.getDay();
  const diffToMon  = dow === 0 ? -6 : 1 - dow;
  const typeColors = { lift:'#22c55e', run:'#3b82f6', longrun:'#f59e0b', recoveryrun:'#06b6d4', optional:'#8b5cf6' };
  const typeIcons  = { lift:'🏋️', run:'🏃', longrun:'🏃', recoveryrun:'🚶', optional:'🏋️' };

  const weekDots = WEEK.map((s, i) => {
    const d = new Date(now);
    d.setDate(now.getDate() + diffToMon + i);
    const key      = dateToKey(d);
    const isRest   = s.type === 'rest';
    const isFuture = d > now;
    const hasLift  = Object.keys(liftLog).some(k => k.startsWith(key));
    const hasRun   = shoeRuns.some(r => r.date === key);
    const done     = hasLift || hasRun;
    // For lift days: check lift; for run days: check runs
    const isWorkout = !isRest;
    return { type: s.type, day: s.day, done, isFuture, isRest, isWorkout, hasLift, hasRun };
  });

  const workoutDays = weekDots.filter(d => d.isWorkout);
  const doneDays    = workoutDays.filter(d => d.done).length;

  dotRow.innerHTML =
    `<div style="font-size:10px;color:var(--text3);font-weight:700;margin-bottom:4px;letter-spacing:1px">THIS WEEK</div>` +
    `<div style="display:flex;gap:5px;align-items:center">` +
    weekDots.map(d => {
      if (d.isRest) {
        return `<div title="${d.day}: Rest" style="width:20px;height:20px;border-radius:6px;background:var(--surface2);border:1.5px solid var(--border);opacity:0.4"></div>`;
      }
      const color  = typeColors[d.type] || '#94a3b8';
      const icon   = typeIcons[d.type]  || '💪';
      let bg, border, label;
      if (d.done) {
        bg = color + '33'; border = color; label = '✓';
      } else if (d.isFuture) {
        bg = 'var(--surface2)'; border = color + '55'; label = icon;
      } else {
        bg = '#2d0f0f'; border = '#7f1d1d'; label = '✗';
      }
      return `<div title="${d.day}: ${d.type}${d.done ? ' ✓' : ''}" style="width:20px;height:20px;border-radius:6px;background:${bg};border:1.5px solid ${border};display:flex;align-items:center;justify-content:center;font-size:${d.done ? '11px' : '9px'};color:${d.done ? color : d.isFuture ? color + 'aa' : '#ef4444'}">${label}</div>`;
    }).join('') +
    `</div>` +
    `<div style="display:flex;gap:10px;margin-top:4px">` +
    `<div style="font-size:9px;color:var(--text3);font-weight:600">${doneDays}/${workoutDays.length} done this week</div>` +
    `<div style="font-size:9px;color:#22c55e;font-weight:600">🏋️ lifts</div>` +
    `<div style="font-size:9px;color:#3b82f6;font-weight:600">🏃 runs</div>` +
    `</div>`;
}

function renderProteinPace(entriesOverride) {
  const bar   = document.getElementById('proteinPaceBar');
  const label = document.getElementById('proteinPaceLabel');
  const hint  = document.getElementById('proteinPaceHint');
  if (!bar) return;

  const entries  = entriesOverride || getFoodEntries();
  const consumed = entries.reduce((s, e) => s + (e.protein || 0), 0);
  const macros   = getStorage('userMacros', null) || MACROS;
  const target   = macros.protein || 190;
  const pct      = Math.min(consumed / target, 1);

  // How many meals remain today
  const h = nowEST().getHours();
  const mealsLeft = h < 8 ? 4 : h < 12 ? 3 : h < 15 ? 2 : h < 19 ? 1 : 0;
  const remaining = Math.max(0, target - consumed);

  bar.style.width   = (pct * 100) + '%';
  bar.style.background = pct >= 1 ? '#22c55e' : pct >= 0.7 ? '#4ade80' : pct >= 0.4 ? '#f59e0b' : '#ef4444';
  label.textContent = `${consumed.toFixed(0)}g / ${target}g`;

  if (pct >= 1) {
    hint.textContent = '✅ Protein goal hit! Great work.';
  } else if (mealsLeft === 0) {
    hint.textContent = `⚠️ ${remaining.toFixed(0)}g short — consider a protein snack`;
  } else {
    const perMeal = (remaining / mealsLeft).toFixed(0);
    hint.textContent = `Need ${remaining.toFixed(0)}g more across ~${mealsLeft} meal${mealsLeft !== 1 ? 's' : ''} left (${perMeal}g each)`;
  }
}

function renderFoodLog() {
  const entries = getFoodEntries();
  const card = document.getElementById('foodLogCard');
  const list = document.getElementById('foodLogList');
  if (!card || !list) return;

  const isPast = getSelectedDateKey() !== todayKey();

  // Always show the card so users can add entries to past days
  card.style.display = 'block';

  // Past-day banner
  const pastBanner = isPast
    ? `<div style="background:#0d1e3d;border:1.5px solid #1e3a5f;border-radius:12px;padding:8px 12px;margin-bottom:10px;font-size:12px;color:#60a5fa;font-weight:600;display:flex;align-items:center;gap:8px">
        📅 Editing past day — changes will be saved to ${getSelectedDateKey()}
       </div>` : '';

  if (entries.length === 0) {
    list.innerHTML = pastBanner + `<div style="text-align:center;color:var(--text3);padding:20px 0;font-size:13px">No entries for this day.<br>Use the form above to add food.</div>`;
    return;
  }

  const totals = entries.reduce((a, e) => ({
    calories: a.calories + e.calories,
    protein:  a.protein  + e.protein,
    carbs:    a.carbs    + e.carbs,
    fat:      a.fat      + e.fat,
  }), { calories:0, protein:0, carbs:0, fat:0 });

  list.innerHTML = pastBanner + entries.map(e => `
    <div class="log-entry" id="entry-${e.id}">
      <div class="log-entry-icon">${e.icon || '🍽️'}</div>
      <div class="log-entry-info">
        <div class="log-entry-name">${esc(e.name)}${e.servings && e.servings !== 1 ? `<span style="font-size:10px;color:var(--text3);font-weight:600;margin-left:6px">×${e.servings}</span>` : ''}</div>
        <div class="log-entry-macros">${e.calories} kcal · ${e.protein}g P · ${e.carbs}g C · ${e.fat}g F</div>
        <div class="log-entry-time">${e.time || ''}</div>
      </div>
      <div class="log-entry-actions">
        <button class="log-action-btn edit" onclick="openEditEntry(${e.id})" title="Edit">✏️</button>
        <button class="log-action-btn del"  onclick="deleteEntry(${e.id})"   title="Delete">🗑️</button>
      </div>
    </div>`).join('') +
    `<div class="log-total-row">
      <div class="log-total-label">Total</div>
      <div class="log-total-macros">${Math.round(totals.calories)} kcal · ${totals.protein.toFixed(1)}g P · ${totals.carbs.toFixed(1)}g C · ${totals.fat.toFixed(1)}g F</div>
    </div>`;
}

// ── Edit Entry with Servings ──
let _editServings = 1;
let _editBaseMacros = null; // null = no base stored, edit macros directly

function openEditEntry(id) {
  const entries = getFoodEntries();
  const e = entries.find(x => x.id === id);
  if (!e) return;

  _editServings   = e.servings || 1;
  _editBaseMacros = e.baseMacros || null;

  document.getElementById('editEntryId').value  = id;
  document.getElementById('editEntryName').value = e.name;
  document.getElementById('editEntrySubtitle').textContent = e.name;

  const hasBase = !!_editBaseMacros;
  const servingsRow  = document.getElementById('editServingsRow');
  const macroLabel   = document.getElementById('editMacroLabel');
  const totalPreview = document.getElementById('editTotalPreview');

  if (hasBase) {
    // Show servings stepper — macro fields show per-serving values
    servingsRow.style.display = 'flex';
    macroLabel.textContent = 'Macros per serving (auto-calculated)';
    totalPreview.style.display = 'flex';
    document.getElementById('editServingBaseLabel').textContent =
      `Base: ${_editBaseMacros.calories} kcal · ${_editBaseMacros.protein}g P per serving`;
    document.getElementById('editServingsDisplay').textContent = _editServings % 1 === 0 ? _editServings : _editServings.toFixed(1);
    // Fill fields with per-serving values
    document.getElementById('editCalories').value = _editBaseMacros.calories;
    document.getElementById('editProtein').value  = _editBaseMacros.protein;
    document.getElementById('editCarbs').value    = _editBaseMacros.carbs;
    document.getElementById('editFat').value      = _editBaseMacros.fat;
    updateEditTotalPreview();
  } else {
    // No base stored — show total macros, editable directly
    servingsRow.style.display = 'none';
    macroLabel.textContent = 'Macros (total)';
    totalPreview.style.display = 'none';
    document.getElementById('editCalories').value = e.calories;
    document.getElementById('editProtein').value  = e.protein;
    document.getElementById('editCarbs').value    = e.carbs;
    document.getElementById('editFat').value      = e.fat;
  }

  document.getElementById('editEntryModal').classList.add('open');
}

function adjustEditServings(delta) {
  _editServings = Math.max(0.5, Math.round((_editServings + delta) * 2) / 2);
  document.getElementById('editServingsDisplay').textContent = _editServings % 1 === 0 ? _editServings : _editServings.toFixed(1);
  updateEditTotalPreview();
}

function onEditMacroInput() {
  // When user manually edits macro fields, clear base so we save as-is
  _editBaseMacros = null;
  document.getElementById('editServingsRow').style.display = 'none';
  document.getElementById('editTotalPreview').style.display = 'none';
  document.getElementById('editMacroLabel').textContent = 'Macros (total)';
}

function updateEditTotalPreview() {
  if (!_editBaseMacros) return;
  const s = _editServings;
  const b = _editBaseMacros;
  const totalEl = document.getElementById('editTotalText');
  totalEl.innerHTML =
    `<span style="color:#f59e0b;font-weight:700">${Math.round(b.calories*s)} kcal</span> · ` +
    `<span style="color:#22c55e">${(b.protein*s).toFixed(1)}g P</span> · ` +
    `<span style="color:#3b82f6">${(b.carbs*s).toFixed(1)}g C</span> · ` +
    `<span style="color:#ef4444">${(b.fat*s).toFixed(1)}g F</span>`;
}

function saveEditedEntry() {
  const id = parseInt(document.getElementById('editEntryId').value);
  const entries = getFoodEntries();
  const idx = entries.findIndex(x => x.id === id);
  if (idx === -1) return;

  const name = document.getElementById('editEntryName').value.trim() || entries[idx].name;

  let calories, protein, carbs, fat, baseMacros, servings;

  if (_editBaseMacros) {
    // Scale from base macros × servings
    const s = _editServings;
    const b = _editBaseMacros;
    calories   = Math.round(b.calories * s);
    protein    = Math.round(b.protein  * s * 10) / 10;
    carbs      = Math.round(b.carbs    * s * 10) / 10;
    fat        = Math.round(b.fat      * s * 10) / 10;
    baseMacros = b;
    servings   = s;
  } else {
    // Direct macro edit — treat as 1 serving
    calories   = parseFloat(document.getElementById('editCalories').value) || 0;
    protein    = parseFloat(document.getElementById('editProtein').value)  || 0;
    carbs      = parseFloat(document.getElementById('editCarbs').value)    || 0;
    fat        = parseFloat(document.getElementById('editFat').value)      || 0;
    servings   = 1;
    baseMacros = { calories, protein, carbs, fat };
  }

  entries[idx] = { ...entries[idx], name, calories, protein, carbs, fat, servings, baseMacros };
  setFoodEntries(entries);
  document.getElementById('editEntryModal').classList.remove('open');
  scheduleRender(renderRings);
  scheduleRender(renderFoodLog);
  scheduleRender(renderWeeklyBalance);
  showToast('✅ Entry updated!');
}

function deleteEntry(id) {
  const allEntries = getFoodEntries();
  const entry = allEntries.find(e => e.id === id);
  const remaining = allEntries.filter(e => e.id !== id);
  const savedDateKey = getSelectedDateKey();
  setFoodEntries(remaining);
  scheduleRender(renderRings);
  scheduleRender(renderFoodLog);
  scheduleRender(renderProteinPace);
  scheduleRender(renderWeeklyBalance);
  showToast('🗑️ Entry removed', () => {
    // Undo: restore entry
    const current = getFoodEntries(savedDateKey);
    current.push(entry);
    current.sort((a,b) => a.id - b.id);
    setFoodEntries(current, savedDateKey);
    scheduleRender(renderRings); scheduleRender(renderFoodLog); scheduleRender(renderProteinPace); scheduleRender(renderWeeklyBalance);
    showToast('↩️ Entry restored');
  });
}

function clearAllEntries() {
  if (!confirm('Clear all food entries for today?')) return;
  setFoodEntries([]);
  scheduleRender(renderRings);
  scheduleRender(renderFoodLog);
}

// ── Saved Foods & Smart Recommendations ──

const TIME_SLOTS = {
  breakfast:  { label: 'Breakfast',     hint: 'breakfast',      hours: [5,6,7,8,9],       dot: '#f59e0b' },
  morning:    { label: 'Morning Snack', hint: 'mid-morning',    hours: [9,10,11],          dot: '#06b6d4' },
  lunch:      { label: 'Lunch',         hint: 'lunch',          hours: [11,12,13,14],      dot: '#3b82f6' },
  afternoon:  { label: 'Afternoon',     hint: 'afternoon',      hours: [14,15,16,17],      dot: '#8b5cf6' },
  dinner:     { label: 'Dinner',        hint: 'dinner',         hours: [17,18,19,20,21],   dot: '#22c55e' },
  evening:    { label: 'Evening Snack', hint: 'evening',        hours: [20,21,22,23],      dot: '#ef4444' },
};

let selectedTimeSlot = null; // shared for scan/manual pickers

function getTimeSlot() {
  const h = nowEST().getHours();
  for (const [key, slot] of Object.entries(TIME_SLOTS)) {
    if (slot.hours.includes(h)) return key;
  }
  return 'lunch'; // default fallback
}

function toggleTimeSlot(btn, context) {
  if (context === 'ai') {
    document.querySelectorAll('#aiTimeSlotPicker .ts-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    aiSelectedSlot = btn.dataset.slot;
    return;
  }
  const picker = document.getElementById(context === 'scan' ? 'scanTimeSlotPicker' : 'manualTimeSlotPicker');
  picker.querySelectorAll('.ts-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  selectedTimeSlot = btn.dataset.slot;
}

function renderUsualFoods() {
  const card = document.getElementById('usualFoodsCard');
  if (!card) return;

  // ── Build frequency map from last 30 days ──────────────────
  const all    = getStorage('foodEntries', {});
  const cutoff = Date.now() - 30 * 24 * 60 * 60 * 1000;
  const todayK = todayKey();
  const freq   = {};

  Object.entries(all).forEach(([dateK, entries]) => {
    if (dateK === todayK) return;
    if (new Date(dateK + 'T12:00:00').getTime() < cutoff) return;
    entries.forEach(e => {
      if (!e.name) return;
      const key = e.name.toLowerCase().trim();
      if (!freq[key]) {
        freq[key] = {
          name:     e.name,
          icon:     e.icon || '🍽️',
          calories: e.baseMacros ? e.baseMacros.calories : (e.calories || 0),
          protein:  e.baseMacros ? e.baseMacros.protein  : (e.protein  || 0),
          carbs:    e.baseMacros ? e.baseMacros.carbs    : (e.carbs    || 0),
          fat:      e.baseMacros ? e.baseMacros.fat      : (e.fat      || 0),
          count: 0, times: []
        };
      }
      freq[key].count++;
      if (e.time) freq[key].times.push(e.time);
    });
  });

  const allFoods = Object.values(freq).sort((a, b) => b.count - a.count);
  if (allFoods.length === 0) { card.style.display = 'none'; return; }

  // ── Time-of-day filtering ───────────────────────────────────
  const hour = new Date().getHours();
  let timeLabel = '', timePeriod = '';
  if      (hour <  10) { timeLabel = '🌅 Morning picks';   timePeriod = 'morning'; }
  else if (hour <  13) { timeLabel = '☀️ Midday picks';    timePeriod = 'midday'; }
  else if (hour <  17) { timeLabel = '🌤 Afternoon picks'; timePeriod = 'afternoon'; }
  else if (hour <  20) { timeLabel = '🌆 Evening picks';   timePeriod = 'evening'; }
  else                 { timeLabel = '🌙 Night picks';     timePeriod = 'night'; }

  function parseHour(t) {
    if (!t) return -1;
    const parts = t.split(' ');
    const ampm  = parts[1];
    let [h]     = parts[0].split(':').map(Number);
    if (ampm === 'PM' && h !== 12) h += 12;
    if (ampm === 'AM' && h === 12) h = 0;
    return h;
  }
  const slotHours = { morning:[5,10], midday:[10,13], afternoon:[13,17], evening:[17,20], night:[20,25] };
  const [lo, hi]  = slotHours[timePeriod] || [0, 24];

  const timeFoods = allFoods.filter(f =>
    f.times.length > 0 && f.times.some(t => { const h = parseHour(t); return h >= lo && h < hi; })
  );
  const top10 = (timeFoods.length >= 3 ? timeFoods : allFoods).slice(0, 10);

  document.getElementById('usualFoodsTimeLabel').textContent = timeLabel;
  document.getElementById('usualFoodsSubtitle').textContent  = `Top ${top10.length} from last 30 days`;

  // ── Store foods before rendering (avoids JSON-in-onclick bug) ──
  window._ufFoods = top10;
  window._ufQty   = new Array(top10.length).fill(1);

  // ── Yesterday same-time banner ──────────────────────────────
  const yDate = new Date(); yDate.setDate(yDate.getDate() - 1);
  const yKey  = yDate.toISOString().slice(0, 10);
  const yEntries = (all[yKey] || []).filter(e => {
    const h = parseHour(e.time); return h >= lo && h < hi;
  });

  const bannerEl   = document.getElementById('yesterdayRepeatBanner');
  const repeatList = document.getElementById('yesterdayRepeatList');
  if (yEntries.length > 0) {
    // Store yesterday entries in _ufYesterday for onclick access
    window._ufYesterday = yEntries.slice(0, 3);
    bannerEl.style.display = 'block';
    repeatList.innerHTML = window._ufYesterday.map((e, yi) => {
      const servings = e.servings || 1;
      return `<div class="uf-repeat-row">
        <div style="font-size:20px;width:28px;text-align:center">${e.icon || '🍽️'}</div>
        <div style="flex:1;min-width:0">
          <div style="font-size:12px;font-weight:700;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${esc(e.name)}</div>
          <div style="font-size:10px;color:var(--text3)">${Math.round(e.calories)} kcal · ${e.protein}g pro${servings > 1 ? ' · ' + servings + '×' : ''}</div>
        </div>
        <button onclick="quickAddUsual(${yi})" style="padding:5px 10px;background:var(--green-soft);border:1.5px solid var(--green);border-radius:9px;color:#4ade80;font-size:11px;font-weight:700;cursor:pointer">+ Add</button>
      </div>`;
    }).join('');
  } else {
    bannerEl.style.display = 'none';
  }

  // ── Render top 10 list ──────────────────────────────────────
  document.getElementById('usualFoodsList').innerHTML = top10.map((f, i) =>
    `<div class="uf-row" id="uf-row-${i}">
      <div class="uf-icon">${f.icon}</div>
      <div class="uf-info">
        <div class="uf-name">${esc(f.name)}</div>
        <div class="uf-macros" id="uf-macros-${i}">${Math.round(f.calories)} kcal · ${f.protein}g pro · ${f.carbs}g carbs · ${f.fat}g fat</div>
      </div>
      <div class="uf-badge">${f.count}×</div>
      <div class="uf-stepper" id="uf-stepper-${i}">
        <button class="uf-step-btn" onclick="ufStep(${i},-1)">−</button>
        <div class="uf-step-val" id="uf-qty-${i}">1</div>
        <button class="uf-step-btn" onclick="ufStep(${i},1)">+</button>
        <button class="uf-add-btn" onclick="ufConfirm(${i})">Log</button>
      </div>
      <button class="uf-tap-btn" id="uf-tap-${i}" onclick="ufToggle(${i})">Add</button>
    </div>`
  ).join('');

  card.style.display = 'block';
}


function ufToggle(i) {
  if (!window._ufFoods || !window._ufFoods[i]) return;
  const stepper = document.getElementById(`uf-stepper-${i}`);
  const tapBtn  = document.getElementById(`uf-tap-${i}`);
  if (!stepper || !tapBtn) return;
  const isOpen = stepper.classList.contains('active');
  // Close all others
  document.querySelectorAll('.uf-stepper').forEach(s => s.classList.remove('active'));
  document.querySelectorAll('.uf-tap-btn').forEach(b => b.style.display = '');
  if (!isOpen) {
    stepper.classList.add('active');
    tapBtn.style.display = 'none';
    window._ufQty[i] = 1;
    document.getElementById(`uf-qty-${i}`).textContent = '1';
    ufUpdateMacros(i);
  }
}

function ufStep(i, delta) {
  if (!window._ufQty) return;
  const qty = Math.max(0.5, (window._ufQty[i] || 1) + delta);
  window._ufQty[i] = Math.round(qty * 2) / 2;
  document.getElementById(`uf-qty-${i}`).textContent = window._ufQty[i];
  ufUpdateMacros(i);
}

function ufUpdateMacros(i) {
  if (!window._ufFoods) return;
  const f  = window._ufFoods[i];
  if (!f) return;
  const q  = window._ufQty[i] || 1;
  const el = document.getElementById(`uf-macros-${i}`);
  if (el) el.textContent = `${Math.round(f.calories * q)} kcal · ${Math.round(f.protein*q*10)/10}g pro · ${Math.round(f.carbs*q*10)/10}g carbs · ${Math.round(f.fat*q*10)/10}g fat`;
}

function ufConfirm(i) {
  if (!window._ufFoods) return;
  const f = window._ufFoods[i];
  if (!f) return;
  const qty = window._ufQty[i] || 1;
  addFoodEntry({
    name:     f.name,
    icon:     f.icon || '🍽️',
    calories: Math.round(f.calories * qty),
    protein:  Math.round(f.protein  * qty * 10) / 10,
    carbs:    Math.round(f.carbs    * qty * 10) / 10,
    fat:      Math.round(f.fat      * qty * 10) / 10,
    servings: qty
  });
  const stepper = document.getElementById(`uf-stepper-${i}`);
  const tapBtn  = document.getElementById(`uf-tap-${i}`);
  if (stepper) stepper.classList.remove('active');
  if (tapBtn)  tapBtn.style.display = '';
  window._ufQty[i] = 1;
  const qEl = document.getElementById(`uf-qty-${i}`);
  if (qEl) qEl.textContent = '1';
  ufUpdateMacros(i);
}

// Yesterday banner uses index into _ufYesterday array
function quickAddUsual(yi) {
  if (!window._ufYesterday || !window._ufYesterday[yi]) return;
  const e    = window._ufYesterday[yi];
  const prev = e.servings || 1;
  const base = e.baseMacros || {
    calories: (e.calories || 0) / prev,
    protein:  (e.protein  || 0) / prev,
    carbs:    (e.carbs    || 0) / prev,
    fat:      (e.fat      || 0) / prev,
  };
  showServingsPrompt(e.name, prev, function(s) {
    s = s || 1;
    addFoodEntry({
      name:     e.name,
      icon:     e.icon || '🍽️',
      calories: Math.round(base.calories * s),
      protein:  Math.round(base.protein  * s * 10) / 10,
      carbs:    Math.round(base.carbs    * s * 10) / 10,
      fat:      Math.round(base.fat      * s * 10) / 10,
      servings: s
    });
  });
}

function renderQuickRecs() {

  const slot = getTimeSlot();
  const slotInfo = TIME_SLOTS[slot];
  const saved = getStorage('savedFoods', []);
  const recs = saved.filter(f => f.slot === slot);

  const card = document.getElementById('quickRecsCard');
  if (recs.length === 0) { card.style.display = 'none'; return; }

  card.style.display = 'block';
  document.querySelector('.meal-time-dot').style.background = slotInfo.dot;
  document.getElementById('mealTimeLabel').textContent = slotInfo.label + ' suggestions';
  document.getElementById('mealTimeHint').textContent = slotInfo.hint;

  document.getElementById('quickFoodsRow').innerHTML = recs.map((f, i) => {
    const idx = saved.findIndex(sf => sf.name === f.name && sf.slot === f.slot);
    return `<div class="quick-food-chip" onclick="quickAddFood(${idx})">
      <div class="qfc-name">${f.name}</div>
      <div class="qfc-cal">${f.calories} kcal · ${f.protein}g pro</div>

    </div>`;
  }).join('');
}


function showServingsPrompt(foodName, defaultServings, callback) {
  // Create modal overlay
  const overlay = document.createElement('div');
  overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:9999;display:flex;align-items:center;justify-content:center';
  overlay.innerHTML = `
    <div style="background:#1e293b;border-radius:16px;padding:24px;width:280px;box-shadow:0 8px 32px rgba(0,0,0,0.5)">
      <div style="font-size:15px;font-weight:700;color:#fff;margin-bottom:4px">${foodName}</div>
      <div style="font-size:12px;color:#64748b;margin-bottom:16px">How many servings?</div>
      <input id="_srvInput" type="number" min="0.25" max="20" step="0.25" value="${defaultServings}"
        style="width:100%;background:#0f172a;border:1.5px solid #334155;border-radius:10px;padding:12px;color:#fff;font-size:20px;font-weight:700;text-align:center;outline:none;font-family:inherit;box-sizing:border-box"/>
      <div style="display:flex;gap:8px;margin-top:8px">
        <button onclick="document.getElementById('_srvInput').value=Math.max(0.25,(parseFloat(document.getElementById('_srvInput').value)||1)-0.5)"
          style="flex:1;background:#0f172a;border:1px solid #334155;border-radius:8px;color:#fff;font-size:20px;padding:8px;cursor:pointer">−</button>
        <button onclick="document.getElementById('_srvInput').value=(parseFloat(document.getElementById('_srvInput').value)||1)+0.5"
          style="flex:1;background:#0f172a;border:1px solid #334155;border-radius:8px;color:#fff;font-size:20px;padding:8px;cursor:pointer">+</button>
      </div>
      <div style="display:flex;gap:10px;margin-top:16px">
        <button id="_srvCancel" style="flex:1;background:#0f172a;border:1px solid #334155;border-radius:10px;color:#94a3b8;font-size:14px;font-weight:600;padding:12px;cursor:pointer;font-family:inherit">Cancel</button>
        <button id="_srvConfirm" style="flex:1;background:linear-gradient(135deg,#22c55e,#16a34a);border:none;border-radius:10px;color:#fff;font-size:14px;font-weight:700;padding:12px;cursor:pointer;font-family:inherit">Add</button>
      </div>
    </div>`;
  document.body.appendChild(overlay);
  setTimeout(() => document.getElementById('_srvInput').focus(), 50);
  document.getElementById('_srvCancel').onclick = () => document.body.removeChild(overlay);
  document.getElementById('_srvConfirm').onclick = () => {
    const val = parseFloat(document.getElementById('_srvInput').value) || 1;
    document.body.removeChild(overlay);
    callback(val);
  };
  overlay.addEventListener('keydown', e => {
    if (e.key === 'Enter') document.getElementById('_srvConfirm').click();
    if (e.key === 'Escape') document.getElementById('_srvCancel').click();
  });
}

function quickAddFood(idx) {
  const saved = getStorage('savedFoods', []);
  const f = saved[idx];
  if (!f) return;
  showServingsPrompt(f.name, 1, function(servings) {
    const s = servings || 1;
    addFoodEntry({
      name: f.name,
      calories: Math.round((f.calories||0) * s),
      protein:  Math.round((f.protein||0)  * s * 10) / 10,
      carbs:    Math.round((f.carbs||0)    * s * 10) / 10,
      fat:      Math.round((f.fat||0)      * s * 10) / 10,
      servings: s,
      icon: '⚡'
    });
    showToast(`✅ ${f.name} added!`);
  });
}

function deleteSavedFood(idx) {
  const saved = getStorage('savedFoods', []);
  saved.splice(idx, 1);
  setStorage('savedFoods', saved);
  renderQuickRecs();
}

function saveFoodToSlot(food, slot) {
  if (!slot) { showToast('⚠️ Pick a meal time first'); return false; }
  const saved = getStorage('savedFoods', []);
  // avoid exact duplicates in same slot
  const exists = saved.some(f => f.name === food.name && f.slot === slot);
  if (exists) { showToast('Already saved in that slot!'); return false; }
  saved.push({ ...food, slot });
  setStorage('savedFoods', saved);
  showToast(`⭐ Saved to ${TIME_SLOTS[slot].label}!`);
  return true;
}

function saveManualFood() {
  const name = document.getElementById('manualFoodName').value.trim();
  if (!name) { showToast('⚠️ Enter a food name'); return; }
  if (!selectedTimeSlot) { showToast('⚠️ Pick a meal time'); return; }
  const food = {
    name,
    calories: parseInt(document.getElementById('in-calories').value) || 0,
    protein:  parseFloat(document.getElementById('in-protein').value)  || 0,
    carbs:    parseFloat(document.getElementById('in-carbs').value)    || 0,
    fat:      parseFloat(document.getElementById('in-fat').value)      || 0,
  };
  saveFoodToSlot(food, selectedTimeSlot);
  document.getElementById('manualFoodName').value = '';
  // reset picker
  document.querySelectorAll('#manualTimeSlotPicker .ts-btn').forEach(b => b.classList.remove('active'));
  selectedTimeSlot = null;
  renderQuickRecs();
}


let _lastDeletedEntry = null;
let _lastDeletedDateKey = null;

function showToast(msg, undoFn) {
  // Remove any existing toast
  document.querySelectorAll('.app-toast').forEach(t => t.remove());
  const toast = document.createElement('div');
  toast.className = 'app-toast';
  toast.style.cssText = 'position:fixed;bottom:100px;left:50%;transform:translateX(-50%);background:#1e222d;color:#eef0f6;padding:10px 16px;border-radius:20px;font-size:13px;font-weight:600;z-index:400;white-space:nowrap;box-shadow:0 4px 20px rgba(0,0,0,0.4);border:1px solid #2a2f3d;display:flex;align-items:center;gap:12px;transition:opacity 0.3s';
  const msgSpan = document.createElement('span');
  msgSpan.textContent = msg;
  toast.appendChild(msgSpan);
  if (undoFn) {
    const undoBtn = document.createElement('button');
    undoBtn.textContent = 'UNDO';
    undoBtn.style.cssText = 'background:#22c55e;color:#000;border:none;border-radius:10px;padding:4px 10px;font-size:11px;font-weight:800;cursor:pointer;font-family:inherit;flex-shrink:0';
    undoBtn.onclick = () => { undoFn(); toast.remove(); };
    toast.appendChild(undoBtn);
  }
  document.body.appendChild(toast);
  const timer = setTimeout(() => { toast.style.opacity = '0'; setTimeout(() => toast.remove(), 300); }, undoFn ? 4000 : 2200);
  toast.dataset.timer = timer;
}


// ── Barcode Scanner ──
let scannerStream = null;
let scannerInterval = null;
let scannedProduct = null;
let servings = 1;

async function openScanner() {
  document.getElementById('scannerModal').classList.add('open');
  document.getElementById('foodResult').style.display = 'none';
  document.getElementById('scanStatus').textContent = '🔍 Scanning for barcode…';
  document.getElementById('scanSubtitle').textContent = 'Point your camera at a barcode';
  document.getElementById('cameraView').style.display = 'block';
  scannedProduct = null;
  servings = 1;
  selectedTimeSlot = null;
  document.getElementById('srvVal').textContent = '1';

  // Auto-select current time slot
  const currentSlot = getTimeSlot();
  document.querySelectorAll('#scanTimeSlotPicker .ts-btn').forEach(b => {
    b.classList.toggle('active', b.dataset.slot === currentSlot);
  });
  selectedTimeSlot = currentSlot;

  try {
    await startQuagga();
  } catch (e) {
    document.getElementById('scanStatus').textContent = '⚠️ Camera access denied. Please allow camera in browser settings.';
  }
}

function startQuagga() {
  return new Promise((resolve, reject) => {
    if (!window.Quagga) {
      document.getElementById('scanStatus').textContent = '⚠️ Scanner library failed to load. Try manual entry.';
      reject(new Error('Quagga not loaded'));
      return;
    }

    Quagga.init({
      inputStream: {
        name: 'Live',
        type: 'LiveStream',
        target: document.getElementById('quagga-container'),
        constraints: {
          facingMode: 'environment',
          width: { ideal: 1280 },
          height: { ideal: 720 },
        },
      },
      decoder: {
        readers: ['ean_reader', 'ean_8_reader', 'upc_reader', 'upc_e_reader', 'code_128_reader', 'code_39_reader'],
        debug: { drawBoundingBox: false, showFrequency: false, drawScanline: false, showPattern: false }
      },
      locate: true,
    }, (err) => {
      if (err) {
        document.getElementById('scanStatus').textContent = '⚠️ Could not start camera: ' + err.message;
        reject(err);
        return;
      }
      Quagga.start();

      // Style the Quagga-injected video to fill the container
      const vid = document.querySelector('#quagga-container video');
      if (vid) {
        vid.style.cssText = 'width:100%;height:100%;object-fit:cover;border-radius:18px;display:block';
      }
      const canvas = document.querySelector('#quagga-container canvas');
      if (canvas) canvas.style.display = 'none';

      resolve();
    });

    Quagga.onDetected((result) => {
      const code = result.codeResult?.code;
      if (!code) return;
      Quagga.stop();
      lookupBarcode(code);
    });
  });
}

function startDecoding() { /* legacy stub — not used with Quagga */ }
function beginScan() { /* legacy stub — not used with Quagga */ }

async function lookupBarcode(barcode) {
  document.getElementById('scanStatus').textContent = `⏳ Looking up barcode ${barcode}…`;
  document.getElementById('cameraView').style.display = 'none';
  stopCamera();

  // ══════════════════════════════════════════════════════════
  // parseOFF — correctly handles Open Food Facts nutriment data
  // OFFs always stores nutrients per 100g in _100g fields AND
  // per-serving in _serving fields. We ALWAYS prefer _serving.
  // If _serving is missing, we scale from _100g using serving_quantity.
  // ══════════════════════════════════════════════════════════
  function parseOFF(p) {
    const n = p.nutriments || {};

    // Get per-serving value first, fall back to per-100g × scale
    const servingQty = parseFloat(p.serving_quantity) || parseFloat(p.serving_size) || 0;
    const scale100g  = servingQty > 0 ? servingQty / 100 : 1;

    function getPerServing(base) {
      // Key variants for the nutrient name
      const bases = [base, base.replace('-','_')];
      for (const b of bases) {
        // 1. Explicit per-serving field
        const sv = n[`${b}_serving`];
        if (sv !== undefined && sv !== null && sv !== '' && !isNaN(parseFloat(sv))) {
          return parseFloat(sv);
        }
      }
      // 2. Per-100g field × serving scale
      for (const b of bases) {
        const v100 = n[`${b}_100g`];
        if (v100 !== undefined && v100 !== null && v100 !== '' && !isNaN(parseFloat(v100))) {
          return parseFloat(v100) * scale100g;
        }
      }
      // 3. Raw field (assume per-serving if nutrition_data_per === 'serving', else scale)
      for (const b of bases) {
        const raw = n[b];
        if (raw !== undefined && raw !== null && raw !== '' && !isNaN(parseFloat(raw))) {
          const dataPer = p.nutrition_data_per || '100g';
          return dataPer === 'serving' ? parseFloat(raw) : parseFloat(raw) * scale100g;
        }
      }
      return 0;
    }

    // Calories: prefer energy-kcal, fall back to energy (kJ) ÷ 4.184
    let calories = getPerServing('energy-kcal');
    if (calories === 0) {
      const kj = getPerServing('energy');
      if (kj > 0) calories = kj / 4.184;
    }

    // Sanity check: if calories per serving look like per-100g (>800 for most foods)
    // AND we have a real serving size that's much smaller, flag a scaling issue
    // and force-scale down
    if (calories > 800 && servingQty > 0 && servingQty < 60) {
      // Likely 100g data without proper _serving fields — scale it
      calories   = calories   * (servingQty / 100);
    }

    const protein = getPerServing('proteins');
    const carbs   = getPerServing('carbohydrates');
    const fat     = getPerServing('fat');

    // Build serving size label
    const servingLabel = p.serving_size
      ? p.serving_size
      : servingQty > 0 ? `${servingQty}g` : '1 serving';

    return {
      name:        p.product_name_en || p.product_name || p.abbreviated_product_name || '',
      brand:       p.brands || '',
      calories:    Math.round(calories),
      protein:     Math.round(protein  * 10) / 10,
      carbs:       Math.round(carbs    * 10) / 10,
      fat:         Math.round(fat      * 10) / 10,
      servingSize: servingLabel,
      source:      'Open Food Facts',
    };
  }

  // ══════════════════════════════════════════════════════════
  // parseUSDAFood — extract macros from USDA FoodData item.
  // USDA branded foods store nutrients per 100g by default.
  // servingSize is in servingSizeUnit (g, oz, etc).
  // We must scale 100g values to the actual serving size.
  // ══════════════════════════════════════════════════════════
  function parseUSDAFood(f) {
    const nutr = id => {
      const found = (f.foodNutrients || []).find(x =>
        x.nutrientId === id || x.nutrientNumber === String(id) ||
        x.nutrientId === String(id)
      );
      return found?.value ?? 0;
    };

    // Raw values are per 100g
    const cal100   = nutr(1008) || nutr(208);
    const prot100  = nutr(1003) || nutr(203);
    const carbs100 = nutr(1005) || nutr(205);
    const fat100   = nutr(1004) || nutr(204);

    // Convert serving to grams for scaling
    let servingG = parseFloat(f.servingSize) || 0;
    const unit   = (f.servingSizeUnit || 'g').toLowerCase();
    if (unit === 'oz')      servingG *= 28.3495;
    else if (unit === 'ml') servingG *= 1;   // assume 1g/ml for liquids
    else if (unit === 'lb') servingG *= 453.592;

    // If no serving size in grams, values are already per 100g — use as-is
    const scale = servingG > 0 ? servingG / 100 : 1;

    const servingLabel = f.servingSize
      ? `${f.servingSize}${f.servingSizeUnit || 'g'}`
      : '100g';

    // Extract full micronutrient profile
    const micros = parseMicronutrients(f.foodNutrients, scale);

    return {
      name:        f.description || '',
      brand:       f.brandOwner || f.brandName || '',
      calories:    Math.round(cal100   * scale),
      protein:     Math.round(prot100  * scale * 10) / 10,
      carbs:       Math.round(carbs100 * scale * 10) / 10,
      fat:         Math.round(fat100   * scale * 10) / 10,
      servingSize: servingLabel,
      source:      'USDA',
      micros,
    };
  }

  // ── Sanity check: flag implausible macros ──
  function isSane(prod) {
    if (!prod.name) return false;
    if (prod.calories < 0 || prod.calories > 2000) return false;
    if (prod.protein  < 0 || prod.protein  > 200)  return false;
    if (prod.carbs    < 0 || prod.carbs    > 300)   return false;
    if (prod.fat      < 0 || prod.fat      > 150)   return false;
    // Calorie sanity: 4*P + 4*C + 9*F should roughly equal calories (±30%)
    const calcCals = prod.protein * 4 + prod.carbs * 4 + prod.fat * 9;
    if (prod.calories > 10 && calcCals > 0) {
      const ratio = calcCals / prod.calories;
      if (ratio < 0.5 || ratio > 2.0) return false; // macros don't add up — bad data
    }
    return true;
  }

  // ── DB 1: Open Food Facts — exact UPC/EAN lookup ──────────
  try {
    document.getElementById('scanStatus').textContent = '⏳ Searching Open Food Facts…';
    const res  = await fetch(
      `https://world.openfoodfacts.org/api/v2/product/${barcode}` +
      `?fields=product_name,product_name_en,abbreviated_product_name,brands,` +
      `serving_size,serving_quantity,nutriments,nutrition_data_per,nutriscore_data`
    );
    const data = await res.json();
    if (data.status === 1 && data.product) {
      const prod = parseOFF(data.product);
      if (isSane(prod)) {
        scannedProduct = prod;
        servings = 1;
        renderFoodResult();
        document.getElementById('scanStatus').textContent = '✅ Found — Open Food Facts';
        return;
      } else if (prod.name) {
        // Found product but macros are bad — show with warning
        // Still use it but warn user
        scannedProduct = prod;
        servings = 1;
        renderFoodResult();
        document.getElementById('scanStatus').textContent = '⚠️ Found but nutrition data may be incomplete — verify against label';
        return;
      }
    }
  } catch(e) { console.warn('OFF lookup failed:', e); }

  // ── DB 2: USDA FoodData Central — direct UPC gtinUpc lookup ──
  try {
    document.getElementById('scanStatus').textContent = '⏳ Searching USDA (by UPC)…';
    // USDA supports direct gtinUpc search which is exact
    const res  = await fetch(
      `https://api.nal.usda.gov/fdc/v1/foods/search` +
      `?query=${barcode}&dataType=Branded&pageSize=5&api_key=${USDA_API_KEY}`
    );
    const data = await res.json();
    // Find exact gtinUpc match first, then fall back to first result
    const foods = data.foods || [];
    const exact = foods.find(f => f.gtinUpc === barcode || f.gtinUpc === barcode.replace(/^0+/,''));
    const f     = exact || foods[0];
    if (f) {
      const prod = parseUSDAFood(f);
      if (isSane(prod)) {
        scannedProduct = prod;
        servings = 1;
        renderFoodResult();
        document.getElementById('scanStatus').textContent =
          exact ? '✅ Found — USDA (exact UPC match)' : '✅ Found — USDA';
        return;
      }
    }
  } catch(e) { console.warn('USDA UPC lookup failed:', e); }

  // ── DB 3: Open Food Facts US store (fallback) ──────────────
  // Try the US-specific endpoint in case world endpoint missed it
  try {
    document.getElementById('scanStatus').textContent = '⏳ Searching Open Food Facts US…';
    const res  = await fetch(
      `https://us.openfoodfacts.org/api/v2/product/${barcode}` +
      `?fields=product_name,product_name_en,brands,serving_size,serving_quantity,nutriments,nutrition_data_per`
    );
    const data = await res.json();
    if (data.status === 1 && data.product) {
      const prod = parseOFF(data.product);
      if (prod.name && prod.calories > 0) {
        scannedProduct = prod;
        servings = 1;
        renderFoodResult();
        document.getElementById('scanStatus').textContent = '✅ Found — Open Food Facts US';
        return;
      }
    }
  } catch(e) { console.warn('OFF US lookup failed:', e); }

  // ── All databases failed — offer manual entry prompt ──────
  document.getElementById('scanStatus').textContent =
    `❌ Barcode ${barcode} not found. Try the manual search or enter nutrition facts manually.`;
  document.getElementById('cameraView').style.display = 'block';
  openScannerCamera();
}

function renderFoodResult() {
  const p = scannedProduct;
  document.getElementById('foodName').textContent = p.name;

  // Brand + serving info + source badge
  const sourceColor = p.source === 'USDA' ? '#60a5fa' : '#a78bfa';
  const sourceBg    = p.source === 'USDA' ? '#0d1e3d' : '#1a1030';
  document.getElementById('foodBrand').innerHTML =
    `${p.brand ? `<strong>${p.brand}</strong> · ` : ''}` +
    `Per serving: <strong>${p.servingSize}</strong>` +
    `<span style="margin-left:8px;font-size:9px;background:${sourceBg};color:${sourceColor};padding:2px 7px;border-radius:8px;font-weight:700">${p.source || 'DB'}</span>`;

  document.getElementById('srvVal').textContent = servings % 1 === 0 ? servings : servings.toFixed(1);

  const cals  = Math.round(p.calories * servings);
  const prot  = Math.round(p.protein  * servings * 10) / 10;
  const carbs = Math.round(p.carbs    * servings * 10) / 10;
  const fat   = Math.round(p.fat      * servings * 10) / 10;

  // Calorie check: 4P + 4C + 9F should be close to label calories
  const calcCals = Math.round(prot * 4 + carbs * 4 + fat * 9);
  const calDiff  = Math.abs(calcCals - cals);
  const showCalWarning = cals > 10 && calDiff > cals * 0.3; // >30% off

  document.getElementById('foodMacros').innerHTML = [
    { label: 'Calories', val: cals,  unit: 'kcal', color: '#f59e0b' },
    { label: 'Protein',  val: prot,  unit: 'g',    color: '#22c55e' },
    { label: 'Carbs',    val: carbs, unit: 'g',    color: '#3b82f6' },
    { label: 'Fat',      val: fat,   unit: 'g',    color: '#ef4444' },
  ].map(m => `
    <div class="food-macro-chip">
      <div class="food-macro-chip-val" style="color:${m.color}">${m.val}</div>
      <div class="food-macro-chip-lbl">${m.label}</div>
      <div style="font-size:9px;color:var(--text3)">${m.unit}</div>
    </div>`).join('');

  // Show warning if macros don't add up — tells user to verify label
  const warnEl = document.getElementById('scanMacroWarning');
  if (warnEl) {
    if (showCalWarning) {
      warnEl.style.display = 'block';
      warnEl.textContent = `⚠️ Macro math (${calcCals} kcal calc'd) doesn't match calories (${cals} kcal). Verify against the nutrition label before logging.`;
    } else {
      warnEl.style.display = 'none';
    }
  }

  document.getElementById('foodResult').style.display = 'block';
}

function adjustServings(delta) {
  servings = Math.max(0.5, Math.round((servings + delta) * 10) / 10);
  renderFoodResult();
}

function logScannedFood() {
  if (!scannedProduct) return;
  const p = scannedProduct;
  // Scale micros by servings
  const scaledMicros = {};
  if (p.micros) {
    Object.entries(p.micros).forEach(([k, v]) => {
      scaledMicros[k] = Math.round(v * servings * 1000) / 1000;
    });
  }
  addFoodEntry({
    name:     p.name,
    calories: Math.round(p.calories * servings),
    protein:  Math.round(p.protein  * servings * 10) / 10,
    carbs:    Math.round(p.carbs    * servings * 10) / 10,
    fat:      Math.round(p.fat      * servings * 10) / 10,
    icon: '🏷️',
    micros: Object.keys(scaledMicros).length ? scaledMicros : undefined,
  });
  if (selectedTimeSlot) {
    saveFoodToSlot({ name: p.name, calories: Math.round(p.calories * servings), protein: Math.round(p.protein * servings * 10)/10, carbs: Math.round(p.carbs * servings * 10)/10, fat: Math.round(p.fat * servings * 10)/10 }, selectedTimeSlot);
  }
  closeScanner();
  renderQuickRecs();
  showToast(`✅ ${p.name} logged!`);
}

function stopCamera() {
  try { if (window.Quagga) Quagga.stop(); } catch(e) {}
  if (scannerStream) { scannerStream.getTracks().forEach(t => t.stop()); scannerStream = null; }
  if (scannerInterval) { clearInterval(scannerInterval); scannerInterval = null; }
}

function closeScanner() {
  stopCamera();
  document.getElementById('scannerModal').classList.remove('open');
}

async function openScannerCamera() {
  try { await startQuagga(); } catch(e) {}
}

// ── AI Food Search ──
let aiSearchProduct  = null;
let aiSearchServings = 1;

function openAISearch() {
  aiSearchProduct  = null;
  aiSearchServings = 1;
  document.getElementById('aiSearchInput').value = '';
  document.getElementById('aiSearchLoading').style.display  = 'none';
  document.getElementById('aiSearchResults').style.display  = 'none';
  document.getElementById('aiSearchSelected').style.display = 'none';
  document.getElementById('aiSearchExamples').style.display = 'flex';
  document.getElementById('aiSearchModal').classList.add('open');
  setTimeout(() => document.getElementById('aiSearchInput').focus(), 300);
}

function closeAISearch() {
  document.getElementById('aiSearchModal').classList.remove('open');
}

function setSearchExample(btn) {
  document.getElementById('aiSearchInput').value = btn.textContent.replace(/^[^\s]+\s/,'').trim();
  runAISearch();
}

function backToAISearch() {
  document.getElementById('aiSearchSelected').style.display = 'none';
  document.getElementById('aiSearchResults').style.display  = 'block';
  document.getElementById('aiSearchExamples').style.display = 'none';
}

// ── Food search tab switching ──
function switchFoodSearchTab(tab) {
  ['search','meal','supp'].forEach(t => {
    const btn = document.getElementById('fstab-'+t);
    const panel = document.getElementById('fstab-'+t+'-content');
    if (btn) btn.classList.toggle('fstab-active', t === tab);
    if (panel) panel.style.display = t === tab ? '' : 'none';
  });
  if (tab === 'supp') renderSuppPresets();
}

// Parse a USDA food item into a standardized product object
function usdaFoodToProduct(f) {
  const nutr = n => (f.foodNutrients || []).find(x =>
    x.nutrientId === n || x.nutrientNumber === String(n) ||
    x.nutrientId === String(n)
  );
  let servingG = parseFloat(f.servingSize) || 0;
  const sUnit = (f.servingSizeUnit || 'g').toLowerCase();
  if (sUnit === 'oz') servingG *= 28.3495;
  else if (sUnit === 'lb') servingG *= 453.592;
  const scale = servingG > 0 ? servingG / 100 : 1;
  return {
    name:     f.description,
    brand:    f.brandOwner || f.brandName || f.dataType || '',
    serving:  f.servingSize ? `${f.servingSize}${f.servingSizeUnit || 'g'}` : '100g',
    calories: Math.round((nutr(1008)?.value || nutr(208)?.value || 0) * scale),
    protein:  Math.round((nutr(1003)?.value || nutr(203)?.value || 0) * scale * 10) / 10,
    carbs:    Math.round((nutr(1005)?.value || nutr(205)?.value || 0) * scale * 10) / 10,
    fat:      Math.round((nutr(1004)?.value || nutr(204)?.value || 0) * scale * 10) / 10,
    micros:   parseMicronutrients(f.foodNutrients, scale),
    fdcId:    f.fdcId,
    dataType: f.dataType,
    source:   'usda',
    confidence: 'high',
  };
}

// Search USDA — Foundation + SR Legacy first (best micros), then Branded
async function searchUSDAFull(query) {
  // First: whole foods (Foundation Foods + SR Legacy) — most complete micronutrient data
  const wholeFoodsUrl = `https://api.nal.usda.gov/fdc/v1/foods/search?query=${encodeURIComponent(query)}&dataType=Foundation,SR%20Legacy&pageSize=6&api_key=${USDA_API_KEY}`;
  const [wfRes, brandedRes] = await Promise.all([
    fetch(wholeFoodsUrl),
    fetch(`https://api.nal.usda.gov/fdc/v1/foods/search?query=${encodeURIComponent(query)}&dataType=Branded&pageSize=6&api_key=${USDA_API_KEY}`)
  ]);

  let results = [];

  if (wfRes.ok) {
    const wfData = await wfRes.json();
    const wf = (wfData.foods || []).map(f => ({ ...usdaFoodToProduct(f), microQuality: 'full' }))
      .filter(f => f.calories > 0);
    results.push(...wf);
  }

  if (brandedRes.ok) {
    const bData = await brandedRes.json();
    const branded = (bData.foods || []).map(f => ({ ...usdaFoodToProduct(f), microQuality: 'partial' }))
      .filter(f => f.calories > 0);
    results.push(...branded);
  }

  // Dedupe by name similarity, prefer Foundation/SR Legacy
  const seen = new Set();
  return results.filter(f => {
    const key = f.name.toLowerCase().slice(0, 30);
    if (seen.has(key)) return false;
    seen.add(key);
    return true;
  }).slice(0, 8);
}

async function runAISearch() {
  const query = document.getElementById('aiSearchInput').value.trim();
  if (!query) { showToast('⚠️ Describe a food first'); return; }

  document.getElementById('aiSearchExamples').style.display = 'none';
  document.getElementById('aiSearchResults').style.display  = 'none';
  document.getElementById('aiSearchSelected').style.display = 'none';
  document.getElementById('aiSearchLoading').style.display  = 'block';
  document.getElementById('aiSearchLoadingText').textContent = 'Searching USDA database…';

  try {
    const foods = await searchUSDAFull(query);

    if (foods.length > 0) {
      document.getElementById('aiSearchLoading').style.display = 'none';
      renderAISearchResults(foods);
      return;
    }

    // ── Fallback: Claude AI with full micro estimation ──
    document.getElementById('aiSearchLoadingText').textContent = 'Estimating with AI…';

    const prompt = 'You are a precise nutrition database. The user searched for: "' + query + '".' +
      ' Return 3 matching foods as JSON only, no markdown:' +
      ' {"results":[{"name":"Full food name","brand":"Brand or Generic","serving":"1 serving description",' +
      '"calories":0,"protein":0,"carbs":0,"fat":0,' +
      '"micros":{"vitC":0,"vitD":0,"vitB12":0,"calcium":0,"magnesium":0,"iron":0,"potassium":0,"zinc":0,"fiber":0,"sodium":0,"omega3":0},' +
      '"confidence":"high","microQuality":"estimated"}]}.' +
      ' Use real nutritional data. Fill in micros with best available estimates in mg or standard units.';

    const data = await callClaudeAPI({
      model: 'claude-haiku-4-5-20251001',
      max_tokens: 800,
      messages: [{ role: 'user', content: prompt }],
    });

    document.getElementById('aiSearchLoading').style.display = 'none';
    const text = (data.content?.[0]?.text || '').replace(/```json|```/g, '').trim();
    const jsonMatch = text.match(/\{[\s\S]*\}/);
    if (!jsonMatch) throw new Error('No JSON');
    const parsed = JSON.parse(jsonMatch[0]);
    renderAISearchResults((parsed.results || []).map(r => ({ ...r, source: 'ai' })));

  } catch (err) {
    document.getElementById('aiSearchLoading').style.display = 'none';
    document.getElementById('aiSearchExamples').style.display = 'flex';
    showToast('⚠️ Search failed — try again');
    console.error(err);
  }
}

function renderAISearchResults(results) {
  if (!results.length) {
    showToast('No results found — try a different description');
    document.getElementById('aiSearchExamples').style.display = 'flex';
    return;
  }

  const confIcon = { high: '✅', medium: '🟡', low: '⚪' };

  document.getElementById('aiSearchResultsList').innerHTML = results.map((r, i) => {
    const microCount = Object.keys(r.micros || {}).length;
    const microLabel = r.microQuality === 'full'     ? '🟢 Full micros' :
                       r.microQuality === 'partial'   ? '🟡 Partial micros' :
                       r.microQuality === 'estimated' ? '🔵 AI estimated' :
                       microCount > 5                 ? '🟢 Full micros' :
                       microCount > 0                 ? '🟡 Partial micros' : '⚪ Macros only';
    const srcBg = r.source === 'usda' ? '#0d1e3d' : '#1a1030';
    const srcCol = r.source === 'usda' ? '#60a5fa' : '#a78bfa';
    return `<div class="search-result-item" onclick="selectAISearchResult(${i})">
      <div style="flex:1">
        <div class="search-result-name">${r.name}</div>
        <div class="search-result-macros">${r.brand ? r.brand + ' · ' : ''}${r.serving}</div>
        <div class="search-result-macros" style="margin-top:3px">
          <span style="color:#f59e0b;font-weight:700">${r.calories} kcal</span> ·
          <span style="color:#22c55e">P ${r.protein}g</span> ·
          <span style="color:#3b82f6">C ${r.carbs}g</span> ·
          <span style="color:#ef4444">F ${r.fat}g</span>
          <span style="margin-left:6px;font-size:9px;background:${srcBg};color:${srcCol};padding:2px 6px;border-radius:8px;font-weight:700">${r.source === 'usda' ? 'USDA' : 'AI'}</span>
          <span style="margin-left:4px;font-size:9px;color:var(--text3)">${microLabel}</span>
        </div>
      </div>
      <div class="search-result-arrow">›</div>
    </div>`;
  }).join('');

  window._aiSearchResults = results;
  document.getElementById('aiSearchResults').style.display = 'block';
}

function selectAISearchResult(idx) {
  const r = window._aiSearchResults[idx];
  aiSearchProduct  = r;
  aiSearchServings = 1;

  document.getElementById('aiSearchResults').style.display  = 'none';
  renderAISearchFoodCard();
  document.getElementById('aiSearchSelected').style.display = 'block';
  document.getElementById('aiSearchServingsVal').textContent = '1';
}

function renderAISearchFoodCard() {
  if (!aiSearchProduct) return;
  const p = aiSearchProduct;
  const s = aiSearchServings;
  document.getElementById('aiSearchFoodCard').innerHTML = `
    <div class="food-name">${p.name}</div>
    <div class="food-brand">${p.brand} · ${p.serving} per serving</div>
    <div class="food-macros">
      <div class="food-macro-chip">
        <div class="food-macro-chip-val" style="color:#f59e0b">${Math.round(p.calories*s)}</div>
        <div class="food-macro-chip-lbl">kcal</div>
      </div>
      <div class="food-macro-chip">
        <div class="food-macro-chip-val" style="color:#22c55e">${(p.protein*s).toFixed(1)}g</div>
        <div class="food-macro-chip-lbl">protein</div>
      </div>
      <div class="food-macro-chip">
        <div class="food-macro-chip-val" style="color:#3b82f6">${(p.carbs*s).toFixed(1)}g</div>
        <div class="food-macro-chip-lbl">carbs</div>
      </div>
      <div class="food-macro-chip">
        <div class="food-macro-chip-val" style="color:#ef4444">${(p.fat*s).toFixed(1)}g</div>
        <div class="food-macro-chip-lbl">fat</div>
      </div>
    </div>`;
}

function adjustAISearchServings(delta) {
  aiSearchServings = Math.max(0.5, Math.round((aiSearchServings + delta) * 2) / 2);
  document.getElementById('aiSearchServingsVal').textContent = aiSearchServings;
  renderAISearchFoodCard();
}

function logAISearchFood() {
  if (!aiSearchProduct) return;
  const p = aiSearchProduct;
  const s = aiSearchServings;
  const scaledMicros = {};
  if (p.micros) {
    Object.entries(p.micros).forEach(([k, v]) => {
      scaledMicros[k] = Math.round(v * s * 1000) / 1000;
    });
  }
  addFoodEntry({
    name:     `${p.name}${s !== 1 ? ' ×'+s : ''}`,
    calories: Math.round(p.calories * s),
    protein:  Math.round(p.protein  * s * 10) / 10,
    carbs:    Math.round(p.carbs    * s * 10) / 10,
    fat:      Math.round(p.fat      * s * 10) / 10,
    icon: '🔍',
    micros: Object.keys(scaledMicros).length ? scaledMicros : undefined,
  });
  closeAISearch();
  showToast(`✅ ${p.name} logged!`);
}

// ── AI Photo Macro Estimator ──
let photoBase64 = null;
let aiProduct = null;
let aiServings = 1;
let aiSelectedSlot = null;

function openPhotoAI() {
  document.getElementById('photoModal').classList.add('open');
  resetPhoto();
  // Auto-select current time slot
  const slot = getTimeSlot();
  document.querySelectorAll('#aiTimeSlotPicker .ts-btn').forEach(b => {
    b.classList.toggle('active', b.dataset.slot === slot);
  });
  aiSelectedSlot = slot;
}

function closePhotoModal() {
  document.getElementById('photoModal').classList.remove('open');
  resetPhoto();
}

function triggerCamera() { document.getElementById('cameraInput').click(); }
function triggerGallery() { document.getElementById('galleryInput').click(); }

function handlePhotoInput(input) {
  const file = input.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    const dataUrl = e.target.result;
    // strip prefix to get pure base64
    photoBase64 = dataUrl.split(',')[1];
    document.getElementById('photoPreview').src = dataUrl;
    document.getElementById('photoPreviewWrap').style.display = 'block';
    document.getElementById('photoPlaceholder').style.display = 'none';
    document.getElementById('analyzeBtn').disabled = false;
    document.getElementById('analyzeBtn').style.opacity = '1';
  };
  reader.readAsDataURL(file);
  // reset input so same file can be reselected
  input.value = '';
}

function resetPhoto() {
  photoBase64 = null;
  aiProduct = null;
  aiServings = 1;
  document.getElementById('photoPreviewWrap').style.display = 'none';
  document.getElementById('photoPlaceholder').style.display = 'block';
  document.getElementById('analyzeBtn').disabled = true;
  document.getElementById('analyzeBtn').style.opacity = '0.4';
  document.getElementById('photoHint').value = '';
  document.getElementById('photoStep1').style.display = 'block';
  document.getElementById('photoStep2').style.display = 'none';
  document.getElementById('photoStep3').style.display = 'none';
}

const AI_LOADING_MSGS = [
  'Identifying ingredients and estimating portions…',
  'Checking protein content…',
  'Estimating carbohydrates…',
  'Calculating calories…',
  'Finalising macro breakdown…',
];

async function analyzePhoto() {
  if (!photoBase64) return;

  // Show loading step
  document.getElementById('photoStep1').style.display = 'none';
  document.getElementById('photoStep2').style.display = 'block';

  // Cycle loading messages
  let msgIdx = 0;
  const msgEl = document.getElementById('aiLoadingMsg');
  const msgInterval = setInterval(() => {
    msgIdx = (msgIdx + 1) % AI_LOADING_MSGS.length;
    msgEl.textContent = AI_LOADING_MSGS[msgIdx];
  }, 1800);

  const hint = document.getElementById('photoHint').value.trim();
  const prompt = `You are a precise sports nutrition expert. Analyse this food photo and estimate the macros.
${hint ? `The user says: "${hint}"` : ''}

Identify every food item visible, estimate realistic portion sizes for a typical serving shown, and return ONLY a valid JSON object with NO extra text, markdown, or explanation:

{
  "meal_name": "Short descriptive name (e.g. Grilled Chicken & Rice Bowl)",
  "description": "2-3 sentence breakdown of what you see, portion sizes, and any assumptions made",
  "calories": <integer, total kcal>,
  "protein": <number, grams, 1 decimal>,
  "carbs": <number, grams, 1 decimal>,
  "fat": <number, grams, 1 decimal>,
  "confidence": "high" | "medium" | "low"
}

Be realistic. A chicken breast is ~30g protein. A cup of rice is ~45g carbs. Err toward accuracy over optimism.`;

  try {
    const data = await callClaudeAPI({
      model: 'claude-opus-4-6',
      max_tokens: 1024,
      messages: [{
        role: 'user',
        content: [
          { type: 'image', source: { type: 'base64', media_type: 'image/jpeg', data: photoBase64 } },
          { type: 'text', text: prompt }
        ]
      }]
    });

    clearInterval(msgInterval);
    const rawText = data.content.find(b => b.type === 'text')?.text || '';

    // Parse JSON — strip any accidental markdown fences
    const cleaned = rawText.replace(/```json|```/g, '').trim();
    const parsed = JSON.parse(cleaned);

    aiProduct = {
      name: parsed.meal_name || 'Meal',
      description: parsed.description || '',
      calories: Math.round(parsed.calories || 0),
      protein:  Math.round((parsed.protein  || 0) * 10) / 10,
      carbs:    Math.round((parsed.carbs    || 0) * 10) / 10,
      fat:      Math.round((parsed.fat      || 0) * 10) / 10,
      confidence: parsed.confidence || 'medium',
    };
    aiServings = 1;
    renderAIResult();

  } catch (err) {
    clearInterval(msgInterval);
    document.getElementById('photoStep2').style.display = 'none';
    document.getElementById('photoStep1').style.display = 'block';
    document.getElementById('photoPreviewWrap').style.display = 'block';
    document.getElementById('photoPlaceholder').style.display = 'none';
    document.getElementById('analyzeBtn').disabled = false;
    document.getElementById('analyzeBtn').style.opacity = '1';
    showToast('❌ AI error: ' + (err.message || 'Try again'));
  }
}

function renderAIResult() {
  const p = aiProduct;
  document.getElementById('photoStep2').style.display = 'none';
  document.getElementById('photoStep3').style.display = 'block';

  const confColor = { high: '#22c55e', medium: '#f59e0b', low: '#ef4444' }[p.confidence] || '#d97706';
  const confLabel = { high: '✅ High confidence', medium: '⚠️ Medium confidence', low: '⚠️ Low confidence — add a hint for better accuracy' }[p.confidence] || '';

  document.getElementById('aiMealName').textContent = p.name;
  document.getElementById('aiMealDesc').innerHTML =
    `<span style="color:${confColor};font-weight:700;font-size:11px">${confLabel}</span><br>${p.description}`;
  document.getElementById('aiSrvVal').textContent = aiServings;
  renderAIMacroChips();
}

function renderAIMacroChips() {
  const p = aiProduct;
  const s = aiServings;
  document.getElementById('aiMealMacros').innerHTML = [
    { label: 'Calories', val: Math.round(p.calories * s),                    unit: 'kcal', color: '#f59e0b' },
    { label: 'Protein',  val: Math.round(p.protein  * s * 10) / 10,          unit: 'g',    color: '#22c55e' },
    { label: 'Carbs',    val: Math.round(p.carbs    * s * 10) / 10,          unit: 'g',    color: '#3b82f6' },
    { label: 'Fat',      val: Math.round(p.fat      * s * 10) / 10,          unit: 'g',    color: '#ef4444' },
  ].map(m => `
    <div class="food-macro-chip">
      <div class="food-macro-chip-val" style="color:${m.color}">${m.val}</div>
      <div class="food-macro-chip-lbl">${m.label}</div>
      <div style="font-size:9px;color:var(--text3)">${m.unit}</div>
    </div>`).join('');
}

function adjustAIServings(delta) {
  aiServings = Math.max(0.25, Math.round((aiServings + delta) * 100) / 100);
  document.getElementById('aiSrvVal').textContent = aiServings % 1 === 0 ? aiServings : aiServings.toFixed(2).replace(/\.?0+$/, '');
  renderAIMacroChips();
}

function logAIFood() {
  if (!aiProduct) return;
  const p = aiProduct;
  const s = aiServings;
  addFoodEntry({
    name:     p.name,
    calories: Math.round(p.calories * s),
    protein:  Math.round(p.protein  * s * 10) / 10,
    carbs:    Math.round(p.carbs    * s * 10) / 10,
    fat:      Math.round(p.fat      * s * 10) / 10,
    icon: '🤖',
  });
  if (aiSelectedSlot) {
    saveFoodToSlot({ name: p.name, calories: Math.round(p.calories*s), protein: Math.round(p.protein*s*10)/10, carbs: Math.round(p.carbs*s*10)/10, fat: Math.round(p.fat*s*10)/10 }, aiSelectedSlot);
  }
  closePhotoModal();
  renderQuickRecs();
  showToast(`✅ ${p.name} logged!`);
}

// ── Settings ──
function openSettings() {
  document.getElementById('settingsModal').classList.add('open');
  const creds = getStorage('garminCreds', null);
  if (creds) {
    document.getElementById('garminKey').value    = creds.key    || '';
    document.getElementById('garminSecret').value = creds.secret || '';
  }
  const goals = getStorage('userGoals', {});
  if (goals.weight) document.getElementById('settingWeight').value     = goals.weight;
  if (goals.goal)   document.getElementById('settingGoalWeight').value = goals.goal;
  // Populate macro fields
  const savedMacros = getStorage('userMacros', null) || MACROS;
  document.getElementById('settingCalories').value = savedMacros.calories;
  document.getElementById('settingProtein').value  = savedMacros.protein;
  document.getElementById('settingCarbs').value    = savedMacros.carbs;
  document.getElementById('settingFat').value      = savedMacros.fat;
  // Populate TDEE
  const savedTDEE = getStorage('userTDEE', null) || TDEE;
  document.getElementById('settingTDEE').value = savedTDEE;
  // Reset auto-calc result
  const res = document.getElementById('tdeeCalcResult');
  if (res) { res.style.display = 'none'; res.innerHTML = ''; }
  updateGarminSettingsUI();
  updateStravaSettingsUI();
}
function closeSettings() {
  document.getElementById('settingsModal').classList.remove('open');
}
function saveGoalSettings() {
  const w   = parseInt(document.getElementById('settingWeight').value)     || 170;
  const g   = parseInt(document.getElementById('settingGoalWeight').value) || 163;
  const cal = parseInt(document.getElementById('settingCalories').value)   || MACROS.calories;
  const pro = parseInt(document.getElementById('settingProtein').value)    || MACROS.protein;
  const crb = parseInt(document.getElementById('settingCarbs').value)      || MACROS.carbs;
  const fat = parseInt(document.getElementById('settingFat').value)        || MACROS.fat;
  const tdee = parseInt(document.getElementById('settingTDEE').value)      || TDEE;
  setStorage('userGoals',  { weight: w, goal: g });
  setStorage('userMacros', { calories: cal, protein: pro, carbs: crb, fat: fat });
  setStorage('userTDEE',   tdee);
  renderRings();
  renderProteinPace();
  renderWeeklyBalance();
  updateMacroTargetsRow();
  showToast('✅ Goals & macros saved!');
}

function autoCalcTDEE() {
  const resultEl = document.getElementById('tdeeCalcResult');
  // Need at least 7 days of both food log and weight entries
  const macroLog     = getStorage('macroLog', {});
  const weightEntries = getStorage('weightEntries', []).sort((a,b) => a.date > b.date ? 1 : -1);
  const burnLog      = getStorage('burnLog', {});

  if (weightEntries.length < 2) {
    resultEl.style.display = 'block';
    resultEl.innerHTML = '⚠️ Need at least 2 weight entries to calculate. Keep logging your weight daily and come back in a week.';
    return;
  }

  // Use entries within last 30 days that have both food + weight data
  const cutoff = new Date(); cutoff.setDate(cutoff.getDate() - 30);
  const recentWeights = weightEntries.filter(e => new Date(e.date) >= cutoff);
  if (recentWeights.length < 2) {
    resultEl.style.display = 'block';
    resultEl.innerHTML = '⚠️ Need more recent weight entries. Log your weight for at least 2 days within the past 30 days.';
    return;
  }

  const first = recentWeights[0];
  const last  = recentWeights[recentWeights.length - 1];
  const days  = Math.round((new Date(last.date) - new Date(first.date)) / (1000*60*60*24));
  if (days < 3) {
    resultEl.style.display = 'block';
    resultEl.innerHTML = '⚠️ Need at least 3 days between first and last weight entry for an accurate estimate.';
    return;
  }

  // Average daily calories logged between those dates
  const dateKeys = [];
  const d = new Date(first.date);
  while (d <= new Date(last.date)) {
    dateKeys.push(d.toISOString().slice(0,10));
    d.setDate(d.getDate()+1);
  }
  const loggedKeys = dateKeys.filter(k => macroLog[k] && macroLog[k].calories > 0);
  if (loggedKeys.length < 3) {
    resultEl.style.display = 'block';
    resultEl.innerHTML = '⚠️ Not enough food log entries in that period. Log your meals for at least 3 days.';
    return;
  }

  const avgCals = loggedKeys.reduce((s,k) => s + macroLog[k].calories, 0) / loggedKeys.length;
  const weightChange = last.weight - first.weight; // negative = loss
  // calories from weight change: 1 lb = 3500 kcal
  const calsFromWeightChange = (weightChange * 3500) / days; // daily surplus/deficit from weight
  // TDEE = avgCals - calsFromWeightChange
  // If lost weight (negative change), calsFromWeightChange is negative, so TDEE = avgCals + |deficit|
  const estimatedTDEE = Math.round(avgCals - calsFromWeightChange);

  // Populate the field
  document.getElementById('settingTDEE').value = estimatedTDEE;

  const lostGained = weightChange < 0 ? `lost ${Math.abs(weightChange).toFixed(1)} lbs` : `gained ${weightChange.toFixed(1)} lbs`;
  resultEl.style.display = 'block';
  resultEl.innerHTML = `
    <strong style="color:var(--text)">Estimated TDEE: ${estimatedTDEE.toLocaleString()} kcal</strong><br>
    Based on ${days} days of data (${loggedKeys.length} days logged).<br>
    Avg intake: ${Math.round(avgCals)} kcal/day · ${lostGained} (${first.date} → ${last.date})<br>
    <span style="color:var(--text3)">Hit Save to apply this number.</span>
  `;
}

// ── Garmin OAuth 1.0a ──
// Garmin uses OAuth 1.0a. Since this runs client-side we do the request-token
// step via a CORS proxy, then redirect the user to Garmin's auth page.
// On return the verifier comes back in the URL and we exchange for access token.

const GARMIN_BASE      = 'https://connectapi.garmin.com';
const GARMIN_REQ_URL   = GARMIN_BASE + '/oauth-service/oauth/request_token';
const GARMIN_AUTH_URL  = 'https://connect.garmin.com/oauthConfirm';
const GARMIN_ACCESS_URL= GARMIN_BASE + '/oauth-service/oauth/access_token';
const GARMIN_API_BASE  = GARMIN_BASE + '/activitylist-service/activities/search/activities';
const CORS_PROXY       = 'https://corsproxy.io/?';

function b64(str) { return btoa(unescape(encodeURIComponent(str))); }
function rfc3986(str) { return encodeURIComponent(str).replace(/[!'()*]/g, c => '%' + c.charCodeAt(0).toString(16).toUpperCase()); }

function generateNonce() {
  return Math.random().toString(36).substring(2) + Math.random().toString(36).substring(2);
}

function oauthHeader(method, url, params, consumerKey, consumerSecret, tokenKey='', tokenSecret='') {
  const ts = Math.floor(Date.now() / 1000).toString();
  const nonce = generateNonce();
  const base = {
    oauth_consumer_key: consumerKey,
    oauth_nonce: nonce,
    oauth_signature_method: 'HMAC-SHA1',
    oauth_timestamp: ts,
    oauth_token: tokenKey,
    oauth_version: '1.0',
    ...params
  };
  if (!tokenKey) delete base.oauth_token;

  const sortedKeys = Object.keys(base).sort();
  const paramStr = sortedKeys.map(k => `${rfc3986(k)}=${rfc3986(base[k])}`).join('&');
  const sigBase = `${method}&${rfc3986(url)}&${rfc3986(paramStr)}`;
  const sigKey  = `${rfc3986(consumerSecret)}&${rfc3986(tokenSecret)}`;

  // HMAC-SHA1 via Web Crypto
  return { sigBase, sigKey, nonce, ts, base };
}

async function hmacSha1(key, data) {
  const enc = new TextEncoder();
  const cryptoKey = await crypto.subtle.importKey(
    'raw', enc.encode(key), { name: 'HMAC', hash: 'SHA-1' }, false, ['sign']
  );
  const sig = await crypto.subtle.sign('HMAC', cryptoKey, enc.encode(data));
  return btoa(String.fromCharCode(...new Uint8Array(sig)));
}

async function buildAuthHeader(method, url, extraParams, consumerKey, consumerSecret, tokenKey='', tokenSecret='') {
  const { sigBase, sigKey, nonce, ts, base } = oauthHeader(method, url, extraParams, consumerKey, consumerSecret, tokenKey, tokenSecret);
  const sig = await hmacSha1(sigKey, sigBase);
  const headerParams = { ...base, oauth_signature: sig };
  if (!tokenKey) delete headerParams.oauth_token;
  const hdr = 'OAuth ' + Object.keys(headerParams).sort()
    .map(k => `${rfc3986(k)}="${rfc3986(headerParams[k])}"`)
    .join(', ');
  return hdr;
}

async function startGarminOAuth() {
  const key    = document.getElementById('garminKey').value.trim();
  const secret = document.getElementById('garminSecret').value.trim();
  if (!key || !secret) { showToast('⚠️ Enter your Consumer Key and Secret first'); return; }

  setStorage('garminCreds', { key, secret });
  showToast('🔄 Requesting token from Garmin…');

  try {
    const callbackUrl = encodeURIComponent(window.location.href.split('?')[0]);
    const authHeader = await buildAuthHeader('POST', GARMIN_REQ_URL, { oauth_callback: callbackUrl }, key, secret);

    const res = await fetch(CORS_PROXY + encodeURIComponent(GARMIN_REQ_URL), {
      method: 'POST',
      headers: { 'Authorization': authHeader, 'Content-Type': 'application/x-www-form-urlencoded' }
    });
    const text = await res.text();
    const params = Object.fromEntries(new URLSearchParams(text));

    if (!params.oauth_token) throw new Error('No request token received. Check your Consumer Key/Secret.');

    setStorage('garminReqToken', params);
    // Redirect to Garmin authorize page
    window.location.href = `${GARMIN_AUTH_URL}?oauth_token=${params.oauth_token}`;

  } catch (err) {
    showToast('❌ ' + err.message);
  }
}

async function handleOAuthCallback() {
  const urlParams = new URLSearchParams(window.location.search);
  const verifier  = urlParams.get('oauth_verifier');
  const token     = urlParams.get('oauth_token');
  if (!verifier || !token) return;

  // Clean URL
  window.history.replaceState({}, '', window.location.pathname);

  document.getElementById('oauthModal').classList.add('open');
  document.getElementById('oauthTitle').textContent = 'Completing authorization…';
  document.getElementById('oauthMsg').textContent = 'Exchanging tokens with Garmin. This takes just a moment.';

  const creds    = getStorage('garminCreds', {});
  const reqToken = getStorage('garminReqToken', {});

  try {
    const authHeader = await buildAuthHeader(
      'POST', GARMIN_ACCESS_URL,
      { oauth_verifier: verifier },
      creds.key, creds.secret,
      reqToken.oauth_token, reqToken.oauth_token_secret
    );
    const res = await fetch(CORS_PROXY + encodeURIComponent(GARMIN_ACCESS_URL), {
      method: 'POST',
      headers: { 'Authorization': authHeader, 'Content-Type': 'application/x-www-form-urlencoded' }
    });
    const text = await res.text();
    const accessParams = Object.fromEntries(new URLSearchParams(text));

    if (!accessParams.oauth_token) throw new Error('Token exchange failed. Try connecting again.');

    setStorage('garminToken', {
      token: accessParams.oauth_token,
      secret: accessParams.oauth_token_secret,
      displayName: accessParams.display_name || 'Garmin User'
    });

    document.getElementById('oauthIcon').textContent = '✅';
    document.getElementById('oauthTitle').textContent = 'Connected!';
    document.getElementById('oauthMsg').textContent = `Successfully connected as ${accessParams.display_name || 'your Garmin account'}. Fetching today\'s activities…`;

    setTimeout(() => {
      document.getElementById('oauthModal').classList.remove('open');
      updateGarminSettingsUI();
      fetchGarminToday();
    }, 2000);

  } catch (err) {
    document.getElementById('oauthIcon').textContent = '❌';
    document.getElementById('oauthTitle').textContent = 'Connection failed';
    document.getElementById('oauthMsg').textContent = err.message;
  }
}

function updateGarminSettingsUI() {
  const tok = getStorage('garminToken', null);
  const statusEl  = document.getElementById('garminConnectStatus');
  const setupEl   = document.getElementById('garminSetupSteps');
  const panelEl   = document.getElementById('garminConnectedPanel');
  if (tok) {
    statusEl.className = 'connect-status connected';
    statusEl.textContent = '🟢 Connected';
    setupEl.style.display  = 'none';
    panelEl.style.display  = 'block';
    document.getElementById('garminUsername').textContent = tok.displayName || 'Garmin User';
  } else {
    statusEl.className = 'connect-status disconnected';
    statusEl.textContent = '⚪ Not connected';
    setupEl.style.display  = 'block';
    panelEl.style.display  = 'none';
  }
}

function toggleAutoAdjust(btn) {
  btn.classList.toggle('on');
  setStorage('garminAutoAdjust', btn.classList.contains('on'));
}

function disconnectGarmin() {
  if (!confirm('Disconnect your Garmin account?')) return;
  localStorage.removeItem('garminToken');
  localStorage.removeItem('garminCreds');
  localStorage.removeItem('garminReqToken');
  updateGarminSettingsUI();
  document.getElementById('garminCard').style.display = 'none';
  showToast('Garmin disconnected');
}

// ── Fetch today's Garmin activities ──
async function fetchGarminToday() {
  const tok   = getStorage('garminToken', null);
  const creds = getStorage('garminCreds', null);
  if (!tok || !creds) return;

  document.getElementById('garminCard').style.display = 'block';
  document.getElementById('garminActivitySub').textContent = 'Syncing…';

  const today = nowEST();
  const startLocal = dateToKey(today);
  const apiUrl = `${GARMIN_API_BASE}?startDate=${startLocal}&limit=10`;

  try {
    const authHeader = await buildAuthHeader(
      'GET', GARMIN_API_BASE,
      { startDate: startLocal, limit: '10' },
      creds.key, creds.secret,
      tok.token, tok.secret
    );
    const res = await fetch(CORS_PROXY + encodeURIComponent(apiUrl), {
      headers: { 'Authorization': authHeader, 'Accept': 'application/json' }
    });
    if (!res.ok) throw new Error(`Garmin API error ${res.status}`);
    const activities = await res.json();

    // Sum up runs / cardio for today
    let totalCalories = 0, totalDistance = 0, totalDuration = 0, activityCount = 0;
    const runTypes = ['running','trail_running','treadmill_running','track_running'];

    (Array.isArray(activities) ? activities : []).forEach(a => {
      const type = (a.activityType?.typeKey || '').toLowerCase();
      if (runTypes.some(r => type.includes(r))) {
        totalCalories += a.calories || 0;
        totalDistance += a.distance || 0;
        totalDuration += a.duration || 0;
        activityCount++;
      }
    });

    renderGarminCard(totalCalories, totalDistance, totalDuration, activityCount);
    if (getStorage('garminAutoAdjust', true)) {
      adjustMacrosForBurn(totalCalories);
    }
    setStorage('garminToday', { calories: totalCalories, distance: totalDistance, duration: totalDuration, fetched: Date.now() });

  } catch (err) {
    document.getElementById('garminActivitySub').textContent = '⚠️ Sync failed — ' + err.message;
  }
}

function renderGarminCard(calories, distance, duration, count, source='garmin') {
  const km    = (distance / 1000).toFixed(1);
  const miles = (distance / 1609.34).toFixed(1);
  const mins  = Math.round(duration / 60);
  const hrs   = mins >= 60 ? `${Math.floor(mins/60)}h ${mins%60}m` : `${mins}m`;
  const srcLabel = source === 'strava' ? 'Strava' : 'Garmin Connect';
  const srcEmoji = source === 'strava' ? '🟠' : '🔵';

  document.getElementById('garminActivityTitle').textContent = count > 0 ? `${count} run${count>1?'s':''} today` : 'No runs today';
  document.getElementById('garminActivitySub').textContent   = count > 0
    ? `${srcEmoji} Synced from ${srcLabel}`
    : `${srcEmoji} ${srcLabel} · Rest day — standard macros apply`;

  document.getElementById('garminStatsRow').innerHTML = [
    { val: calories > 0 ? calories.toLocaleString() : '—', lbl: 'Calories', color: '#f59e0b' },
    { val: parseFloat(miles) > 0 ? miles + ' mi'    : '—', lbl: 'Distance', color: '#3b82f6' },
    { val: mins > 0 ? hrs                            : '—', lbl: 'Duration', color: '#22c55e' },
  ].map(s => `<div class="garmin-stat">
    <div class="garmin-stat-val" style="color:${s.color}">${s.val}</div>
    <div class="garmin-stat-lbl">${s.lbl}</div>
  </div>`).join('');

  // Show shoe row if there's a run and at least one active shoe
  const shoeRow = document.getElementById('todayShoeRow');
  if (shoeRow) {
    const hasRun    = parseFloat(miles) > 0;
    const hasShoes  = getShoes().filter(s => s.status === 'active').length > 0;
    if (hasRun && hasShoes) {
      shoeRow.style.display = 'flex';
      const todayRun  = getShoeRuns().find(r => r.date === todayKey());
      const labelEl   = document.getElementById('todayShoeLabel');
      const assignBtn = document.getElementById('todayShoeAssignBtn');
      if (todayRun) {
        const shoe = getShoes().find(s => s.id === todayRun.shoeId);
        labelEl.textContent = `👟 ${shoe?.name || 'Shoes'} · ${todayRun.miles.toFixed(2)} mi logged`;
        if (assignBtn) assignBtn.style.display = 'none';
      } else {
        labelEl.textContent = `👟 Which shoes did you wear? (${miles} mi)`;
        if (assignBtn) assignBtn.style.display = '';
      }
    } else {
      shoeRow.style.display = 'none';
    }
  }
}

function openTodayShoeAssign() {
  const cached = getStorage('stravaToday', null) || getStorage('garminToday', null);
  if (!cached || !cached.distance) { showToast('⚠️ No run data — sync Strava first'); return; }
  promptShoeAssignment({
    date:       todayKey(),
    miles:      cached.distance / 1609.34,
    duration:   cached.duration || 0,
    calories:   cached.calories || 0,
    activityId: cached.activityId || null,
  });
}

function adjustMacrosForBurn(burnCalories) {
  const banner = document.getElementById('garminMacroBanner');
  const text   = document.getElementById('garminMacroText');

  // Persist burn calories keyed by date so it survives page reload
  const burnLog = getStorage('burnLog', {});
  const todayK  = todayKey();
  if (burnCalories > 0) {
    burnLog[todayK] = burnCalories;
    setStorage('burnLog', burnLog);
  }

  if (burnCalories <= 0) {
    banner.style.display = 'none';
    setStorage('garminAdjustedMacros', null);
    renderRings();
    return;
  }

  // Add ~60% of burn back as extra calories (don't eat back 100% — still want a deficit)
  const extraCals  = Math.round(burnCalories * 0.6);
  const extraCarbs = Math.round(extraCals * 0.65 / 4); // 65% from carbs

  const base = getStorage('adaptiveMacros', null) || getStorage('userMacros', null) || MACROS;
  const adjusted = {
    calories: base.calories + extraCals,
    carbs:    base.carbs    + extraCarbs,
    protein:  base.protein,
    fat:      base.fat,
  };

  setStorage('garminAdjustedMacros', adjusted);

  banner.style.display = 'flex';
  text.textContent = `🟠 Run detected! +${extraCals} kcal → ${adjusted.calories} kcal target, ${adjusted.carbs}g carbs`;

  // Update rings, targets row, and weekly balance
  renderRings(adjusted);
  renderWeeklyBalance();
}

// ── Strava OAuth 2.0 ──
const STRAVA_AUTH_URL   = 'https://www.strava.com/oauth/authorize';
const STRAVA_TOKEN_URL  = 'https://www.strava.com/oauth/token';
const STRAVA_API_BASE   = 'https://www.strava.com/api/v3';

function startStravaOAuth() {
  const clientId = document.getElementById('stravaClientId').value.trim();
  const secret   = document.getElementById('stravaClientSecret').value.trim();
  if (!clientId || !secret) { showToast('⚠️ Enter your Client ID and Secret first'); return; }
  setStorage('stravaCreds', { clientId, secret });

  const redirectUri = encodeURIComponent('https://macro.jeremy-39c.workers.dev');
  const scope = 'read,activity:read';
  window.location.href = `${STRAVA_AUTH_URL}?client_id=${clientId}&redirect_uri=${redirectUri}&response_type=code&scope=${scope}&state=strava_oauth`;
}

async function handleStravaCallback() {
  const urlParams = new URLSearchParams(window.location.search);
  const code  = urlParams.get('code');
  const state = urlParams.get('state');
  if (!code || state !== 'strava_oauth') return;

  // Clean URL immediately
  window.history.replaceState({}, '', window.location.pathname);

  document.getElementById('oauthModal').classList.add('open');
  document.getElementById('oauthIcon').textContent  = '🟠';
  document.getElementById('oauthTitle').textContent = 'Connecting to Strava…';
  document.getElementById('oauthMsg').textContent   = 'Exchanging authorization code for access token…';

  const creds = getStorage('stravaCreds', {});
  try {
    const res = await fetch(STRAVA_TOKEN_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        client_id:     creds.clientId,
        client_secret: creds.secret,
        code,
        grant_type:    'authorization_code',
        redirect_uri:  'https://macro.jeremy-39c.workers.dev'
      })
    });
    const data = await res.json();
    if (!data.access_token) throw new Error(data.message || 'Token exchange failed');

    setStorage('stravaToken', {
      accessToken:  data.access_token,
      refreshToken: data.refresh_token,
      expiresAt:    data.expires_at,
      athlete:      data.athlete,
    });

    const name = `${data.athlete?.firstname || ''} ${data.athlete?.lastname || ''}`.trim() || 'Strava User';
    document.getElementById('oauthIcon').textContent  = '✅';
    document.getElementById('oauthTitle').textContent = 'Strava Connected!';
    document.getElementById('oauthMsg').textContent   = `Connected as ${name}. Fetching today's activities…`;

    setTimeout(() => {
      document.getElementById('oauthModal').classList.remove('open');
      updateStravaSettingsUI();
      fetchStravaToday();
    }, 2000);

  } catch (err) {
    document.getElementById('oauthIcon').textContent  = '❌';
    document.getElementById('oauthTitle').textContent = 'Connection failed';
    document.getElementById('oauthMsg').textContent   = err.message;
  }
}

async function refreshStravaTokenIfNeeded() {
  const tok = getStorage('stravaToken', null);
  if (!tok) return null;

  // Token still valid
  if (Date.now() / 1000 < tok.expiresAt - 300) return tok.accessToken;

  // Need to refresh
  const creds = getStorage('stravaCreds', {});
  if (!creds.clientId || !creds.secret) {
    showToast('⚠️ Strava credentials missing — reconnect in Settings');
    return tok.accessToken; // try with existing token
  }

  try {
    const res = await fetch(STRAVA_TOKEN_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        client_id:     creds.clientId,
        client_secret: creds.secret,
        refresh_token: tok.refreshToken,
        grant_type:    'refresh_token'
      })
    });
    const data = await res.json();
    if (!data.access_token) {
      console.warn('Strava refresh response:', data);
      showToast('⚠️ Strava token refresh failed — try reconnecting in Settings');
      return tok.accessToken;
    }
    const updated = { ...tok, accessToken: data.access_token, refreshToken: data.refresh_token, expiresAt: data.expires_at };
    setStorage('stravaToken', updated);
    return data.access_token;
  } catch(e) {
    console.warn('Strava refresh error:', e);
    return tok.accessToken;
  }
}

async function fetchStravaToday() {
  const accessToken = await refreshStravaTokenIfNeeded();
  if (!accessToken) return;

  document.getElementById('garminCard').style.display = 'block';
  document.getElementById('garminActivitySub').textContent = 'Syncing from Strava…';

  // Get today's date in EST, then build UTC unix timestamps for midnight EST = 05:00 UTC
  const estDate = todayKey(); // YYYY-MM-DD in EST
  const startOfDay = Math.floor(new Date(estDate + 'T05:00:00Z').getTime() / 1000); // midnight EST = 05:00 UTC
  const endOfDay   = Math.floor(new Date(estDate + 'T04:59:59Z').getTime() / 1000) + 86400; // 23:59:59 EST

  try {
    const res = await fetch(
      `${STRAVA_API_BASE}/athlete/activities?after=${startOfDay}&before=${endOfDay}&per_page=30`,
      { headers: { 'Authorization': `Bearer ${accessToken}` } }
    );

    if (res.status === 401) {
      // Token truly expired and refresh failed — ask user to reconnect
      document.getElementById('garminActivitySub').textContent = '⚠️ Strava session expired — reconnect in Settings';
      setStorage('stravaToken', null);
      return;
    }
    if (!res.ok) {
      const errText = await res.text().catch(() => '');
      throw new Error(`Strava API ${res.status}: ${errText.slice(0,120)}`);
    }

    const activities = await res.json();

    const runTypes = ['Run','VirtualRun','TrailRun','Treadmill','Walk','Hike'];
    const todayRuns = activities.filter(a => {
      const type = a.sport_type || a.type || '';
      return runTypes.some(t => type.toLowerCase().includes(t.toLowerCase()));
    });

    let totalCalories = 0, totalDistance = 0, totalDuration = 0, count = todayRuns.length;

    // The list endpoint doesn't return calories — fetch detail for each run
    // (Strava detail endpoint includes the calories field shown in app)
    for (const a of todayRuns) {
      let cal = 0;
      try {
        const detailRes = await fetch(
          `${STRAVA_API_BASE}/activities/${a.id}`,
          { headers: { 'Authorization': `Bearer ${accessToken}` } }
        );
        if (detailRes.ok) {
          const detail = await detailRes.json();
          cal = detail.calories || 0;
        }
      } catch(e) {
        // Fallback: estimate from kilojoules if detail fetch fails
        cal = a.kilojoules ? Math.round(a.kilojoules / 4.184) : 0;
      }
      totalCalories += cal;
      totalDistance += a.distance || 0;
      totalDuration += a.moving_time || 0;
    }

    renderGarminCard(totalCalories, totalDistance, totalDuration, count, 'strava');
    if (getStorage('stravaAutoAdjust', true)) adjustMacrosForBurn(totalCalories);
    setStorage('stravaToday', { calories: totalCalories, distance: totalDistance, duration: totalDuration, fetched: Date.now() });
    renderShoeStravaCard();

    // Prompt shoe assignment after run syncs
    if (todayRuns.length > 0 && totalDistance > 0) {
      onStravaRunSynced({
        date:       todayKey(),
        miles:      totalDistance / 1609.34,
        duration:   totalDuration,
        calories:   totalCalories,
        activityId: String(todayRuns[0].id),
      });
    }
  } catch (err) {
    document.getElementById('garminActivitySub').textContent = '⚠️ Strava sync failed — ' + err.message;
  }
}

function updateStravaSettingsUI() {
  const tok = getStorage('stravaToken', null);
  const statusEl = document.getElementById('stravaConnectStatus');
  const setupEl  = document.getElementById('stravaSetupSteps');
  const panelEl  = document.getElementById('stravaConnectedPanel');

  if (tok) {
    statusEl.className   = 'connect-status connected';
    statusEl.textContent = '🟢 Connected';
    setupEl.style.display  = 'none';
    panelEl.style.display  = 'block';
    // Show the activity card immediately — data fills in after async fetch
    document.getElementById('garminCard').style.display = 'block';
    const a = tok.athlete;
    document.getElementById('stravaUsername').textContent =
      a ? `${a.firstname || ''} ${a.lastname || ''}`.trim() : 'Strava User';
    const creds = getStorage('stravaCreds', {});
    if (creds.clientId) document.getElementById('stravaClientId').value = creds.clientId;
  } else {
    statusEl.className   = 'connect-status disconnected';
    statusEl.textContent = '⚪ Not connected';
    setupEl.style.display  = 'block';
    panelEl.style.display  = 'none';
  }
}

function toggleStravaAutoAdjust(btn) {
  btn.classList.toggle('on');
  setStorage('stravaAutoAdjust', btn.classList.contains('on'));
}

function disconnectStrava() {
  if (!confirm('Disconnect your Strava account?')) return;
  localStorage.removeItem('stravaToken');
  localStorage.removeItem('stravaCreds');
  localStorage.removeItem('stravaToday');
  localStorage.removeItem('stravaAdjustedMacros');
  updateStravaSettingsUI();
  // Hide garmin card only if garmin also not connected
  const garminTok = getStorage('garminToken', null);
  if (!garminTok) document.getElementById('garminCard').style.display = 'none';
  renderRings();
  showToast('Strava disconnected');
}

// ── Weight Tracking & Trend ──
const GOAL_WEIGHT    = 163;
const START_WEIGHT   = 170;
const GOAL_DAYS      = 30;
const GOAL_WEEKLY_LB = (START_WEIGHT - GOAL_WEIGHT) / (GOAL_DAYS / 7); // ~1.63 lbs/wk

function openWeightModal() {
  const log = getStorage('weightLog', {});
  const today = log[todayKey()];
  document.getElementById('weightInput').value = today || '';
  document.getElementById('weightModal').classList.add('open');
}

function saveWeight() {
  const val = parseFloat(document.getElementById('weightInput').value);
  if (!val || val < 50 || val > 500) { showToast('⚠️ Enter a valid weight'); return; }
  const log = getStorage('weightLog', {});
  log[todayKey()] = val;
  setStorage('weightLog', log);
  logInteraction('weight_logged', val);
  document.getElementById('weightModal').classList.remove('open');
  renderWeightTrend();
  checkAdaptiveMacros();
  showToast(`⚖️ ${val} lbs logged!`);
}

function getWeightTrend() {
  const log = getStorage('weightLog', {});
  const entries = Object.entries(log)
    .map(([date, weight]) => ({ date, weight }))
    .sort((a, b) => a.date.localeCompare(b.date))
    .slice(-30); // last 30 days
  return entries;
}

// Normalize weightLog (always stored as {date: number}) into sorted [{date, weight}] array
function getWeightEntries() {
  const log = getStorage('weightLog', {});
  return Object.entries(log)
    .map(([date, weight]) => ({ date, weight: parseFloat(weight) }))
    .sort((a, b) => a.date.localeCompare(b.date));
}

// Get most recent logged weight as a number, or null
function getLatestWeight() {
  const entries = getWeightEntries();
  return entries.length ? entries[entries.length - 1].weight : null;
}


function smoothedWeight(entries) {
  // 3-day rolling average
  return entries.map((e, i) => {
    const slice = entries.slice(Math.max(0, i-2), i+1);
    const avg = slice.reduce((s, x) => s + x.weight, 0) / slice.length;
    return { ...e, smoothed: Math.round(avg * 10) / 10 };
  });
}

function renderWeightTrend() {
  const entries = getWeightTrend();
  const card  = document.getElementById('weightTrendCard');
  const svg   = document.getElementById('weightSparkline');
  const badges = document.getElementById('weightBadges');
  const statBlock = document.getElementById('weightStatBlock');

  if (entries.length === 0) {
    svg.innerHTML = '<text x="150" y="34" text-anchor="middle" font-size="11" fill="#4d5468" font-family="Plus Jakarta Sans, sans-serif">Log your weight to see your trend</text>';
    badges.innerHTML = '';
    statBlock.style.display = 'none';
    return;
  }

  // Latest weight
  const latest = entries[entries.length - 1];
  document.getElementById('weightTrendVal').textContent = latest.weight;
  document.getElementById('weightTrendSubtitle').textContent = `${entries.length} day${entries.length>1?'s':''} tracked · Goal: ${GOAL_WEIGHT} lbs`;
  statBlock.style.display = 'block';

  // Sparkline
  const smoothed = smoothedWeight(entries);
  const weights  = smoothed.map(e => e.smoothed);
  const minW = Math.min(...weights) - 1;
  const maxW = Math.max(...weights) + 1;
  const W = 300, H = 60;
  const toX = (i) => entries.length === 1 ? W/2 : (i / (entries.length - 1)) * W;
  const toY = (w) => H - ((w - minW) / (maxW - minW)) * (H - 8) - 4;

  const points = smoothed.map((e, i) => `${toX(i).toFixed(1)},${toY(e.smoothed).toFixed(1)}`).join(' ');
  const firstPt = `${toX(0).toFixed(1)},${toY(smoothed[0].smoothed).toFixed(1)}`;
  const lastPt  = `${toX(smoothed.length-1).toFixed(1)},${toY(smoothed[smoothed.length-1].smoothed).toFixed(1)}`;

  // Goal line
  const goalY = toY(GOAL_WEIGHT);

  svg.innerHTML = `
    <defs>
      <linearGradient id="wGrad" x1="0" y1="0" x2="0" y2="1">
        <stop offset="0%" stop-color="#22c55e" stop-opacity="0.18"/>
        <stop offset="100%" stop-color="#22c55e" stop-opacity="0"/>
      </linearGradient>
    </defs>
    ${goalY >= 0 && goalY <= H ? `<line x1="0" y1="${goalY.toFixed(1)}" x2="${W}" y2="${goalY.toFixed(1)}" stroke="#3b82f6" stroke-width="1" stroke-dasharray="4,3" opacity="0.5"/>
    <text x="${W-2}" y="${(goalY-3).toFixed(1)}" text-anchor="end" font-size="9" fill="#3b82f6" font-family="Plus Jakarta Sans,sans-serif" opacity="0.8">Goal</text>` : ''}
    <polyline points="${points}" fill="none" stroke="#22c55e" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
    <circle cx="${lastPt.split(',')[0]}" cy="${lastPt.split(',')[1]}" r="3.5" fill="#22c55e"/>
  `;

  // Progress badges
  const totalLost  = START_WEIGHT - latest.weight;
  const remaining  = latest.weight - GOAL_WEIGHT;
  const daysIn     = entries.length;
  const expectedLost = (daysIn / GOAL_DAYS) * (START_WEIGHT - GOAL_WEIGHT);
  const diff       = totalLost - expectedLost;

  let statusClass = 'neutral', statusText = 'Keep logging';
  if (entries.length >= 5) {
    if (diff >= -0.3 && diff <= 0.5)   { statusClass = 'on-track'; statusText = '✅ On track'; }
    else if (diff < -0.3)              { statusClass = 'too-slow'; statusText = '⚠️ Behind pace'; }
    else if (diff > 0.5)               { statusClass = 'too-fast'; statusText = '⚡ Ahead of pace'; }
  }

  badges.innerHTML = [
    remaining > 0 ? `<span class="weight-badge neutral">📉 ${remaining.toFixed(1)} lbs to go</span>` : `<span class="weight-badge on-track">🎉 Goal reached!</span>`,
    totalLost > 0 ? `<span class="weight-badge on-track">−${totalLost.toFixed(1)} lbs lost</span>` : '',
    entries.length >= 3 ? `<span class="weight-badge ${statusClass}">${statusText}</span>` : '',
  ].filter(Boolean).join('');
}

// ── Adaptive Macro Adjustment ──
function checkAdaptiveMacros() {
  const entries = getWeightTrend();
  if (entries.length < 7) return; // Need at least a week of data

  // Get last 7 days average
  const last7 = entries.slice(-7);
  const avgWeight = last7.reduce((s, e) => s + e.weight, 0) / last7.length;

  // Get previous 7 days avg (if available)
  if (entries.length < 14) return;
  const prev7 = entries.slice(-14, -7);
  const prevAvg = prev7.reduce((s, e) => s + e.weight, 0) / prev7.length;

  const weeklyChange = avgWeight - prevAvg; // negative = losing
  const targetChange = -GOAL_WEEKLY_LB;     // we want ~-1.63 lbs/wk

  const diff = weeklyChange - targetChange; // positive = losing too slow, negative = too fast

  let newCalories = MACROS.calories;
  let msg = '';

  if (Math.abs(diff) < 0.3) {
    msg = `✅ Perfect pace — losing ${Math.abs(weeklyChange).toFixed(1)} lbs/wk. Macros unchanged.`;
  } else if (diff > 0.3) {
    // Losing too slowly — cut more
    const cut = Math.round(diff * 500);
    newCalories = Math.max(1800, MACROS.calories - cut);
    msg = `⚠️ Losing ${Math.abs(weeklyChange).toFixed(1)} lbs/wk — below target. Reducing calories by ${MACROS.calories - newCalories} to ${newCalories} kcal.`;
  } else {
    // Losing too fast — add back
    const add = Math.round(Math.abs(diff) * 500);
    newCalories = Math.min(2800, MACROS.calories + add);
    msg = `⚡ Losing ${Math.abs(weeklyChange).toFixed(1)} lbs/wk — ahead of target. Adding ${newCalories - MACROS.calories} calories to ${newCalories} kcal to protect muscle.`;
  }

  // Update adaptive targets
  const adjustedProtein = MACROS.protein; // always keep protein high
  const adjustedCarbs   = Math.round((newCalories - adjustedProtein * 4 - MACROS.fat * 9) / 4);
  const adaptive = { calories: newCalories, protein: adjustedProtein, carbs: Math.max(100, adjustedCarbs), fat: MACROS.fat };
  setStorage('adaptiveMacros', adaptive);

  const banner = document.getElementById('adaptiveMacroBanner');
  const text   = document.getElementById('adaptiveMacroText');
  banner.style.display = 'flex';
  text.textContent = msg;

  renderRings();
}

// renderRings — checks adaptive macros, Garmin/Strava adjustments, and ringMode
function renderRings(overrideMacros) {
  const adaptive  = getStorage('adaptiveMacros', null);
  const garminAdj = getStorage('garminAdjustedMacros', null);
  const targets   = overrideMacros || garminAdj || adaptive || MACROS;
  const macroLog  = getStorage('macroLog', {});
  const dayData   = macroLog[getSelectedDateKey()] || { calories:0, protein:0, carbs:0, fat:0 };
  document.getElementById('ringsRow').innerHTML =
    makeSVGRing(dayData.calories, targets.calories, '#f59e0b', 'Calories', 'kcal', ringMode) +
    makeSVGRing(dayData.protein,  targets.protein,  '#22c55e', 'Protein',  'g',    ringMode) +
    makeSVGRing(dayData.carbs,    targets.carbs,    '#3b82f6', 'Carbs',    'g',    ringMode) +
    makeSVGRing(dayData.fat,      targets.fat,      '#ef4444', 'Fat',      'g',    ringMode);

  // Update the macro targets row
  const tCal  = document.getElementById('targetCalories');
  const tPro  = document.getElementById('targetProtein');
  const tCarb = document.getElementById('targetCarbs');
  const tFat  = document.getElementById('targetFat');
  const tSrc  = document.getElementById('targetSource');
  if (tCal) tCal.textContent  = targets.calories;
  if (tPro) tPro.textContent  = targets.protein + 'g';
  if (tCarb) tCarb.textContent = targets.carbs + 'g';
  if (tFat) tFat.textContent  = targets.fat + 'g';
  if (tSrc) {
    if (garminAdj || overrideMacros) {
      const hasStrava = !!getStorage('stravaToken', null);
      tSrc.textContent = hasStrava ? '🟠 Strava' : '🔵 Garmin';
      tSrc.style.color = hasStrava ? '#f97316' : '#3b82f6';
    } else if (adaptive) {
      tSrc.textContent = '🧠 Adaptive';
      tSrc.style.color = '#8b5cf6';
    } else {
      tSrc.textContent = 'Base';
      tSrc.style.color = 'var(--text3)';
    }
  }
}

// ── Copy Yesterday's Meals ──
function checkCopyYesterday() {
  const btn = document.getElementById('copyYesterdayBtn');
  if (!btn) return;
  const all = getStorage('foodEntries', {});
  const yEntries = all[getYesterdayKey()] || [];
  btn.style.display = yEntries.length > 0 ? 'flex' : 'none';
  if (yEntries.length > 0) {
    btn.textContent = `📋 Copy Yesterday's ${yEntries.length} meal${yEntries.length>1?'s':''}`;
  }
}

function copyYesterdayMeals() {
  const all = getStorage('foodEntries', {});
  // "yesterday" relative to selected day
  const selDate = new Date(getSelectedDateKey() + 'T12:00:00');
  selDate.setDate(selDate.getDate() - 1);
  const prevKey = dateToKey(selDate);
  const yEntries = (all[prevKey] || []).map(e => ({
    ...e,
    id:   Date.now() + Math.random(),
    time: nowEST().toLocaleTimeString('en-US', { hour:'2-digit', minute:'2-digit', timeZone:'America/New_York' }),
  }));
  if (yEntries.length === 0) { showToast('No meals logged the previous day'); return; }

  const todayEntries = getFoodEntries();
  setFoodEntries([...todayEntries, ...yEntries]);
  renderRings();
  renderFoodLog();
  renderWeeklyBalance();
  showToast(`📋 Copied ${yEntries.length} meals!`);
}

// ── Daily Motivational Quote (Claude AI) ──
async function loadDailyQuote() {
  const QUOTE_KEY = 'dailyQuote';
  const today = todayKey();

  // Use cached quote if already generated today
  const cached = getStorage(QUOTE_KEY, null);
  if (cached && cached.date === today) {
    renderQuote(cached.quote, cached.author);
    return;
  }

  // Clear stale cache from a previous day
  if (cached && cached.date !== today) {
    localStorage.removeItem(QUOTE_KEY);
  }

  const textEl   = document.getElementById('dailyQuoteText');
  const authorEl = document.getElementById('dailyQuoteAuthor');
  textEl.textContent = 'Generating today\'s motivation…';
  textEl.className = 'quote-text quote-loading';
  authorEl.textContent = '';

  const prompt = `You are a personal coach for Jeremy, a 52-year-old man working hard to go from 170 lbs to 163 lbs in 30 days. He follows a Push/Pull/Legs lifting program 3x per week, runs regularly, and tracks macros at 2,200 kcal/day with 190g protein.

Generate ONE short, powerful motivational quote for today (${nowEST().toLocaleDateString('en-US', {weekday:'long', month:'long', day:'numeric', timeZone:'America/New_York'})}). The quote should feel personal to his journey — touching on one or more of: strength training at 52, staying disciplined with nutrition, weight loss, consistency, or the mental game of fitness.

The quote can be original or attributed to a real person. Keep it under 30 words.

Respond with ONLY valid JSON, no markdown:
{"quote": "The quote text here.", "author": "— Author Name (or leave empty string if original)"}`;

  // Large pool of fallback quotes — rotated by date so it changes daily even offline
  const fallbacks = [
    { quote: "The only bad workout is the one that didn't happen. Show up, every single day.", author: "" },
    { quote: "Discipline is choosing between what you want now and what you want most.", author: "— Abraham Lincoln" },
    { quote: "At 52, you're not slowing down. You're refining. Every rep counts double.", author: "" },
    { quote: "Your body can stand almost anything. It's your mind you have to convince.", author: "" },
    { quote: "Success is the sum of small efforts repeated day in and day out.", author: "— Robert Collier" },
    { quote: "The groundwork for all happiness is good health. Log your macros, lift heavy, repeat.", author: "" },
    { quote: "It never gets easier. You just get stronger.", author: "" },
    { quote: "Take care of your body. It's the only place you have to live.", author: "— Jim Rohn" },
    { quote: "Motivation gets you started. Habit keeps you going. Build the habit.", author: "" },
    { quote: "You don't have to be extreme. Just be consistent.", author: "" },
    { quote: "Every rep is a vote for the person you're becoming.", author: "" },
    { quote: "Strength does not come from the body. It comes from the will.", author: "" },
    { quote: "The pain you feel today will be the strength you feel tomorrow.", author: "" },
    { quote: "Fitness is not about being better than someone else. It's about being better than you used to be.", author: "" },
    { quote: "At 52, every pound you lose is a gift to the next 30 years.", author: "" },
  ];

  try {
    const data = await callClaudeAPI({
      model: 'claude-haiku-4-5-20251001',
      max_tokens: 200,
      messages: [{ role: 'user', content: prompt }]
    });

    if (!data.content) throw new Error('API error');
    const raw  = data.content.find(b => b.type === 'text')?.text || '';
    const clean = raw.replace(/```json|```/g, '').trim();
    const jsonMatch = clean.match(/\{[\s\S]*\}/);
    if (!jsonMatch) throw new Error('No JSON');
    const parsed = JSON.parse(jsonMatch[0]);

    const entry = { date: today, quote: parsed.quote, author: parsed.author || '' };
    setStorage(QUOTE_KEY, entry);
    renderQuote(entry.quote, entry.author);

  } catch (e) {
    // Pick fallback by day-of-year so it changes daily
    const d = nowEST();
    const dayOfYear = Math.floor((d - new Date(d.getFullYear(), 0, 0)) / 86400000);
    const fb = fallbacks[dayOfYear % fallbacks.length];
    setStorage(QUOTE_KEY, { date: today, quote: fb.quote, author: fb.author });
    renderQuote(fb.quote, fb.author);
  }
}

function renderQuote(quote, author) {
  const textEl   = document.getElementById('dailyQuoteText');
  const authorEl = document.getElementById('dailyQuoteAuthor');
  textEl.textContent = `"${quote}"`;
  textEl.className   = 'quote-text quote-animate';
  authorEl.textContent = author || '';
}

// ── Weekly Calorie Balance ──
function renderWeeklyBalance() {
  const grid  = document.getElementById('weekBalanceGrid');
  const sumRow = document.getElementById('weeklySummaryRow');
  const rangeEl = document.getElementById('weekRangeLabel');
  if (!grid || !sumRow) return;

  // Build Mon–Sun using pure ms arithmetic — no setDate, no timezone mutation issues
  const todayStr   = todayKey();                              // 'YYYY-MM-DD' in EST
  const todayAnchor = new Date(todayStr + 'T12:00:00');       // noon local — stable anchor
  const DAY_MS     = 24 * 60 * 60 * 1000;
  const dow        = todayAnchor.getDay();                    // 0=Sun
  const diffToMon  = (dow === 0 ? -6 : 1 - dow);             // steps back to Monday
  const monMs      = todayAnchor.getTime() + diffToMon * DAY_MS;
  const weekDays   = Array.from({ length: 7 }, (_, i) => new Date(monMs + i * DAY_MS));

  const macroLog   = getStorage('macroLog', {});
  const burnLog    = getStorage('burnLog', {});
  const shoeRuns   = getShoeRuns(); // runs logged via shoe tracker (may have calorie data)
  // Use userTDEE, fallback to adaptive calories, fallback to hardcoded TDEE
  const adaptive   = getStorage('adaptiveMacros', null);
  const userMacros = getStorage('userMacros', null);
  const baseTDEE   = getStorage('userTDEE', null) || (adaptive || userMacros || { calories: TDEE }).calories;

  const DAY_NAMES = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];

  const days = weekDays.map((d, i) => {
    const key     = dateToKey(d);
    const log     = macroLog[key];
    const hasData = !!log && log.calories > 0;
    const isToday = key === todayStr;
    const isPast  = key <= todayStr;

    // Burn calories: prefer explicit burnLog (Strava/Garmin), then estimate from shoeRuns
    let dayBurn = burnLog[key] || 0;
    if (!dayBurn) {
      // Estimate from shoe runs: ~100 cal/mile (conservative)
      const dayRuns = shoeRuns.filter(r => r.date === key);
      dayBurn = dayRuns.reduce((s, r) => {
        if (r.calories && r.calories > 0) return s + r.calories;  // Strava/Garmin exact
        return s + Math.round((r.miles || 0) * 100);              // estimate if no cal data
      }, 0);
    }

    const trueMaint = baseTDEE + dayBurn;
    const balance   = hasData ? (log.calories - trueMaint) : null;
    return { name: DAY_NAMES[i], key, balance, hasData, isToday, isPast, dayBurn };
  });

  // Max absolute balance for scaling bars
  const maxAbs = Math.max(500, ...days.filter(d => d.balance !== null).map(d => Math.abs(d.balance)));

  // Range label
  const fmt = d => `${d.getMonth()+1}/${d.getDate()}`;
  if (rangeEl) rangeEl.textContent = `${fmt(weekDays[0])} – ${fmt(weekDays[6])}`;

  // Render bar chart
  grid.innerHTML = days.map(d => {
    const bal = d.balance;
    const isSurplus = bal > 0;
    const hasVal = bal !== null;
    const type = !hasVal ? 'none' : isSurplus ? 'surplus' : 'deficit';
    const barH = hasVal ? Math.max(4, Math.round((Math.abs(bal) / maxAbs) * 52)) : 3;
    const label = !hasVal
      ? (d.isPast ? '—' : '')
      : isSurplus
        ? `+${Math.abs(bal) >= 1000 ? (Math.abs(bal)/1000).toFixed(1)+'k' : Math.round(Math.abs(bal))}`
        : `-${Math.abs(bal) >= 1000 ? (Math.abs(bal)/1000).toFixed(1)+'k' : Math.round(Math.abs(bal))}`;
    const runDot = d.dayBurn > 0 ? `<div style="font-size:8px;text-align:center;margin-top:2px">🏃</div>` : '';

    return `<div class="wbd${d.isToday ? ' wbd-today' : ''}">
      <div class="wbd-name">${d.name}</div>
      <div class="wbd-bar-wrap">
        <div class="wbd-bar ${type}" style="height:${barH}px"></div>
      </div>
      <div class="wbd-val ${type}">${label}</div>
      ${runDot}
    </div>`;
  }).join('');

  // Weekly totals
  const loggedDays   = days.filter(d => d.balance !== null);
  const weeklyNet    = loggedDays.reduce((s, d) => s + d.balance, 0);
  const weeklyBurn   = days.reduce((s, d) => s + (d.dayBurn || 0), 0);
  const weightImpact = weeklyNet / 3500; // lbs (neg = loss)
  const daysLogged   = loggedDays.length;

  const netColor = weeklyNet < 0 ? 'var(--green)' : weeklyNet > 0 ? 'var(--red)' : 'var(--text)';
  const wtColor  = weightImpact < 0 ? 'var(--green)' : weightImpact > 0 ? 'var(--red)' : 'var(--text)';
  const wtSign   = weightImpact < 0 ? '−' : weightImpact > 0 ? '+' : '';
  const netSign  = weeklyNet  < 0 ? '−' : weeklyNet  > 0 ? '+' : '';

  const burnTile = weeklyBurn > 0
    ? `<div class="weekly-stat">
        <div class="weekly-stat-val" style="color:#f97316">${weeklyBurn.toLocaleString()}</div>
        <div class="weekly-stat-lbl">Run Cals Burned</div>
      </div>`
    : '';

  sumRow.innerHTML = `
    <div class="weekly-stat">
      <div class="weekly-stat-val" style="color:${netColor}">${netSign}${Math.abs(Math.round(weeklyNet)).toLocaleString()}</div>
      <div class="weekly-stat-lbl">Net vs Maintenance</div>
    </div>
    <div class="weekly-stat">
      <div class="weekly-stat-val" style="color:${wtColor}">${wtSign}${Math.abs(weightImpact).toFixed(2)} lbs</div>
      <div class="weekly-stat-lbl">Expected Change</div>
    </div>
    ${burnTile}
    <div class="weekly-stat">
      <div class="weekly-stat-val">${daysLogged}/7</div>
      <div class="weekly-stat-lbl">Days Logged</div>
    </div>`;
}

// ═══════════════════════════════════════════════════════
// ── USDA FoodData Central Search ──
// ═══════════════════════════════════════════════════════
const USDA_API_KEY = 'DEMO_KEY'; // free tier: 30 req/hr, 50/day

// All Claude API calls route through the Cloudflare worker proxy at /api/claude
// The actual API key lives in Cloudflare environment secrets (never in code)
async function callClaudeAPI(payload) {
  const res = await fetch('/api/claude', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  });
  if (!res.ok) throw new Error(`Proxy error ${res.status}`);
  return res.json();
}

async function searchUSDA(query, maxResults = 8) {
  const url = `https://api.nal.usda.gov/fdc/v1/foods/search?query=${encodeURIComponent(query)}&pageSize=${maxResults}&api_key=${USDA_API_KEY}`;
  const res = await fetch(url);
  if (!res.ok) throw new Error('USDA API error');
  const data = await res.json();
  return (data.foods || []).map(f => {
    const nutr = n => (f.foodNutrients || []).find(x => x.nutrientId === n || x.nutrientNumber === String(n));
    return {
      fdcId:    f.fdcId,
      name:     f.description,
      brand:    f.brandOwner || f.brandName || '',
      calories: Math.round(nutr(1008)?.value || nutr('208')?.value || 0),
      protein:  Math.round((nutr(1003)?.value || nutr('203')?.value || 0) * 10) / 10,
      carbs:    Math.round((nutr(1005)?.value || nutr('205')?.value || 0) * 10) / 10,
      fat:      Math.round((nutr(1004)?.value || nutr('204')?.value || 0) * 10) / 10,
      servingSize: f.servingSize || 100,
      servingUnit: f.servingSizeUnit || 'g',
    };
  }).filter(f => f.calories > 0);
}

// ═══════════════════════════════════════════════════════
// ── Restaurant Food Search (USDA Branded DB) ──
// ═══════════════════════════════════════════════════════
async function runRestaurantSearch() {
  const q = document.getElementById('restaurantSearchInput').value.trim();
  if (!q) return;
  const loadEl  = document.getElementById('restaurantLoading');
  const resEl   = document.getElementById('restaurantResults');
  loadEl.style.display = 'block';
  resEl.innerHTML = '';
  try {
    // Use USDA branded foods (dataType=Branded catches restaurant items)
    const url = `https://api.nal.usda.gov/fdc/v1/foods/search?query=${encodeURIComponent(q)}&dataType=Branded&pageSize=12&api_key=${USDA_API_KEY}`;
    const res  = await fetch(url);
    const data = await res.json();
    const foods = (data.foods || []).map(f => {
      const nutr = n => (f.foodNutrients || []).find(x => x.nutrientId === n || x.nutrientNumber === String(n));
      return {
        name:     f.description,
        brand:    f.brandOwner || f.brandName || '',
        calories: Math.round(nutr(1008)?.value || nutr('208')?.value || 0),
        protein:  Math.round((nutr(1003)?.value || nutr('203')?.value || 0) * 10) / 10,
        carbs:    Math.round((nutr(1005)?.value || nutr('205')?.value || 0) * 10) / 10,
        fat:      Math.round((nutr(1004)?.value || nutr('204')?.value || 0) * 10) / 10,
        servingSize: f.servingSize || 100,
        servingUnit: f.servingSizeUnit || 'g',
      };
    }).filter(f => f.calories > 0);

    loadEl.style.display = 'none';
    if (foods.length === 0) {
      resEl.innerHTML = '<div style="text-align:center;color:var(--text3);padding:20px;font-size:13px">No results found. Try a different search.</div>';
      return;
    }
    resEl.innerHTML = foods.map((f, i) => `
      <div class="db-result" onclick="openFoodDetail(${JSON.stringify(f).replace(/"/g, '&quot;')}, 'log')">
        <div class="db-result-info">
          <div class="db-result-name">${f.name}</div>
          <div class="db-result-meta">${f.brand ? f.brand + ' · ' : ''}${f.protein}g P · ${f.carbs}g C · ${f.fat}g F · per ${f.servingSize}${f.servingUnit}</div>
        </div>
        <div class="db-result-kcal">${f.calories}<br><span style="font-size:9px;color:var(--text3);font-weight:600">kcal</span></div>
      </div>`).join('');
  } catch(e) {
    loadEl.style.display = 'none';
    resEl.innerHTML = '<div style="color:var(--red);font-size:12px;padding:10px">Search failed. Check your connection and try again.</div>';
  }
}

function quickRestaurant(btn) {
  document.getElementById('restaurantSearchInput').value = btn.textContent.replace(/^[^ ]+ /,'');
  runRestaurantSearch();
}

// ═══════════════════════════════════════════════════════
// ── Shared Food Detail Modal ──
// ═══════════════════════════════════════════════════════
let fdFood = null, fdServings = 1, fdMode = 'log', fdRecipeCallback = null;

function openFoodDetail(food, mode, recipeCallback) {
  fdFood = food; fdServings = 1; fdMode = mode; fdRecipeCallback = recipeCallback || null;
  document.getElementById('fdTitle').textContent = mode === 'recipe' ? '➕ Add to Recipe' : '🍽️ Log Food';
  document.getElementById('fdServingsVal').textContent = '1';

  const card = document.getElementById('fdFoodCard');
  card.innerHTML = `
    <div class="food-name">${food.name}</div>
    ${food.brand ? `<div class="food-brand">${food.brand}</div>` : ''}
    <div class="food-macros" id="fdMacrosGrid"></div>`;
  renderFdMacros();

  const btns = document.getElementById('fdActionBtns');
  if (mode === 'recipe') {
    btns.innerHTML = `<button class="btn-green" onclick="addIngredientToRecipe()">➕ Add to Recipe</button>`;
  } else {
    btns.innerHTML = `<button class="btn-green" onclick="logFdFood()">LOG THIS FOOD ✓</button>`;
  }
  document.getElementById('foodDetailModal').classList.add('open');
}

function renderFdMacros() {
  const s = fdServings;
  const f = fdFood;
  document.getElementById('fdMacrosGrid').innerHTML = `
    <div class="food-macro-chip"><div class="food-macro-chip-val">${Math.round(f.calories*s)}</div><div class="food-macro-chip-lbl">kcal</div></div>
    <div class="food-macro-chip"><div class="food-macro-chip-val">${(f.protein*s).toFixed(1)}g</div><div class="food-macro-chip-lbl">Protein</div></div>
    <div class="food-macro-chip"><div class="food-macro-chip-val">${(f.carbs*s).toFixed(1)}g</div><div class="food-macro-chip-lbl">Carbs</div></div>
    <div class="food-macro-chip"><div class="food-macro-chip-val">${(f.fat*s).toFixed(1)}g</div><div class="food-macro-chip-lbl">Fat</div></div>`;
  document.getElementById('fdServingsVal').textContent = fdServings % 1 === 0 ? fdServings : fdServings.toFixed(1);
}

function adjustFdServings(delta) {
  fdServings = Math.max(0.5, fdServings + delta);
  renderFdMacros();
}

function logFdFood() {
  if (!fdFood) return;
  const s = fdServings;
  addFoodEntry({
    name:     fdFood.name + (s !== 1 ? ` (×${s})` : ''),
    calories: Math.round(fdFood.calories * s),
    protein:  Math.round(fdFood.protein  * s * 10) / 10,
    carbs:    Math.round(fdFood.carbs    * s * 10) / 10,
    fat:      Math.round(fdFood.fat      * s * 10) / 10,
    icon: '🍽️',
  });
  document.getElementById('foodDetailModal').classList.remove('open');
}

// ═══════════════════════════════════════════════════════
// ── Recipe Builder ──
// ═══════════════════════════════════════════════════════
let currentRecipeIngredients = [];

function openNewRecipeModal() {
  currentRecipeIngredients = [];
  document.getElementById('recipeNameInput').value = '';
  document.getElementById('recipeIngSearchInput').value = '';
  document.getElementById('recipeIngResults').innerHTML = '';
  document.getElementById('recipeIngLoading').style.display = 'none';
  renderRecipeIngList();
  document.getElementById('newRecipeModal').classList.add('open');
}

async function searchRecipeIngredient() {
  const q = document.getElementById('recipeIngSearchInput').value.trim();
  if (!q) return;
  const loadEl = document.getElementById('recipeIngLoading');
  const resEl  = document.getElementById('recipeIngResults');
  loadEl.style.display = 'block';
  resEl.innerHTML = '';
  try {
    const foods = await searchUSDA(q, 6);
    loadEl.style.display = 'none';
    if (foods.length === 0) { resEl.innerHTML = '<div style="font-size:12px;color:var(--text3);padding:8px">No results. Try a different term.</div>'; return; }
    resEl.innerHTML = foods.map((f,i) => `
      <div class="db-result" onclick='addIngToCurrentRecipe(${JSON.stringify(f)})'>
        <div class="db-result-info">
          <div class="db-result-name">${f.name}</div>
          <div class="db-result-meta">${f.calories} kcal · ${f.protein}g P · per ${f.servingSize}${f.servingUnit}</div>
        </div>
        <div style="font-size:18px;color:var(--green)">+</div>
      </div>`).join('');
  } catch(e) {
    loadEl.style.display = 'none';
    resEl.innerHTML = '<div style="color:var(--red);font-size:12px">Search failed.</div>';
  }
}

function addIngToCurrentRecipe(food) {
  currentRecipeIngredients.push({ ...food, qty: 1 });
  renderRecipeIngList();
  document.getElementById('recipeIngResults').innerHTML = '';
  document.getElementById('recipeIngSearchInput').value = '';
  showToast(`✅ ${food.name.slice(0,30)} added`);
}

function updateIngQty(i, val) {
  currentRecipeIngredients[i].qty = parseFloat(val) || 1;
  renderRecipeIngList();
}

function removeIngredient(i) {
  currentRecipeIngredients.splice(i, 1);
  renderRecipeIngList();
}

function renderRecipeIngList() {
  const listEl = document.getElementById('recipeIngredientsList');
  const totalEl = document.getElementById('recipeTotalBar');
  if (currentRecipeIngredients.length === 0) {
    listEl.innerHTML = '<div style="font-size:12px;color:var(--text3);font-style:italic">No ingredients yet — search above</div>';
    totalEl.style.display = 'none';
    return;
  }
  const totals = currentRecipeIngredients.reduce((a, ing) => ({
    calories: a.calories + ing.calories * ing.qty,
    protein:  a.protein  + ing.protein  * ing.qty,
    carbs:    a.carbs    + ing.carbs    * ing.qty,
    fat:      a.fat      + ing.fat      * ing.qty,
  }), { calories:0, protein:0, carbs:0, fat:0 });

  listEl.innerHTML = currentRecipeIngredients.map((ing, i) => `
    <div class="recipe-ingredient-row">
      <div class="recipe-ing-name">${ing.name.length > 32 ? ing.name.slice(0,32)+'…' : ing.name}</div>
      <input class="ing-qty-input" type="number" value="${ing.qty}" min="0.25" step="0.25"
        onchange="updateIngQty(${i}, this.value)" title="Servings" />
      <div class="recipe-ing-macros">${Math.round(ing.calories*ing.qty)} kcal</div>
      <button onclick="removeIngredient(${i})" style="background:none;border:none;color:var(--red);font-size:16px;cursor:pointer;flex-shrink:0">✕</button>
    </div>`).join('');

  totalEl.style.display = 'flex';
  totalEl.style.justifyContent = 'space-between';
  totalEl.style.alignItems = 'center';
  totalEl.innerHTML = `
    <div style="font-size:11px;font-weight:700;color:var(--text2)">TOTAL</div>
    <div class="recipe-total-macros">${Math.round(totals.calories)} kcal · ${totals.protein.toFixed(1)}g P · ${totals.carbs.toFixed(1)}g C · ${totals.fat.toFixed(1)}g F</div>`;
}

function saveRecipe() {
  const name = document.getElementById('recipeNameInput').value.trim();
  if (!name) { showToast('⚠️ Enter a recipe name'); return; }
  if (currentRecipeIngredients.length === 0) { showToast('⚠️ Add at least one ingredient'); return; }

  const totals = currentRecipeIngredients.reduce((a, ing) => ({
    calories: a.calories + ing.calories * ing.qty,
    protein:  a.protein  + ing.protein  * ing.qty,
    carbs:    a.carbs    + ing.carbs    * ing.qty,
    fat:      a.fat      + ing.fat      * ing.qty,
  }), { calories:0, protein:0, carbs:0, fat:0 });

  const recipe = {
    id:          Date.now(),
    name,
    ingredients: currentRecipeIngredients.map(i => ({ ...i })),
    totals:      { calories: Math.round(totals.calories), protein: Math.round(totals.protein*10)/10, carbs: Math.round(totals.carbs*10)/10, fat: Math.round(totals.fat*10)/10 },
    created:     todayKey(),
  };
  const recipes = getStorage('savedRecipes', []);
  recipes.push(recipe);
  setStorage('savedRecipes', recipes);
  document.getElementById('newRecipeModal').classList.remove('open');
  renderRecipeList();
  showToast(`📖 "${name}" saved!`);
}

function deleteRecipe(id) {
  if (!confirm('Delete this recipe?')) return;
  const recipes = getStorage('savedRecipes', []).filter(r => r.id !== id);
  setStorage('savedRecipes', recipes);
  renderRecipeList();
  showToast('🗑️ Recipe deleted');
}

function logRecipe(id) {
  const recipe = getStorage('savedRecipes', []).find(r => r.id === id);
  if (!recipe) return;
  addFoodEntry({ name: recipe.name, ...recipe.totals, icon: '📖' });
  showToast(`✅ ${recipe.name} logged!`);
}

function renderRecipeList() {
  const recipes = getStorage('savedRecipes', []);
  const el = document.getElementById('recipeList');
  if (!el) return;
  if (recipes.length === 0) {
    el.innerHTML = '<div class="empty-state">No recipes yet.<br>Tap "+ Create New Recipe" to build your first one.</div>';
    return;
  }
  el.innerHTML = recipes.map(r => `
    <div class="recipe-card">
      <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:8px">
        <div>
          <div class="recipe-name">📖 ${r.name}</div>
          <div class="recipe-meta">${r.ingredients.length} ingredients · Created ${r.created}</div>
        </div>
      </div>
      <div style="background:var(--surface2);border-radius:12px;padding:10px 12px;margin-bottom:10px">
        <div style="font-size:12px;font-weight:700;color:var(--text);margin-bottom:6px">Nutrition (full recipe)</div>
        <div style="display:flex;gap:10px;flex-wrap:wrap">
          <span style="font-size:12px;font-weight:700;color:var(--amber)">${r.totals.calories} kcal</span>
          <span style="font-size:12px;color:var(--green);font-weight:600">${r.totals.protein}g P</span>
          <span style="font-size:12px;color:var(--blue);font-weight:600">${r.totals.carbs}g C</span>
          <span style="font-size:12px;color:var(--red);font-weight:600">${r.totals.fat}g F</span>
        </div>
      </div>
      <div style="margin-bottom:10px">
        ${r.ingredients.map(ing => `<div style="display:flex;justify-content:space-between;font-size:12px;padding:4px 0;border-bottom:1px solid var(--border)">
          <span style="color:var(--text2)">${ing.name.slice(0,40)}</span>
          <span style="color:var(--text3);font-weight:600">×${ing.qty} · ${Math.round(ing.calories*ing.qty)} kcal</span>
        </div>`).join('')}
      </div>
      <div style="display:flex;gap:8px">
        <button class="btn-recipe-log" onclick="logRecipe(${r.id})">✅ Log This Meal</button>
        <button class="btn-recipe-delete" onclick="deleteRecipe(${r.id})">🗑️ Delete</button>
      </div>
    </div>`).join('');
}

// ═══════════════════════════════════════════════════════
// ── Monthly Trend Charts ──
// ═══════════════════════════════════════════════════════
let currentTrendMetric = 'calories';

function setTrendMetric(metric, btn) {
  currentTrendMetric = metric;
  document.querySelectorAll('.chart-tab').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  renderTrendChart();
}

function renderTrendChart() {
  const container = document.getElementById('monthChartContainer');
  const summaryRow = document.getElementById('trendSummaryRow');
  if (!container) return;

  const metric = currentTrendMetric;
  const isWeight = metric === 'weight';

  // Get last 30 days of data
  const today = nowEST();
  const days = [];
  for (let i = 29; i >= 0; i--) {
    const d = nowEST();
    d.setDate(today.getDate() - i);
    const key = dateToKey(d);
    days.push({ key, label: d.getDate(), month: d.getMonth() });
  }

  let values;
  if (isWeight) {
    const weightLog = getStorage('weightLog', {});
    values = days.map(d => ({ ...d, val: weightLog[d.key] || null }));
  } else {
    const macroLog = getStorage('macroLog', {});
    values = days.map(d => {
      const log = macroLog[d.key];
      return { ...d, val: log ? (log[metric] || 0) : null };
    });
  }

  const logged = values.filter(v => v.val !== null);
  if (logged.length === 0) {
    container.innerHTML = '<div class="empty-state" style="padding:30px 0">No data logged yet for this metric.</div>';
    summaryRow.innerHTML = '';
    return;
  }

  const maxVal = Math.max(...logged.map(v => v.val));
  const minVal = Math.min(...logged.map(v => v.val));
  const avgVal = logged.reduce((s, v) => s + v.val, 0) / logged.length;

  const colors = { calories:'#f59e0b', protein:'#22c55e', carbs:'#3b82f6', fat:'#ef4444', weight:'#8b5cf6' };
  const color = colors[metric];
  const target = isWeight ? null : (MACROS[metric] || null);

  // Bar chart
  const bars = values.map(d => {
    const hasVal = d.val !== null;
    const pct = hasVal ? Math.max(4, Math.round((d.val / (maxVal * 1.1)) * 100)) : 2;
    const isToday = d.key === todayKey();
    const overTarget = target && hasVal && d.val > target * 1.05;
    const barColor = overTarget ? '#ef4444' : (isToday ? color : color + 'cc');
    // Month boundary labels
    const showLabel = d.label === 1 || d.label % 7 === 1;
    return `<div class="month-bar-wrap">
      <div class="month-bar" style="height:${pct}%;background:${barColor};${isToday ? 'outline:2px solid #3b82f6;border-radius:5px 5px 0 0' : ''}"></div>
      <div class="month-bar-lbl">${showLabel ? d.label : ''}</div>
    </div>`;
  }).join('');

  container.innerHTML = `<div class="month-bar-chart">${bars}</div>`;

  // Summary stats
  const unit = isWeight ? 'lbs' : (metric === 'calories' ? 'kcal' : 'g');
  const trend = logged.length >= 7
    ? (logged[logged.length-1].val - logged[0].val).toFixed(1)
    : null;
  const trendStr = trend === null ? '—' : (trend > 0 ? `+${trend}` : trend);

  summaryRow.innerHTML = `
    <div class="weekly-stat" style="border-color:${color}30">
      <div class="weekly-stat-val" style="color:${color}">${Math.round(avgVal)}</div>
      <div class="weekly-stat-lbl">30-Day Avg (${unit})</div>
    </div>
    <div class="weekly-stat">
      <div class="weekly-stat-val">${Math.round(maxVal)}</div>
      <div class="weekly-stat-lbl">Peak</div>
    </div>
    <div class="weekly-stat">
      <div class="weekly-stat-val" style="color:${parseFloat(trendStr) < 0 && isWeight ? 'var(--green)' : parseFloat(trendStr) > 0 && !isWeight ? 'var(--red)' : 'var(--text)'}">${trendStr}</div>
      <div class="weekly-stat-lbl">30-Day Trend</div>
    </div>
    ${target ? `<div class="weekly-stat">
      <div class="weekly-stat-val" style="color:${Math.abs(avgVal-target)/target < 0.05 ? 'var(--green)' : 'var(--amber)'}">${Math.round((avgVal/target)*100)}%</div>
      <div class="weekly-stat-lbl">vs Target</div>
    </div>` : ''}`;
}

// ── Data Backup & Restore ──
const BACKUP_KEYS = [
  'liftPRs',
  'macroLog', 'foodEntries', 'weightLog',
  'savedFoods', 'savedRecipes', 'liftLog', 'liftLog2',
  'adaptiveMacros', 'garminAdjustedMacros', 'dailyQuote',
  'garminToken', 'garminCreds', 'garminToday',
  'stravaToken', 'stravaCreds', 'stravaToday',
  'garminAutoAdjust', 'stravaAutoAdjust',
  'shoeGarage', 'shoeRuns',
];

function exportData() {
  const backup = { _version: 1, _exported: new Date().toISOString(), data: {} };
  BACKUP_KEYS.forEach(key => {
    const val = localStorage.getItem(key);
    if (val !== null) backup.data[key] = val; // store raw strings to avoid double-parse
  });
  const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
  const url  = URL.createObjectURL(blob);
  const a    = document.createElement('a');
  const date = dateToKey(nowEST());
  a.href     = url;
  a.download = `jeremymacro-backup-${date}.json`;
  a.click();
  URL.revokeObjectURL(url);
  showToast('✅ Backup downloaded!');
}

function importData(input) {
  const file = input.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    try {
      const backup = JSON.parse(e.target.result);
      if (!backup.data) throw new Error('Invalid backup file');
      let count = 0;
      Object.entries(backup.data).forEach(([key, val]) => {
        localStorage.setItem(key, val);
        count++;
      });
      // Re-render everything
      renderRings();
      renderWeekStrip();
      renderFoodLog();
      renderWeightTrend();
      checkCopyYesterday();
      checkAdaptiveMacros();
      renderWeeklyBalance();
      renderRecipeList();

      const statusEl = document.getElementById('importStatus');
      statusEl.style.display = 'block';
      statusEl.textContent = `✅ Restored ${count} data entries successfully!`;
      showToast('✅ Data restored! All your logs are back.');
      setTimeout(() => { statusEl.style.display = 'none'; }, 5000);
    } catch(err) {
      showToast('❌ Invalid backup file — please use a file exported from this app.');
    }
    input.value = ''; // reset so same file can be re-imported
  };
  reader.readAsText(file);
}

// ── SHOE TRACKER ──

const SHOE_COLORS = ['#f97316','#22c55e','#3b82f6','#8b5cf6','#ef4444','#06b6d4','#f59e0b','#ec4899'];
function getShoes()    { return getStorage('shoeGarage', []); }
function setShoes(s)   { setStorage('shoeGarage', s); }
function getShoeRuns() { return getStorage('shoeRuns', []); }
function setShoeRuns(r){ setStorage('shoeRuns', r); logInteraction('run_saved', r[r.length-1]?.miles || ''); }
// Photos stored separately to avoid quota issues with embedded base64
// Cache shoe photos in memory — reset any time photos are saved
let _shoePhotoCache = null;
function _invalidateShoePhotoCache() { _shoePhotoCache = null; }
function getShoePhoto(shoeId) {
  if (!_shoePhotoCache) _shoePhotoCache = getStorage('shoePhotos', {});
  return _shoePhotoCache[shoeId] || null;
}
// Migration: if old shoes have photoData embedded, move it out
function migrateShoePhotos() {
  const shoes  = getShoes();
  const photos = getStorage('shoePhotos', {});
  let changed  = false;
  shoes.forEach(s => {
    if (s.photoData) {
      photos[s.id] = s.photoData;
      delete s.photoData;
      s.hasPhoto = true;
      changed = true;
    }
  });
  if (changed) {
    _invalidateShoePhotoCache();
    setStorage('shoePhotos', photos);
    setStorage('shoeGarage', shoes);
  }
}

function shoeCurrentMiles(shoeId, runs) {
  const shoe = getShoes().find(s => s.id === shoeId);
  const runMiles = (runs || getShoeRuns()).filter(r => r.shoeId === shoeId).reduce((s,r) => s+(r.miles||0), 0);
  return runMiles + (shoe?.startMiles || 0) + (shoe?.mileageOffset || 0);
}
function lastRunDate(shoeId, runs) {
  const sr = (runs || getShoeRuns()).filter(r => r.shoeId === shoeId);
  return sr.length ? sr.map(r => r.date).sort().reverse()[0] : '';
}
function shoeAvgPace(shoeId, runs) {
  const sr = (runs || getShoeRuns()).filter(r => r.shoeId === shoeId && r.miles > 0 && r.duration > 0);
  if (!sr.length) return null;
  return sr.reduce((s,r) => s+r.duration/60, 0) / sr.reduce((s,r) => s+r.miles, 0);
}
function formatPace(minPerMile) {
  if (!minPerMile) return '—';
  const m = Math.floor(minPerMile);
  const s = Math.round((minPerMile - m) * 60);
  return `${m}:${String(s).padStart(2,'0')}/mi`;
}

function renderShoeStravaCard() {
  const card = document.getElementById('shoeStravaCard');
  if (!card) return;
  const cached   = getStorage('stravaToday', null) || getStorage('garminToday', null);
  const isStrava = !!getStorage('stravaToken', null);
  const isGarmin = !!getStorage('garminToken', null);
  if (!cached || (!isStrava && !isGarmin)) { card.style.display = 'none'; return; }

  const miles  = ((cached.distance || 0) / 1609.34).toFixed(2);
  const source = isStrava ? '🟠 Synced from Strava' : '🔵 Synced from Garmin';

  document.getElementById('shoeStravaMiles').textContent = parseFloat(miles) > 0 ? `${miles} mi` : '0 mi';
  document.getElementById('shoeStravaSub').textContent   = source;
  card.style.display = 'flex';
}

function renderShoePage() {
  renderShoeStravaCard();
  const shoes  = getShoes();
  const runs   = getShoeRuns();
  const listEl  = document.getElementById('shoeList');
  const emptyEl = document.getElementById('shoeEmptyState');
  const summEl  = document.getElementById('shoeGarageSummary');
  const warnEl  = document.getElementById('shoeRetireWarning');
  if (!listEl) return;

  const totalMiles = runs.reduce((s, r) => s + (r.miles || 0), 0);
  summEl.textContent = `${shoes.length} pair${shoes.length !== 1 ? 's' : ''} · ${totalMiles.toFixed(1)} total miles logged`;

  // Garage count badge
  const countEl = document.getElementById('shoeGarageCount');
  if (countEl) countEl.textContent = shoes.length ? `${shoes.filter(s=>s.status==='active').length} active · ${shoes.filter(s=>s.status==='retired').length} retired` : '';

  // Retirement warnings
  const warnings = shoes.filter(s => {
    const mi = shoeCurrentMiles(s.id, runs);
    return s.status === 'active' && mi >= (s.retireMiles || 400) * 0.9;
  });
  if (warnings.length) {
    warnEl.style.display = 'block';
    warnEl.innerHTML = warnings.map(s => {
      const mi = shoeCurrentMiles(s.id, runs);
      return `⚠️ <strong>${s.name}</strong> is at ${mi.toFixed(0)} mi (${Math.round(mi / (s.retireMiles || 400) * 100)}% of ${s.retireMiles || 400} mi limit)`;
    }).join('<br>');
  } else { warnEl.style.display = 'none'; }

  if (!shoes.length) {
    listEl.innerHTML = '';
    emptyEl.style.display = 'block';
    return;
  }
  emptyEl.style.display = 'none';

  const sorted = [...shoes].sort((a, b) => {
    if (a.status !== b.status) return a.status === 'active' ? -1 : 1;
    return lastRunDate(b.id, runs).localeCompare(lastRunDate(a.id, runs));
  });

  listEl.innerHTML = sorted.map(shoe => {
    const miles     = shoeCurrentMiles(shoe.id, runs);
    const retireMi  = shoe.retireMiles || 400;
    const pct       = Math.min(miles / retireMi, 1);
    const shoeRuns  = runs.filter(r => r.shoeId === shoe.id);
    const avgPace   = shoeAvgPace(shoe.id, runs);
    const lastDate  = lastRunDate(shoe.id, runs);
    const color     = shoe.color || SHOE_COLORS[parseInt(shoe.id) % SHOE_COLORS.length] || '#f97316';
    const barColor  = pct > 0.9 ? '#ef4444' : pct > 0.7 ? '#f59e0b' : '#22c55e';
    const miLeft    = Math.max(0, retireMi - miles);
    const photoSrc  = shoe.hasPhoto ? getShoePhoto(shoe.id) : null;

    // Photo or colour avatar
    const photoHtml = photoSrc
      ? `<img src="${photoSrc}" style="width:72px;height:72px;border-radius:14px;object-fit:cover;flex-shrink:0;cursor:pointer" onclick="openShoeDetail('${shoe.id}')" />`
      : `<div style="width:72px;height:72px;border-radius:14px;background:${color}22;border:2px solid ${color}55;display:flex;align-items:center;justify-content:center;font-size:34px;flex-shrink:0;cursor:pointer" onclick="openShoeDetail('${shoe.id}')">👟</div>`;

    return `<div class="shoe-card${shoe.status === 'retired' ? ' retired' : ''}">
      <div class="shoe-card-accent" style="background:${color}"></div>

      <!-- Header row: photo + info + actions -->
      <div style="display:flex;align-items:flex-start;gap:12px;padding-left:8px;margin-bottom:12px">
        ${photoHtml}
        <div style="flex:1;min-width:0">
          <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;margin-bottom:2px">
            <div class="shoe-name" style="cursor:pointer" onclick="openShoeDetail('${shoe.id}')">${esc(shoe.name)}</div>
            <span class="shoe-status-badge ${shoe.status === 'retired' ? 'shoe-status-retired' : 'shoe-status-active'}">${shoe.status === 'retired' ? 'Retired' : 'Active'}</span>
          </div>
          <div class="shoe-brand">${shoe.brand || ''}${shoe.color ? ' · ' + shoe.color : ''}</div>
          <div style="font-size:11px;color:var(--text3);margin-top:4px">Last run: ${lastDate ? new Date(lastDate + 'T12:00:00').toLocaleDateString('en-US', { month:'short', day:'numeric' }) : 'Never'}</div>
        </div>
        <!-- Action buttons -->
        <div style="display:flex;flex-direction:column;gap:6px;flex-shrink:0">
          <button onclick="event.stopPropagation();openEditShoe('${shoe.id}')" style="background:var(--surface2);border:1.5px solid var(--border);border-radius:10px;color:var(--text2);font-size:11px;font-weight:700;padding:5px 10px;cursor:pointer;white-space:nowrap">✏️ Edit</button>
          <button onclick="event.stopPropagation();openShoeDetail('${shoe.id}')" style="background:var(--surface2);border:1.5px solid var(--border);border-radius:10px;color:#60a5fa;font-size:11px;font-weight:700;padding:5px 10px;cursor:pointer;white-space:nowrap">📋 Runs</button>
          <button onclick="event.stopPropagation();deleteShoe('${shoe.id}')" style="background:#2d0f0f;border:1.5px solid #7f1d1d;border-radius:10px;color:#f87171;font-size:11px;font-weight:700;padding:5px 10px;cursor:pointer;white-space:nowrap">🗑️ Delete</button>
        </div>
      </div>

      <!-- Mileage bar -->
      <div style="padding-left:8px">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:5px">
          <div style="font-size:18px;font-weight:800;color:var(--text)">${miles.toFixed(1)} <span style="font-size:12px;font-weight:600;color:var(--text3)">mi</span></div>
          <div style="font-size:11px;color:var(--text3);font-weight:600">${Math.round(pct * 100)}% · ${miLeft.toFixed(0)} mi left of ${retireMi}</div>
        </div>
        <div class="shoe-mileage-bar-track" style="margin-bottom:10px">
          <div class="shoe-mileage-bar-fill" style="width:${pct * 100}%;background:${barColor}"></div>
        </div>
      </div>

      <!-- Stats grid -->
      <div class="shoe-stats-grid" style="padding-left:8px">
        <div class="shoe-stat"><div class="shoe-stat-val">${shoeRuns.length}</div><div class="shoe-stat-lbl">Runs</div></div>
        <div class="shoe-stat"><div class="shoe-stat-val">${avgPace ? formatPace(avgPace) : '—'}</div><div class="shoe-stat-lbl">Avg Pace</div></div>
        <div class="shoe-stat"><div class="shoe-stat-val">${shoeRuns.length ? (shoeRuns.reduce((s, r) => s + (r.miles || 0), 0) / shoeRuns.length).toFixed(1) : '—'}</div><div class="shoe-stat-lbl">Avg Miles</div></div>
        <div class="shoe-stat"><div class="shoe-stat-val">${miLeft.toFixed(0)}</div><div class="shoe-stat-lbl">Mi Left</div></div>
      </div>
    </div>`;
  }).join('');
}

function openAddShoeModal() {
  document.getElementById('editShoeId').value = '';
  document.getElementById('addShoeTitle').textContent = '👟 Add New Shoe';
  document.getElementById('shoeNameInput').value = '';
  document.getElementById('shoeBrandInput').value = '';
  document.getElementById('shoeStartMiles').value = '0';
  document.getElementById('shoeRetireMiles').value = '400';
  document.getElementById('shoeColorInput').value = '';
  document.getElementById('shoeStatusInput').value = 'active';
  document.getElementById('shoePhotoImg').style.display = 'none';
  document.getElementById('shoePhotoPlaceholder').style.display = 'block';
  document.getElementById('shoeAIStatus').style.display = 'none';
  window._shoePhotoData = null;
  document.getElementById('addShoeModal').classList.add('open');
}

function openEditShoe(shoeId) {
  const shoe = getShoes().find(s => s.id===shoeId);
  if (!shoe) return;
  document.getElementById('editShoeId').value = shoeId;
  document.getElementById('addShoeTitle').textContent = '✏️ Edit Shoe';
  document.getElementById('shoeNameInput').value = shoe.name||'';
  document.getElementById('shoeBrandInput').value = shoe.brand||'';
  document.getElementById('shoeStartMiles').value = shoe.startMiles||0;
  document.getElementById('shoeRetireMiles').value = shoe.retireMiles||400;
  document.getElementById('shoeColorInput').value = shoe.color||'';
  document.getElementById('shoeStatusInput').value = shoe.status||'active';
  const existingPhoto = getShoePhoto(shoeId);
  if (existingPhoto) {
    document.getElementById('shoePhotoImg').src = existingPhoto;
    document.getElementById('shoePhotoImg').style.display = 'block';
    document.getElementById('shoePhotoPlaceholder').style.display = 'none';
  } else {
    document.getElementById('shoePhotoImg').style.display = 'none';
    document.getElementById('shoePhotoPlaceholder').style.display = 'block';
  }
  window._shoePhotoData = existingPhoto;
  document.getElementById('shoeAIStatus').style.display = 'none';
  document.getElementById('addShoeModal').classList.add('open');
}

function saveShoe() {
  try {
    const name = document.getElementById('shoeNameInput').value.trim();
    if (!name) { showToast('⚠️ Enter a shoe name'); return; }
    const editId = document.getElementById('editShoeId').value;
    const shoes  = getShoes();
    const shoeId = editId || String(Date.now());

    // Build shoe record WITHOUT photo embedded — photos stored separately
    const shoeData = {
      id:          shoeId,
      name,
      brand:       document.getElementById('shoeBrandInput').value.trim(),
      startMiles:  parseFloat(document.getElementById('shoeStartMiles').value)||0,
      retireMiles: parseFloat(document.getElementById('shoeRetireMiles').value)||400,
      color:       document.getElementById('shoeColorInput').value.trim() || SHOE_COLORS[shoes.length%SHOE_COLORS.length],
      status:      document.getElementById('shoeStatusInput').value,
      hasPhoto:    !!window._shoePhotoData,
      addedDate:   editId ? (shoes.find(s=>s.id===editId)?.addedDate||todayKey()) : todayKey(),
    };

    // Save photo separately so a quota error there doesn't kill the shoe record
    if (window._shoePhotoData) {
      const photos = getStorage('shoePhotos', {});
      photos[shoeId] = window._shoePhotoData;
      _invalidateShoePhotoCache();
      const photoSaved = setStorage('shoePhotos', photos);
      if (!photoSaved) {
        shoeData.hasPhoto = false;
        showToast('⚠️ Photo too large to save — shoe saved without photo');
      }
    }

    if (editId) {
      const idx = shoes.findIndex(s => s.id === editId);
      if (idx !== -1) shoes[idx] = shoeData;
      else shoes.push(shoeData);
    } else {
      shoes.push(shoeData);
    }

    const saved = setStorage('shoeGarage', shoes);
    if (!saved) {
      showToast('⚠️ Storage full — could not save shoe. Try deleting old data.');
      return;
    }

    document.getElementById('addShoeModal').classList.remove('open');
    renderShoePage();
    showToast(editId ? `✅ ${name} updated!` : `👟 ${name} added to your garage!`);
  } catch(e) {
    console.error('saveShoe error:', e);
    showToast('⚠️ Error saving shoe: ' + e.message);
  }
}

async function handleShoePhoto(input) {
  const file = input.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = async (e) => {
    const dataUrl = e.target.result;
    window._shoePhotoData = dataUrl;
    document.getElementById('shoePhotoImg').src = dataUrl;
    document.getElementById('shoePhotoImg').style.display = 'block';
    document.getElementById('shoePhotoPlaceholder').style.display = 'none';
    const statusEl = document.getElementById('shoeAIStatus');
    statusEl.style.display = 'block';
    statusEl.style.color = 'var(--text2)';
    statusEl.textContent = '🤖 AI identifying your shoe…';
    try {
      const data = await callClaudeAPI({ model:'claude-haiku-4-5-20251001', max_tokens:300, messages:[{ role:'user', content:[
          { type:'image', source:{ type:'base64', media_type:file.type||'image/jpeg', data:dataUrl.split(',')[1] }},
          { type:'text', text:'Identify this running shoe. Reply ONLY with valid JSON, no markdown:\n{"brand":"Nike","model":"Pegasus 40","fullName":"Nike Pegasus 40","confidence":"high"}\nIf unknown, use "Unknown" for brand and model.' }
        ]}]});
      if (data.content) {
        const match = (data.content[0]?.text||'').match(/\{[\s\S]*\}/);
        if (match) {
          const parsed = JSON.parse(match[0]);
          const fullName = parsed.fullName||`${parsed.brand} ${parsed.model}`;
          statusEl.innerHTML = `✅ Identified: <strong>${fullName}</strong>`;
          statusEl.style.color = 'var(--green)';
          if (!document.getElementById('shoeNameInput').value) document.getElementById('shoeNameInput').value = fullName;
          if (!document.getElementById('shoeBrandInput').value) document.getElementById('shoeBrandInput').value = parsed.brand||'';
          return;
        }
      }
      statusEl.textContent = '⚠️ Could not identify — enter details manually';
      statusEl.style.color = 'var(--amber)';
    } catch(e) { statusEl.textContent = '⚠️ AI unavailable — enter manually'; statusEl.style.color = 'var(--amber)'; }
  };
  reader.readAsDataURL(file);
}

// ── Update shoe reference photo from shoe detail ──────────────
async function updateShoePhoto(shoeId, input) {
  const file = input.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = async (e) => {
    const dataUrl = e.target.result;
    // Resize to reduce storage footprint
    const resized = await resizeImage(dataUrl, 800);
    const photos = getStorage('shoePhotos', {});
    photos[shoeId] = resized;
    _invalidateShoePhotoCache();
    const saved = setStorage('shoePhotos', photos);
    if (!saved) { showToast('⚠️ Photo too large — try a smaller image'); return; }
    // Mark shoe as having photo
    const shoes = getShoes();
    const idx = shoes.findIndex(s => s.id === shoeId);
    if (idx !== -1) { shoes[idx].hasPhoto = true; setStorage('shoeGarage', shoes); }
    showToast('📸 Reference photo saved!');
    // Re-render detail in place
    if (_shoeDetailOpenId === shoeId) _renderShoeDetail(shoeId);
    renderShoePage();
  };
  reader.readAsDataURL(file);
}

// ── Resize image helper (returns base64 dataUrl) ─────────────
function resizeImage(dataUrl, maxSize) {
  return new Promise(resolve => {
    const img = new Image();
    img.onload = () => {
      const scale = Math.min(1, maxSize / Math.max(img.width, img.height));
      const w = Math.round(img.width  * scale);
      const h = Math.round(img.height * scale);
      const canvas = document.createElement('canvas');
      canvas.width = w; canvas.height = h;
      canvas.getContext('2d').drawImage(img, 0, 0, w, h);
      resolve(canvas.toDataURL('image/jpeg', 0.82));
    };
    img.src = dataUrl;
  });
}

// ── AI shoe photo matching ────────────────────────────────────
// Called from the assign run modal — user takes/uploads a photo of
// their feet/shoes and we compare against all reference photos.
async function matchShoeFromPhoto(input) {
  const file = input.files[0];
  if (!file) return;

  const statusEl = document.getElementById('shoeMatchStatus');
  statusEl.style.display = 'block';
  statusEl.style.color   = 'var(--text2)';
  statusEl.textContent   = '🤖 Analysing photo…';

  const reader = new FileReader();
  reader.onload = async (e) => {
    const runPhotoB64 = e.target.result.split(',')[1];
    const runMediaType = file.type || 'image/jpeg';

    const shoes = getShoes().filter(s => s.status === 'active');
    const shoesWithPhotos = shoes.filter(s => s.hasPhoto && getShoePhoto(s.id));

    // Build the prompt
    // Strategy: send the run photo + embed each reference shoe photo inline
    // and ask Claude to rank by visual similarity
    let promptText = `A runner just took this photo of the shoes they are currently wearing after a run.
Compare it against the following reference shoe photos from their closet and identify which pair they are wearing.

Closet shoes:\n`;
    const refImages = [];
    shoesWithPhotos.forEach((shoe, i) => {
      const photoData = getShoePhoto(shoe.id);
      const b64 = photoData.split(',')[1];
      const mt  = 'image/jpeg';
      promptText += `${i+1}. ID: ${shoe.id} | Name: "${shoe.name}" | Brand: ${shoe.brand||'unknown'}\n`;
      refImages.push({ type:'image', source:{ type:'base64', media_type:mt, data:b64 }});
      refImages.push({ type:'text', text:`(Reference photo for shoe ${i+1}: ${shoe.name})`});
    });

    if (shoesWithPhotos.length === 0) {
      // No reference photos — fall back to plain identification
      promptText = `Identify the running shoes in this photo. Reply ONLY with JSON:\n{"brand":"Nike","model":"Pegasus 40","confidence":"high","notes":""}`;
    } else {
      promptText += `\nNow here is the photo of the shoes the runner just wore (the LAST image).\n\nReply ONLY with valid JSON, no markdown:\n{"matchedId":"<shoe_id or null>","matchedName":"<name or Unknown>","confidence":"high|medium|low","reasoning":"<1 sentence>"}\n\nIf none of the reference photos match well, set matchedId to null.`;
    }

    const contentArr = [
      ...refImages,
      { type:'image', source:{ type:'base64', media_type:runMediaType, data:runPhotoB64 }},
      { type:'text', text: promptText }
    ];

    try {
      const data = await callClaudeAPI({
        model: 'claude-opus-4-6',
        max_tokens: 400,
        messages:[{ role:'user', content: contentArr }]
      });

      if (!data.content) throw new Error('API error');
      const raw  = data.content?.[0]?.text || '';
      const jsonMatch = raw.match(/\{[\s\S]*\}/);
      if (!jsonMatch) throw new Error('No JSON in response');
      const parsed = JSON.parse(jsonMatch[0]);

      // Highlight the matched shoe in the list
      if (parsed.matchedId) {
        const confColor = parsed.confidence === 'high' ? '#22c55e' : parsed.confidence === 'medium' ? '#f59e0b' : '#94a3b8';
        const confEmoji = parsed.confidence === 'high' ? '✅' : parsed.confidence === 'medium' ? '⚠️' : '❓';
        statusEl.style.color = confColor;
        statusEl.innerHTML   = `${confEmoji} <strong>${parsed.matchedName}</strong> — ${parsed.confidence} confidence<br><span style="font-size:10px;opacity:0.8">${parsed.reasoning||''}</span>`;
        // Visually highlight the matched button and auto-scroll to it
        document.querySelectorAll('.assign-shoe-btn').forEach(btn => {
          btn.style.border = '';
          btn.style.background = '';
        });
        // Find the button for this shoe and highlight it
        const btns = document.querySelectorAll('.assign-shoe-btn');
        btns.forEach(btn => {
          if (btn.getAttribute('onclick') && btn.getAttribute('onclick').includes(parsed.matchedId)) {
            btn.style.border = `2px solid ${confColor}`;
            btn.style.background = confColor === '#22c55e' ? 'rgba(34,197,94,0.08)' : 'rgba(245,158,11,0.08)';
            btn.scrollIntoView({ behavior:'smooth', block:'nearest' });
            // Add a "Best Match" badge
            if (!btn.querySelector('.match-badge')) {
              const badge = document.createElement('div');
              badge.className = 'match-badge';
              badge.style.cssText = `position:absolute;top:-8px;right:8px;background:${confColor};color:#000;font-size:9px;font-weight:800;padding:2px 7px;border-radius:8px;letter-spacing:0.5px`;
              badge.textContent  = `${confEmoji} ${parsed.confidence.toUpperCase()} MATCH`;
              btn.style.position = 'relative';
              btn.appendChild(badge);
            }
          }
        });
      } else {
        statusEl.style.color = 'var(--amber)';
        statusEl.textContent = `❓ Couldn't match — ${parsed.reasoning || 'please select manually'}`;
      }
    } catch(err) {
      statusEl.style.color  = 'var(--amber)';
      statusEl.textContent  = '⚠️ AI matching failed — please pick manually';
      console.error('matchShoeFromPhoto:', err);
    }
  };
  reader.readAsDataURL(file);
}

function promptShoeAssignment(runData) {
  const shoes = getShoes().filter(s => s.status==='active');
  if (!shoes.length) return;
  // Check by activityId OR by date — don't re-prompt if already assigned today
  const existing = getShoeRuns().find(r =>
    (r.activityId && runData.activityId && r.activityId === runData.activityId) ||
    (r.date === (runData.date || todayKey()))
  );
  if (existing) return;
  const modal = document.getElementById('assignRunModal');
  document.getElementById('assignRunData').value = JSON.stringify(runData);
  document.getElementById('assignRunDetails').textContent = `${runData.miles.toFixed(2)} mi · ${Math.round(runData.duration/60)}m · ${runData.date}`;
  // Reset match UI
  const matchStatus = document.getElementById('shoeMatchStatus');
  if (matchStatus) { matchStatus.style.display = 'none'; matchStatus.textContent = ''; }
  // Hide photo section if no shoes have reference photos
  const shoesWithPhotos = getShoes().filter(s => s.status==='active' && s.hasPhoto);
  const photoSection = document.getElementById('shoePhotoMatchSection');
  if (photoSection) photoSection.style.display = shoesWithPhotos.length > 0 ? 'block' : 'none';
  const _assignRuns = getShoeRuns(); // read once, reuse in map
  document.getElementById('assignShoeList').innerHTML = shoes.map(shoe => {
    const miles = shoeCurrentMiles(shoe.id, _assignRuns);
    const imgHtml = shoe.hasPhoto ? `<img src="${getShoePhoto(shoe.id)}" style="width:40px;height:40px;border-radius:10px;object-fit:cover;flex-shrink:0"/>` : `<div class="assign-shoe-avatar">👟</div>`;
    return `<button class="assign-shoe-btn" onclick="assignRunToShoe('${shoe.id}')">
      ${imgHtml}
      <div style="flex:1;min-width:0"><div style="font-size:14px;font-weight:700;color:var(--text)">${shoe.name}</div><div style="font-size:11px;color:var(--text3);margin-top:2px">${shoe.brand||''} · ${miles.toFixed(1)} mi so far</div></div>
      <div style="font-size:12px;color:var(--text3);font-weight:600">${(shoe.retireMiles||400)-miles>0?((shoe.retireMiles||400)-miles).toFixed(0)+' mi left':'⚠️ Retire'}</div>
    </button>`;
  }).join('') + `<button class="assign-shoe-btn" onclick="assignRunToNewShoe()" style="border-style:dashed"><div class="assign-shoe-avatar" style="font-size:24px">+</div><div style="font-size:14px;font-weight:700;color:var(--text2)">Add a new pair first</div></button>`;
  modal.classList.add('open');
}

function assignRunToShoe(shoeId) {
  const runData = JSON.parse(document.getElementById('assignRunData').value||'{}');
  if (!runData.miles) return;
  const runs = getShoeRuns();
  runs.push({ id:String(Date.now()), shoeId, date:runData.date||todayKey(), miles:runData.miles, duration:runData.duration||0, calories:runData.calories||0, activityId:runData.activityId||null });
  setShoeRuns(runs);
  document.getElementById('assignRunModal').classList.remove('open');
  renderShoePage();
  const shoe = getShoes().find(s=>s.id===shoeId);
  const newTotal = shoeCurrentMiles(shoeId, runs);
  showToast(`👟 ${runData.miles.toFixed(2)} mi logged to ${shoe?.name||'shoe'}! (${newTotal.toFixed(1)} mi total)`);
  const retireMi = shoe?.retireMiles||400;
  if (newTotal >= retireMi*0.9 && newTotal < retireMi) setTimeout(()=>showToast(`⚠️ ${shoe?.name} is at ${Math.round(newTotal/retireMi*100)}% — retirement approaching!`), 2000);
  else if (newTotal >= retireMi) setTimeout(()=>showToast(`🚨 ${shoe?.name} has hit ${newTotal.toFixed(0)} mi — time to retire!`), 2000);
}

function assignRunToNewShoe() {
  document.getElementById('assignRunModal').classList.remove('open');
  const shoesBtn = document.querySelector('.tab-btn[onclick*="shoes"]');
  if (shoesBtn) switchTab('shoes', shoesBtn);
  setTimeout(()=>openAddShoeModal(), 300);
}

// Track which shoe detail is open for refreshing
let _shoeDetailOpenId = null;

function openShoeDetail(shoeId) {
  _shoeDetailOpenId = shoeId;
  _renderShoeDetail(shoeId);
  document.getElementById('shoeDetailModal').classList.add('open');
}

function _renderShoeDetail(shoeId) {
  const shoe      = getShoes().find(s => s.id === shoeId);
  if (!shoe) return;
  const allRuns   = getShoeRuns();
  const runs      = allRuns.filter(r => r.shoeId === shoeId).sort((a,b) => b.date.localeCompare(a.date));
  const miles     = shoeCurrentMiles(shoeId, allRuns);
  const retireMi  = shoe.retireMiles || 400;
  const pct       = Math.min(miles / retireMi, 1);
  const barColor  = pct > 0.9 ? '#ef4444' : pct > 0.7 ? '#f59e0b' : '#22c55e';
  const avgPace   = shoeAvgPace(shoeId, allRuns);
  const totalMins = runs.reduce((s,r) => s + (r.duration||0) / 60, 0);

  const photoSrc = getShoePhoto(shoeId);
  const imgHtml = photoSrc
    ? `<div style="position:relative;border-radius:14px;overflow:hidden;margin-bottom:10px">
        <img src="${photoSrc}" style="width:100%;max-height:180px;object-fit:cover;display:block"/>
       </div>
       <div style="display:flex;gap:8px;margin-bottom:14px">
         <label style="flex:1;display:flex;align-items:center;justify-content:center;gap:6px;padding:9px;background:var(--surface2);border:1.5px solid var(--border);border-radius:12px;font-size:11px;font-weight:700;color:var(--text2);cursor:pointer">
           📷 Take Photo<input type="file" accept="image/*" capture="environment" style="display:none" onchange="updateShoePhoto('${shoeId}',this)"/>
         </label>
         <label style="flex:1;display:flex;align-items:center;justify-content:center;gap:6px;padding:9px;background:var(--surface2);border:1.5px solid var(--border);border-radius:12px;font-size:11px;font-weight:700;color:var(--text2);cursor:pointer">
           🖼️ Choose Photo<input type="file" accept="image/*" style="display:none" onchange="updateShoePhoto('${shoeId}',this)"/>
         </label>
       </div>`
    : `<div style="display:flex;gap:8px;margin-bottom:14px">
         <label style="flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:6px;padding:16px;background:linear-gradient(135deg,#0f172a,#1e293b);border:1.5px dashed #334155;border-radius:14px;font-size:11px;font-weight:700;color:#475569;cursor:pointer">
           <span style="font-size:24px">📷</span>Take Photo<input type="file" accept="image/*" capture="environment" style="display:none" onchange="updateShoePhoto('${shoeId}',this)"/>
         </label>
         <label style="flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:6px;padding:16px;background:linear-gradient(135deg,#0f172a,#1e293b);border:1.5px dashed #334155;border-radius:14px;font-size:11px;font-weight:700;color:#475569;cursor:pointer">
           <span style="font-size:24px">🖼️</span>Choose Photo<input type="file" accept="image/*" style="display:none" onchange="updateShoePhoto('${shoeId}',this)"/>
         </label>
       </div>`;

  const runsHtml = !runs.length
    ? `<div style="text-align:center;color:var(--text3);padding:24px;font-size:13px">No runs logged yet</div>`
    : runs.map(r => {
        const pace    = (r.duration && r.miles) ? formatPace(r.duration / 60 / r.miles) : '';
        const durStr  = r.duration ? Math.round(r.duration / 60) + 'm' : '';
        const calStr  = r.calories ? r.calories + ' kcal' : '';
        const meta    = [durStr, calStr, pace ? pace + '/mi' : ''].filter(Boolean).join(' · ');
        // Full date display
        const d = new Date(r.date + 'T12:00:00');
        const dateStr = d.toLocaleDateString('en-US', { month:'short', day:'numeric', year:'numeric' });
        return `<div class="shoe-run-row" id="runrow-${r.id}" style="flex-direction:column;align-items:stretch;gap:0;padding:0">
          <!-- Main run row -->
          <div style="display:flex;align-items:center;gap:10px;padding:10px 0">
            <div style="min-width:76px">
              <div style="font-size:12px;font-weight:700;color:var(--text3)">${dateStr}</div>
            </div>
            <div class="shoe-run-info" style="flex:1">
              <div class="shoe-run-mi">${(r.miles||0).toFixed(2)} mi</div>
              ${meta ? `<div class="shoe-run-meta">${meta}</div>` : ''}
            </div>
            <button onclick="toggleRunEdit('${r.id}')" style="background:#0d1e3d;border:1px solid #1e3a5f;border-radius:8px;color:#60a5fa;font-size:11px;font-weight:700;padding:5px 10px;cursor:pointer;flex-shrink:0">✏️</button>
            <button onclick="deleteShoeRun('${r.id}','${shoeId}')" style="background:#2d0f0f;border:1px solid #7f1d1d;border-radius:8px;color:#f87171;font-size:11px;font-weight:700;padding:5px 10px;cursor:pointer;flex-shrink:0">🗑️</button>
          </div>
          <!-- Inline edit form (hidden by default) -->
          <div id="runedit-${r.id}" style="display:none;background:var(--surface2);border-radius:12px;padding:12px;margin-bottom:10px;border:1.5px solid var(--border)">
            <div style="font-size:11px;font-weight:700;color:var(--text2);letter-spacing:1px;text-transform:uppercase;margin-bottom:10px">Edit Run</div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:8px">
              <div>
                <div style="font-size:10px;color:var(--text3);font-weight:700;text-transform:uppercase;letter-spacing:0.8px;margin-bottom:4px">Date</div>
                <input type="date" id="re-date-${r.id}" value="${r.date}"
                  style="width:100%;padding:8px 10px;background:var(--surface);border:1.5px solid var(--border);border-radius:10px;color:var(--text);font-family:inherit;font-size:13px;font-weight:600"/>
              </div>
              <div>
                <div style="font-size:10px;color:var(--text3);font-weight:700;text-transform:uppercase;letter-spacing:0.8px;margin-bottom:4px">Miles</div>
                <input type="number" step="0.01" id="re-miles-${r.id}" value="${(r.miles||0).toFixed(2)}"
                  style="width:100%;padding:8px 10px;background:var(--surface);border:1.5px solid var(--border);border-radius:10px;color:var(--text);font-family:inherit;font-size:13px;font-weight:700"/>
              </div>
              <div>
                <div style="font-size:10px;color:var(--text3);font-weight:700;text-transform:uppercase;letter-spacing:0.8px;margin-bottom:4px">Duration (min)</div>
                <input type="number" step="1" id="re-dur-${r.id}" value="${r.duration ? Math.round(r.duration/60) : ''}" placeholder="—"
                  style="width:100%;padding:8px 10px;background:var(--surface);border:1.5px solid var(--border);border-radius:10px;color:var(--text);font-family:inherit;font-size:13px;font-weight:700"/>
              </div>
              <div>
                <div style="font-size:10px;color:var(--text3);font-weight:700;text-transform:uppercase;letter-spacing:0.8px;margin-bottom:4px">Calories</div>
                <input type="number" step="1" id="re-cal-${r.id}" value="${r.calories || ''}" placeholder="—"
                  style="width:100%;padding:8px 10px;background:var(--surface);border:1.5px solid var(--border);border-radius:10px;color:var(--text);font-family:inherit;font-size:13px;font-weight:700"/>
              </div>
            </div>
            <div style="display:flex;gap:8px">
              <button onclick="saveRunEdit('${r.id}','${shoeId}')"
                style="flex:1;padding:9px;background:var(--green-soft);border:1.5px solid #166534;border-radius:10px;color:#22c55e;font-family:inherit;font-size:12px;font-weight:800;cursor:pointer">Save Changes</button>
              <button onclick="toggleRunEdit('${r.id}')"
                style="padding:9px 14px;background:var(--surface);border:1.5px solid var(--border);border-radius:10px;color:var(--text2);font-family:inherit;font-size:12px;font-weight:700;cursor:pointer">Cancel</button>
            </div>
          </div>
        </div>`;
      }).join('');

  document.getElementById('shoeDetailContent').innerHTML = `
    <div style="display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:4px">
      <div>
        <div class="modal-title" style="margin-bottom:2px">${esc(shoe.name)}</div>
        <div style="font-size:12px;color:var(--text3);font-weight:600">${shoe.brand||''}${shoe.color?' · '+shoe.color:''}</div>
      </div>
      <button onclick="editShoeMileage('${shoeId}',${miles.toFixed(2)})" style="background:#0d1e3d;border:1px solid #1e3a5f;border-radius:8px;color:#60a5fa;font-size:11px;font-weight:700;padding:5px 11px;cursor:pointer;flex-shrink:0;margin-top:4px">✏️ Adjust Miles</button>
    </div>
    <div style="margin-bottom:14px"></div>
    ${imgHtml}
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:6px">
      <div style="font-size:22px;font-weight:800;color:var(--text)">${miles.toFixed(1)} <span style="font-size:14px;font-weight:600;color:var(--text3)">mi total</span></div>
      <div style="font-size:12px;color:var(--text3);font-weight:600">${Math.round(pct*100)}% of ${retireMi} mi</div>
    </div>
    <div class="shoe-mileage-bar-track" style="margin-bottom:14px">
      <div class="shoe-mileage-bar-fill" style="width:${pct*100}%;background:${barColor}"></div>
    </div>
    <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:20px">
      <div class="shoe-stat"><div class="shoe-stat-val">${runs.length}</div><div class="shoe-stat-lbl">Runs</div></div>
      <div class="shoe-stat"><div class="shoe-stat-val">${avgPace ? formatPace(avgPace) : '—'}</div><div class="shoe-stat-lbl">Avg Pace</div></div>
      <div class="shoe-stat"><div class="shoe-stat-val">${totalMins >= 60 ? Math.floor(totalMins/60)+'h '+Math.round(totalMins%60)+'m' : Math.round(totalMins)+'m'}</div><div class="shoe-stat-lbl">Time</div></div>
      <div class="shoe-stat"><div class="shoe-stat-val">${Math.max(0, retireMi - miles).toFixed(0)}</div><div class="shoe-stat-lbl">Mi Left</div></div>
    </div>
    <div style="font-size:11px;font-weight:700;color:var(--text2);letter-spacing:1px;text-transform:uppercase;margin-bottom:10px">
      Run History <span style="color:var(--text3);font-weight:600">(${runs.length})</span>
    </div>
    <div id="shoeRunList">${runsHtml}</div>`;
}

function toggleRunEdit(runId) {
  const el = document.getElementById(`runedit-${runId}`);
  if (!el) return;
  el.style.display = el.style.display === 'none' ? 'block' : 'none';
}

function saveRunEdit(runId, shoeId) {
  const dateVal  = document.getElementById(`re-date-${runId}`)?.value;
  const milesVal = parseFloat(document.getElementById(`re-miles-${runId}`)?.value);
  const durVal   = parseFloat(document.getElementById(`re-dur-${runId}`)?.value);
  const calVal   = parseInt(document.getElementById(`re-cal-${runId}`)?.value);

  if (!dateVal || isNaN(milesVal) || milesVal <= 0) {
    showToast('⚠️ Date and miles are required');
    return;
  }

  const runs = getShoeRuns();
  const run  = runs.find(r => r.id === runId);
  if (!run) return;

  run.date     = dateVal;
  run.miles    = Math.round(milesVal * 100) / 100;
  run.duration = !isNaN(durVal) && durVal > 0 ? durVal * 60 : (run.duration || 0);
  run.calories = !isNaN(calVal) && calVal > 0 ? calVal : (run.calories || 0);

  setShoeRuns(runs);
  renderShoePage();
  _renderShoeDetail(shoeId); // refresh detail in-place
  showToast('✅ Run updated');
}

function deleteShoeRun(runId, shoeId) {
  const runs = getShoeRuns();
  const run  = runs.find(r => r.id === runId);
  const mi   = run ? (run.miles||0).toFixed(2) : '';
  if (!confirm(`Delete this run (${mi} mi)?`)) return;
  setShoeRuns(runs.filter(r => r.id !== runId));
  renderShoePage();
  _renderShoeDetail(shoeId); // refresh detail in-place, keep modal open
  showToast('🗑️ Run deleted');
}

function deleteShoe(shoeId) {
  const shoes = getShoes();
  const runs  = getShoeRuns();
  const shoe  = shoes.find(s => s.id === shoeId);
  if (!shoe) return;
  const runCount = runs.filter(r => r.shoeId === shoeId).length;
  if (!confirm(`Delete "${shoe.name}"? This will also remove all ${runCount} runs logged to it.`)) return;
  setShoes(shoes.filter(s => s.id !== shoeId));
  setShoeRuns(runs.filter(r => r.shoeId !== shoeId));
  renderShoePage();
  showToast(`🗑️ ${shoe.name} deleted`);
}

function editShoeMileage(shoeId, currentMiles) {
  const input = prompt(
    `Current total mileage: ${parseFloat(currentMiles).toFixed(1)} mi\n\nEnter the correct total mileage:`,
    parseFloat(currentMiles).toFixed(1)
  );
  if (input === null) return; // cancelled
  const newTotal = parseFloat(input);
  if (isNaN(newTotal) || newTotal < 0) {
    alert('Please enter a valid number of miles (0 or more).');
    return;
  }
  const shoes = getShoes();
  const shoe  = shoes.find(s => s.id === shoeId);
  if (!shoe) return;
  // Compute how many miles came from runs + startMiles (excluding existing offset)
  const runMiles = getShoeRuns().filter(r => r.shoeId === shoeId).reduce((s,r) => s+(r.miles||0), 0);
  const baseMiles = runMiles + (shoe.startMiles || 0);
  shoe.mileageOffset = Math.round((newTotal - baseMiles) * 100) / 100;
  setShoes(shoes);
  document.getElementById('shoeDetailModal').classList.remove('open');
  renderShoePage();
  showToast(`✅ Mileage updated to ${newTotal.toFixed(1)} mi`);
}

function onStravaRunSynced(runData) {
  if (!getShoes().filter(s=>s.status==='active').length) return;
  const existing = getShoeRuns().find(r=>r.activityId && r.activityId===runData.activityId);
  if (existing) return;
  promptShoeAssignment(runData);
}

// ═══════════════════════════════════════════════════════
// ── HISTORY SUB-TABS ──────────────────────────────────
// ═══════════════════════════════════════════════════════

function switchHistoryTab(tab) {
  ['lift','blood','nutr','trends'].forEach(t => {
    const el = document.getElementById('historyTab-'+t);
    const btn = document.getElementById('htab-'+t);
    if (el) el.style.display = t === tab ? '' : 'none';
    if (btn) btn.classList.toggle('htab-active', t === tab);
  });
  if (tab === 'lift')   renderHistoryPage();
  if (tab === 'blood')  renderBloodWorkPage();
  if (tab === 'nutr')   renderNutritionReport(7);
  if (tab === 'trends') { renderMonthChart(); renderTrendSummary(); }
}

// ═══════════════════════════════════════════════════════
// ── BLOOD WORK ─────────────────────────────────────────
// ═══════════════════════════════════════════════════════

let _bloodFileData = null; // { base64, mediaType, name }

function handleBloodDrop(e) {
  const file = e.dataTransfer.files[0];
  if (file) handleBloodFile(file);
}

function handleBloodFile(file) {
  if (!file) return;
  const nameEl   = document.getElementById('bloodUploadName');
  const statusEl = document.getElementById('bloodUploadStatus');
  const btnEl    = document.getElementById('bloodAnalyzeBtn');
  nameEl.textContent = '📎 ' + file.name;
  statusEl.style.display = 'block';
  statusEl.style.color   = 'var(--text2)';
  statusEl.textContent   = '⏳ Reading file…';
  btnEl.style.display    = 'none';

  const isPdf = file.type === 'application/pdf' || file.name.toLowerCase().endsWith('.pdf');

  if (isPdf) {
    // Extract text from PDF using PDF.js — avoids sending huge base64 through the proxy
    const reader = new FileReader();
    reader.onload = async e => {
      try {
        if (typeof pdfjsLib === 'undefined') {
          // PDF.js not loaded yet — fallback to base64 document method
          const base64 = e.target.result.split(',')[1];
          _bloodFileData = { base64, mediaType: 'application/pdf', name: file.name, extractedText: null };
          statusEl.textContent = '';
          btnEl.style.display = 'block';
          btnEl.textContent   = '🤖 Analyze PDF with AI';
          return;
        }
        pdfjsLib.GlobalWorkerOptions.workerSrc =
          'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        const arrayBuffer = e.target.result;
        const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
        let fullText = '';
        for (let i = 1; i <= pdf.numPages; i++) {
          const page = await pdf.getPage(i);
          const tc   = await page.getTextContent();
          fullText  += tc.items.map(s => s.str).join(' ') + '\n';
        }
        _bloodFileData = { extractedText: fullText, mediaType: 'text/plain', name: file.name, base64: null };
        statusEl.textContent = '✅ ' + pdf.numPages + ' pages extracted — ready to analyze';
        btnEl.style.display = 'block';
        btnEl.textContent   = '🤖 Analyze PDF with AI';
      } catch(err) {
        console.error('PDF extract error:', err);
        statusEl.textContent = '❌ Could not read PDF. Try the paste text option below.';
        statusEl.style.color = '#ef4444';
      }
    };
    reader.readAsArrayBuffer(file);
  } else {
    // Image file — use base64 as before
    const reader = new FileReader();
    reader.onload = e => {
      const dataUrl = e.target.result;
      const mediaType = file.type || 'image/jpeg';
      _bloodFileData = { base64: dataUrl.split(',')[1], mediaType, name: file.name, extractedText: null };
      statusEl.textContent = '';
      btnEl.style.display  = 'block';
      btnEl.textContent    = '🤖 Analyze Image with AI';
    };
    reader.readAsDataURL(file);
  }
}

function getBloodResults() { return getStorage('bloodResults', []); }
function saveBloodResults(r) { setStorage('bloodResults', r); }

// Known reference ranges [low, high, unit, display name]
const BLOOD_REFS = {
  // ── Metabolic ──────────────────────────────────────
  'glucose':           [70, 99,   'mg/dL',    'Glucose',               'metabolic'],
  'hba1c':             [4.0, 5.6, '%',         'HbA1c',                 'metabolic'],
  'bun':               [6, 24,   'mg/dL',    'BUN',                   'metabolic'],
  'creatinine':        [0.76, 1.27,'mg/dL',  'Creatinine',            'metabolic'],
  'egfr':              [60, 999,  'mL/min',   'eGFR',                  'metabolic'],
  'sodium':            [134, 144, 'mmol/L',   'Sodium',                'metabolic'],
  'potassium':         [3.5, 5.2, 'mmol/L',   'Potassium',             'metabolic'],
  'calcium':           [8.7, 10.2,'mg/dL',   'Calcium',               'metabolic'],
  'uric_acid':         [3.4, 7.0, 'mg/dL',    'Uric Acid',             'metabolic'],
  'magnesium':         [1.6, 2.3, 'mg/dL',    'Magnesium',             'metabolic'],

  // ── Lipids ─────────────────────────────────────────
  'total_cholesterol': [0,   200, 'mg/dL',    'Total Cholesterol',     'lipids'],
  'ldl':               [0,   100, 'mg/dL',    'LDL Cholesterol',       'lipids'],
  'hdl':               [40,  999, 'mg/dL',    'HDL Cholesterol',       'lipids'],
  'triglycerides':     [0,   150, 'mg/dL',    'Triglycerides',         'lipids'],
  'non_hdl':           [0,   130, 'mg/dL',    'Non-HDL Cholesterol',   'lipids'],
  'lipoprotein_a':     [0,   75,  'nmol/L',   'Lipoprotein(a)',         'lipids'],  // ⚠️ yours = 123 HIGH
  'apolipoprotein_b':  [0,   90,  'mg/dL',    'Apolipoprotein B',      'lipids'],  // ⚠️ yours = 117 HIGH
  'vldl':              [5,   40,  'mg/dL',    'VLDL Cholesterol',      'lipids'],

  // ── Hormones ───────────────────────────────────────
  'testosterone_total':[264, 916, 'ng/dL',    'Testosterone (Total)',  'hormones'],
  'testosterone_free': [30.3,183, 'pg/mL',    'Testosterone (Free)',   'hormones'],
  'shbg':              [19.3,76.4,'nmol/L',   'SHBG',                  'hormones'],
  'estradiol':         [7.6, 42.6,'pg/mL',    'Estradiol',             'hormones'],
  'cortisol':          [6.2, 19.4,'mcg/dL',   'Cortisol (AM)',         'hormones'],
  'tsh':               [0.45, 4.5,'uIU/mL',   'TSH',                   'hormones'],
  't4_free':           [0.82,1.77,'ng/dL',    'Free T4',               'hormones'],
  'free_t3':           [2.0, 4.4, 'pg/mL',    'Free T3',               'hormones'],
  'insulin':           [2.6,24.9, 'uIU/mL',   'Insulin',               'hormones'],
  'dhea_s':            [71.6,375, 'ug/dL',    'DHEA-S',                'hormones'],
  'psa':               [0,   4.0, 'ng/mL',    'PSA',                   'hormones'],

  // ── CBC ────────────────────────────────────────────
  'wbc':               [3.4, 10.8,'x10E3/uL', 'WBC',                   'cbc'],
  'rbc':               [4.14,5.80,'x10E6/uL', 'RBC',                   'cbc'],
  'hemoglobin':        [13.0,17.7,'g/dL',     'Hemoglobin',            'cbc'],
  'hematocrit':        [37.5,51.0,'%',         'Hematocrit',            'cbc'],
  'platelets':         [150, 450, 'x10E3/uL', 'Platelets',             'cbc'],
  'mcv':               [79,  97,  'fL',        'MCV',                   'cbc'],
  'mchc':              [31.5,35.7,'g/dL',     'MCHC',                  'cbc'],

  // ── Vitamins ───────────────────────────────────────
  'vitamin_d':         [40,  80,  'ng/mL',    'Vitamin D (25-OH)',     'vitamins'],  // optimal range
  'vitamin_b12':       [400, 1000,'pg/mL',    'Vitamin B12',           'vitamins'],  // optimal
  'folate':            [3.0, 20,  'ng/mL',    'Folate',                'vitamins'],

  // ── Inflammation & Iron ────────────────────────────
  'ferritin':          [30,  300, 'ng/mL',    'Ferritin',              'inflammation'],
  'iron':              [38,  169, 'ug/dL',    'Iron',                  'inflammation'],
  'crp':               [0,   1.0, 'mg/L',     'CRP Cardiac',           'inflammation'],

  // ── Liver ──────────────────────────────────────────
  'alt':               [7,   44,  'IU/L',     'ALT',                   'liver'],
  'ast':               [0,   40,  'IU/L',     'AST',                   'liver'],
  'alkaline_phosphatase':[44, 121,'IU/L',     'Alkaline Phosphatase',  'liver'],
  'ggt':               [8,   61,  'U/L',      'GGT',                   'liver'],
};






const KEY_ALIASES = {
  'blood_glucose':'glucose','fasting_glucose':'glucose','serum_glucose':'glucose',
  'hemoglobin_a1c':'hba1c','hb_a1c':'hba1c','a1c':'hba1c','glycated_hemoglobin':'hba1c',
  'blood_urea_nitrogen':'bun','urea_nitrogen':'bun','serum_creatinine':'creatinine',
  'estimated_gfr':'egfr','gfr':'egfr',
  'cholesterol_total':'total_cholesterol','total_chol':'total_cholesterol','cholesterol':'total_cholesterol',
  'ldl_cholesterol':'ldl','ldl_chol':'ldl','ldl_calculated':'ldl','ldl_c':'ldl',
  'ldl_chol_calc':'ldl','ldl_chol_calc_nih':'ldl','ldl_direct':'ldl',
  'hdl_cholesterol':'hdl','hdl_chol':'hdl','hdl_c':'hdl',
  'trig':'triglycerides','trigs':'triglycerides','tg':'triglycerides',
  'vldl_cholesterol':'vldl','vldl_chol':'vldl',
  'lp_a':'lipoprotein_a','lpa':'lipoprotein_a',
  'apo_b':'apolipoprotein_b','apob':'apolipoprotein_b',
  'non_hdl_cholesterol':'non_hdl','non_hdl_chol':'non_hdl',
  'tchol_hdl_ratio':'t_chol_hdl_ratio','chol_hdl_ratio':'t_chol_hdl_ratio',
  'testosterone':'testosterone_total','total_testosterone':'testosterone_total',
  'free_testosterone':'testosterone_free','testosterone_free_calc':'testosterone_free',
  'sex_hormone_binding_globulin':'shbg','sex_horm_binding_glob':'shbg',
  'estradiol_e2':'estradiol','e2':'estradiol',
  'cortisol_am':'cortisol','morning_cortisol':'cortisol',
  'thyroid_stimulating_hormone':'tsh','thyrotropin':'tsh',
  'free_t4':'t4_free','thyroxine_free':'t4_free','t4_free_direct':'t4_free',
  'free_thyroxine':'t4_free','thyroxine_t4_free':'t4_free','thyroxine_t4':'t4_free',
  't3_free':'free_t3','triiodothyronine_free':'free_t3','ft3':'free_t3',
  't3_uptake':'t3_uptake','resin_t3_uptake':'t3_uptake',
  'fasting_insulin':'insulin','serum_insulin':'insulin',
  'dhea_sulfate':'dhea_s','dheas':'dhea_s','dhea':'dhea_s',
  'prostate_specific_antigen':'psa','psa_total':'psa',
  'white_blood_cell':'wbc','white_blood_cells':'wbc','leukocytes':'wbc',
  'red_blood_cell':'rbc','red_blood_cells':'rbc','erythrocytes':'rbc',
  'hgb':'hemoglobin','hb':'hemoglobin','haemoglobin':'hemoglobin',
  'hct':'hematocrit','packed_cell_volume':'hematocrit',
  'platelet_count':'platelets','thrombocytes':'platelets','plt':'platelets',
  'mean_corpuscular_volume':'mcv','mean_corpuscular_hemoglobin_concentration':'mchc',
  'red_cell_distribution_width':'rdw','rdw_cv':'rdw',
  'lymphs_absolute':'lymphocytes_abs','lymphocytes_absolute':'lymphocytes_abs',
  'absolute_lymphocytes':'lymphocytes_abs','lymphs':'lymphocytes_pct',
  'lymphocytes':'lymphocytes_pct',
  'neutrophils_absolute':'neutrophils_abs','absolute_neutrophils':'neutrophils_abs',
  'neutrophils':'neutrophils_pct',
  'monocytes_absolute':'monocytes_abs','absolute_monocytes':'monocytes_abs',
  'monocytes':'monocytes_pct',
  'eos_absolute':'eosinophils_abs','eosinophils_absolute':'eosinophils_abs',
  'eosinophils':'eosinophils_pct',
  'baso_absolute':'basophils_abs','basophils_absolute':'basophils_abs',
  'eos':'eosinophils_pct','basos':'basophils_pct',
  'neuts':'neutrophils_pct','lymphs_pct':'lymphocytes_pct',
  'monos':'monocytes_pct','monos_abs':'monocytes_abs',
  'neuts_abs':'neutrophils_abs','eos_abs':'eosinophils_abs',
  'basos_abs':'basophils_abs',
  'basophils':'basophils_pct',
  'immature_granulocytes':'immature_grans_pct',
  'immature_grans_abs':'immature_grans_abs',
  'bun_creatinine':'bun_creatinine_ratio','bun_cr_ratio':'bun_creatinine_ratio',
  'chloride_serum':'chloride','serum_chloride':'chloride',
  'co2':'carbon_dioxide','carbon_dioxide_total':'carbon_dioxide',
  'bicarbonate':'carbon_dioxide',
  'total_protein':'protein_total','protein_serum':'protein_total',
  'globulin':'globulin_total','serum_globulin':'globulin_total',
  'vitamin_d_25_hydroxy':'vitamin_d','25_oh_vitamin_d':'vitamin_d','vit_d':'vitamin_d',
  'vitamin_b12_serum':'vitamin_b12','cobalamin':'vitamin_b12','b12':'vitamin_b12',
  'folic_acid':'folate','folate_serum':'folate',
  'c_reactive_protein':'crp','crp_cardiac':'crp','hs_crp':'crp',
  'high_sensitivity_crp':'crp','c_reactive_protein_cardiac':'crp',
  'serum_ferritin':'ferritin','ferritin_serum':'ferritin',
  'serum_iron':'iron','iron_serum':'iron',
  'tibc':'iron_tibc','total_iron_binding_capacity':'iron_tibc',
  'iron_sat':'transferrin_sat','iron_saturation':'transferrin_sat',
  'alanine_aminotransferase':'alt','alt_sgpt':'alt','sgpt':'alt',
  'aspartate_aminotransferase':'ast','ast_sgot':'ast','sgot':'ast',
  'alk_phos':'alkaline_phosphatase','alp':'alkaline_phosphatase',
  'gamma_glutamyl_transferase':'ggt','gamma_gt':'ggt',
  'bilirubin_total':'bilirubin','total_bilirubin':'bilirubin',
  'albumin_serum':'albumin','serum_albumin':'albumin',
};

function normalizeBloodKey(key) {
  if (!key) return key;
  var k = key.toLowerCase().trim().replace(/[^a-z0-9_]/g, '_').replace(/__+/g, '_').replace(/^_|_$/g, '');
  return KEY_ALIASES[k] || k;
}

function normalizeBloodMarkers(markers) {
  if (!markers) return markers;
  var seen = {};
  return markers
    .map(function(m) {
      return {name:m.name, key:normalizeBloodKey(m.key), value:m.value, unit:m.unit, ref_low:m.ref_low, ref_high:m.ref_high, flag:m.flag};
    })
    .filter(function(m) {
      if (seen[m.key]) return false;
      seen[m.key] = true;
      return true;
    });
}


function seedBloodResults() {
  try {
    var seeded = [{"id": 1000000003, "date": "2025-04-21", "lab": "Labcorp", "uploadedAt": "2025-04-21T00:00:00.000Z", "markers": [{"name": "WBC", "key": "wbc", "value": 4.0, "unit": "x10E3/uL", "ref_low": 3.4, "ref_high": 10.8, "flag": null}, {"name": "RBC", "key": "rbc", "value": 4.18, "unit": "x10E6/uL", "ref_low": 4.14, "ref_high": 5.8, "flag": null}, {"name": "Hemoglobin", "key": "hemoglobin", "value": 13.1, "unit": "g/dL", "ref_low": 13.0, "ref_high": 17.7, "flag": null}, {"name": "Hematocrit", "key": "hematocrit", "value": 38.9, "unit": "%", "ref_low": 37.5, "ref_high": 51.0, "flag": null}, {"name": "MCV", "key": "mcv", "value": 93, "unit": "fL", "ref_low": 79, "ref_high": 97, "flag": null}, {"name": "MCH", "key": "mch", "value": 31.3, "unit": "pg", "ref_low": 26.6, "ref_high": 33.0, "flag": null}, {"name": "MCHC", "key": "mchc", "value": 33.7, "unit": "g/dL", "ref_low": 31.5, "ref_high": 35.7, "flag": null}, {"name": "RDW", "key": "rdw", "value": 12.4, "unit": "%", "ref_low": 11.6, "ref_high": 15.4, "flag": null}, {"name": "Platelets", "key": "platelets", "value": 261, "unit": "x10E3/uL", "ref_low": 150, "ref_high": 450, "flag": null}, {"name": "Neutrophils %", "key": "neutrophils_pct", "value": 35, "unit": "%", "ref_low": null, "ref_high": null, "flag": null}, {"name": "Lymphocytes %", "key": "lymphocytes_pct", "value": 47, "unit": "%", "ref_low": null, "ref_high": null, "flag": null}, {"name": "Monocytes %", "key": "monocytes_pct", "value": 12, "unit": "%", "ref_low": null, "ref_high": null, "flag": null}, {"name": "Eosinophils %", "key": "eosinophils_pct", "value": 5, "unit": "%", "ref_low": null, "ref_high": null, "flag": null}, {"name": "Basophils %", "key": "basophils_pct", "value": 1, "unit": "%", "ref_low": null, "ref_high": null, "flag": null}, {"name": "Neutrophils (Abs)", "key": "neutrophils_abs", "value": 1.4, "unit": "x10E3/uL", "ref_low": 1.4, "ref_high": 7.0, "flag": null}, {"name": "Lymphocytes (Abs)", "key": "lymphocytes_abs", "value": 1.9, "unit": "x10E3/uL", "ref_low": 0.7, "ref_high": 3.1, "flag": null}, {"name": "Monocytes (Abs)", "key": "monocytes_abs", "value": 0.5, "unit": "x10E3/uL", "ref_low": 0.1, "ref_high": 0.9, "flag": null}, {"name": "Eosinophils (Abs)", "key": "eosinophils_abs", "value": 0.2, "unit": "x10E3/uL", "ref_low": 0.0, "ref_high": 0.4, "flag": null}, {"name": "Basophils (Abs)", "key": "basophils_abs", "value": 0.0, "unit": "x10E3/uL", "ref_low": 0.0, "ref_high": 0.2, "flag": null}, {"name": "Immature Grans %", "key": "immature_grans_pct", "value": 0, "unit": "%", "ref_low": null, "ref_high": null, "flag": null}, {"name": "Immature Grans (Abs)", "key": "immature_grans_abs", "value": 0.0, "unit": "x10E3/uL", "ref_low": 0.0, "ref_high": 0.1, "flag": null}, {"name": "Glucose", "key": "glucose", "value": 94, "unit": "mg/dL", "ref_low": 70, "ref_high": 99, "flag": null}, {"name": "BUN", "key": "bun", "value": 22, "unit": "mg/dL", "ref_low": 6, "ref_high": 24, "flag": null}, {"name": "Creatinine", "key": "creatinine", "value": 1.24, "unit": "mg/dL", "ref_low": 0.76, "ref_high": 1.27, "flag": null}, {"name": "eGFR", "key": "egfr", "value": 71, "unit": "mL/min/1.73", "ref_low": 59, "ref_high": null, "flag": null}, {"name": "BUN/Creatinine Ratio", "key": "bun_creatinine_ratio", "value": 18, "unit": "", "ref_low": 9, "ref_high": 20, "flag": null}, {"name": "Sodium", "key": "sodium", "value": 141, "unit": "mmol/L", "ref_low": 134, "ref_high": 144, "flag": null}, {"name": "Potassium", "key": "potassium", "value": 5.1, "unit": "mmol/L", "ref_low": 3.5, "ref_high": 5.2, "flag": null}, {"name": "Chloride", "key": "chloride", "value": 104, "unit": "mmol/L", "ref_low": 96, "ref_high": 106, "flag": null}, {"name": "Carbon Dioxide", "key": "carbon_dioxide", "value": 27, "unit": "mmol/L", "ref_low": 20, "ref_high": 29, "flag": null}, {"name": "Calcium", "key": "calcium", "value": 9.9, "unit": "mg/dL", "ref_low": 8.7, "ref_high": 10.2, "flag": null}, {"name": "Total Protein", "key": "protein_total", "value": 6.8, "unit": "g/dL", "ref_low": 6.0, "ref_high": 8.5, "flag": null}, {"name": "Albumin", "key": "albumin", "value": 4.2, "unit": "g/dL", "ref_low": 4.1, "ref_high": 5.1, "flag": null}, {"name": "Globulin", "key": "globulin_total", "value": 2.6, "unit": "g/dL", "ref_low": 1.5, "ref_high": 4.5, "flag": null}, {"name": "Bilirubin", "key": "bilirubin", "value": 0.5, "unit": "mg/dL", "ref_low": 0.0, "ref_high": 1.2, "flag": null}, {"name": "Alkaline Phosphatase", "key": "alkaline_phosphatase", "value": 62, "unit": "IU/L", "ref_low": 44, "ref_high": 121, "flag": null}, {"name": "AST", "key": "ast", "value": 28, "unit": "IU/L", "ref_low": 0, "ref_high": 40, "flag": null}, {"name": "ALT", "key": "alt", "value": 24, "unit": "IU/L", "ref_low": 0, "ref_high": 44, "flag": null}, {"name": "Total Cholesterol", "key": "total_cholesterol", "value": 178, "unit": "mg/dL", "ref_low": 100, "ref_high": 199, "flag": null}, {"name": "Triglycerides", "key": "triglycerides", "value": 59, "unit": "mg/dL", "ref_low": 0, "ref_high": 149, "flag": null}, {"name": "HDL Cholesterol", "key": "hdl", "value": 73, "unit": "mg/dL", "ref_low": 39, "ref_high": null, "flag": null}, {"name": "VLDL Cholesterol", "key": "vldl", "value": 11, "unit": "mg/dL", "ref_low": 5, "ref_high": 40, "flag": null}, {"name": "LDL Cholesterol", "key": "ldl", "value": 94, "unit": "mg/dL", "ref_low": 0, "ref_high": 99, "flag": null}, {"name": "Chol/HDL Ratio", "key": "t_chol_hdl_ratio", "value": 2.4, "unit": "ratio", "ref_low": 0.0, "ref_high": 5.0, "flag": null}, {"name": "TSH", "key": "tsh", "value": 1.08, "unit": "uIU/mL", "ref_low": 0.45, "ref_high": 4.5, "flag": null}, {"name": "T3 Uptake", "key": "t3_uptake", "value": 27, "unit": "%", "ref_low": 24, "ref_high": 39, "flag": null}, {"name": "T4 Free Direct", "key": "t4_free", "value": 1.37, "unit": "ng/dL", "ref_low": 0.82, "ref_high": 1.77, "flag": null}, {"name": "Free T3", "key": "free_t3", "value": 3.1, "unit": "pg/mL", "ref_low": 2.0, "ref_high": 4.4, "flag": null}, {"name": "TIBC", "key": "iron_tibc", "value": 304, "unit": "ug/dL", "ref_low": 250, "ref_high": 450, "flag": null}, {"name": "Iron", "key": "iron", "value": 124, "unit": "ug/dL", "ref_low": 38, "ref_high": 169, "flag": null}, {"name": "Transferrin Sat", "key": "transferrin_sat", "value": 41, "unit": "%", "ref_low": 15, "ref_high": 55, "flag": null}, {"name": "Testosterone Total", "key": "testosterone_total", "value": 631, "unit": "ng/dL", "ref_low": 264, "ref_high": 916, "flag": null}, {"name": "SHBG", "key": "shbg", "value": 45.2, "unit": "nmol/L", "ref_low": 19.3, "ref_high": 76.4, "flag": null}, {"name": "Testosterone Free", "key": "testosterone_free", "value": 114.1, "unit": "pg/mL", "ref_low": 30.3, "ref_high": 183.2, "flag": null}, {"name": "DHEA-Sulfate", "key": "dhea_s", "value": 260.0, "unit": "ug/dL", "ref_low": 71.6, "ref_high": 375.4, "flag": null}, {"name": "Cortisol", "key": "cortisol", "value": 8.3, "unit": "ug/dL", "ref_low": 6.2, "ref_high": 19.4, "flag": null}, {"name": "Estradiol", "key": "estradiol", "value": 22.6, "unit": "pg/mL", "ref_low": 7.6, "ref_high": 42.6, "flag": null}, {"name": "Prolactin", "key": "prolactin", "value": 7.2, "unit": "ng/mL", "ref_low": 3.9, "ref_high": 22.7, "flag": null}, {"name": "IGF-1", "key": "igf1", "value": 176, "unit": "ng/mL", "ref_low": 81, "ref_high": 263, "flag": null}, {"name": "Vitamin B12", "key": "vitamin_b12", "value": 675, "unit": "pg/mL", "ref_low": 232, "ref_high": 1245, "flag": null}, {"name": "Folate", "key": "folate", "value": 20.0, "unit": "ng/mL", "ref_low": 3.0, "ref_high": null, "flag": null}, {"name": "PSA", "key": "psa", "value": 0.6, "unit": "ng/mL", "ref_low": 0.0, "ref_high": 4.0, "flag": null}, {"name": "HbA1c", "key": "hba1c", "value": 5.6, "unit": "%", "ref_low": 4.8, "ref_high": 5.6, "flag": null}, {"name": "Vitamin D", "key": "vitamin_d", "value": 60.4, "unit": "ng/mL", "ref_low": 30.0, "ref_high": 100.0, "flag": null}, {"name": "Lipoprotein (a)", "key": "lipoprotein_a", "value": 159.7, "unit": "nmol/L", "ref_low": null, "ref_high": 75.0, "flag": "H"}, {"name": "CRP Cardiac", "key": "crp", "value": 1.13, "unit": "mg/L", "ref_low": 0.0, "ref_high": 3.0, "flag": null}, {"name": "Magnesium", "key": "magnesium", "value": 2.0, "unit": "mg/dL", "ref_low": 1.6, "ref_high": 2.3, "flag": null}, {"name": "Insulin", "key": "insulin", "value": 2.4, "unit": "uIU/mL", "ref_low": 2.6, "ref_high": 24.9, "flag": "L"}, {"name": "Ferritin", "key": "ferritin", "value": 83, "unit": "ng/mL", "ref_low": 30, "ref_high": 400, "flag": null}, {"name": "Apolipoprotein B", "key": "apolipoprotein_b", "value": 71, "unit": "mg/dL", "ref_low": null, "ref_high": 90, "flag": null}, {"name": "Thyroglobulin Ab", "key": "thyroglobulin_ab", "value": 1.8, "unit": "IU/mL", "ref_low": 0.0, "ref_high": 0.9, "flag": "H"}, {"name": "Thyroglobulin", "key": "thyroglobulin", "value": 7.9, "unit": "ng/mL", "ref_low": 1.4, "ref_high": 29.2, "flag": null}, {"name": "PTH Intact", "key": "pth", "value": 33, "unit": "pg/mL", "ref_low": 15, "ref_high": 65, "flag": null}]}, {"id": 1000000002, "date": "2024-10-11", "lab": "Labcorp", "uploadedAt": "2024-10-11T00:00:00.000Z", "markers": [{"name": "WBC", "key": "wbc", "value": 4.4, "unit": "x10E3/uL", "ref_low": 3.4, "ref_high": 10.8, "flag": null}, {"name": "RBC", "key": "rbc", "value": 4.74, "unit": "x10E6/uL", "ref_low": 4.14, "ref_high": 5.8, "flag": null}, {"name": "Hemoglobin", "key": "hemoglobin", "value": 14.5, "unit": "g/dL", "ref_low": 13.0, "ref_high": 17.7, "flag": null}, {"name": "Hematocrit", "key": "hematocrit", "value": 44.5, "unit": "%", "ref_low": 37.5, "ref_high": 51.0, "flag": null}, {"name": "MCV", "key": "mcv", "value": 94, "unit": "fL", "ref_low": 79, "ref_high": 97, "flag": null}, {"name": "MCH", "key": "mch", "value": 30.6, "unit": "pg", "ref_low": 26.6, "ref_high": 33.0, "flag": null}, {"name": "MCHC", "key": "mchc", "value": 32.6, "unit": "g/dL", "ref_low": 31.5, "ref_high": 35.7, "flag": null}, {"name": "RDW", "key": "rdw", "value": 12.2, "unit": "%", "ref_low": 11.6, "ref_high": 15.4, "flag": null}, {"name": "Platelets", "key": "platelets", "value": 269, "unit": "x10E3/uL", "ref_low": 150, "ref_high": 450, "flag": null}, {"name": "Neutrophils %", "key": "neutrophils_pct", "value": 37, "unit": "%", "ref_low": null, "ref_high": null, "flag": null}, {"name": "Lymphocytes %", "key": "lymphocytes_pct", "value": 45, "unit": "%", "ref_low": null, "ref_high": null, "flag": null}, {"name": "Monocytes %", "key": "monocytes_pct", "value": 12, "unit": "%", "ref_low": null, "ref_high": null, "flag": null}, {"name": "Eosinophils %", "key": "eosinophils_pct", "value": 5, "unit": "%", "ref_low": null, "ref_high": null, "flag": null}, {"name": "Basophils %", "key": "basophils_pct", "value": 1, "unit": "%", "ref_low": null, "ref_high": null, "flag": null}, {"name": "Neutrophils (Abs)", "key": "neutrophils_abs", "value": 1.6, "unit": "x10E3/uL", "ref_low": 1.4, "ref_high": 7.0, "flag": null}, {"name": "Lymphocytes (Abs)", "key": "lymphocytes_abs", "value": 2.0, "unit": "x10E3/uL", "ref_low": 0.7, "ref_high": 3.1, "flag": null}, {"name": "Monocytes (Abs)", "key": "monocytes_abs", "value": 0.5, "unit": "x10E3/uL", "ref_low": 0.1, "ref_high": 0.9, "flag": null}, {"name": "Eosinophils (Abs)", "key": "eosinophils_abs", "value": 0.2, "unit": "x10E3/uL", "ref_low": 0.0, "ref_high": 0.4, "flag": null}, {"name": "Basophils (Abs)", "key": "basophils_abs", "value": 0.0, "unit": "x10E3/uL", "ref_low": 0.0, "ref_high": 0.2, "flag": null}, {"name": "Immature Grans %", "key": "immature_grans_pct", "value": 0, "unit": "%", "ref_low": null, "ref_high": null, "flag": null}, {"name": "Immature Grans (Abs)", "key": "immature_grans_abs", "value": 0.0, "unit": "x10E3/uL", "ref_low": 0.0, "ref_high": 0.1, "flag": null}, {"name": "Glucose", "key": "glucose", "value": 83, "unit": "mg/dL", "ref_low": 70, "ref_high": 99, "flag": null}, {"name": "BUN", "key": "bun", "value": 26, "unit": "mg/dL", "ref_low": 6, "ref_high": 24, "flag": "H"}, {"name": "Creatinine", "key": "creatinine", "value": 1.13, "unit": "mg/dL", "ref_low": 0.76, "ref_high": 1.27, "flag": null}, {"name": "eGFR", "key": "egfr", "value": 79, "unit": "mL/min/1.73", "ref_low": 59, "ref_high": null, "flag": null}, {"name": "BUN/Creatinine Ratio", "key": "bun_creatinine_ratio", "value": 23, "unit": "", "ref_low": 9, "ref_high": 20, "flag": "H"}, {"name": "Sodium", "key": "sodium", "value": 139, "unit": "mmol/L", "ref_low": 134, "ref_high": 144, "flag": null}, {"name": "Potassium", "key": "potassium", "value": 4.8, "unit": "mmol/L", "ref_low": 3.5, "ref_high": 5.2, "flag": null}, {"name": "Chloride", "key": "chloride", "value": 99, "unit": "mmol/L", "ref_low": 96, "ref_high": 106, "flag": null}, {"name": "Carbon Dioxide", "key": "carbon_dioxide", "value": 27, "unit": "mmol/L", "ref_low": 20, "ref_high": 29, "flag": null}, {"name": "Calcium", "key": "calcium", "value": 10.6, "unit": "mg/dL", "ref_low": 8.7, "ref_high": 10.2, "flag": "H"}, {"name": "Total Protein", "key": "protein_total", "value": 7.5, "unit": "g/dL", "ref_low": 6.0, "ref_high": 8.5, "flag": null}, {"name": "Albumin", "key": "albumin", "value": 4.7, "unit": "g/dL", "ref_low": 4.1, "ref_high": 5.1, "flag": null}, {"name": "Globulin", "key": "globulin_total", "value": 2.8, "unit": "g/dL", "ref_low": 1.5, "ref_high": 4.5, "flag": null}, {"name": "Bilirubin", "key": "bilirubin", "value": 0.4, "unit": "mg/dL", "ref_low": 0.0, "ref_high": 1.2, "flag": null}, {"name": "Alkaline Phosphatase", "key": "alkaline_phosphatase", "value": 57, "unit": "IU/L", "ref_low": 44, "ref_high": 121, "flag": null}, {"name": "AST", "key": "ast", "value": 22, "unit": "IU/L", "ref_low": 0, "ref_high": 40, "flag": null}, {"name": "ALT", "key": "alt", "value": 17, "unit": "IU/L", "ref_low": 0, "ref_high": 44, "flag": null}, {"name": "Total Cholesterol", "key": "total_cholesterol", "value": 243, "unit": "mg/dL", "ref_low": 100, "ref_high": 199, "flag": "H"}, {"name": "Triglycerides", "key": "triglycerides", "value": 76, "unit": "mg/dL", "ref_low": 0, "ref_high": 149, "flag": null}, {"name": "HDL Cholesterol", "key": "hdl", "value": 77, "unit": "mg/dL", "ref_low": 39, "ref_high": null, "flag": null}, {"name": "VLDL Cholesterol", "key": "vldl", "value": 13, "unit": "mg/dL", "ref_low": 5, "ref_high": 40, "flag": null}, {"name": "LDL Cholesterol", "key": "ldl", "value": 153, "unit": "mg/dL", "ref_low": 0, "ref_high": 99, "flag": "H"}, {"name": "Chol/HDL Ratio", "key": "t_chol_hdl_ratio", "value": 3.2, "unit": "ratio", "ref_low": 0.0, "ref_high": 5.0, "flag": null}, {"name": "TSH", "key": "tsh", "value": 1.64, "unit": "uIU/mL", "ref_low": 0.45, "ref_high": 4.5, "flag": null}, {"name": "T3 Uptake", "key": "t3_uptake", "value": 28, "unit": "%", "ref_low": 24, "ref_high": 39, "flag": null}, {"name": "T4 Free Direct", "key": "t4_free", "value": 1.68, "unit": "ng/dL", "ref_low": 0.82, "ref_high": 1.77, "flag": null}, {"name": "Free T3", "key": "free_t3", "value": 3.2, "unit": "pg/mL", "ref_low": 2.0, "ref_high": 4.4, "flag": null}, {"name": "TIBC", "key": "iron_tibc", "value": 336, "unit": "ug/dL", "ref_low": 250, "ref_high": 450, "flag": null}, {"name": "Iron", "key": "iron", "value": 103, "unit": "ug/dL", "ref_low": 38, "ref_high": 169, "flag": null}, {"name": "Transferrin Sat", "key": "transferrin_sat", "value": 31, "unit": "%", "ref_low": 15, "ref_high": 55, "flag": null}, {"name": "Testosterone Total", "key": "testosterone_total", "value": 614, "unit": "ng/dL", "ref_low": 264, "ref_high": 916, "flag": null}, {"name": "SHBG", "key": "shbg", "value": 45.0, "unit": "nmol/L", "ref_low": 19.3, "ref_high": 76.4, "flag": null}, {"name": "Testosterone Free", "key": "testosterone_free", "value": 104.9, "unit": "pg/mL", "ref_low": 30.3, "ref_high": 183.2, "flag": null}, {"name": "DHEA-Sulfate", "key": "dhea_s", "value": 111.0, "unit": "ug/dL", "ref_low": 71.6, "ref_high": 375.4, "flag": null}, {"name": "Cortisol", "key": "cortisol", "value": 16.0, "unit": "ug/dL", "ref_low": 6.2, "ref_high": 19.4, "flag": null}, {"name": "Estradiol", "key": "estradiol", "value": 9.7, "unit": "pg/mL", "ref_low": 7.6, "ref_high": 42.6, "flag": null}, {"name": "Vitamin B12", "key": "vitamin_b12", "value": 699, "unit": "pg/mL", "ref_low": 232, "ref_high": 1245, "flag": null}, {"name": "Folate", "key": "folate", "value": 10.2, "unit": "ng/mL", "ref_low": 3.0, "ref_high": null, "flag": null}, {"name": "PSA", "key": "psa", "value": 0.5, "unit": "ng/mL", "ref_low": 0.0, "ref_high": 4.0, "flag": null}, {"name": "HbA1c", "key": "hba1c", "value": 5.5, "unit": "%", "ref_low": 4.8, "ref_high": 5.6, "flag": null}, {"name": "Vitamin D", "key": "vitamin_d", "value": 44.8, "unit": "ng/mL", "ref_low": 30.0, "ref_high": 100.0, "flag": null}, {"name": "Lipoprotein (a)", "key": "lipoprotein_a", "value": 123.2, "unit": "nmol/L", "ref_low": null, "ref_high": 75.0, "flag": "H"}, {"name": "CRP Cardiac", "key": "crp", "value": 0.46, "unit": "mg/L", "ref_low": 0.0, "ref_high": 3.0, "flag": null}, {"name": "Magnesium", "key": "magnesium", "value": 2.1, "unit": "mg/dL", "ref_low": 1.6, "ref_high": 2.3, "flag": null}, {"name": "Insulin", "key": "insulin", "value": 2.1, "unit": "uIU/mL", "ref_low": 2.6, "ref_high": 24.9, "flag": "L"}, {"name": "Ferritin", "key": "ferritin", "value": 88, "unit": "ng/mL", "ref_low": 30, "ref_high": 400, "flag": null}, {"name": "Free T3", "key": "free_t3", "value": 3.2, "unit": "pg/mL", "ref_low": 2.0, "ref_high": 4.4, "flag": null}, {"name": "Apolipoprotein B", "key": "apolipoprotein_b", "value": 117, "unit": "mg/dL", "ref_low": null, "ref_high": 90, "flag": "H"}]}, {"id": 1000000001, "date": "2011-01-08", "lab": "Quest Diagnostics", "uploadedAt": "2011-01-08T00:00:00.000Z", "markers": [{"name": "Total Cholesterol", "key": "total_cholesterol", "value": 189, "unit": "mg/dL", "ref_low": 125, "ref_high": 200, "flag": null}, {"name": "HDL Cholesterol", "key": "hdl", "value": 68, "unit": "mg/dL", "ref_low": 40, "ref_high": null, "flag": null}, {"name": "Triglycerides", "key": "triglycerides", "value": 78, "unit": "mg/dL", "ref_low": null, "ref_high": 150, "flag": null}, {"name": "LDL Cholesterol", "key": "ldl", "value": 105, "unit": "mg/dL", "ref_low": null, "ref_high": 130, "flag": null}, {"name": "Chol/HDL Ratio", "key": "t_chol_hdl_ratio", "value": 2.8, "unit": "", "ref_low": null, "ref_high": 5.0, "flag": null}]}];
    saveBloodResults(seeded);
  } catch(e) {}
}

function migrateBloodKeys() {
  try {
    var results = getStorage('bloodResults', []);
    if (!Array.isArray(results) || !results.length) return;
    var changed = false;
    results = results.map(function(entry) {
      if (!entry || !entry.markers) return entry;
      var normalized = normalizeBloodMarkers(entry.markers);
      if (JSON.stringify(normalized) !== JSON.stringify(entry.markers)) changed = true;
      return Object.assign({}, entry, {markers: normalized});
    });
    if (changed) setStorage('bloodResults', results);
  } catch(e) {}
}

const PANEL_LABELS = {
  metabolic:    '🔬 Metabolic',
  lipids:       '❤️ Lipids',
  hormones:     '⚡ Hormones',
  cbc:          '🩺 CBC',
  vitamins:     '💊 Vitamins',
  inflammation: '🔥 Inflammation',
  liver:        '🫀 Liver',
};

// Markers where LOWER is better (used for trend direction color)
const LOWER_BETTER = new Set(['ldl','triglycerides','total_cholesterol','glucose','crp','uric_acid',
  'hba1c','cortisol','insulin','lipoprotein_a','apolipoprotein_b','non_hdl','vldl','bun','psa']);

// Markers where HIGHER is better
const HIGHER_BETTER = new Set(['hdl','egfr','vitamin_d','vitamin_b12','testosterone_total',
  'testosterone_free','ferritin','rbc','hemoglobin','hematocrit','dhea_s','free_t3','folate']);

function bloodStatus(key, value) {
  const ref = BLOOD_REFS[key];
  if (!ref) return 'ok';
  const [lo, hi] = ref;
  // For HDL, eGFR — only low side matters
  if (hi >= 999) return value < lo ? (value < lo * 0.85 ? 'bad' : 'warn') : 'ok';
  if (value < lo * 0.85 || value > hi * 1.15) return 'bad';
  if (value < lo || value > hi) return 'warn';
  return 'ok';
}



function buildBloodParsePrompt() {
  return [
    'You are a medical lab results parser. Extract ALL test results from the lab report.',
    'Output ONLY a single valid JSON object. No markdown, no code fences, no explanation, no text before or after.',
    'Numeric values must be numbers not strings.',
    'ref_low and ref_high must be numbers. If only one bound exists use null for the other.',
    'flag must be exactly H, L, or null (JSON null not the string null).',
    'key must be lowercase snake_case. Use EXACTLY these canonical keys (pick the closest match):',
    'glucose hba1c bun creatinine egfr bun_creatinine_ratio sodium potassium chloride carbon_dioxide calcium',
    'total_cholesterol ldl hdl triglycerides vldl non_hdl t_chol_hdl_ratio lipoprotein_a apolipoprotein_b',
    'testosterone_total testosterone_free shbg estradiol cortisol dhea_s psa igf1 insulin',
    'tsh t4_free free_t3 t3_uptake',
    'wbc rbc hemoglobin hematocrit mcv mch mchc rdw platelets',
    'neutrophils_pct lymphocytes_pct monocytes_pct eosinophils_pct basophils_pct',
    'neutrophils_abs lymphocytes_abs monocytes_abs eosinophils_abs basophils_abs',
    'immature_grans_pct immature_grans_abs',
    'alt ast alkaline_phosphatase ggt bilirubin albumin protein_total globulin_total',
    'crp ferritin iron iron_tibc transferrin_sat vitamin_d vitamin_b12 folate',
    'OUTPUT FORMAT (return exactly this structure):',
    '{"test_date":"YYYY-MM-DD","lab_name":"string","markers":[{"name":"string","key":"canonical_key","value":0,"unit":"string","ref_low":0,"ref_high":0,"flag":null}]}',
    'Extract every single marker. Do not skip any. Do not add any text outside the JSON.',
  ].join(' ');
}

async function saveBloodEntry(parsed) {
  const testDate = parsed.test_date || new Date().toISOString().slice(0,10);
  const results = getBloodResults();
  const newEntry = {
    id: Date.now(),
    date: testDate,
    lab: parsed.lab_name || 'Lab Results',
    markers: normalizeBloodMarkers(parsed.markers || []),
    uploadedAt: new Date().toISOString(),
  };
  results.unshift(newEntry);
  saveBloodResults(results);
  return newEntry;
}

function toggleBloodPaste() {
  const area = document.getElementById('bloodPasteArea');
  area.style.display = area.style.display === 'none' ? 'block' : 'none';
}

async function analyzeBloodPasteText() {
  const text = (document.getElementById('bloodPasteText')?.value || '').trim();
  if (!text) { showToast('Please paste your lab report text first'); return; }
  
  const status = document.getElementById('bloodUploadStatus');
  const btn = document.querySelector('[onclick="analyzeBloodPasteText()"]');
  if (btn) { btn.disabled = true; btn.textContent = '⏳ Analyzing…'; }
  status.style.display = 'block';
  status.style.color = 'var(--text2)';
  status.textContent = 'AI is reading your pasted lab results…';

  try {
    const data = await callClaudeAPI({
      model: 'claude-opus-4-6',
      max_tokens: 8000,
      messages: [{ role: 'user', content: buildBloodParsePrompt() + '\n\nLAB REPORT TEXT:\n' + text }]
    });
    if (data.error) throw new Error('API: ' + (data.error.message || JSON.stringify(data.error)));
    const rawText = data.content?.[0]?.text || '';
    // Sanitize common Claude JSON quirks before parsing
    let raw = rawText.replace(/```json\s*/gi, '').replace(/```\s*/g, '').trim();
    // Remove any text before the first { or after the last }
    const firstBrace = raw.indexOf('{');
    const lastBrace = raw.lastIndexOf('}');
    if (firstBrace > 0 || lastBrace < raw.length - 1) raw = raw.slice(firstBrace, lastBrace + 1);
    // Fix "null" string flags to JSON null
    raw = raw.replace(/"flag"\s*:\s*"null"/g, '"flag":null');
    // Fix truncated JSON by attempting to close unclosed arrays/objects
    let parsed;
    try {
      parsed = JSON.parse(raw);
    } catch(jsonErr) {
      // Try to salvage truncated response by closing open structures
      let fixed = raw;
      const opens = (fixed.match(/\[/g)||[]).length - (fixed.match(/\]/g)||[]).length;
      const openBraces = (fixed.match(/\{/g)||[]).length - (fixed.match(/\}/g)||[]).length;
      // Remove trailing incomplete object (last comma + anything after)
      fixed = fixed.replace(/,\s*\{[^}]*$/, '');
      for (let i = 0; i < opens; i++) fixed += ']';
      for (let i = 0; i < openBraces; i++) fixed += '}';
      try {
        parsed = JSON.parse(fixed);
      } catch {
        throw new Error('JSON parse failed (pos ' + jsonErr.message + '). Got: ' + rawText.slice(0, 300));
      }
    }
    if (!parsed.markers?.length) throw new Error('No markers found in response');
    const newEntry = await saveBloodEntry(parsed);
    status.textContent = '✅ Imported ' + newEntry.markers.length + ' markers from ' + newEntry.date;
    document.getElementById('bloodPasteArea').style.display = 'none';
    document.getElementById('bloodPasteText').value = '';
    renderBloodWorkPage();
    generateBloodAIInsights(newEntry);
  } catch(e) {
    status.textContent = '❌ Could not parse. Check the pasted text and try again.';
    status.style.color = '#ef4444';
    if (btn) { btn.disabled = false; btn.textContent = '🤖 Analyze Pasted Text'; }
  }
}

async function analyzeBloodReport() {
  if (!_bloodFileData) return;
  const btn    = document.getElementById('bloodAnalyzeBtn');
  const status = document.getElementById('bloodUploadStatus');
  btn.disabled = true;
  status.style.display = 'block';
  status.style.color = 'var(--text2)';

  try {
    let msgContent;
    if (_bloodFileData.extractedText) {
      status.textContent = '⏳ Sending extracted text to Claude…';
      btn.textContent = '⏳ Analyzing…';
      msgContent = buildBloodParsePrompt() + `\n\nLAB REPORT TEXT:\n` + _bloodFileData.extractedText;
    } else if (_bloodFileData.base64 && _bloodFileData.mediaType === 'application/pdf') {
      status.textContent = '⏳ Sending PDF to Claude…';
      btn.textContent = '⏳ Analyzing…';
      msgContent = [
        { type: 'document', source: { type: 'base64', media_type: 'application/pdf', data: _bloodFileData.base64 } },
        { type: 'text', text: buildBloodParsePrompt() }
      ];
    } else {
      status.textContent = '⏳ Sending image to Claude…';
      btn.textContent = '⏳ Analyzing…';
      msgContent = [
        { type: 'image', source: { type: 'base64', media_type: _bloodFileData.mediaType, data: _bloodFileData.base64 } },
        { type: 'text', text: buildBloodParsePrompt() }
      ];
    }

    const data = await callClaudeAPI({
      model: 'claude-opus-4-6',
      max_tokens: 8000,
      messages: [{ role: 'user', content: msgContent }]
    });

    // Surface API-level errors
    if (data.error) throw new Error('API: ' + (data.error.message || JSON.stringify(data.error)));

    const rawText = data.content?.[0]?.text || '';
    if (!rawText) throw new Error('Empty response from Claude. Full response: ' + JSON.stringify(data));

    // Strip markdown fences robustly
    const raw = rawText.replace(/```json\s*/gi, '').replace(/```\s*/g, '').trim();

    let parsed;
    try {
      parsed = JSON.parse(raw);
    } catch(jsonErr) {
      // Try to extract JSON object from response if Claude added extra text
      const match = raw.match(/\{[\s\S]*\}/);
      if (match) {
        parsed = JSON.parse(match[0]);
      } else {
        throw new Error('JSON parse failed. Claude said: ' + rawText.slice(0, 200));
      }
    }

    if (!parsed.markers || !parsed.markers.length) throw new Error('No markers found in response');

    const newEntry = await saveBloodEntry(parsed);
    btn.style.display = 'none';
    document.getElementById('bloodUploadName').textContent = '';
    _bloodFileData = null;
    document.getElementById('bloodFileInput').value = '';
    status.textContent = '✅ Imported ' + newEntry.markers.length + ' markers from ' + newEntry.date;
    status.style.color = '#22c55e';
    renderBloodWorkPage();
    generateBloodAIInsights(newEntry);

  } catch(e) {
    console.error('Blood parse error:', e);
    btn.disabled = false;
    btn.textContent = '🤖 Analyze with AI';
    status.style.color = '#ef4444';
    status.textContent = '❌ ' + (e.message || 'Unknown error');
    status.style.color = '#ef4444';
  }
}

function renderBloodWorkPage() {
  const results = getBloodResults();
  const container = document.getElementById('bloodResultsList');
  if (!container) return;

  if (results.length === 0) {
    container.innerHTML = '<div class="empty-state">No blood work uploaded yet.<br>Upload your first lab report above.</div>';
    return;
  }

  const dateOptions = results.map((r,i) =>
    `<option value="${i}" ${i===0?'selected':''}>${r.date} — ${r.lab} (${r.markers.length} markers)</option>`
  ).join('');

  container.innerHTML = `
    <div class="card" style="margin-bottom:12px">
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:12px">
        <div class="card-label" style="color:#ef4444;margin:0;flex:1">📅 Lab Result</div>
        <div style="display:flex;gap:6px">
          <button id="bview-panels" class="bview-btn active" onclick="setBloodView('panels')">Panels</button>
          <button id="bview-trends" class="bview-btn" onclick="setBloodView('trends')">Trends</button>
          <button id="bview-table"  class="bview-btn" onclick="setBloodView('table')">Compare</button>
        </div>
      </div>
      <select id="bloodDateSelect" onchange="renderBloodPanels(parseInt(this.value))"
        style="width:100%;background:var(--surface2);border:1.5px solid var(--border);border-radius:10px;padding:10px;color:var(--text);font-size:13px;font-family:inherit">
        ${dateOptions}
      </select>
    </div>
    <div id="bloodSummaryBar"></div>
    <div id="bloodOOBStrip"></div>
    <div id="bloodPanelsContainer"></div>
    <div id="bloodTrendContainer" style="margin-top:4px"></div>
    <div id="bloodTableContainer" style="display:none"></div>
  `;

  window._bloodView = 'panels';
  renderBloodPanels(0);
}

function setBloodView(view) {
  window._bloodView = view;
  ['panels','trends','table'].forEach(v => {
    const btn = document.getElementById('bview-'+v);
    if (btn) btn.classList.toggle('active', v === view);
  });
  const idx = parseInt(document.getElementById('bloodDateSelect')?.value || '0');
  renderBloodPanels(idx);
}

function rangeBar(key, value) {
  const ref = BLOOD_REFS[key];
  if (!ref) return '';
  const [lo, hi] = ref;
  // Handle one-sided ranges
  const isHighOnly = hi >= 900;
  const isLowOnly = lo <= 0;

  // Display range: show 50% below lo and 50% above hi
  const pad = (hi - lo) * 0.6;
  const dispLo = Math.max(0, lo - pad);
  const dispHi = isHighOnly ? lo * 2.5 : hi + pad;
  const dispRange = dispHi - dispLo;

  // Zone positions (optimal range)
  const zoneLPct = ((lo - dispLo) / dispRange * 100).toFixed(1);
  const zoneWPct = isHighOnly ? (100 - parseFloat(zoneLPct)).toFixed(1) :
                   ((hi - lo) / dispRange * 100).toFixed(1);

  // Dot position
  const clampedVal = Math.max(dispLo, Math.min(dispHi, value));
  const dotPct = ((clampedVal - dispLo) / dispRange * 100).toFixed(1);
  const status = bloodStatus(key, value);
  const dotColor = {ok:'#22c55e',warn:'#f59e0b',bad:'#ef4444'}[status];

  const loLbl = isHighOnly ? '' : lo;
  const hiLbl = isHighOnly ? lo + '+' : hi;

  return `<div class="blood-range-bar">
    <div class="blood-range-zone" style="left:${zoneLPct}%;width:${zoneWPct}%"></div>
    <div class="blood-range-dot" style="left:${dotPct}%;background:${dotColor}"></div>
  </div>
  <div class="blood-range-labels"><span>${dispLo.toFixed(dispRange>10?0:1)}</span><span style="color:#22c55e;font-weight:700">${loLbl}–${hiLbl}</span><span>${dispHi.toFixed(dispRange>10?0:1)}</span></div>`;
}

function trendBadge(key, hist, currentVal) {
  if (!hist || hist.length < 2) return '';
  const sorted = [...hist].sort((a,b) => a.date.localeCompare(b.date));
  const prev = sorted[sorted.length - 2].value;
  const pct = ((currentVal - prev) / prev * 100);
  if (Math.abs(pct) < 0.5) return '<span class="blood-marker-trend neut">→ stable</span>';
  const up = currentVal > prev;
  const lowerBetter = LOWER_BETTER.has(key);
  const higherBetter = HIGHER_BETTER.has(key);
  const good = lowerBetter ? !up : higherBetter ? up : null;
  const cls = good === true ? 'good' : good === false ? 'bad' : 'neut';
  const arrow = up ? '↑' : '↓';
  return `<span class="blood-marker-trend ${cls}">${arrow} ${Math.abs(pct).toFixed(1)}%</span>`;
}

function renderBloodPanels(idx) {
  const results = getBloodResults();
  const entry = results[idx];
  if (!entry) return;

  // Build history map
  const history = {};
  results.forEach(r => {
    r.markers.forEach(m => {
      if (!history[m.key]) history[m.key] = [];
      history[m.key].push({ date: r.date, value: m.value });
    });
  });

  const view = window._bloodView || 'panels';

  // ── SUMMARY BAR ─────────────────────────────────────
  const allStatuses = entry.markers.map(m => bloodStatus(m.key, m.value));
  const badCount  = allStatuses.filter(s => s === 'bad').length;
  const warnCount = allStatuses.filter(s => s === 'warn').length;
  const okCount   = allStatuses.filter(s => s === 'ok').length;
  const summaryEl = document.getElementById('bloodSummaryBar');
  if (summaryEl) summaryEl.innerHTML = `
    <div class="blood-summary-grid" style="margin-bottom:12px">
      <div class="blood-summary-tile" style="border:1.5px solid #ef444430">
        <div class="blood-summary-num" style="color:#ef4444">${badCount}</div>
        <div class="blood-summary-lbl">Out of Range</div>
      </div>
      <div class="blood-summary-tile" style="border:1.5px solid #f59e0b30">
        <div class="blood-summary-num" style="color:#f59e0b">${warnCount}</div>
        <div class="blood-summary-lbl">Borderline</div>
      </div>
      <div class="blood-summary-tile" style="border:1.5px solid #22c55e30">
        <div class="blood-summary-num" style="color:#22c55e">${okCount}</div>
        <div class="blood-summary-lbl">Optimal</div>
      </div>
    </div>`;

  // ── OUT OF RANGE STRIP ───────────────────────────────
  const oobEl = document.getElementById('bloodOOBStrip');
  const flagged = entry.markers.filter(m => {
    const s = bloodStatus(m.key, m.value);
    return s === 'bad' || s === 'warn';
  }).sort((a,b) => {
    const sa = bloodStatus(a.key, a.value), sb = bloodStatus(b.key, b.value);
    if (sa === 'bad' && sb !== 'bad') return -1;
    if (sb === 'bad' && sa !== 'bad') return 1;
    return 0;
  });

  if (oobEl && flagged.length > 0) {
    oobEl.innerHTML = `<div class="blood-oob-strip" style="margin-bottom:12px">
      <div class="blood-oob-strip-title">⚠️ ${flagged.length} Markers Need Attention</div>
      ${flagged.map(m => {
        const status = bloodStatus(m.key, m.value);
        const ref = BLOOD_REFS[m.key];
        const name = ref?.[3] || m.name;
        const unit = m.unit || ref?.[2] || '';
        const color = status === 'bad' ? '#ef4444' : '#f59e0b';
        const trend = trendBadge(m.key, history[m.key], m.value);
        const refText = ref ? (ref[1] >= 900 ? '>' + ref[0] : ref[0] + '–' + ref[1]) + ' ' + ref[2] : '';
        return `<div class="blood-oob-item">
          <div>
            <span style="font-size:12px;font-weight:700;color:${color}">${name}</span>
            <span style="font-size:10px;color:var(--text3);margin-left:6px">${refText}</span>
          </div>
          <div style="display:flex;align-items:center;gap:6px">
            ${trend}
            <span style="font-size:14px;font-weight:800;color:${color}">${m.value} ${unit}</span>
          </div>
        </div>`;
      }).join('')}
    </div>`;
  } else if (oobEl) {
    oobEl.innerHTML = `<div style="background:#0d2d1a;border:1px solid #22c55e30;border-radius:14px;padding:12px 16px;margin-bottom:12px;font-size:13px;font-weight:700;color:#22c55e;text-align:center">✅ All markers within normal range</div>`;
  }

  // ── PANELS VIEW ──────────────────────────────────────
  const panelsEl  = document.getElementById('bloodPanelsContainer');
  const trendsEl  = document.getElementById('bloodTrendContainer');
  const tableEl   = document.getElementById('bloodTableContainer');

  panelsEl.style.display  = view === 'panels'  ? '' : 'none';
  trendsEl.style.display  = view === 'trends'  ? '' : 'none';
  tableEl.style.display   = view === 'table'   ? '' : 'none';

  if (view === 'panels') {
    const panels = {};
    entry.markers.forEach(m => {
      const ref = BLOOD_REFS[m.key];
      const panel = ref ? ref[4] : 'other';
      if (!panels[panel]) panels[panel] = [];
      panels[panel].push(m);
    });

    const panelOrder = ['lipids','metabolic','hormones','cbc','vitamins','inflammation','liver','other'];
    panelsEl.innerHTML = panelOrder.filter(p => panels[p]).map(panel => {
      const markers = panels[panel];
      const bad  = markers.filter(m => bloodStatus(m.key, m.value) === 'bad').length;
      const warn = markers.filter(m => bloodStatus(m.key, m.value) === 'warn').length;
      const panelClass = bad > 0 ? 'blood-panel-card has-bad' : warn > 0 ? 'blood-panel-card has-warn' : 'blood-panel-card';

      const badge = bad > 0
        ? `<span style="font-size:10px;background:#450a0a;color:#ef4444;padding:3px 9px;border-radius:20px;font-weight:700">${bad} out of range</span>`
        : warn > 0
        ? `<span style="font-size:10px;background:#422006;color:#f59e0b;padding:3px 9px;border-radius:20px;font-weight:700">${warn} borderline</span>`
        : `<span style="font-size:10px;background:#0d2d1a;color:#22c55e;padding:3px 9px;border-radius:20px;font-weight:700">✓ All optimal</span>`;

      const rows = markers.map(m => {
        const ref = BLOOD_REFS[m.key];
        const status = bloodStatus(m.key, m.value);
        const name = ref?.[3] || m.name;
        const unit = m.unit || ref?.[2] || '';
        const refText = ref
          ? (ref[1] >= 900 ? '>' + ref[0] + ' ' + ref[2] : ref[0] + '–' + ref[1] + ' ' + ref[2])
          : '';
        const trend = trendBadge(m.key, history[m.key], m.value);
        const flagHtml = m.flag
          ? `<span class="blood-marker-flag ${m.flag}">${m.flag}</span>`
          : '';
        const bar = ref ? rangeBar(m.key, m.value) : '';

        return `<div class="blood-marker-row status-${status}">
          <div class="blood-marker-top">
            <div class="blood-marker-name">${name}</div>
            <div class="blood-marker-right">
              ${trend}
              ${flagHtml}
              <div class="blood-marker-val status-${status}">${m.value} <span style="font-size:10px;font-weight:500;color:var(--text3)">${unit}</span></div>
            </div>
          </div>
          ${bar}
          <div style="font-size:10px;color:var(--text3);margin-top:3px">Normal: ${refText || 'see report'}</div>
        </div>`;
      }).join('');

      return `<div class="${panelClass}">
        <div class="blood-panel-title">
          <span>${PANEL_LABELS[panel] || '🔬 Other'}</span>
          ${badge}
        </div>
        ${rows}
      </div>`;
    }).join('');
  }

  // ── TRENDS VIEW ──────────────────────────────────────
  if (view === 'trends') {
    const trendMarkers = Object.entries(history)
      .filter(([k, vals]) => vals.length >= 2)
      .sort((a, b) => {
        // Sort out-of-range first
        const aStatus = bloodStatus(a[0], a[1][a[1].length-1]?.value);
        const bStatus = bloodStatus(b[0], b[1][b[1].length-1]?.value);
        const rank = {bad:0,warn:1,ok:2};
        return (rank[aStatus]||2) - (rank[bStatus]||2);
      });

    if (trendMarkers.length === 0) {
      trendsEl.innerHTML = '<div class="empty-state">Upload at least 2 lab results to see trends</div>';
    } else {
      trendsEl.innerHTML = `<div class="card">
        <div class="card-label" style="color:#a78bfa">📈 Trends Across ${results.length} Lab Results</div>
        <div style="font-size:12px;color:var(--text2);margin-bottom:14px">Out-of-range markers shown first. Color = status at each draw.</div>
        ${trendMarkers.map(([key, vals]) => {
          const ref = BLOOD_REFS[key];
          const sorted = [...vals].sort((a,b) => a.date.localeCompare(b.date));
          const name = ref?.[3] || key;
          const unit = ref?.[2] || '';
          const refLo = ref?.[0], refHi = ref?.[1];
          const allVals = sorted.map(v => v.value);
          const minV = Math.min(...allVals, refLo || Infinity);
          const maxV = Math.max(...allVals, refHi < 900 ? refHi : 0);
          const pad = (maxV - minV) * 0.2 || 1;
          const chartMin = Math.max(0, minV - pad);
          const chartMax = maxV + pad;
          const chartRange = chartMax - chartMin;
          const W = 100, H = 60;

          const toY = v => H - ((v - chartMin) / chartRange * (H - 12) + 6);
          const toX = i => sorted.length === 1 ? W/2 : (i / (sorted.length-1)) * W;

          // Reference band
          const refBand = (refLo !== undefined && refHi !== undefined && refHi < 900)
            ? `<rect x="0" y="${toY(refHi).toFixed(1)}" width="${W}" height="${(toY(refLo)-toY(refHi)).toFixed(1)}" fill="#22c55e15" rx="2"/>`
            : refLo !== undefined
            ? `<rect x="0" y="0" width="${W}" height="${toY(refLo).toFixed(1)}" fill="#ef444410" rx="2"/>`
            : '';

          // Ref lines
          const refLines = [];
          if (refLo !== undefined) refLines.push(`<line x1="0" y1="${toY(refLo).toFixed(1)}" x2="${W}" y2="${toY(refLo).toFixed(1)}" stroke="#22c55e" stroke-width="0.8" stroke-dasharray="3,2" opacity="0.6"/>`);
          if (refHi !== undefined && refHi < 900) refLines.push(`<line x1="0" y1="${toY(refHi).toFixed(1)}" x2="${W}" y2="${toY(refHi).toFixed(1)}" stroke="#22c55e" stroke-width="0.8" stroke-dasharray="3,2" opacity="0.6"/>`);

          // Polyline
          const points = sorted.map((v,i) => `${toX(i).toFixed(1)},${toY(v.value).toFixed(1)}`).join(' ');

          // Dots colored by status
          const dots = sorted.map((v,i) => {
            const s = bloodStatus(key, v.value);
            const col = {ok:'#22c55e',warn:'#f59e0b',bad:'#ef4444'}[s];
            return `<circle cx="${toX(i).toFixed(1)}" cy="${toY(v.value).toFixed(1)}" r="4" fill="${col}" stroke="var(--bg)" stroke-width="1.5"><title>${v.date}: ${v.value} ${unit}</title></circle>`;
          }).join('');

          const first = sorted[0].value, last = sorted[sorted.length-1].value;
          const chgPct = ((last - first) / first * 100).toFixed(1);
          const latestStatus = bloodStatus(key, last);
          const lbetter = LOWER_BETTER.has(key);
          const hbetter = HIGHER_BETTER.has(key);
          const improving = lbetter ? last < first : hbetter ? last > first : null;
          const deltaColor = improving === true ? '#22c55e' : improving === false ? '#ef4444' : '#94a3b8';
          const deltaLabel = parseFloat(chgPct) > 0 ? '+' + chgPct + '%' : chgPct + '%';

          const statusDot = `<span style="display:inline-block;width:8px;height:8px;border-radius:50%;background:${{ok:'#22c55e',warn:'#f59e0b',bad:'#ef4444'}[latestStatus]};margin-right:4px;vertical-align:middle"></span>`;

          return `<div class="btchart-wrap">
            <div class="btchart-header">
              <div class="btchart-name">${statusDot}${name}</div>
              <div style="display:flex;align-items:center;gap:8px">
                <span style="font-size:11px;color:var(--text3)">${last} ${unit}</span>
                <span class="btchart-delta" style="background:${deltaColor}20;color:${deltaColor}">${deltaLabel} overall</span>
              </div>
            </div>
            <svg width="100%" height="${H}" viewBox="0 0 ${W} ${H}" preserveAspectRatio="none" style="display:block;overflow:visible">
              ${refBand}
              ${refLines.join('')}
              <polyline points="${points}" fill="none" stroke="#475569" stroke-width="1.5" stroke-linejoin="round"/>
              ${dots}
            </svg>
            <div style="display:flex;justify-content:space-between;font-size:10px;color:var(--text3);margin-top:4px">
              <span>${sorted[0].date}</span>
              <span style="color:#22c55e;font-size:9px">▬ normal range</span>
              <span>${sorted[sorted.length-1].date}</span>
            </div>
          </div>`;
        }).join('')}
      </div>`;
    }
  }

  // ── COMPARE TABLE VIEW ───────────────────────────────
  if (view === 'table') {
    // Show all markers that appear in at least one result, in a comparison table
    const allKeys = [...new Set(results.flatMap(r => r.markers.map(m => m.key)))];
    const sortedKeys = allKeys.sort((a, b) => {
      // Out of range in latest result first
      const as = bloodStatus(a, entry.markers.find(m=>m.key===a)?.value ?? 0);
      const bs = bloodStatus(b, entry.markers.find(m=>m.key===b)?.value ?? 0);
      const rank = {bad:0,warn:1,ok:2};
      if ((rank[as]||3) !== (rank[bs]||3)) return (rank[as]||3) - (rank[bs]||3);
      // Then by panel
      const ap = BLOOD_REFS[a]?.[4] || 'z';
      const bp = BLOOD_REFS[b]?.[4] || 'z';
      return ap.localeCompare(bp);
    });

    const sortedResults = [...results].sort((a,b) => b.date.localeCompare(a.date));
    const dateHeaders = sortedResults.map(r =>
      `<th style="text-align:right;min-width:70px">${r.date.slice(5)}<br><span style="font-size:9px;font-weight:400">${r.date.slice(0,4)}</span></th>`
    ).join('');

    const rows = sortedKeys.map(key => {
      const ref = BLOOD_REFS[key];
      const name = ref?.[3] || key;
      const unit = ref?.[2] || '';
      const latestMarker = entry.markers.find(m => m.key === key);
      const latestStatus = latestMarker ? bloodStatus(key, latestMarker.value) : 'ok';
      const rowClass = latestStatus === 'bad' ? 'row-bad' : latestStatus === 'warn' ? 'row-warn' : '';
      const dotCol = {ok:'#22c55e',warn:'#f59e0b',bad:'#ef4444'}[latestStatus] || '#475569';

      const cells = sortedResults.map(r => {
        const m = r.markers.find(x => x.key === key);
        if (!m) return '<td style="text-align:right;color:var(--text3)">—</td>';
        const s = bloodStatus(key, m.value);
        const col = {ok:'#22c55e',warn:'#f59e0b',bad:'#ef4444'}[s];

        // Trend from previous result for this marker
        const mIdx = sortedResults.indexOf(r);
        let trendHtml = '';
        if (mIdx < sortedResults.length - 1) {
          const prevResult = sortedResults[mIdx + 1];
          const prevM = prevResult?.markers.find(x => x.key === key);
          if (prevM) {
            const diff = m.value - prevM.value;
            const pct = (diff / prevM.value * 100).toFixed(0);
            const lb = LOWER_BETTER.has(key);
            const hb = HIGHER_BETTER.has(key);
            const good = lb ? diff < 0 : hb ? diff > 0 : null;
            if (Math.abs(parseFloat(pct)) >= 1) {
              const arrColor = good === true ? '#22c55e' : good === false ? '#ef4444' : '#94a3b8';
              trendHtml = `<span style="font-size:9px;color:${arrColor}">${diff>0?'↑':'↓'}</span>`;
            }
          }
        }

        return `<td style="text-align:right"><span style="font-size:13px;font-weight:700;color:${col}">${m.value}</span>${trendHtml}</td>`;
      }).join('');

      const refText = ref ? (ref[1]>=900 ? '>'+ref[0] : ref[0]+'–'+ref[1]) : '–';

      return `<tr class="${rowClass}">
        <td style="font-size:11px;font-weight:600;color:var(--text)">
          <span class="bcomp-dot" style="background:${dotCol}"></span>${name}
          <div style="font-size:9px;color:var(--text3);margin-top:1px;padding-left:12px">${refText} ${unit}</div>
        </td>
        ${cells}
      </tr>`;
    }).join('');

    tableEl.innerHTML = `<div class="card">
      <div class="card-label" style="color:#3b82f6">📊 Side-by-Side Comparison</div>
      <div style="font-size:12px;color:var(--text2);margin-bottom:12px">All markers across every lab result. Red/yellow rows = currently out of range. ↑↓ shows change from prior draw.</div>
      <div style="overflow-x:auto;-webkit-overflow-scrolling:touch">
        <table class="bcomp-table">
          <thead><tr>
            <th>Marker</th>
            ${dateHeaders}
          </tr></thead>
          <tbody>${rows}</tbody>
        </table>
      </div>
    </div>`;
  }

  // Show insights panel
  const insightsEl = document.getElementById('bloodAIInsights');
  if (insightsEl) insightsEl.style.display = 'block';
}

async function generateBloodAIInsights(entry) {
  const insightsEl = document.getElementById('bloodAIInsights');
  const insightsText = document.getElementById('bloodAIInsightsText');
  if (!insightsEl || !insightsText) return;
  insightsEl.style.display = 'block';
  insightsText.innerHTML = '<div style="color:var(--text3)">⏳ Generating health insights…</div>';

  // Gather out of range / borderline markers
  const flagged = entry.markers.filter(m => {
    const s = bloodStatus(m.key, m.value);
    return s === 'bad' || s === 'warn';
  });

  // Get recent nutrition averages for correlation
  const nutritionSummary = getNutritionSummaryText(30);

  const markerLines = entry.markers.map(m => {
    const ref = BLOOD_REFS[m.key];
    const status = ref ? bloodStatus(m.key, m.value) : 'ok';
    const mname = ref ? ref[3] : m.name;
    const flag = status !== 'ok' ? ' (' + status.toUpperCase() + ')' : '';
    return mname + ': ' + m.value + ' ' + (m.unit || '') + flag;
  }).join('\n');
  const prompt = [
    'You are a health coach analyzing blood work results for Jeremy, a 52-year-old male who lifts 3x/week and runs regularly. He tracks macros at 2,200 kcal/day with 190g protein.',
    'Lab results from ' + entry.date + ':',
    markerLines,
    'Recent 30-day nutrition averages:',
    nutritionSummary,
    'Provide a concise actionable health analysis: 1) Most important findings, 2) What is going well, 3) Specific nutrition/lifestyle changes for flagged markers, 4) What to monitor at next draw.',
    'Keep it practical. No disclaimers needed.'
  ].join('\n\n');

  try {
    const data = await callClaudeAPI({
      model: 'claude-opus-4-6',
      max_tokens: 1200,
      messages: [{ role: 'user', content: prompt }]
    });
    const text = data.content?.[0]?.text || 'Could not generate insights.';
    insightsText.innerHTML = text.replace(/\n/g, '<br>').replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
  } catch(e) {
    insightsText.textContent = 'Could not connect to AI. Check your network.';
  }
}

async function analyzeBloodWithNutrition() {
  const insightsText = document.getElementById('bloodAIInsightsText');
  if (!insightsText) return;
  insightsText.innerHTML = '<div style="color:var(--text3)">⏳ Correlating blood work with nutrition history…</div>';

  const results = getBloodResults();
  if (results.length === 0) return;

  const nutritionSummary = getNutritionSummaryText(90);
  const bloodSummary = results.map(r => {
    const flagged = r.markers.filter(m => bloodStatus(m.key, m.value) !== 'ok')
      .map(m => (BLOOD_REFS[m.key] ? BLOOD_REFS[m.key][3] : m.name) + ' ' + m.value)
      .join(', ');
    return r.date + ': ' + (flagged || 'All normal');
  }).join('\n');

  const prompt = [
    "Analyze the relationship between Jeremy's nutrition and his blood work results.",
    'Blood work history:\n' + bloodSummary,
    '90-day nutrition data:\n' + nutritionSummary,
    'Identify specific correlations between his diet and blood markers. For each flagged marker, explain which foods/nutrients are likely contributing and give concrete dietary changes. Focus on actionable insights for a 52-year-old male athlete.'
  ].join('\n\n');

  try {
    const data = await callClaudeAPI({
      model: 'claude-opus-4-6',
      max_tokens: 1500,
      messages: [{ role: 'user', content: prompt }]
    });
    const text = data.content?.[0]?.text || 'Could not generate analysis.';
    insightsText.innerHTML = '<strong style="color:#a78bfa">🔗 Nutrition-Blood Work Correlation</strong><br><br>' +
      text.replace(/\n/g, '<br>').replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
  } catch(e) {
    insightsText.textContent = 'AI unavailable. Try again.';
  }
}

// ═══════════════════════════════════════════════════════
// ── EXTENDED NUTRITION TRACKING ────────────────────────
// ═══════════════════════════════════════════════════════

// Full USDA nutrient ID → key mapping
const MICRO_NUTRIENT_IDS = {
  // Vitamins
  1106: 'vitA',       // Vitamin A RAE (mcg)
  1162: 'vitC',       // Vitamin C (mg)
  1114: 'vitD',       // Vitamin D (mcg)
  1109: 'vitE',       // Vitamin E (mg)
  1185: 'vitK',       // Vitamin K (mcg)
  1165: 'vitB1',      // Thiamine B1 (mg)
  1166: 'vitB2',      // Riboflavin B2 (mg)
  1167: 'vitB3',      // Niacin B3 (mg)
  1170: 'vitB5',      // Pantothenic acid B5 (mg)
  1175: 'vitB6',      // Vitamin B6 (mg)
  1177: 'folate',     // Folate (mcg)
  1178: 'vitB12',     // Vitamin B12 (mcg)
  // Minerals
  1087: 'calcium',    // (mg)
  1090: 'magnesium',  // (mg)
  1092: 'phosphorus', // (mg)
  1093: 'sodium',     // (mg)
  1095: 'zinc',       // (mg)
  1098: 'copper',     // (mg)
  1101: 'manganese',  // (mg)
  1103: 'selenium',   // (mcg)
  1089: 'iron',       // (mg)
  1091: 'potassium',  // (mg)
  // Other
  1079: 'fiber',      // Total dietary fiber (g)
  1085: 'sugar',      // Total sugars (g)
  1292: 'omega3',     // ALA omega-3 (g)
  1316: 'epa',        // EPA (g)
  1320: 'dpa',        // DPA (g)
  1322: 'dha',        // DHA (g)
  1253: 'cholesterol',// (mg)
  1258: 'saturatedFat', // (g)
  1292: 'omega3',     // Polyunsaturated (includes omega-3)
  1257: 'transFat',   // (g)
};

// Recommended Daily Values for display
const MICRO_RDV = {
  vitA: [900, 'mcg', 'Vitamin A'],
  vitC: [90, 'mg', 'Vitamin C'],
  vitD: [20, 'mcg', 'Vitamin D'],
  vitE: [15, 'mg', 'Vitamin E'],
  vitK: [120, 'mcg', 'Vitamin K'],
  vitB1: [1.2, 'mg', 'Vitamin B1 (Thiamine)'],
  vitB2: [1.3, 'mg', 'Vitamin B2 (Riboflavin)'],
  vitB3: [16, 'mg', 'Vitamin B3 (Niacin)'],
  vitB5: [5, 'mg', 'Vitamin B5'],
  vitB6: [1.7, 'mg', 'Vitamin B6'],
  folate: [400, 'mcg', 'Folate'],
  vitB12: [2.4, 'mcg', 'Vitamin B12'],
  calcium: [1000, 'mg', 'Calcium'],
  magnesium: [420, 'mg', 'Magnesium'],
  phosphorus: [700, 'mg', 'Phosphorus'],
  sodium: [2300, 'mg', 'Sodium'],
  zinc: [11, 'mg', 'Zinc'],
  copper: [0.9, 'mg', 'Copper'],
  manganese: [2.3, 'mg', 'Manganese'],
  selenium: [55, 'mcg', 'Selenium'],
  iron: [8, 'mg', 'Iron'],
  potassium: [3400, 'mg', 'Potassium'],
  fiber: [38, 'g', 'Dietary Fiber'],
  sugar: [50, 'g', 'Added Sugars'],
  omega3: [1.6, 'g', 'Omega-3 (ALA)'],
  epa: [0.5, 'g', 'EPA'],
  dha: [0.5, 'g', 'DHA'],
  cholesterol: [300, 'mg', 'Cholesterol'],
  saturatedFat: [20, 'g', 'Saturated Fat'],
};

// Get nutrition summary text for AI prompts
function getNutritionSummaryText(days) {
  const entries = getRecentMicronutrientAverages(days);
  if (Object.keys(entries).length === 0) return 'No detailed nutrition data available yet.';
  return Object.entries(MICRO_RDV).map(([key, [rdv, unit, name]]) => {
    const avg = entries[key] || 0;
    const pct = Math.round(avg / rdv * 100);
    return `${name}: ${avg.toFixed(1)} ${unit}/day (${pct}% of RDV)`;
  }).join('\n');
}

function getRecentMicronutrientAverages(days) {
  const foodEntries = getStorage('foodEntries', {});
  const totals = {};
  const counts = {};
  const cutoff = new Date();
  cutoff.setDate(cutoff.getDate() - days);
  const cutoffKey = cutoff.toISOString().slice(0,10);

  Object.entries(foodEntries).forEach(([dateKey, entries]) => {
    if (dateKey < cutoffKey) return;
    entries.forEach(e => {
      if (!e.micros) return;
      Object.entries(e.micros).forEach(([k, v]) => {
        totals[k] = (totals[k] || 0) + v;
        counts[k] = (counts[k] || 0) + 1;
      });
    });
  });

  const daysWithData = new Set(
    Object.keys(foodEntries).filter(k => k >= cutoffKey)
  ).size || 1;

  const avgs = {};
  Object.keys(totals).forEach(k => { avgs[k] = totals[k] / daysWithData; });
  return avgs;
}

function renderNutritionReport(days) {
  // Update active button
  [7, 30, 90].forEach(d => {
    const btn = document.getElementById('nrBtn'+d);
    if (btn) btn.classList.toggle('nr-btn-active', d === days);
  });

  const avgs = getRecentMicronutrientAverages(days);
  const grid = document.getElementById('nutritionReportGrid');
  const details = document.getElementById('nutritionReportDetails');
  if (!grid) return;

  const hasData = Object.keys(avgs).length > 0;
  if (!hasData) {
    grid.innerHTML = '<div style="font-size:13px;color:var(--text2);text-align:center;padding:20px">No micronutrient data yet.<br><br>Micronutrients are captured when you scan barcodes or search the USDA database. Log a few foods to see your report.</div>';
    if (details) details.innerHTML = '';
    return;
  }

  // Category groupings
  const categories = {
    '💊 Vitamins': ['vitA','vitC','vitD','vitE','vitK','vitB1','vitB2','vitB3','vitB5','vitB6','folate','vitB12'],
    '⚡ Minerals': ['calcium','magnesium','iron','potassium','sodium','zinc','phosphorus','copper','manganese','selenium'],
    '🫀 Heart Health': ['fiber','cholesterol','saturatedFat','omega3','epa','dha','sugar'],
  };

  grid.innerHTML = Object.entries(categories).map(([catName, keys]) => {
    const bars = keys.filter(k => avgs[k] !== undefined).map(k => {
      const [rdv, unit, name] = MICRO_RDV[k] || [1, '', k];
      const avg = avgs[k] || 0;
      const pct = Math.min(150, Math.round(avg / rdv * 100));
      const overRdv = pct > 100;
      // Color: green 80-120%, yellow <50% or >130%, red <20%
      const color = pct >= 80 && pct <= 120 ? '#22c55e'
                  : pct >= 50 && pct <= 130  ? '#f59e0b'
                  : '#ef4444';
      return `<div class="nutr-bar-wrap">
        <div class="nutr-bar-label">
          <span style="color:var(--text2);font-size:12px">${name}</span>
          <span style="color:${color};font-weight:600;font-size:12px">${avg.toFixed(1)} ${unit} <span style="color:var(--text3);font-weight:400">(${pct}%)</span></span>
        </div>
        <div class="nutr-bar-track">
          <div class="nutr-bar-fill" style="width:${Math.min(100,pct)}%;background:${color}"></div>
        </div>
      </div>`;
    });

    if (bars.length === 0) return '';
    return `<div style="margin-bottom:18px">
      <div style="font-size:11px;font-weight:700;color:var(--text3);text-transform:uppercase;letter-spacing:0.8px;margin-bottom:10px">${catName}</div>
      ${bars.join('')}
    </div>`;
  }).join('');

  // Summary stats
  const tracked = Object.keys(avgs).length;
  const optimal = Object.keys(MICRO_RDV).filter(k => {
    const pct = avgs[k] ? avgs[k] / MICRO_RDV[k][0] * 100 : 0;
    return pct >= 80 && pct <= 120;
  }).length;
  const low = Object.keys(MICRO_RDV).filter(k => {
    const pct = avgs[k] ? avgs[k] / MICRO_RDV[k][0] * 100 : 0;
    return pct < 50 && pct > 0;
  });

  if (details) {
    details.innerHTML = `<div class="card">
      <div class="card-label" style="color:#3b82f6">📊 ${days}-Day Summary</div>
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;margin-bottom:16px;text-align:center">
        <div style="background:var(--surface2);border-radius:12px;padding:12px">
          <div style="font-size:22px;font-weight:800;color:#22c55e">${optimal}</div>
          <div style="font-size:10px;color:var(--text3)">Optimal</div>
        </div>
        <div style="background:var(--surface2);border-radius:12px;padding:12px">
          <div style="font-size:22px;font-weight:800;color:#f59e0b">${low.length}</div>
          <div style="font-size:10px;color:var(--text3)">Low</div>
        </div>
        <div style="background:var(--surface2);border-radius:12px;padding:12px">
          <div style="font-size:22px;font-weight:800;color:var(--text2)">${tracked}</div>
          <div style="font-size:10px;color:var(--text3)">Tracked</div>
        </div>
      </div>
      ${low.length > 0 ? `<div style="background:#1c0e00;border:1px solid #92400e;border-radius:12px;padding:12px">
        <div style="font-size:11px;font-weight:700;color:#f59e0b;margin-bottom:6px">⚠️ Consistently Low</div>
        <div style="font-size:12px;color:var(--text2);line-height:1.7">${low.map(k=>MICRO_RDV[k][2]).join(' · ')}</div>
      </div>` : '<div style="background:#0d2d1a;border:1px solid #166534;border-radius:12px;padding:12px;font-size:12px;color:#4ade80;font-weight:600">✅ All tracked nutrients look solid over this period</div>'}
    </div>`;
  }
}

// ═══════════════════════════════════════════════════════
// ── EXTENDED USDA NUTRIENT PARSING ─────────────────────
// ═══════════════════════════════════════════════════════

// Extract micronutrients from a USDA food item's nutrient list
function parseMicronutrients(foodNutrients, scale) {
  const micros = {};
  (foodNutrients || []).forEach(n => {
    const id = n.nutrientId || n.nutrientNumber;
    const key = MICRO_NUTRIENT_IDS[parseInt(id)] || MICRO_NUTRIENT_IDS[String(id)];
    if (key && n.value != null) {
      micros[key] = Math.round((n.value * scale) * 1000) / 1000;
    }
  });
  return micros;
}


// ── Init ──
// Each call is isolated so one failure can't white-screen the app
function safeCall(fn, label) {
  try { fn(); } catch(e) { /* silent — never white-screen for one render */ }
}

safeCall(migrateShoePhotos, 'migrateShoePhotos');
safeCall(seedBloodResults, 'seedBloodResults');
safeCall(migrateBloodKeys, 'migrateBloodKeys');
safeCall(renderWeekStrip, 'renderWeekStrip');

// Restore today's calorie burn adjustment on reload
try {
  const burnLog = getStorage('burnLog', {});
  const burn = burnLog[todayKey()];
  if (burn > 0) {
    const base = getStorage('adaptiveMacros', null) || getStorage('userMacros', null) || MACROS;
    const extraCals  = Math.round(burn * 0.6);
    const extraCarbs = Math.round(extraCals * 0.65 / 4);
    const adjusted = { calories: base.calories + extraCals, carbs: base.carbs + extraCarbs, protein: base.protein, fat: base.fat };
    setStorage('garminAdjustedMacros', adjusted);
    setTimeout(() => {
      const banner = document.getElementById('garminMacroBanner');
      const text   = document.getElementById('garminMacroText');
      if (banner && text) {
        banner.style.display = 'flex';
        text.textContent = `🟠 Run detected! +${extraCals} kcal → ${adjusted.calories} kcal target, ${adjusted.carbs}g carbs`;
      }
    }, 100);
  }
} catch(e) {}

safeCall(renderRings, 'renderRings');
safeCall(renderQuickRecs, 'renderQuickRecs');
safeCall(renderUsualFoods, 'renderUsualFoods');
safeCall(renderFoodLog, 'renderFoodLog');
safeCall(renderWeightTrend, 'renderWeightTrend');
safeCall(checkCopyYesterday, 'checkCopyYesterday');
safeCall(checkAdaptiveMacros, 'checkAdaptiveMacros');
safeCall(renderProgramPage, 'renderProgramPage');
safeCall(renderEventList, 'renderEventList');
safeCall(renderEventCountdowns, 'renderEventCountdowns');

// Pre-seed events if none exist yet
try {
  if (!getEvents().length) {
    saveEvents([
      { id: Date.now(), name: "Grandma's Marathon", date: "2026-06-20", type: "race" },
      { id: Date.now() + 1, name: "Weight Goal", date: "2026-03-23", type: "weight", weightTarget: 163 }
    ]);
    safeCall(renderEventList, 'renderEventList');
    safeCall(renderEventCountdowns, 'renderEventCountdowns');
  }
} catch(e) {}

safeCall(updateStravaSettingsUI, 'updateStravaSettingsUI');
safeCall(renderWeeklyBalance, 'renderWeeklyBalance');
safeCall(renderStreakCard, 'renderStreakCard');
safeCall(renderProteinPace, 'renderProteinPace');
safeCall(renderWorkoutNutritionBanner, 'renderWorkoutNutritionBanner');
safeCall(loadDailyQuote, 'loadDailyQuote');
safeCall(renderRecipeList, 'renderRecipeList');
safeCall(updateHeaderDate, 'updateHeaderDate');
safeCall(updateDateNavBar, 'updateDateNavBar');
safeCall(scheduleMidnightRefresh, 'scheduleMidnightRefresh');
setTimeout(renderShoePage, 0);

// Mobile resume fix — when app comes back from background, check if day changed
document.addEventListener('visibilitychange', () => {
  if (document.visibilityState === 'visible') {
    const cached = getStorage('dailyQuote', null);
    if (!cached || cached.date !== todayKey()) {
      updateHeaderDate();
      renderWeekStrip();
      renderRings();
      renderFoodLog();
      renderWeightTrend();
      renderWeeklyBalance();
      checkCopyYesterday();
      loadDailyQuote();
    }
  }
});

// Auto-select current time slot in manual picker on load
(function() {
  const currentSlot = getTimeSlot();
  const btn = document.querySelector(`#manualTimeSlotPicker .ts-btn[data-slot="${currentSlot}"]`);
  if (btn) { btn.classList.add('active'); selectedTimeSlot = currentSlot; }
})();

// Handle OAuth callbacks — check Garmin first, then Strava
handleOAuthCallback();
handleStravaCallback();

// Auto-load activity data if connected (Strava takes priority if both connected)
(function() {
  const stravaTok = getStorage('stravaToken', null);
  const garminTok = getStorage('garminToken', null);

  if (stravaTok) {
    document.getElementById('garminCard').style.display = 'block';
    const cached = getStorage('stravaToday', null);
    if (cached && (Date.now() - cached.fetched) < 30 * 60 * 1000) {
      renderGarminCard(cached.calories, cached.distance, cached.duration, cached.calories > 0 ? 1 : 0, 'strava');
      if (getStorage('stravaAutoAdjust', true)) adjustMacrosForBurn(cached.calories);
    } else {
      fetchStravaToday();
    }
  } else if (garminTok) {
    document.getElementById('garminCard').style.display = 'block';
    const cached = getStorage('garminToday', null);
    if (cached && (Date.now() - cached.fetched) < 30 * 60 * 1000) {
      renderGarminCard(cached.calories, cached.distance, cached.duration, cached.calories > 0 ? 1 : 0, 'garmin');
      if (getStorage('garminAutoAdjust', true)) adjustMacrosForBurn(cached.calories);
    } else {
      fetchGarminToday();
    }
  }
})();

// ═══════════════════════════════════════════════════════
// ── RETROACTIVE MICRO ENRICHMENT ───────────────────────
// ═══════════════════════════════════════════════════════

async function startRetroEnrichment() {
  const btn = document.getElementById('enrichBtn');
  const statusEl = document.getElementById('enrichStatus');
  const progressEl = document.getElementById('enrichProgress');
  const bar = document.getElementById('enrichProgressBar');
  const progressText = document.getElementById('enrichProgressText');

  btn.disabled = true;
  btn.textContent = '⏳ Scanning food history…';
  statusEl.style.display = 'block';
  progressEl.style.display = 'block';

  // 1. Collect ALL food entries across all dates
  const foodEntries = getStorage('foodEntries', {});
  const allDates = Object.keys(foodEntries);

  if (!allDates.length) {
    statusEl.textContent = '⚠️ No food history found.';
    btn.disabled = false;
    btn.textContent = '🔄 Enrich All Past Meals with Micronutrients';
    return;
  }

  // 2. Build unique food name list (skip already-enriched entries)
  const uniqueFoods = new Map(); // name.toLowerCase() → { name, dates: [{date, idx}] }
  let totalEntries = 0, alreadyHave = 0;

  allDates.forEach(date => {
    (foodEntries[date] || []).forEach((entry, idx) => {
      totalEntries++;
      if (entry.micros && Object.keys(entry.micros).length > 0) { alreadyHave++; return; }
      const key = (entry.name || '').toLowerCase().trim();
      if (!key) return;
      if (!uniqueFoods.has(key)) uniqueFoods.set(key, { name: entry.name, refs: [] });
      uniqueFoods.get(key).refs.push({ date, idx });
    });
  });

  const needsEnrich = [...uniqueFoods.values()];
  statusEl.textContent = `Found ${totalEntries} entries · ${alreadyHave} already have micros · ${needsEnrich.length} unique foods to look up`;

  if (!needsEnrich.length) {
    statusEl.innerHTML = '✅ All entries already have micronutrient data!';
    progressEl.style.display = 'none';
    btn.disabled = false;
    btn.textContent = '✅ Already Complete';
    renderNutritionReport(7);
    return;
  }

  // 3. Look up each unique food — USDA first, AI fallback
  // Process in small batches to avoid rate limiting
  const BATCH_SIZE = 3;
  let processed = 0, usdaHits = 0, aiHits = 0, missed = 0;
  const microCache = new Map(); // food key → micros object (normalized per 100 cal proxy)

  const setProgress = (pct, msg) => {
    bar.style.width = pct + '%';
    progressText.textContent = msg;
  };

  for (let i = 0; i < needsEnrich.length; i += BATCH_SIZE) {
    const batch = needsEnrich.slice(i, i + BATCH_SIZE);
    setProgress(Math.round(i / needsEnrich.length * 80), `Looking up ${i+1}–${Math.min(i+BATCH_SIZE, needsEnrich.length)} of ${needsEnrich.length} foods…`);

    // Parallel USDA lookups for the batch
    await Promise.all(batch.map(async food => {
      const key = food.name.toLowerCase().trim();
      try {
        // Try Foundation + SR Legacy first
        const url = `https://api.nal.usda.gov/fdc/v1/foods/search?query=${encodeURIComponent(food.name)}&dataType=Foundation,SR%20Legacy,Branded&pageSize=3&api_key=${USDA_API_KEY}`;
        const res = await fetch(url);
        if (!res.ok) return;
        const data = await res.json();
        const f = (data.foods || [])[0];
        if (!f) return;

        // Scale to 100g for storage (entries will scale by their own calories)
        // Actually: store absolute micros for a standard reference serving
        // We'll scale to match the entry's calorie count later
        let servingG = parseFloat(f.servingSize) || 100;
        const sUnit = (f.servingSizeUnit || 'g').toLowerCase();
        if (sUnit === 'oz') servingG *= 28.3495;
        const scale100 = 100 / (servingG || 100);
        const micros100 = parseMicronutrients(f.foodNutrients, scale100); // normalized to 100g

        const cal100 = (() => {
          const n = (f.foodNutrients || []).find(x => x.nutrientId === 1008 || x.nutrientId === 208);
          return (n?.value || 0);
        })();

        microCache.set(key, { micros100, cal100: cal100 || 200, source: 'usda', fdcName: f.description });
        usdaHits++;
      } catch(e) { /* will fall through to AI */ }
    }));

    processed += batch.length;
  }

  // 4. AI fallback for any still missing — batch them together
  const needsAI = needsEnrich.filter(f => !microCache.has(f.name.toLowerCase().trim()));
  if (needsAI.length > 0) {
    setProgress(82, `AI estimating ${needsAI.length} foods not found in USDA…`);

    // Send in groups of 10 to AI
    for (let i = 0; i < needsAI.length; i += 10) {
      const group = needsAI.slice(i, i + 10);
      const prompt = 'Estimate micronutrients per 100g for these foods. Return ONLY JSON: ' +
        '{"foods":[{"name":"string","cal100":0,"micros":{"vitA":0,"vitC":0,"vitD":0,"vitE":0,"vitK":0,' +
        '"vitB1":0,"vitB2":0,"vitB3":0,"vitB6":0,"vitB12":0,"folate":0,' +
        '"calcium":0,"magnesium":0,"iron":0,"potassium":0,"zinc":0,"selenium":0,' +
        '"fiber":0,"sodium":0,"omega3":0,"cholesterol":0,"saturatedFat":0}}]}. ' +
        'Foods: ' + group.map(f => f.name).join(', ');
      try {
        const data = await callClaudeAPI({
          model: 'claude-haiku-4-5-20251001', max_tokens: 1500,
          messages: [{ role: 'user', content: prompt }]
        });
        const raw = (data.content?.[0]?.text || '').replace(/```json|```/g, '').trim();
        const parsed = JSON.parse(raw.match(/\{[\s\S]*\}/)?.[0] || '{}');
        (parsed.foods || []).forEach((f, idx) => {
          if (group[idx]) {
            const key = group[idx].name.toLowerCase().trim();
            microCache.set(key, {
              micros100: f.micros || {},
              cal100: f.cal100 || 200,
              source: 'ai'
            });
            aiHits++;
          }
        });
      } catch(e) { console.warn('AI batch failed:', e); }
    }
  }

  // 5. Write micros back to all matching entries
  setProgress(90, 'Writing micronutrients back to food history…');

  let enriched = 0;
  allDates.forEach(date => {
    let changed = false;
    (foodEntries[date] || []).forEach(entry => {
      if (entry.micros && Object.keys(entry.micros).length > 0) return; // skip already done
      const key = (entry.name || '').toLowerCase().trim();
      const cached = microCache.get(key);
      if (!cached) { missed++; return; }

      // Scale micros from per-100g to this entry's calorie equivalent
      // Use calorie ratio as proxy for serving size
      const entryCals = entry.calories || 200;
      const scaleFactor = cached.cal100 > 0 ? entryCals / cached.cal100 : 1;
      const scaledMicros = {};
      Object.entries(cached.micros100 || {}).forEach(([k, v]) => {
        scaledMicros[k] = Math.round(v * scaleFactor * 1000) / 1000;
      });

      if (Object.keys(scaledMicros).length > 0) {
        entry.micros = scaledMicros;
        entry.microSource = cached.source;
        enriched++;
        changed = true;
      }
    });
    if (changed) setStorage('foodEntries_' + date, foodEntries[date]);
  });

  // Also save back to main foodEntries object
  setStorage('foodEntries', foodEntries);

  setProgress(100, 'Done!');
  missed = needsEnrich.length - usdaHits - aiHits;
  statusEl.innerHTML = `✅ Enriched <strong>${enriched}</strong> entries — ` +
    `<span style="color:#22c55e">${usdaHits} USDA</span> · ` +
    `<span style="color:#a78bfa">${aiHits} AI estimated</span>` +
    (missed > 0 ? ` · <span style="color:#ef4444">${missed} not found</span>` : '');

  btn.disabled = false;
  btn.textContent = '✅ Enrichment Complete — Run Again?';

  // Refresh the nutrition report
  setTimeout(() => renderNutritionReport(30), 500);
}

// ═══════════════════════════════════════════════════════
// ── MEAL ANALYZER ──────────────────────────────────────
// ═══════════════════════════════════════════════════════

let _mealAnalysisData = null;

async function analyzeMealDescription() {
  const desc = (document.getElementById('mealDescInput')?.value || '').trim();
  if (!desc) { showToast('Describe your meal first'); return; }

  const btn = document.getElementById('mealAnalyzeBtn');
  const resultEl = document.getElementById('mealAnalysisResult');
  btn.disabled = true;
  btn.textContent = '⏳ Breaking down meal…';
  resultEl.style.display = 'none';

  // Step 1: Ask Claude to decompose into USDA-searchable ingredients
  const decompPrompt = 'Decompose this meal into individual ingredients for USDA database lookup. ' +
    'Return ONLY JSON: {"meal_name":"string","total_calories_estimate":0,' +
    '"ingredients":[{"name":"USDA-searchable name e.g. chicken breast cooked","grams":0,"serving_desc":"e.g. 6 oz"}]}. ' +
    'Use standard USDA food names. Be specific (cooked vs raw, method). Meal: ' + desc;

  try {
    const decompData = await callClaudeAPI({
      model: 'claude-sonnet-4-6',
      max_tokens: 800,
      messages: [{ role: 'user', content: decompPrompt }]
    });

    const decompRaw = (decompData.content?.[0]?.text || '').replace(/```json|```/g, '').trim();
    const decomp = JSON.parse(decompRaw.match(/\{[\s\S]*\}/)?.[0] || '{}');
    const ingredients = decomp.ingredients || [];

    if (!ingredients.length) throw new Error('No ingredients parsed');

    btn.textContent = `⏳ Looking up ${ingredients.length} ingredients in USDA…`;

    // Step 2: Search USDA for each ingredient
    const lookupResults = await Promise.all(
      ingredients.map(async ing => {
        try {
          // SR Legacy first for best micros
          const url = `https://api.nal.usda.gov/fdc/v1/foods/search?query=${encodeURIComponent(ing.name)}&dataType=Foundation,SR%20Legacy&pageSize=3&api_key=${USDA_API_KEY}`;
          const res = await fetch(url);
          if (!res.ok) return { ing, product: null, found: false };
          const data = await res.json();
          const f = (data.foods || [])[0];
          if (!f) return { ing, product: null, found: false };
          // Scale to the ingredient's gram weight
          const scaleG = ing.grams > 0 ? ing.grams / 100 : 1;
          const p = usdaFoodToProduct(f);
          // Rescale everything to actual gram weight
          const resScaled = {
            ...p,
            calories: Math.round(p.calories * scaleG),
            protein:  Math.round(p.protein  * scaleG * 10) / 10,
            carbs:    Math.round(p.carbs    * scaleG * 10) / 10,
            fat:      Math.round(p.fat      * scaleG * 10) / 10,
            micros:   Object.fromEntries(Object.entries(p.micros || {}).map(([k,v]) => [k, Math.round(v * scaleG * 1000)/1000])),
          };
          return { ing, product: resScaled, found: true };
        } catch(e) {
          return { ing, product: null, found: false };
        }
      })
    );

    // Step 3: For not-found ingredients, use AI estimation
    const notFound = lookupResults.filter(r => !r.found);
    if (notFound.length > 0) {
      const estimatePrompt = 'Estimate nutrition for these ingredients (per specified gram amounts). ' +
        'Return ONLY JSON: {"estimates":[{"name":"string","calories":0,"protein":0,"carbs":0,"fat":0,' +
        '"micros":{"vitC":0,"vitD":0,"calcium":0,"magnesium":0,"iron":0,"potassium":0,"zinc":0,"fiber":0}}]}. ' +
        'Ingredients: ' + notFound.map(r => r.ing.name + ' ' + r.ing.grams + 'g').join(', ');
      try {
        const estData = await callClaudeAPI({
          model: 'claude-sonnet-4-6', max_tokens: 800,
          messages: [{ role: 'user', content: estimatePrompt }]
        });
        const estRaw = (estData.content?.[0]?.text || '').replace(/```json|```/g, '').trim();
        const estimates = JSON.parse(estRaw.match(/\{[\s\S]*\}/)?.[0] || '{}').estimates || [];
        estimates.forEach((est, i) => {
          if (notFound[i]) {
            notFound[i].product = { ...est, source: 'ai', microQuality: 'estimated' };
            notFound[i].found = true;
          }
        });
      } catch(e) { /* best effort */ }
    }

    // Step 4: Sum everything up
    const totals = { calories: 0, protein: 0, carbs: 0, fat: 0, micros: {} };
    lookupResults.forEach(r => {
      if (!r.product) return;
      totals.calories += r.product.calories || 0;
      totals.protein  += r.product.protein  || 0;
      totals.carbs    += r.product.carbs    || 0;
      totals.fat      += r.product.fat      || 0;
      Object.entries(r.product.micros || {}).forEach(([k, v]) => {
        totals.micros[k] = (totals.micros[k] || 0) + v;
      });
    });

    _mealAnalysisData = {
      name: decomp.meal_name || desc.slice(0, 40),
      ingredients: lookupResults,
      totals,
      icon: '🍽️'
    };

    // Render the breakdown
    const foundCount = lookupResults.filter(r => r.found).length;
    const microCount = Object.keys(totals.micros).length;
    resultEl.innerHTML = `
      <div style="background:var(--surface2);border-radius:14px;padding:14px;margin-bottom:12px">
        <div style="font-size:14px;font-weight:700;color:var(--text);margin-bottom:10px">${_mealAnalysisData.name}</div>
        <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:6px;margin-bottom:10px">
          <div style="text-align:center"><div style="font-size:18px;font-weight:800;color:#f59e0b">${Math.round(totals.calories)}</div><div style="font-size:10px;color:var(--text3)">kcal</div></div>
          <div style="text-align:center"><div style="font-size:18px;font-weight:800;color:#22c55e">${totals.protein.toFixed(1)}g</div><div style="font-size:10px;color:var(--text3)">protein</div></div>
          <div style="text-align:center"><div style="font-size:18px;font-weight:800;color:#3b82f6">${totals.carbs.toFixed(1)}g</div><div style="font-size:10px;color:var(--text3)">carbs</div></div>
          <div style="text-align:center"><div style="font-size:18px;font-weight:800;color:#ef4444">${totals.fat.toFixed(1)}g</div><div style="font-size:10px;color:var(--text3)">fat</div></div>
        </div>
        <div style="font-size:11px;color:var(--text3);margin-bottom:10px">${foundCount}/${ingredients.length} ingredients found · ${microCount} micronutrients captured</div>
        ${lookupResults.map(r => `
          <div class="meal-ingredient-row">
            <span class="meal-ingredient-status">${r.found ? (r.product?.source === 'ai' ? '🔵' : '✅') : '❌'}</span>
            <div style="flex:1">
              <div style="font-weight:600;color:var(--text)">${r.ing.serving_desc || r.ing.name}</div>
              <div style="color:var(--text3);font-size:11px">${r.found ? (r.product?.name || r.ing.name) + ' · ' + (r.product?.calories || 0) + ' kcal' : 'Not found — excluded'}</div>
            </div>
          </div>`).join('')}
      </div>
      <button onclick="logMealToday()" style="width:100%;background:#22c55e;border:none;border-radius:12px;padding:13px;color:#fff;font-size:14px;font-weight:700;cursor:pointer;font-family:inherit">✓ Log This Meal</button>
    `;
    resultEl.style.display = 'block';
    btn.disabled = false;
    btn.textContent = '🔄 Re-analyze';

  } catch(e) {
    console.error('Meal analysis error:', e);
    btn.disabled = false;
    btn.textContent = '🤖 Analyze Meal + Get Micros';
    showToast('❌ Could not analyze meal. Be more specific about ingredients and amounts.');
  }
}

function logMealToday() {
  if (!_mealAnalysisData) return;
  const { name, totals, icon } = _mealAnalysisData;
  addFoodEntry({
    name,
    calories: Math.round(totals.calories),
    protein:  Math.round(totals.protein  * 10) / 10,
    carbs:    Math.round(totals.carbs    * 10) / 10,
    fat:      Math.round(totals.fat      * 10) / 10,
    micros:   Object.keys(totals.micros).length ? totals.micros : undefined,
    icon: icon || '🍽️',
  });
  closeAISearch();
  showToast('✅ Meal logged with ' + Object.keys(totals.micros || {}).length + ' micronutrients!');
  _mealAnalysisData = null;
}

// ═══════════════════════════════════════════════════════
// ── SUPPLEMENT LOGGER ──────────────────────────────────
// ═══════════════════════════════════════════════════════

const SUPPLEMENT_PRESETS = [
  { name: 'Vitamin D3 2000 IU',  icon: '☀️', calories: 0, protein: 0, carbs: 0, fat: 0, micros: { vitD: 50 } },
  { name: 'Vitamin D3 5000 IU',  icon: '☀️', calories: 0, protein: 0, carbs: 0, fat: 0, micros: { vitD: 125 } },
  { name: 'Magnesium 400mg',      icon: '💊', calories: 0, protein: 0, carbs: 0, fat: 0, micros: { magnesium: 400 } },
  { name: 'Magnesium Glycinate 200mg', icon: '💊', calories: 0, protein: 0, carbs: 0, fat: 0, micros: { magnesium: 200 } },
  { name: 'Zinc 15mg',            icon: '💊', calories: 0, protein: 0, carbs: 0, fat: 0, micros: { zinc: 15 } },
  { name: 'Zinc 30mg',            icon: '💊', calories: 0, protein: 0, carbs: 0, fat: 0, micros: { zinc: 30 } },
  { name: 'Fish Oil 1g (1000mg)', icon: '🐟', calories: 9, protein: 0, carbs: 0, fat: 1, micros: { omega3: 0.3, epa: 0.18, dha: 0.12 } },
  { name: 'Fish Oil 2g (2000mg)', icon: '🐟', calories: 18, protein: 0, carbs: 0, fat: 2, micros: { omega3: 0.6, epa: 0.36, dha: 0.24 } },
  { name: 'Omega-3 Triple Strength', icon: '🐟', calories: 25, protein: 0, carbs: 0, fat: 3, micros: { omega3: 2.4, epa: 1.0, dha: 0.8 } },
  { name: 'Vitamin C 500mg',      icon: '🍊', calories: 0, protein: 0, carbs: 0, fat: 0, micros: { vitC: 500 } },
  { name: 'Vitamin C 1000mg',     icon: '🍊', calories: 0, protein: 0, carbs: 0, fat: 0, micros: { vitC: 1000 } },
  { name: 'Vitamin K2 100mcg',    icon: '💊', calories: 0, protein: 0, carbs: 0, fat: 0, micros: { vitK: 100 } },
  { name: 'Vitamin B12 1000mcg',  icon: '💊', calories: 0, protein: 0, carbs: 0, fat: 0, micros: { vitB12: 1000 } },
  { name: 'Folate 400mcg',        icon: '💊', calories: 0, protein: 0, carbs: 0, fat: 0, micros: { folate: 400 } },
  { name: 'Iron 18mg',            icon: '🔴', calories: 0, protein: 0, carbs: 0, fat: 0, micros: { iron: 18 } },
  { name: 'Calcium 500mg',        icon: '🦴', calories: 0, protein: 0, carbs: 0, fat: 0, micros: { calcium: 500 } },
  { name: 'Potassium 99mg',       icon: '🍌', calories: 0, protein: 0, carbs: 0, fat: 0, micros: { potassium: 99 } },
  { name: "Multivitamin (Men's)", icon: '💊', calories: 10, protein: 0, carbs: 2, fat: 0,
    micros: { vitA: 900, vitC: 90, vitD: 25, vitE: 15, vitK: 75, vitB1: 1.5, vitB2: 1.7, vitB3: 20, vitB6: 2, vitB12: 6, folate: 400, calcium: 200, magnesium: 100, zinc: 11, iron: 18, selenium: 55 } },
  { name: 'NMN 500mg',            icon: '⚡', calories: 0, protein: 0, carbs: 0, fat: 0, micros: {} },
  { name: 'Creatine 5g',          icon: '💪', calories: 0, protein: 0, carbs: 0, fat: 0, micros: {} },
  { name: 'Collagen Peptides 10g', icon: '💪', calories: 38, protein: 9, carbs: 0, fat: 0, micros: {} },
];

let _customSuppNutrients = [];

function renderSuppPresets() {
  const el = document.getElementById('suppPresetList');
  if (!el) return;
  el.innerHTML = SUPPLEMENT_PRESETS.map((s, i) => {
    const microSummary = Object.entries(s.micros || {}).slice(0, 3)
      .map(([k, v]) => (MICRO_RDV[k]?.[2] || k) + ' ' + v + (MICRO_RDV[k]?.[1] || ''))
      .join(' · ') || 'Tracked for compliance';
    return `<div class="supp-preset-row">
      <div class="supp-preset-info">
        <div class="supp-preset-name">${s.icon} ${s.name}</div>
        <div class="supp-preset-detail">${microSummary}</div>
      </div>
      <button class="supp-log-btn" onclick="logPresetSupplement(${i})">Log</button>
    </div>`;
  }).join('');

  // Custom supplement nutrient fields
  _customSuppNutrients = [];
  renderCustomSuppNutrients();
}

function renderCustomSuppNutrients() {
  const el = document.getElementById('suppCustomNutrients');
  if (!el) return;
  const commonNutrients = Object.entries(MICRO_RDV).map(([k, [,unit,name]]) => `<option value="${k}">${name} (${unit})</option>`).join('');
  el.innerHTML = _customSuppNutrients.map((n, i) => `
    <div style="display:flex;gap:4px;align-items:center">
      <select onchange="_customSuppNutrients[${i}].key=this.value" style="flex:1;background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:6px;color:var(--text);font-size:11px;font-family:inherit">
        ${commonNutrients}
      </select>
      <input type="number" placeholder="mg" style="width:60px;padding:6px;font-size:11px" value="${n.value||''}" onchange="_customSuppNutrients[${i}].value=parseFloat(this.value)||0">
      <button onclick="_customSuppNutrients.splice(${i},1);renderCustomSuppNutrients()" style="background:none;border:none;color:#ef4444;font-size:16px;cursor:pointer;padding:0 4px">×</button>
    </div>
  `).join('');
}

function addCustomSuppNutrient() {
  _customSuppNutrients.push({ key: 'vitD', value: 0 });
  renderCustomSuppNutrients();
}

function logPresetSupplement(idx) {
  const s = SUPPLEMENT_PRESETS[idx];
  addFoodEntry({
    name: s.name,
    calories: s.calories || 0,
    protein:  s.protein  || 0,
    carbs:    s.carbs    || 0,
    fat:      s.fat      || 0,
    micros:   Object.keys(s.micros || {}).length ? s.micros : undefined,
    icon: s.icon || '💊',
  });
  showToast('✅ ' + s.name + ' logged!');
}

function logCustomSupplement() {
  const name = (document.getElementById('suppCustomName')?.value || '').trim();
  if (!name) { showToast('Enter a supplement name'); return; }
  const micros = {};
  _customSuppNutrients.forEach(n => { if (n.key && n.value > 0) micros[n.key] = n.value; });
  addFoodEntry({
    name, calories: 0, protein: 0, carbs: 0, fat: 0,
    micros: Object.keys(micros).length ? micros : undefined,
    icon: '💊',
  });
  document.getElementById('suppCustomName').value = '';
  _customSuppNutrients = [];
  renderCustomSuppNutrients();
  showToast('✅ ' + name + ' logged!');
}

// ── One-time seed: Labcorp Oct 2024 results ──
(function seedLabcorpOct2024() {
  try {
    const existing = JSON.parse(localStorage.getItem('bloodResults') || '[]');
    if (existing.some(r => r.date === '2024-10-11')) return;
    const entry = {
      id: 1728691200000,
      date: '2024-10-11',
      lab: 'Labcorp',
      markers: [
        {name:'WBC',key:'wbc',value:4.4,unit:'x10E3/uL',ref_low:3.4,ref_high:10.8,flag:null},
        {name:'RBC',key:'rbc',value:4.74,unit:'x10E6/uL',ref_low:4.14,ref_high:5.80,flag:null},
        {name:'Hemoglobin',key:'hemoglobin',value:14.5,unit:'g/dL',ref_low:13.0,ref_high:17.7,flag:null},
        {name:'Hematocrit',key:'hematocrit',value:44.5,unit:'%',ref_low:37.5,ref_high:51.0,flag:null},
        {name:'Platelets',key:'platelets',value:269,unit:'x10E3/uL',ref_low:150,ref_high:450,flag:null},
        {name:'Glucose',key:'glucose',value:83,unit:'mg/dL',ref_low:70,ref_high:99,flag:null},
        {name:'BUN',key:'bun',value:26,unit:'mg/dL',ref_low:6,ref_high:24,flag:'H'},
        {name:'Creatinine',key:'creatinine',value:1.13,unit:'mg/dL',ref_low:0.76,ref_high:1.27,flag:null},
        {name:'eGFR',key:'egfr',value:79,unit:'mL/min/1.73',ref_low:59,ref_high:999,flag:null},
        {name:'Sodium',key:'sodium',value:139,unit:'mmol/L',ref_low:134,ref_high:144,flag:null},
        {name:'Potassium',key:'potassium',value:4.8,unit:'mmol/L',ref_low:3.5,ref_high:5.2,flag:null},
        {name:'Calcium',key:'calcium',value:10.6,unit:'mg/dL',ref_low:8.7,ref_high:10.2,flag:'H'},
        {name:'ALT',key:'alt',value:17,unit:'IU/L',ref_low:0,ref_high:44,flag:null},
        {name:'AST',key:'ast',value:22,unit:'IU/L',ref_low:0,ref_high:40,flag:null},
        {name:'Alkaline Phosphatase',key:'alkaline_phosphatase',value:57,unit:'IU/L',ref_low:44,ref_high:121,flag:null},
        {name:'Total Cholesterol',key:'total_cholesterol',value:243,unit:'mg/dL',ref_low:0,ref_high:199,flag:'H'},
        {name:'LDL',key:'ldl',value:153,unit:'mg/dL',ref_low:0,ref_high:99,flag:'H'},
        {name:'HDL',key:'hdl',value:77,unit:'mg/dL',ref_low:40,ref_high:999,flag:null},
        {name:'Triglycerides',key:'triglycerides',value:76,unit:'mg/dL',ref_low:0,ref_high:149,flag:null},
        {name:'Lipoprotein(a)',key:'lipoprotein_a',value:123.2,unit:'nmol/L',ref_low:0,ref_high:75,flag:'H'},
        {name:'Apolipoprotein B',key:'apolipoprotein_b',value:117,unit:'mg/dL',ref_low:0,ref_high:90,flag:'H'},
        {name:'Testosterone',key:'testosterone_total',value:614,unit:'ng/dL',ref_low:264,ref_high:916,flag:null},
        {name:'Free Testosterone',key:'testosterone_free',value:104.9,unit:'pg/mL',ref_low:30.3,ref_high:183.2,flag:null},
        {name:'TSH',key:'tsh',value:1.64,unit:'uIU/mL',ref_low:0.45,ref_high:4.5,flag:null},
        {name:'Free T4',key:'t4_free',value:1.68,unit:'ng/dL',ref_low:0.82,ref_high:1.77,flag:null},
        {name:'Free T3',key:'free_t3',value:3.2,unit:'pg/mL',ref_low:2.0,ref_high:4.4,flag:null},
        {name:'DHEA-Sulfate',key:'dhea_s',value:111,unit:'ug/dL',ref_low:71.6,ref_high:375.4,flag:null},
        {name:'Cortisol',key:'cortisol',value:16.0,unit:'ug/dL',ref_low:6.2,ref_high:19.4,flag:null},
        {name:'Insulin',key:'insulin',value:2.1,unit:'uIU/mL',ref_low:2.6,ref_high:24.9,flag:'L'},
        {name:'Estradiol',key:'estradiol',value:9.7,unit:'pg/mL',ref_low:7.6,ref_high:42.6,flag:null},
        {name:'Vitamin D',key:'vitamin_d',value:44.8,unit:'ng/mL',ref_low:30,ref_high:100,flag:null},
        {name:'Vitamin B12',key:'vitamin_b12',value:699,unit:'pg/mL',ref_low:232,ref_high:1245,flag:null},
        {name:'Folate',key:'folate',value:10.2,unit:'ng/mL',ref_low:3.0,ref_high:20,flag:null},
        {name:'Ferritin',key:'ferritin',value:88,unit:'ng/mL',ref_low:30,ref_high:400,flag:null},
        {name:'Iron',key:'iron',value:103,unit:'ug/dL',ref_low:38,ref_high:169,flag:null},
        {name:'CRP Cardiac',key:'crp',value:0.46,unit:'mg/L',ref_low:0,ref_high:3.0,flag:null},
        {name:'HbA1c',key:'hba1c',value:5.5,unit:'%',ref_low:4.8,ref_high:5.6,flag:null},
        {name:'PSA',key:'psa',value:0.5,unit:'ng/mL',ref_low:0,ref_high:4.0,flag:null},
        {name:'Magnesium',key:'magnesium',value:2.1,unit:'mg/dL',ref_low:1.6,ref_high:2.3,flag:null},
      ],
      uploadedAt: new Date().toISOString(),
    };
    const all = JSON.parse(localStorage.getItem('bloodResults') || '[]');
    all.unshift(entry);
    localStorage.setItem('bloodResults', JSON.stringify(all));
    console.log('✅ Seeded Labcorp Oct 2024 (39 markers)');
  } catch(e) { console.warn('Seed failed:', e); }
})();

// ── Hidden Deploy Panel ──
let _deployTapCount = 0, _deployTapTimer = null;
function handleDeployTap() {
  _deployTapCount++;
  clearTimeout(_deployTapTimer);
  if (_deployTapCount >= 5) {
    _deployTapCount = 0;
    openDeployModal();
  } else {
    _deployTapTimer = setTimeout(() => _deployTapCount = 0, 2000);
  }
}

function openDeployModal() {
  const modal = document.getElementById('deployModal');
  modal.style.display = 'flex';
  // Load saved token
  const saved = localStorage.getItem('deploy_gh_token');
  if (saved) {
    document.getElementById('deployToken').value = saved;
    document.getElementById('deployTokenSaved').style.display = 'block';
  }
}

// Token save on input
document.addEventListener('DOMContentLoaded', () => {
  const tokenInput = document.getElementById('deployToken');
  if (tokenInput) {
    tokenInput.addEventListener('input', function() {
      if (this.value.startsWith('ghp_')) {
        localStorage.setItem('deploy_gh_token', this.value);
        document.getElementById('deployTokenSaved').style.display = 'block';
      }
    });
  }

  // Drop zone
  const drop = document.getElementById('deployDrop');
  const fileInput = document.getElementById('deployFileInput');
  if (drop) {
    drop.addEventListener('click', () => fileInput.click());
    drop.addEventListener('dragover', e => { e.preventDefault(); drop.style.borderColor = '#3b82f6'; });
    drop.addEventListener('dragleave', () => drop.style.borderColor = '#2a2a2a');
    drop.addEventListener('drop', e => {
      e.preventDefault();
      drop.style.borderColor = '#2a2a2a';
      handleDeployFile(e.dataTransfer.files[0]);
    });
    fileInput.addEventListener('change', e => handleDeployFile(e.target.files[0]));
  }
});

let _deployFileContent = null;
function handleDeployFile(file) {
  if (!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    _deployFileContent = e.target.result;
    document.getElementById('deployFileName').textContent = file.name + ' (' + (file.size/1024).toFixed(0) + 'kb)';
    document.getElementById('deployDrop').style.borderColor = '#22c55e';
    const btn = document.getElementById('deploySubmitBtn');
    btn.disabled = false;
    btn.style.opacity = '1';
  };
  reader.readAsText(file);
}

async function runDeploy() {
  const token = document.getElementById('deployToken').value.trim();
  if (!token) { showDeployStatus('❌ Enter GitHub token first', '#ef4444'); return; }
  if (!_deployFileContent) { showDeployStatus('❌ Select a file first', '#ef4444'); return; }

  const btn = document.getElementById('deploySubmitBtn');
  btn.disabled = true;
  showDeployStatus('⏳ Pushing to GitHub...', '#3b82f6');

  const REPO = 'jeremysfla/macro-tracker';
  const FILE = 'public/index.html';
  const headers = {
    'Authorization': `token ${token}`,
    'Accept': 'application/vnd.github.v3+json',
    'Content-Type': 'application/json'
  };

  try {
    function toBase64(str) {
      const bytes = new TextEncoder().encode(str);
      let bin = '';
      for (let i = 0; i < bytes.length; i++) bin += String.fromCharCode(bytes[i]);
      return btoa(bin);
    }

    // Get current SHA of public/index.html
    let sha = '';
    const getResp = await fetch(`https://api.github.com/repos/${REPO}/contents/${FILE}`, { headers });
    if (getResp.ok) { const d = await getResp.json(); sha = d.sha; }

    // Push public/index.html
    const encoded = toBase64(_deployFileContent);
    const body = { message: `Deploy from app ${new Date().toLocaleString()}`, content: encoded };
    if (sha) body.sha = sha;

    const putResp = await fetch(`https://api.github.com/repos/${REPO}/contents/${FILE}`, {
      method: 'PUT', headers, body: JSON.stringify(body)
    });

    if (!putResp.ok) { const e = await putResp.json(); throw new Error(e.message); }
    const result = await putResp.json();
    showDeployStatus(`✅ Deployed! Commit ${result.commit.sha.slice(0,7)} — live in ~30s`, '#22c55e');
    _deployFileContent = null;
    document.getElementById('deployFileName').textContent = file.name + ' (' + (file.size/1024).toFixed(0) + 'kb)';
    document.getElementById('deployDrop').style.borderColor = '#2a2a2a';
  } catch(e) {
    showDeployStatus(`❌ ${e.message}`, '#ef4444');
  }
  btn.disabled = false;
  btn.style.opacity = '1';
}

function showDeployStatus(msg, color) {
  const el = document.getElementById('deployStatus');
  el.style.display = 'block';
  el.style.color = color;
  el.textContent = msg;
}


// ── Claude AI Chat ──
let claudeHistory = [];

function getAppContext() {
  const todayK = todayKey();
  const userMacros = getStorage('userMacros', MACROS);
  const tdee = getStorage('userTDEE', TDEE);

  // Today's food - use foodEntries (correct storage key)
  const allFoodEntries = getStorage('foodEntries', {});
  const macroLog = getStorage('macroLog', {});
  const entries = allFoodEntries[todayK] || [];
  const todayMacros = macroLog[todayK] || {};
  const totals = Object.keys(todayMacros).length ? todayMacros : entries.reduce((a, e) => ({
    calories: a.calories + (e.calories||0),
    protein: a.protein + (e.protein||0),
    carbs: a.carbs + (e.carbs||0),
    fat: a.fat + (e.fat||0)
  }), {calories:0, protein:0, carbs:0, fat:0});

  // Full food history - last 30 days using correct storage key
  const foodHistory = [];
  for (let i = 1; i <= 30; i++) {
    const d = nowEST();
    d.setDate(d.getDate() - i);
    const dk = dateToKey(d);
    const dayEntries = allFoodEntries[dk];
    if (dayEntries && dayEntries.length > 0) {
      const dt = macroLog[dk] || dayEntries.reduce((a, e) => ({
        calories: a.calories + (e.calories||0),
        protein: a.protein + (e.protein||0),
        carbs: a.carbs + (e.carbs||0),
        fat: a.fat + (e.fat||0)
      }), {calories:0, protein:0, carbs:0, fat:0});
      const foods = dayEntries.map(e => e.name).filter(Boolean).join(', ');
      foodHistory.push(`${dk}: ${Math.round(dt.calories)}cal P:${Math.round(dt.protein)}g C:${Math.round(dt.carbs)}g F:${Math.round(dt.fat)}g | ${foods}`);
    }
  }

  // Full weight log
  const weightHistory = getWeightEntries().map(w => `${w.date}: ${w.weight} lbs`);

  // All runs
  const shoeRuns = getStorage('shoeRuns', []);
  const allRuns = shoeRuns.map(r => `${r.date}: ${r.miles} mi${r.shoe ? ' ('+r.shoe+')' : ''}`);

  // All workouts
  const workouts = getStorage('workoutHistory', []);
  const allWorkouts = workouts.map(w => `${w.date}: ${w.name||'workout'}${w.exercises ? ' - '+w.exercises.map(e=>e.name).join(', ') : ''}`);

  // Lift PRs
  const prs = getStorage('liftPRs', {});
  const prList = Object.entries(prs).map(([k,v]) => `${k}: ${v.weight||v}lbs x${v.reps||1} (1RM: ${v.est1rm||v.weight||v}lbs)`);

  // Shoes
  const shoes = getStorage('shoeGarage', []);
  const shoeList = shoes.map(s => `${s.name}: ${s.miles||0} mi used`);

  // Saved foods (frequent foods)
  const savedFoods = getStorage('savedFoods', []);
  const topFoods = savedFoods.slice(0, 20).map(f => `${f.name} (${f.calories}cal, P:${f.protein}g)`);

  // Claude memory - things learned over time
  const memory = getStorage('claudeMemory', []);

  // Calorie burn log
  const burnLog = getStorage('burnLog', {});
  const recentBurns = Object.entries(burnLog).slice(-7).map(([d,b]) => `${d}: -${b}cal burned`);

  return `You are Jeremy's personal AI fitness coach with FULL access to his health data. You know everything about his nutrition, workouts, and progress. Be specific, data-driven, and proactive.

=== JEREMY'S PROFILE ===
Age: 52 | Goal: 170 → 163 lbs in 30 days
Daily targets: ${userMacros.calories} cal | ${userMacros.protein}g protein | ${userMacros.carbs}g carbs | ${userMacros.fat}g fat
TDEE: ${tdee} cal/day

=== TODAY (${todayK}) ===
Calories: ${Math.round(totals.calories)} / ${userMacros.calories} (${Math.round(userMacros.calories - totals.calories)} remaining)
Protein: ${Math.round(totals.protein)}g / ${userMacros.protein}g | Carbs: ${Math.round(totals.carbs)}g | Fat: ${Math.round(totals.fat)}g
Foods: ${entries.map(e => e.name).join(', ') || 'none logged yet'}

=== FOOD HISTORY (last 30 days) ===
${foodHistory.length ? foodHistory.join('\n') : 'No history'}

=== WEIGHT HISTORY (all entries) ===
${weightHistory.length ? weightHistory.join('\n') : 'No entries'}

=== ALL RUNS ===
${allRuns.length ? allRuns.slice(-30).join('\n') : 'No runs logged'}

=== ALL WORKOUTS ===
${allWorkouts.length ? allWorkouts.slice(-30).join('\n') : 'No workouts logged'}

=== LIFT PRs ===
${prList.length ? prList.join(' | ') : 'None recorded'}

=== SHOES ===
${shoeList.length ? shoeList.join(' | ') : 'None'}

=== CALORIE BURNS (recent) ===
${recentBurns.length ? recentBurns.join('\n') : 'None'}

=== FREQUENT FOODS ===
${topFoods.length ? topFoods.join(', ') : 'None saved'}

=== MEMORY (learned preferences) ===
${memory.length ? memory.join('\n') : 'Nothing stored yet'}

=== APP USAGE PATTERNS ===
${getUsageSummary()}

You can remember things by saying "REMEMBER: [fact]" in your response and it will be saved for future conversations.
Be concise, data-driven, and proactive. Reference specific numbers from Jeremy's actual data.`;
}

// ── Events & Countdowns ──
function getEvents() { return getStorage('userEvents', []); }
function saveEvents(events) { setStorage('userEvents', events); }

let _eventType = 'race';
function setEventType(type) {
  _eventType = type;
  document.getElementById('evtTypeRace').style.background = type === 'race' ? '#3b82f6' : 'var(--surface2)';
  document.getElementById('evtTypeRace').style.color = type === 'race' ? '#fff' : 'var(--text2)';
  document.getElementById('evtTypeRace').style.borderColor = type === 'race' ? '#3b82f6' : 'var(--border)';
  document.getElementById('evtTypeWeight').style.background = type === 'weight' ? '#22c55e' : 'var(--surface2)';
  document.getElementById('evtTypeWeight').style.color = type === 'weight' ? '#fff' : 'var(--text2)';
  document.getElementById('evtTypeWeight').style.borderColor = type === 'weight' ? '#22c55e' : 'var(--border)';
  document.getElementById('eventWeightRow').style.display = type === 'weight' ? 'block' : 'none';
  document.getElementById('eventNameInput').placeholder = type === 'weight' ? 'e.g. Race Weight, Summer Goal' : 'e.g. Grandma\'s Marathon';
}

function openAddEventModal() {
  _eventType = 'race';
  setEventType('race');
  document.getElementById('eventEditId').value = '';
  document.getElementById('eventNameInput').value = '';
  document.getElementById('eventDateInput').value = '';
  document.getElementById('eventWeightTarget').value = '';
  document.getElementById('addEventModalTitle').textContent = '🏁 Add Event / Goal';
  document.getElementById('saveEventBtn').textContent = 'Save';
  document.getElementById('evtTypeRow').style.display = 'flex';
  document.getElementById('addEventModal').classList.add('open');
}

function openEditEventModal(id) {
  const event = getEvents().find(e => e.id === id);
  if (!event) return;
  _eventType = event.type || 'race';
  setEventType(_eventType);
  document.getElementById('eventEditId').value = id;
  document.getElementById('eventNameInput').value = event.name;
  document.getElementById('eventDateInput').value = event.date;
  document.getElementById('eventWeightTarget').value = event.weightTarget || '';
  document.getElementById('addEventModalTitle').textContent = '✏️ Edit Event';
  document.getElementById('saveEventBtn').textContent = 'Update';
  document.getElementById('evtTypeRow').style.display = 'none';
  document.getElementById('addEventModal').classList.add('open');
}

function saveEvent() {
  const name = document.getElementById('eventNameInput').value.trim();
  const date = document.getElementById('eventDateInput').value;
  if (!name || !date) return;
  const editId = document.getElementById('eventEditId').value;
  let events = getEvents();

  if (editId) {
    // Edit existing
    events = events.map(e => {
      if (e.id !== parseInt(editId) && e.id !== editId) return e;
      const updated = { ...e, name, date };
      if (e.type === 'weight') {
        const target = parseFloat(document.getElementById('eventWeightTarget').value);
        if (target) updated.weightTarget = target;
      }
      return updated;
    });
  } else {
    // Add new
    const event = { id: Date.now(), name, date, type: _eventType };
    if (_eventType === 'weight') {
      const target = parseFloat(document.getElementById('eventWeightTarget').value);
      if (target) event.weightTarget = target;
    }
    events.push(event);
    events.sort((a, b) => a.date.localeCompare(b.date));
  }

  saveEvents(events);
  document.getElementById('addEventModal').classList.remove('open');
  renderEventCountdowns();
  renderEventList();
}

function deleteEvent(id) {
  const events = getEvents().filter(e => e.id !== id);
  saveEvents(events);
  renderEventCountdowns();
  renderEventList();
}

function daysUntil(dateStr) {
  const today = nowEST();
  today.setHours(0,0,0,0);
  const target = new Date(dateStr + 'T00:00:00');
  return Math.ceil((target - today) / 86400000);
}

function renderEventCountdowns() {
  const container = document.getElementById('eventCountdowns');
  if (!container) return;
  const events = getEvents().filter(e => daysUntil(e.date) >= 0);
  const currentWeight = getLatestWeight();

  if (!events.length) { container.innerHTML = ''; return; }

  // Build items for each event
  const items = events.map(e => {
    const days = daysUntil(e.date);
    const urgent = days <= 7;
    const soon = days <= 30;
    const isWeight = e.type === 'weight';
    const color = isWeight ? '#22c55e' : urgent ? '#ef4444' : soon ? '#f59e0b' : '#3b82f6';
    const emoji = isWeight ? '⚖️' : urgent ? '🚨' : soon ? '⚡' : '🏁';
    const dateStr = new Date(e.date + 'T00:00:00').toLocaleDateString('en-US', {month:'short', day:'numeric', year:'numeric'});

    if (isWeight && e.weightTarget) {
      const diff = currentWeight ? (currentWeight - e.weightTarget).toFixed(1) : null;
      const byDate = new Date(e.date + 'T00:00:00').toLocaleDateString('en-US', {month:'short', day:'numeric'});
      return `<div style="flex:1;text-align:center;padding:0 8px">
        <div style="font-size:10px;font-weight:700;color:${color};letter-spacing:1px;text-transform:uppercase;margin-bottom:4px">${emoji} ${e.name}</div>
        <div style="font-size:26px;font-weight:900;color:${color};letter-spacing:-1px">${e.weightTarget}<span style="font-size:12px;font-weight:600;color:var(--text2)">lbs</span></div>
        <div style="font-size:11px;color:var(--text3);margin-top:2px">by ${byDate}</div>
        <div style="font-size:11px;color:${color};font-weight:700;margin-top:2px">${diff !== null ? (diff > 0 ? diff + ' to lose' : '✅ Achieved!') : days + ' days'}</div>
      </div>`;
    } else {
      return `<div style="flex:1;text-align:center;padding:0 8px">
        <div style="font-size:10px;font-weight:700;color:${color};letter-spacing:1px;text-transform:uppercase;margin-bottom:4px">${emoji} ${e.name}</div>
        <div style="font-size:26px;font-weight:900;color:var(--text);letter-spacing:-1px">${days}<span style="font-size:12px;font-weight:600;color:var(--text2)"> days</span></div>
        <div style="font-size:11px;color:var(--text3);margin-top:2px">to go</div>
        <div style="font-size:10px;color:var(--text3);margin-top:1px">${dateStr}</div>
      </div>`;
    }
  });

  // Render all in one card with dividers
  const divider = `<div style="width:1px;background:var(--border);margin:4px 0"></div>`;
  container.innerHTML = `<div class="card" style="padding:14px 18px;margin-bottom:14px">
    <div style="display:flex;align-items:center;justify-content:space-around">
      ${items.join(divider)}
    </div>
  </div>`;
}

function renderEventList() {
  const container = document.getElementById('eventList');
  if (!container) return;
  const events = getEvents();
  if (!events.length) {
    container.innerHTML = '<div style="font-size:13px;color:var(--text3);text-align:center;padding:12px">No events added yet</div>';
    return;
  }
  const currentWeight = getLatestWeight();

  container.innerHTML = events.map(e => {
    const days = daysUntil(e.date);
    const past = days < 0;
    const isWeight = e.type === 'weight';
    const color = past ? '#64748b' : isWeight ? '#22c55e' : days <= 7 ? '#ef4444' : days <= 30 ? '#f59e0b' : '#3b82f6';
    const emoji = isWeight ? '⚖️' : '🏁';
    let sub = past ? 'Completed' : days + ' days away';
    if (isWeight && e.weightTarget && currentWeight && !past) {
      const diff = (currentWeight - e.weightTarget).toFixed(1);
      sub += ` · Target: ${e.weightTarget}lbs (${diff > 0 ? diff + ' to lose' : 'achieved!'})`;
    }
    return `<div style="display:flex;align-items:center;justify-content:space-between;padding:10px 0;border-bottom:1px solid var(--border)">
      <div>
        <div style="font-size:14px;font-weight:700;color:var(--text)">${emoji} ${e.name}</div>
        <div style="font-size:11px;color:${color};font-weight:600;margin-top:2px">${sub} · ${new Date(e.date + 'T00:00:00').toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'})}</div>
      </div>
      <div style="display:flex;gap:4px">
        <button onclick="openEditEventModal(${e.id})" style="background:none;border:none;color:#60a5fa;font-size:18px;cursor:pointer;padding:4px 8px">✏️</button>
        <button onclick="deleteEvent(${e.id})" style="background:none;border:none;color:#ef4444;font-size:18px;cursor:pointer;padding:4px 8px">🗑</button>
      </div>
    </div>`;
  }).join('');
}

// ── End Events ──

// ── Interaction Tracker ──
function logInteraction(type, detail) {
  try {
    const log = getStorage('interactionLog', []);
    const now = nowEST();
    log.push({ type, detail, date: dateToKey(now), hour: now.getHours(), ts: Date.now() });
    if (log.length > 500) log.splice(0, log.length - 500);
    setStorage('interactionLog', log);
  } catch(e) {}
}

function getUsageSummary() {
  const log = getStorage('interactionLog', []);
  if (!log.length) return 'No interaction data yet — use the app more and check back!';

  const tabCounts = {}, hourCounts = {}, featureCounts = {}, dailyActivity = {};
  log.forEach(e => {
    if (e.type === 'tab_visit') tabCounts[e.detail] = (tabCounts[e.detail]||0) + 1;
    if (e.hour !== undefined) {
      const label = e.hour < 6 ? 'night(early)' : e.hour < 12 ? 'morning' : e.hour < 17 ? 'afternoon' : e.hour < 21 ? 'evening' : 'night';
      hourCounts[label] = (hourCounts[label]||0) + 1;
    }
    if (e.date) dailyActivity[e.date] = (dailyActivity[e.date]||0) + 1;
    if (e.type !== 'tab_visit') featureCounts[e.type] = (featureCounts[e.type]||0) + 1;
  });

  const totalDays = Object.keys(dailyActivity).length;
  const avgPerDay = totalDays ? (log.length / totalDays).toFixed(1) : 0;
  const topTabs = Object.entries(tabCounts).sort((a,b)=>b[1]-a[1]).map(([k,v])=>`${k}(${v}x)`).join(', ');
  const leastTabs = Object.entries(tabCounts).sort((a,b)=>a[1]-b[1]).slice(0,3).map(([k,v])=>`${k}(${v}x)`).join(', ');
  const topHours = Object.entries(hourCounts).sort((a,b)=>b[1]-a[1]).map(([k,v])=>`${k}(${v}x)`).join(', ');
  const topFeatures = Object.entries(featureCounts).sort((a,b)=>b[1]-a[1]).slice(0,10).map(([k,v])=>`${k}(${v}x)`).join(', ');

  return `USAGE DATA (${log.length} interactions, ${totalDays} days tracked, avg ${avgPerDay}/day)
Most visited tabs: ${topTabs || 'none yet'}
Least visited tabs: ${leastTabs || 'none yet'}
Most active time: ${topHours || 'none yet'}
Features used: ${topFeatures || 'none yet'}`;
}

function triggerAppImprovement() {
  const summary = getUsageSummary();
  const prompt = `Analyze how I actually use this app and suggest specific improvements.

${summary}

App tabs: Today, Recipes, Trends, Shoes, Workout, Program, History, AI.
Features: food logging, barcode scanning, macro tracking, weight logging, shoe mileage, workout logging, lift PRs, recipe builder, run tracking, Strava integration, AI coaching, event countdowns.

Please analyze:
1. Which features I use most vs least — should underused ones be removed, simplified, or made more prominent?
2. What patterns do you see in when/how I use the app?
3. What features might be missing based on my behavior?
4. Specific UI improvements for my top 3 most-used areas.

Be direct and specific. Reference my actual usage numbers.`;
  claudeQuickPrompt(prompt);
}
// ── End Interaction Tracker ──

function processClaudeMemory(response) {
  const memoryMatches = response.match(/REMEMBER:\s*(.+)/gi);
  if (memoryMatches) {
    const memory = getStorage('claudeMemory', []);
    memoryMatches.forEach(m => {
      const fact = m.replace(/REMEMBER:\s*/i, '').trim();
      if (!memory.includes(fact)) {
        memory.push(fact);
        if (memory.length > 50) memory.shift(); // keep last 50
      }
    });
    setStorage('claudeMemory', memory);
  }
}

// Voice dictation for Claude input
let _voiceRecognition = null;
let _voiceActive = false;

function toggleVoiceDictation() {
  const btn = document.getElementById('claudeVoiceBtn');
  const input = document.getElementById('claudeInput');

  if (_voiceActive) {
    _voiceRecognition?.stop();
    return;
  }

  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SR) {
    alert('Voice dictation not supported in this browser.');
    return;
  }

  _voiceRecognition = new SR();
  _voiceRecognition.lang = 'en-US';
  _voiceRecognition.continuous = false;
  _voiceRecognition.interimResults = true;

  _voiceRecognition.onstart = () => {
    _voiceActive = true;
    btn.style.background = '#ef4444';
    btn.textContent = '🔴';
  };

  _voiceRecognition.onresult = (e) => {
    const transcript = Array.from(e.results).map(r => r[0].transcript).join('');
    input.value = transcript;
    input.style.height = 'auto';
    input.style.height = input.scrollHeight + 'px';
  };

  _voiceRecognition.onend = () => {
    _voiceActive = false;
    btn.style.background = '#1e3a5f';
    btn.textContent = '🎤';
    // Auto-send if we got something
    if (input.value.trim()) sendClaudeMessage();
  };

  _voiceRecognition.onerror = () => {
    _voiceActive = false;
    btn.style.background = '#1e3a5f';
    btn.textContent = '🎤';
  };

  _voiceRecognition.start();
}

function claudeQuickPrompt(text) {
  document.getElementById('claudeInput').value = text;
  sendClaudeMessage();
}

async function sendClaudeMessage() {
  const input = document.getElementById('claudeInput');
  const msg = input.value.trim();
  if (!msg) return;

  input.value = '';
  input.style.height = 'auto';

  // Add user message
  appendClaudeMessage('user', msg);
  claudeHistory.push({ role: 'user', content: msg });

  // Show typing indicator
  const typingId = 'typing_' + Date.now();
  appendClaudeMessage('typing', '...', typingId);

  document.getElementById('claudeSendBtn').disabled = true;

  try {
    const resp = await fetch('/api/claude', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        model: 'claude-opus-4-6',
        max_tokens: 1024,
        system: getAppContext(),
        messages: claudeHistory
      })
    });

    const data = await resp.json();
    if (data.error) throw new Error(data.error.message || JSON.stringify(data.error));
    const reply = data.content?.[0]?.text || 'Sorry, I had trouble responding.';

    // Remove typing indicator
    document.getElementById(typingId)?.remove();

    claudeHistory.push({ role: 'assistant', content: reply });
    processClaudeMemory(reply);
    const displayReply = reply.replace(/REMEMBER:\s*.+/gi, '').trim();
    appendClaudeMessage('assistant', displayReply);

  } catch(e) {
    document.getElementById(typingId)?.remove();
    appendClaudeMessage('assistant', '❌ Error: ' + e.message + ' | ' + e.constructor.name);
  }

  document.getElementById('claudeSendBtn').disabled = false;
  document.getElementById('claudeInput').focus();
}

function appendClaudeMessage(role, text, id) {
  const container = document.getElementById('claudeChatMessages');
  const div = document.createElement('div');
  if (id) div.id = id;

  const isUser = role === 'user';
  const isTyping = role === 'typing';

  div.style.cssText = `display:flex;justify-content:${isUser ? 'flex-end' : 'flex-start'};`;

  const bubble = document.createElement('div');
  bubble.style.cssText = `
    max-width:85%;
    padding:12px 16px;
    border-radius:${isUser ? '18px 18px 4px 18px' : '18px 18px 18px 4px'};
    background:${isUser ? '#2563eb' : '#1e293b'};
    color:#fff;
    font-size:14px;
    line-height:1.5;
    white-space:pre-wrap;
    ${isTyping ? 'color:#64748b;font-style:italic;' : ''}
  `;
  bubble.textContent = text;

  div.appendChild(bubble);
  container.appendChild(div);
  container.scrollTop = container.scrollHeight;
}

</script>
<!-- Recipe Builder Modal -->
<div class="modal-overlay" id="newRecipeModal">
  <div class="modal-sheet">
    <div class="modal-handle"></div>
    <div class="modal-title">📖 New Recipe</div>
    <div class="modal-sub">Name your recipe, search for ingredients, set quantities</div>

    <input type="text" id="recipeNameInput" placeholder="Recipe name (e.g. Post-Workout Bowl)" style="margin-bottom:14px" />

    <div style="font-size:11px;font-weight:700;color:var(--text2);letter-spacing:1px;text-transform:uppercase;margin-bottom:8px">🔍 Search Ingredients (USDA Database)</div>
    <div style="position:relative;margin-bottom:10px">
      <input type="text" id="recipeIngSearchInput" placeholder="e.g. chicken breast, brown rice, olive oil…"
        style="padding-right:48px" onkeydown="if(event.key==='Enter')searchRecipeIngredient()" />
      <button onclick="searchRecipeIngredient()" style="position:absolute;right:8px;top:50%;transform:translateY(-50%);width:34px;height:34px;border-radius:10px;background:var(--blue);border:none;cursor:pointer;font-size:14px;color:#fff;display:flex;align-items:center;justify-content:center">➤</button>
    </div>
    <div id="recipeIngLoading" style="display:none;text-align:center;padding:12px;font-size:12px;color:var(--text2)">Searching USDA database…</div>
    <div id="recipeIngResults" style="max-height:160px;overflow-y:auto;margin-bottom:12px"></div>

    <div style="font-size:11px;font-weight:700;color:var(--text2);letter-spacing:1px;text-transform:uppercase;margin-bottom:8px">🧺 Ingredients Added</div>
    <div id="recipeIngredientsList" style="margin-bottom:12px">
      <div style="font-size:12px;color:var(--text3);font-style:italic">No ingredients yet — search above</div>
    </div>

    <div id="recipeTotalBar" style="display:none;background:var(--surface2);border-radius:12px;padding:10px 14px;margin-bottom:14px;font-size:12px;font-weight:700;color:var(--text)"></div>

    <button class="btn-green" onclick="saveRecipe()">💾 Save Recipe</button>
    <button class="btn-outline" onclick="document.getElementById('newRecipeModal').classList.remove('open')">Cancel</button>
  </div>
</div>

<!-- Food Detail / Serving Modal (shared for USDA + Restaurant) -->
<div class="modal-overlay" id="foodDetailModal">
  <div class="modal-sheet">
    <div class="modal-handle"></div>
    <div class="modal-title" id="fdTitle">Food Details</div>
    <div class="food-result" id="fdFoodCard"></div>
    <div style="display:flex;align-items:center;gap:12px;background:var(--surface2);border-radius:14px;padding:10px 14px;border:1.5px solid var(--border);margin-bottom:12px">
      <div style="font-size:13px;font-weight:600;color:var(--text);flex:1">Servings</div>
      <div style="display:flex;align-items:center;gap:10px">
        <button class="srv-btn" onclick="adjustFdServings(-0.5)">−</button>
        <div class="srv-val" id="fdServingsVal">1</div>
        <button class="srv-btn" onclick="adjustFdServings(0.5)">+</button>
      </div>
    </div>
    <div id="fdActionBtns"></div>
    <button class="btn-outline" onclick="document.getElementById('foodDetailModal').classList.remove('open')">Cancel</button>
  </div>
</div>
<!-- ── Add / Edit Shoe Modal ── -->
<div class="modal-overlay" id="addShoeModal">
  <div class="modal-sheet">
    <div class="modal-handle"></div>
    <div class="modal-title" id="addShoeTitle">👟 Add New Shoe</div>
    <div class="modal-sub">Take a photo to auto-identify, or enter details manually</div>
    <input type="hidden" id="editShoeId" />
    <div style="margin-bottom:14px">
      <div style="font-size:11px;font-weight:700;color:var(--text2);letter-spacing:1px;text-transform:uppercase;margin-bottom:8px">📸 Identify via Photo (AI)</div>
      <div style="position:relative;border-radius:16px;overflow:hidden;background:#0f172a;aspect-ratio:16/9;display:flex;align-items:center;justify-content:center;margin-bottom:8px" id="shoePhotoPreview">
        <div style="text-align:center;color:#475569" id="shoePhotoPlaceholder"><div style="font-size:36px">📷</div><div style="font-size:12px;margin-top:6px;font-weight:600">No photo yet</div></div>
        <img id="shoePhotoImg" style="display:none;width:100%;height:100%;object-fit:cover" />
      </div>
      <div style="display:flex;gap:8px">
        <label style="flex:1;display:flex;align-items:center;justify-content:center;gap:8px;padding:10px;background:var(--surface2);border:1.5px solid var(--border);border-radius:12px;font-size:12px;font-weight:700;color:var(--text2);cursor:pointer">
          📷 Take Photo<input type="file" accept="image/*" capture="environment" style="display:none" onchange="handleShoePhoto(this)" />
        </label>
        <label style="flex:1;display:flex;align-items:center;justify-content:center;gap:8px;padding:10px;background:var(--surface2);border:1.5px solid var(--border);border-radius:12px;font-size:12px;font-weight:700;color:var(--text2);cursor:pointer">
          🖼️ Choose Photo<input type="file" accept="image/*" style="display:none" onchange="handleShoePhoto(this)" />
        </label>
      </div>
      <div id="shoeAIStatus" style="display:none;margin-top:8px;font-size:12px;font-weight:600;color:var(--text2);text-align:center;padding:10px;background:var(--surface2);border-radius:10px"></div>
    </div>
    <div style="font-size:11px;font-weight:700;color:var(--text2);letter-spacing:1px;text-transform:uppercase;margin-bottom:8px">Shoe Details</div>
    <input type="text" id="shoeNameInput" placeholder="e.g. Brooks Ghost 15 — Race Pair" style="margin-bottom:8px" />
    <input type="text" id="shoeBrandInput" placeholder="Brand (e.g. Brooks, Nike, ASICS)" style="margin-bottom:8px" />
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:14px">
      <div><div style="font-size:10px;font-weight:700;color:var(--text2);letter-spacing:1px;text-transform:uppercase;margin-bottom:5px">Starting Miles</div><input type="number" id="shoeStartMiles" placeholder="0" value="0" min="0" /></div>
      <div><div style="font-size:10px;font-weight:700;color:var(--text2);letter-spacing:1px;text-transform:uppercase;margin-bottom:5px">Retire At (mi)</div><input type="number" id="shoeRetireMiles" placeholder="400" value="400" min="100" /></div>
    </div>
    <div style="display:flex;gap:8px;margin-bottom:14px">
      <div style="flex:1"><div style="font-size:10px;font-weight:700;color:var(--text2);letter-spacing:1px;text-transform:uppercase;margin-bottom:5px">Color</div><input type="text" id="shoeColorInput" placeholder="e.g. Blue/White" /></div>
      <div style="flex:1"><div style="font-size:10px;font-weight:700;color:var(--text2);letter-spacing:1px;text-transform:uppercase;margin-bottom:5px">Status</div>
        <select id="shoeStatusInput" style="width:100%;padding:11px 12px;border-radius:14px;border:1.5px solid var(--border);background:var(--surface2);font-family:inherit;font-size:13px;color:var(--text)">
          <option value="active">Active</option><option value="retired">Retired</option>
        </select>
      </div>
    </div>
    <button type="button" class="btn-green" onclick="saveShoe()">💾 Save Shoe</button>
    <button type="button" class="btn-outline" onclick="document.getElementById('addShoeModal').classList.remove('open')">Cancel</button>
  </div>
</div>

<!-- ── Assign Run to Shoe Modal ── -->
<div class="modal-overlay" id="assignRunModal">
  <div class="modal-sheet">
    <div class="modal-handle"></div>
    <div class="modal-title">🏃 Which shoes did you wear?</div>
    <div class="modal-sub" id="assignRunDetails">Assign today's run to a pair of shoes</div>
    <input type="hidden" id="assignRunData" />
    <!-- AI photo match -->
    <div id="shoePhotoMatchSection" style="margin-bottom:14px">
      <label style="display:flex;align-items:center;justify-content:center;gap:8px;padding:10px 14px;background:var(--surface2);border:1.5px dashed var(--border);border-radius:14px;font-size:12px;font-weight:700;color:var(--text2);cursor:pointer">
        📸 Take photo to auto-identify shoes
        <input type="file" accept="image/*" capture="environment" style="display:none" onchange="matchShoeFromPhoto(this)" />
      </label>
      <div id="shoeMatchStatus" style="display:none;margin-top:8px;font-size:12px;font-weight:600;padding:10px 12px;background:var(--surface2);border-radius:10px;line-height:1.5"></div>
    </div>
    <div id="assignShoeList" style="margin-bottom:12px"></div>
    <button class="btn-outline" onclick="document.getElementById('assignRunModal').classList.remove('open')">Skip for now</button>
  </div>
</div>

<!-- ── Shoe Detail Modal ── -->
<div class="modal-overlay" id="shoeDetailModal">
  <div class="modal-sheet" style="max-height:90vh;display:flex;flex-direction:column">
    <div class="modal-handle"></div>
    <div id="shoeDetailContent" style="flex:1;overflow-y:auto;padding-bottom:8px"></div>
    <button class="btn-outline" style="flex-shrink:0;margin-top:10px" onclick="document.getElementById('shoeDetailModal').classList.remove('open')">Close</button>
  </div>
</div>

</body>
</html>